<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<title>上门保养</title>
	<link rel="stylesheet" href="./css/nav.css">
	<script src="./js/jquery-1.10.1.min.js"></script>
	<script language="javascript" src="./js/jquery.json-2.2.js"></script> 
	<script src="./js/main.js"></script>
	<style>
		article.orderPart{
			background-color: #fff;
		}
		div.orderPart-title{
			padding: 0.6rem;
			border-bottom: 1px solid #D9D9E2;
		}
		div.orderPart-title p{
			font-size: 0.9rem;
			border-left: 0.2rem solid #f55d5d;
			padding-left: 0.2rem;
			line-height: 1.2rem;
		}
		span.totalMoney{
			float: right;
			font-size: 0.9rem!important;
			color: #f55d5d;
		}
		table{
			width: 100%;
		}
		table td{
			border-bottom: 1px solid #D9D9E2;
			font-size: 0.8rem!important;
			padding: 0.6rem 0;
		}
		td.nameTd{
			padding: 0.6rem 0 0.6rem 1rem!important;
		}
		td.priceTd{
			color: #f55d5d!important;
			text-align: right;
			padding: 0.6rem 1rem 0.6rem 0!important;
		}
		td.detailTd{
			font-size: 0.8rem!important;
			width: 36%;
		}

		article.orderInfo{
			background-color: #fff;
			margin-top: 1rem;
			padding: 0.6rem 1rem;
		}
		article.orderInfo{
			font-size: 0.8rem!important;
		}
		article.orderInfo p,article.orderInfo span{
			font-size: 0.8rem!important;
		}
		article.orderInfo p{
			margin-top: 0.4rem;
		}
		div.addressWraper span{
			float: left;
		}
		article.phone{
			margin-top: 0.8rem;
			background-color: #fff;
			overflow: hidden;
			border-bottom: 1px solid #D9D9E2;
		}
		article.phone p.phone-left{
			float: left;
			width: 70%;
			padding: 1rem;
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;
			font-size: 0.8rem!important;
			border-right: 1px solid #D9D9E2;
		}
		article.phone a.phone-right{
			display: block;
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;
			float: right;
			color: #1e1e1e!important;
			width: 30%;
			text-align: center;
		}
		article.phone a.phone-right img{
			width: 1rem;
		}
		article.phone a.phone-right span{
			font-size: 0.8rem!important;
			margin-right: 0.5rem;
		}
		article.cancle{
			margin-top: 3rem;
			background-color: #fff;
			border-top: 1px solid #D9D9E2;
			overflow: hidden;
		}
		article.cancle div.cancle-left{
			float: left;
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;
			font-size: 0.8rem;
			line-height: 1rem;
			width: 70%;
			padding: 0.5rem;
		}
		article.cancle div.cancle-right{
			float: right;
			font-size: 0.8rem!important;
			text-align: center;
			width: 30%;
			color: #fff;
			background-color: #f55d5d;
			font-size: 1rem;
			line-height: 3rem;
		}

		div.dialog{
			position: fixed;
			top: 0;
			z-index: 500;
			height: 100%;
			width: 100%;
			background-color: rgba(0,0,0,0.5);
		}
		div.dialogWraper{
			position: relative;
			width: 90%;
			margin: 5rem auto;
			background-color: #fff;
			border-radius: 8px;
		}
		div.dialogWraper div.payItem{
			padding: 1rem 1rem 1rem 0.4rem;
			border-bottom: 1px solid #D9D9E2;
			overflow: hidden;
		}
		div.dialogWraper div.payItem p{
			font-size: 1rem;
			text-align: center;
		}
		div.dialogWraper div.payBtn{
			padding: 1rem;
			text-align: center;
			font-size: 1rem;
		}
		div.cancleBtnTwo{
			text-align: center;
			overflow: hidden;
		}
		p.sureCancle{
			font-size: 1rem;
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;
			padding: 1rem;
			float: left;
			width: 50%;
			border-right: 1px solid #D9D9E2;
		}
		p.notCancle{
			font-size: 1rem;
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;
			padding: 1rem;
			float: left;
			width: 50%;
		}
	</style>
</head>
<body>
	<section>
		<article class="orderPart">
			<div class="orderPart-title"><p>订购项目<span class="totalMoney"></span></p></div>
			<div class="orderPart-detail">
				<table cellspacing="0" cellpadding="0" border="0">
					<tbody>
					</tbody>
				</table>
			</div>
		</article>
		<article class="orderInfo">
			<div class="creatOrderTimeWraper">下单时间：<span class="creatOrderTime">2014-11-02 12:00</span></div>
			<div class="orderTimeWraper">预约时间：<span class="orderTime">2014-11-02 12:00-13:00</span></div>
			<div class="payTypeWraper">支付方式：<span class="payType">先服务后付款</span></div>
			<div class="addressWraper"><span>服务地点：</span><p class="address">北京市海淀区北京市海淀区北京市海淀区北京市海淀区</p></div>
		</article>
		<article class="phone">
			<p class="phone-left">本服务由养车宝合作伙伴易车生活提供</p>
			<a class="phone-right" href="tel:4000107877"><p><span>客服电话</span><img src="./img/phone_icon.png"></p></a>
		</article>
		<article class="cancle">
			<div class="cancle-left">
				<p class="topOrderNum">订单号：<span>12345</span></p>
				<p class="bottomOrderStatus">订单状态：<span>待服务</span></p>
			</div>
			<div class="cancle-right" style="display: none;">取消订单</div>
		</article>
	</section>
	<div class="dialog" style="display:none;" id="phoneDialog">
		<div class="dialogWraper" id="dialogWraper">
			<div class="payItem"><p>请联系客服400-010-7877</p></div>
			<div class="payBtn">确定</div>
		</div>
	</div>
	<div class="dialog" style="display:none;" id="cancleDialog">
		<div class="dialogWraper" id="dialogWraper-cancle">
			<div class="payItem"><p>确认取消订单吗？</p></div>
			<div class="cancleBtnTwo"><p class="sureCancle">确定</p><p class="notCancle">取消</p></div>
		</div>
	</div>
</body>
<script type="text/javascript">
	$(function(){
		// 获取参数
		var url = window.location.search; 
	    var paramJson = {};
	    if(url!=''){
	    	var paramsArr = (url.split("?")[1]).split("&");
		    $.each(paramsArr,function(i){
		        var item = paramsArr[i].split("=");
		        paramJson[item[0]] = item[1]
		    });
	    }
	    // 客服垂直居中
	    $('article.phone a.phone-right').height($('P.phone-left').outerHeight());
	    $('article.phone a.phone-right p').css('line-height',$('P.phone-left').outerHeight()+'px');

	    // 获取订单详情
		$.ajax({
			url:'/yangchebao-app-ws/ws/0.1/externmaintain/order/detail/bynumber?orderNumber='+paramJson.orderNumber+'&'+new Date().getTime(),
			type:'get',
			dataType:'json',
			async:false,
			contentType:'application/json;charset=utf-8',
			success:function(data){
				$('span.totalMoney').html('￥'+data.sumPrice);
				var orderListStr='';
				data.productArray.forEach(function(key,i){
					orderListStr+='<tr>'
								 +'<td class="nameTd">'+key.productName+'</td>'
								 +'<td class="detailTd">'+key.products[0].productName+'</td>'
								 +'<td class="priceTd"></td>'
								 +'</tr>';
					if(i==0){
						if(key.products[0].products){
							key.products[0].products.forEach(function(_key,j){
								orderListStr+='<tr>'
											 +'<td class="nameTd"></td>'
											 +'<td class="detailTd">'+_key.productName+'</td>'
											 +'<td class="priceTd"></td>'
											 +'</tr>';
							})
						}
						
					}
				});
				$('tbody').html(orderListStr);
				$('span.creatOrderTime').html(data.orderDate);
				$('span.orderTime').html(data.reserveDateStr);
				$('span.payType').html(data.payChannelName);
				$('p.address').html(data.address);
				$('p.topOrderNum span').html(paramJson.orderNumber);
				$('p.bottomOrderStatus span').html(data.statusName);
				var bodyHeight=$('body').height();
				var windowHeight=window.screen.availHeight;
				if(windowHeight>bodyHeight){
					$('article.cancle').css({'position':'fixed','bottom':'0','width':'100%'})
				};
				if(data.status!='3'&&data.status!='4'){
					$('div.cancle-right').show();
					$('div.cancle-right').unbind('click').bind('click',function(){
						if(data.status!=0){
							$('div#phoneDialog').show();
							var dialogWraperHeight=$('div#phoneDialog div.dialogWraper').outerHeight();
							$('div#phoneDialog div.dialogWraper').css({'top':'50%','margin-top':'-'+dialogWraperHeight/2+'px'});
							$('div#phoneDialog').bind('click',function(e){
								if($(e.target).closest('#dialogWraper').length==0){
									$('div#phoneDialog').hide()
								}
							});
							$('div#phoneDialog div.payBtn').unbind('click').bind('click',function(){
								$('div#phoneDialog').hide()
							})
						}else{
							$('div#cancleDialog').show();
							var dialogWraperHeight=$('div#cancleDialog div.dialogWraper').outerHeight();
							$('div#cancleDialog div.dialogWraper').css({'top':'50%','margin-top':'-'+dialogWraperHeight/2+'px'});
							$('div#cancleDialog div.cancleBtnTwo p.notCancle').bind('click',function(e){
								$('div#cancleDialog').hide()
							});
							$('div#cancleDialog div.cancleBtnTwo p.sureCancle').unbind('click').bind('click',function(){
								var postData={};
								postData.maintainOrderId=data.maintainOrderId;
								postData.orderNumber=data.orderNumber;
								postData.customerId=paramJson.customerId;
								$.ajax({
						    		url:'/yangchebao-app-ws/ws/0.1/externmaintain/order/cancel/v3',
						    		type:'post',
						    		dataType:'json',
						    		data:$.toJSON(postData),
						    		async:false,
						    		contentType:'application/json;charset=utf-8',
						    		success:function(data){
						    			$('p.bottomOrderStatus span').html(data.statusName);
						    			$('div.cancle-right').css('display','none');
						    			$('div#cancleDialog').hide()
						    		}
						    	})
							})
							
						}
					})
				}else{
					$('div.cancle-right').hide()
				}
			}
		})
	})
</script>
</html>