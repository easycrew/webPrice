<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,heihgt=device-height,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="format-detection" content="telephone=no" />
	<title>养车宝</title>
	<script src="http://app.yangchebao.com.cn/group1/M00/00/9F/jquery-1.9.1.min.00000000000000.js"></script> 
	<script src="http://app.yangchebao.com.cn/group1/M00/00/9F/jquery.json-2.2.000000000000000.js"></script>
	<script src="./js/commen.js"></script>
	<link rel="stylesheet" href="./css/main.css">
	<style>
		article{
			background-color: #fff;
			border-bottom: 1px solid #d9d9e2;
		}
		p.city{
			float: left;
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;
			width: 50%;
			border-right: 1px solid #d9d9e2;
			padding: 1.35rem 1rem 1.5rem 1.5rem;
		}
		p.car{
			float: right;
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;
			width: 50%;
			padding: 1.35rem 1rem 1.5rem 1.5rem;
		}
		span.cityName,span.carBrand{
			float: left;
			font-size: 1.5rem;
		}
		span.downArrow{
			float: right;
			position: relative;
			top: 6px;
		}
		span.downArrow::before,span.downArrow::after{
			position: absolute;
			left: -14px;
			width: 0;
			height: 0;
			font-size: 0px;
			content: '';
			border-left: 7px solid transparent;
			border-right: 7px solid transparent;
		}
		span.downArrow::before{
			top: 0;
			border-top: 7px solid #6eaade;
		}
		span.downArrow::after{
			top: -1px;
			border-top: 7px solid #fff;
		}

		article.middle{
			margin-top: 0.8rem;
		}
		div.miTitle{
			padding: 1rem 1.5rem;
			border-bottom: 1px solid #d9d9e2;
		}
		p.miTtleL{
			float: left;
			font-size: 1.5rem;
			line-height: 1.6rem;
			padding-left: 0.7rem;
			border-left: 2px solid #f55d5d;
		}
		p.miTtleR{
			float: right;
			font-size: 1.2rem;
			color: #6eaade;
		}
		span.rightArrow{
			position: relative;
		}
		span.rightArrow::before,span.rightArrow::after{
			position: absolute;
			top: 1px;
			width: 0;
			height: 0;
			content: '';
			font-size: 0px;
			border-top: 7px solid transparent;
			border-bottom: 7px solid transparent;
		}
		span.rightArrow::before{
			right: -4px;
			border-left: 7px solid #a2a2a2;
		}
		span.rightArrow::after{
			right: -3px;
			border-left: 7px solid #fff;
		}
		span.allText{
			margin-right: 1rem;
		}
		div.miCon{
			padding: 1.5rem 0 1.2rem 1.5rem;
		}
		div.miConL{
			float: left;
		}
		img.shopImg{
			width: 80px;
			margin-right: 1.4rem;
		}
		span.shopName{
			font-size: 1.6rem;
		}
		span.distance{
			float: right;
			position: relative;
			top: 2px;
			display: inline-block;
			color: #fff;
			background-color: #f55d5d;
			font-size: 1.2rem;
		}
		p.address{
			font-size: 1.2rem;
			padding: 0.4rem 0 0.2rem;
		}
		span.price{
			float: right;
			margin-right: 1rem;
			color: #f55d5d;
			font-size: 1.5rem;
		}

		article.bottom{
			padding: 1.5rem;
			margin-top: 0.8rem;
		}
		ul.service-ul li.serviceItem{
			float: left;
			width: 30%;
			text-align: center;
			color: #fff;
			font-size: 1.2rem;
			padding: 0.55rem 0 0.65rem;
			margin-bottom: 1rem;
			-webkit-border-radius: 4px;
			-moz-border-radius: 4px;
			border-radius: 4px;
		}
		.noServ{
			opacity: 0.3;
			filter: alpha(opacity=30);
		}
		ul.service-ul li.serviceItem img{
			width: 4.6rem;
		}
		li[data-code="4"]{
			background-color: #AE95FF;
		}
		li[data-code="5"]{
			background-color: #34CC89;
		}
		li[data-code="6"]{
			background-color: #EE8C00;
		}
		li[data-code="7"]{
			background-color: #FF8259;
		}
		li[data-code="2"]{
			background-color: #C46AB4;
		}
		li[data-code="3"]{
			background-color: #51AFFF;
		}
		ul.service-ul li:nth-child(2),ul.service-ul li:nth-child(5){
			margin: 0 5%;
		}
		li.carSafe{
			float: left;
			width: 100%;
			background-color: #FFC521;
			color: #fff;
			font-size: 1.8rem;
			text-align: center;
			-webkit-border-radius: 4px;
			-moz-border-radius: 4px;
			border-radius: 4px;
			padding: 0.7rem 0;
		}
		li.carSafe img{
			width: 4.6rem;
			margin-right: 1rem;
		}
		ul.service-ul li a{
			display: block;
			color: #fff;
		}
	</style>
</head>
<body>
	<article class="top">
		<div class="topW clearfix">
			<p class="city clearfix"><span class="cityName"></span><span class="downArrow"></span></p>
			<p class="car clearfix"><span class="carBrand"></span><span class="downArrow"></span></p>
		</div>
	</article>
	<article class="middle">
		<div class="miTitle clearfix">
			<p class="miTtleL">最近的洗车店</p>
			<p class="miTtleR"><span class="allText">全部洗车店</span><span class="rightArrow"></span></p>
		</div>
		<div class="miCon clearfix">
			<div class="miConL"><img class="shopImg"></div>
			<div class="miConR">
				<p class="shopW"><span class="shopName"></span><span class="distance"></span></p>
				<p class="address"></p>
				<p class="guanzhuPrice"><span class="price"></span></p>
			</div>
		</div>
	</article>
	<article class="bottom">
		<ul class="service-ul clearfix">
		</ul>
	</article>
</body>
<script type="text/javascript">
	$(function(){
		// 获取参数
		var url = window.location.search; 
	    var paramJson = {};
	    if(url!=''){
	    	var paramsArr = (url.split("?")[1]).split("&");
		    $.each(paramsArr,function(i){
		        var item = paramsArr[i].split("=");
		        paramJson[item[0]] = item[1]
		    });
	    }
	    if(paramJson.companyNo){
	    	store.clear();
	    	store.set('customerId', paramJson.customerId);
			store.set('userInfoId',paramJson.userInfoId);
			store.set('companyNo', paramJson.companyNo);
			store.set('mobile', paramJson.mobile);
			store.set('lon', paramJson.lon);
			store.set('lat', paramJson.lat);
			store.set('areaName', decodeURI(decodeURI(paramJson.areaName)));
			store.set('bizType', paramJson.bizType);
			store.set('cityLevel', paramJson.cityLevel);
			if(paramJson.carInfoId){
				store.set('carInfoId', paramJson.carInfoId);
				store.set('modelId', paramJson.modelId);
				store.set('modelName', decodeURI(decodeURI(paramJson.modelName)));
			}
	    }
	 	if(urlIp()=='app.yangchebao.com.cn'){
			store.set('serviceId','72');
			store.set('optionIds','216');
		}else{
			store.set('serviceId','64');
			store.set('optionIds','177');
		}
	    var urlArr=[];
	    urlArr.push('customerId='+store.get('customerId'));
	    urlArr.push('userInfoId='+store.get('userInfoId'));
	    urlArr.push('companyNo='+store.get('companyNo'));
	    urlArr.push('mobile='+store.get('mobile'));
	    urlArr.push('lon='+store.get('lon'));
	    urlArr.push('lat='+store.get('lat'));
	    urlArr.push('areaName='+store.get('areaName'));
	    urlArr.push('bizType='+store.get('bizType'));
	    urlArr.push('cityLevel='+store.get('cityLevel'));
	    if(store.get('carInfoId')){
	    	urlArr.push('carInfoId='+store.get('carInfoId'))
	    }
	    if(store.get('modelId')){
	    	urlArr.push('modelId='+store.get('modelId'))
	    }
	    if(store.get('modelName')){
	    	urlArr.push('modelName='+store.get('modelName'))
	    }
	    url=urlArr.join('&');

		$('span.cityName').html(decodeURI(decodeURI(store.get('areaName'))));
        
		$('span.carBrand').html(decodeURI(decodeURI(store.get('modelName'))));
		// 编辑车系
		$('p.car').on('click',function(){
			store.set('isNearShopWash','0');
			store.set('isAllWash','0');
			window.location.href="brand.html"
		});
		// 编辑城市
		$('p.city').on('click',function(){
			store.set('isNearShopWash','0');
			store.set('isAllWash','0');
			window.location.href="city.html"
		});
		$.ajax({
			url:'/yangchebao-app-ws/ws/0.1/public/query/service/auth?companyNo='+store.get('companyNo')+'&userInfoId='+store.get('userInfoId')+'&areaName='+store.get('areaName')+'&'+new Date().getTime(),
			type:'get',
			dataType:'json',
			contentType:'application/json;charset=utf-8',
			success:function(data){
				var itemStr='';
				data.forEach(function(key,i){
					if(key.code!=1){
						if(key.forwardUrl.indexOf('?')>-1){
							key.forwardUrl+='&'+url
						}else{
							key.forwardUrl+='?'+url
						} 
						if(key.code!=8){
							if(key.status == 1){     
								itemStr+='<li class="serviceItem" data-code="'+key.code+'"><a href="'+key.forwardUrl+'"><p class="itemIcon"><img src="'+key.logo+'"></p><p class="itemText">'+key.serviceName+'</p></a></li>'
							}else{
								itemStr+='<li class="serviceItem noServ" data-code="'+key.code+'"><a href="javascript:"><p class="itemIcon"><img src="'+key.logo+'"></p><p class="itemText">'+key.serviceName+'</p></a></li>'
							}
						}else{
							if(key.status == 1){         
								itemStr+='<li class="carSafe" data-code="'+key.code+'"><a href="'+key.forwardUrl+'"><p class="itemIcon"><img src="'+key.logo+'"></p><p class="itemText">'+key.serviceName+'</p></a></li>'
							}else{
								itemStr+='<li class="carSafe noServ" data-code="'+key.code+'"><a href="javascript:"><p class="itemIcon"><img src="'+key.logo+'"></p><p class="itemText">'+key.serviceName+'</p></a></li>'
							}
						}
					}else{
					//测试环境 &serviceId=64&optionIds=177 线上环境&serviceId=72&optionIds=216
						if(navigator.geolocation){ 
							navigator.geolocation.getCurrentPosition(function(position){  
								var lat = position.coords.latitude;
								var lng = position.coords.longitude; 
								$.ajax({
									url:'/yangchebao-app-ws/ws/0.1/public/geocoder/location/city?lat='+lat+'&lon='+lng+'&'+new Date().getTime(),
									type:'get',
									dataType:'json',
									async:false,
									contentType:'application/json;charset=utf-8',
									success:function(data){
										$.ajax({
											url:'/yangchebao-app-ws/ws/0.1/standardservice/business/page?areaName='+data.cityName+'&modelId='+store.get('modelId')+'&serviceId='+store.get('serviceId')+'&optionIds='+store.get('optionIds')+'&lon='+lng+'&lat='+lat+'&pageindex=0&pagesize=1',
											type:'get',
											async:false,
											dataType:'json',
											contentType:'application/json;charset=utf-8',
											success:function(data){
												$('img.shopImg').attr('src',data.items[0].logo);
												$('span.shopName').html(data.items[0].name).attr('data-id',data.items[0].businessInfoId);
												$('span.distance').html(data.items[0].distance);
												$('p.address').html(data.items[0].address);
												$('span.price').html('￥'+data.items[0].reservePrice)
											},
											error:function(xhr){
												var error=eval('('+xhr.responseText+')');
												alert(error[0].message)
											}
										})
									},error:function(xhr){
										var error=eval('('+xhr.responseText+')');
										alert(error[0].message)
									}
								}); 
							})
						}else{
							$.ajax({
								url:'/yangchebao-app-ws/ws/0.1/standardservice/business/page?areaName='+store.get('areaName')+'&modelId='+store.get('modelId')+'&serviceId=64&optionIds=177&lon='+store.get('lon')+'&lat='+store.get('lat')+'&pageindex=0&pagesize=1',
								type:'get',
								async:false,
								dataType:'json',
								contentType:'application/json;charset=utf-8',
								success:function(data){
									$('img.shopImg').attr('src',data.items[0].logo);
									$('span.shopName').html(data.items[0].name).attr('data-id',data.items[0].businessInfoId);
									$('span.distance').html(data.items[0].distance);
									$('p.address').html(data.items[0].address);
									$('span.price').html('￥'+data.items[0].reservePrice)
								},
								error:function(xhr){
									var error=eval('('+xhr.responseText+')');
									alert(error[0].message)
								}
							})
						}
					}
					
				});
				$('ul.service-ul').html(itemStr);

				$('div.miCon').on('click',function(){
					if(urlIp()=='app.yangchebao.com.cn'){
						store.set('serviceId','72');
					}else{
						store.set('serviceId','64');
					}
					
					var businessInfoId=$(this).find('span.shopName').attr('data-id');
					store.set('businessInfoId',businessInfoId);
					window.location.href="nearShopWash.html"
				});

				$('p.miTtleR').on('click',function(){
					if(urlIp()=='app.yangchebao.com.cn'){
						store.set('serviceId','72');
					}else{
						store.set('serviceId','64');
					}
					store.set('isNearShopWash','0');
					store.set('isAllWash','1');
					window.location.href="standardServ/selectServAttribute.html"
				}); 
			}
		})  
	})
</script>
</html>