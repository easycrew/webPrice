<!DOCTYPE html>
<html>
<head> 
<meta charset="utf-8" />
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" name="viewport" />
<meta content="yes" name="apple-mobile-web-app-capable" />
<meta content="black" name="apple-mobile-web-app-status-bar-style" />
<script type="text/javascript" src="./js/jquery-1.9.1.min.js"></script>  
<script type="text/javascript" src="./js/jquery.json-2.2.js"></script> 
<script type="text/javascript" src="./js/index.js"></script> 
<link rel="stylesheet" href="css/index.css">
<title>快速注册</title>
</head> 
<body style="background-color:#f4f7f8;">
  <section class="regist-wrap" style="display:none;">
    <ul class="form-wrap" style="padding-top: 25px">
    <li><span class="phone"><img src="css/images/phone.png"></span>
       <div class="input-wrap"><input type="text" placeholder="请输入您的手机号码" id="mobile"/></div>
      <span class="regist-btn" id="getcodeBtn">发送验证码</span></li>
    <li><span class="msg"><img src="css/images/msg.png"></span>
       <div class="input-wrap"><input type="text" placeholder="请输入您的验证码" id="code"/></div></li> 
    </ul>
    <p class="check-link carCheckBtn"><span>选择车系</span><label class="arrow"></label></p>   
    <p class="help">短信收不到，获取语音验证码</p>
    <footer class="regist-footer">
     <div class="button bg-org" id="submit">确认</div>
    </footer>
  </section>
  <section class="brand-wrap"  style="display:none;">
    <div class="brandList"> 
    </div>
    <div class="car-overlay" style="display:none;"></div>
    <article class="car-wrap" style="display:none;">   
       <span class="close"><label></label></span>
    </article> 
  </section>
  <div class="overlay-wrap"></div>
<div class="dialog" style="display:none;" id="dialog">
      <div>
        <h1>提示</h1>
        <p>您已经是养车宝用户，点击下一步继续。</p>
        <div class="btn-wrap">
            <div class="dialog-btn next">下一步</div>
        </div>
      </div>
</div>  
<div class="dialog" style="display:none;" id="dialog2">
      <div>
        <h1>提示</h1>
        <p>此手机号已绑定其他微信号，如需解绑，请联系客服010-58377979。</p>
        <div class="btn-wrap">
            <div class="dialog-btn next">下一步</div>
        </div>
      </div>
</div> 
<p class="weixinTip" style="display:none;font-size:1.2rem;;text-align:center;padding:20% 0;">请在微信中打开。 </p>
<script type="text/javascript">
$(document).ready(function(){  
    var ua = navigator.userAgent.toLowerCase();
	if(ua.match(/MicroMessenger/i)=="micromessenger") {
	  $(".regist-wrap").show();
	}else{
	  $(".weixinTip").show();
	}
      var url =window.location.search;  
      var paramJson = {};
      if(url!=undefined&&url!=""){
        var paramsArr = (url.split("?")[1]).split("&"); 
        $.each(paramsArr,function(i){
         var item = paramsArr[i].split("=");
         paramJson[item[0]] = item[1];
        });    
      }     
      $(".carCheckBtn").click(function(){
         $(".regist-wrap").fadeOut();
         $(".brand-wrap").fadeIn();
      });  
      $("#getcodeBtn").click(function(){ 
          if($(this).hasClass("disabled")){
            return false;
          }
          sendMsg();
      });     
	  $("#dialog2 .next").click(function(){ 
           $("#dialog2").hide();
      });        
      $(".help").click(function(){   
	   if($(this).hasClass("unable")){
            return false;
          }
		  sendMsg("1");
      });       
      $(".car-wrap").on('click','.close',function(){
          $(".car-wrap").fadeOut();
          $(".car-wrap").html('<span class="close"><label></label></span>');
          $(".car-overlay").fadeOut();
      }); 
      $(".brandList").on('click','li',function(){ 
           var brandid = $(this).attr("brandid");
           paramJson.brandid =brandid;
           getCarList(brandid);
		   $(document).scrollTop(0); 
           $(".car-overlay").fadeIn();
           $(".car-wrap").fadeIn();
      }); 
     $(".car-wrap").on('click','li',function(){  
           paramJson.modelId=$(this).attr("modelid");
           var modelName = $(this).html(); 
           $(".carCheckBtn span").html(modelName); 
           $(".brand-wrap").fadeOut();
		   $(".car-wrap").html('<span class="close"><label></label></span>');
           $(".car-wrap").hide();
           $(".car-overlay").hide();
           $(".regist-wrap").fadeIn();
           if(paramJson.userId!=undefined&&paramJson.userId!=""){
              modifyModel();
              window.location.href = "trafficCar.html?openid="+paramJson.openid;
           }
          
    });   
    $("#submit").click(function(){ 
          var mobile = $.trim($("#mobile").val());
          if(mobile==""){
              alertTasat("请输入手机号码");
              return;
          } 
          var phoneReg = /^((\+86)|(86)){0,}1\d{10}$/; 
          if(!phoneReg.test(mobile)){
            alertTasat("请输入正确的手机号码"); 
            return;
          }   
          var code = $.trim($("#code").val()); 
          if(code==""){
              alertTasat("请输入验证码");
              return;
          } 
          var cReg = /^\d{4}$/; 
          if(!cReg.test(code)){
            alertTasat("请输入正确的验证码"); 
            return;
          }   
          if(paramJson.modelId==undefined||paramJson.modelId==""){
            alertTasat("请选择车系"); 
            return;
          }
          var postData = {}; 
          postData.openid = paramJson.openid;
          postData.mobile = mobile;
          postData.code = code;  
          postData.modelId = paramJson.modelId; 
          $.ajax({
                url: '/yangchebao-weixin-ws/ws/0.1/carwash/userFastReg',
                type: 'post',
                async: false,
                data:$.toJSON(postData),
                dataType: 'json',
                contentType:'application/json;charset=utf-8',
                success:function(data){
                      modifyModel();
                      window.location.href = "trafficCar.html?openid="+data.openid;
                },error:function(xhr){ 
                     var mes = eval('('+xhr.responseText+')'); 
                     alertTasat(mes[0].message);  
                } 
            }); 
       }); 
      
      getBrandMsg();
      function getBrandMsg(){ 
          $.ajax({
              url: '/shopmanage-ws/ws/0.1/support/brand/list',
              type: 'get', 
              dataType: 'json',
              success: function(data) {  
                 $.each(data,function(k,v){
                    var _h1 = '<h1 class="word">'+k+'</h1>'; 
                    $(".brandList").append(_h1);
                    var _ul = $("<ul>");
                    var items = v;
                    $.each(items,function(i){
                    var item = items[i];
                    var _li = $("<li>").html(item.name).attr("brandid",item.id); 
                    _ul.append(_li); 
                    }); 
                    $(".brandList").append(_ul);
                 });  
              },error:function(xhr){  
              }
          });  
      }
      function getCarList(brandid){ 
          $.ajax({
              url: '/shopmanage-ws/ws/0.1/support/model/list?brandId='+brandid,
              type: 'get', 
              dataType: 'json',
              success: function(data) {    
                 $.each(data,function(i){
                    var item = data[i];
                    var _h1 = '<h1 class="word">'+item.name+'</h1>';  
                    $(".car-wrap").append(_h1);
                    var _ul = $("<ul>").attr("class","carList");
                    var models = item.models;
                    $.each(models,function(i){
                    var model = models[i];
                    var _li = $("<li>").html(model.name).attr("modelid",model.id); 
                    _ul.append(_li); 
                    }); 
                    $(".car-wrap").append(_ul);
                 });  
              },error:function(xhr){  
              }
          });  
      }     
      function modifyModel(){ 
          var postData = {};
          postData.brandId= paramJson.brandid;
          postData.modelId= paramJson.modelId;
          postData.userId= paramJson.userId;
          $.ajax({  
              url: '/yangchebao-weixin-ws/ws/0.1/carwash/getModelMsgByBrandId',
              type: 'post', 
              data:$.toJSON(postData),
              dataType: 'json',
              async:'false',
              contentType:'application/json;charset=utf-8', 
              success: function(data) {    
                 window.location.href = "trafficCar.html?openid="+data.openid; 
              },error:function(xhr){  
              }
          });  
      }  
      function sendMsg(voice){ 
            var postData = {};
             var mobile = $.trim($("#mobile").val());
            if(mobile==""){
                alertTasat("请输入手机号码");
                return;
            }
            var phoneReg = /^((\+86)|(86)){0,}1\d{10}$/; 
            if(!phoneReg.test(mobile)){
              alertTasat("请输入正确的手机号码"); 
              return;
            }    
            postData.mobile = mobile;
            postData.openid = paramJson.openid; 
      			if(voice!=undefined&&voice=="1"){
      				postData.voice="1";
      				voiceTime();
      			}else{
      				time(); 
      			} 
            $.ajax({
                url: '/yangchebao-weixin-ws/ws/0.1/traffic/getMobileCode',
                type: 'post', 
                data:$.toJSON(postData),
                dataType: 'json',
                contentType:'application/json;charset=utf-8',
                success:function(data){ 
				    if(data.boundError=="true"){
					   $("#dialog2").show();
					   return false;
					 }
                     if(data.isReg=="yes"){
                        $("#dialog").show();
                        if(data.isHaveCar=="yes"){  
                           $("#dialog .next").click(function(){
                               if(data.isHavePlate=="yes"){
                                  window.location.href = "trafficList.html?openid="+paramJson.openid;
                               }else{
                                  window.location.href = "trafficCar.html?openid="+paramJson.openid;
                               } 
                            }); 
                        }else{
                           paramJson.userId = data.userId;
                           $("#dialog .next").click(function(){
                              $("#dialog").fadeOut();
                              $(".regist-wrap").fadeOut();
                              $(".brand-wrap").fadeIn(); 
                           }); 
                        }   
                     } 
                },error:function(xhr){ 
                     var mes = eval('('+xhr.responseText+')');  
                } 
            }); 
      } 
});
var wait = 60;
function time() {
  var o = $("#getcodeBtn");
  if (wait == 0) {
  o.removeClass("disabled");
  o.html("获取验证码"); 
  wait = 60;
  } else {
  o.addClass("disabled", true);
  o.html(wait + " s");
  wait--;
  setTimeout(function() {
  time();//循环调用
  },
  1000)
  }
} 
var voiceWait = 60;
function voiceTime() {
  var o = $(".help");
  if (voiceWait == 0) {
  o.removeClass("unable"); 
  voiceWait = 60;
  } else {
  o.addClass("unable", true); 
  voiceWait--;
  setTimeout(function() {
  voiceTime();//循环调用
  },
  1000)
  }
}  
</script>  
</body>
</html>