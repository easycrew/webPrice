<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,heihgt=device-height,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="format-detection" content="telephone=no" />
	<title>选择车型</title>
	<script src="http://app.yangchebao.com.cn/group1/M00/00/9F/jquery-1.9.1.min.00000000000000.js "></script> 
	<script src="http://app.yangchebao.com.cn/group1/M00/00/9F/jquery.json-2.2.000000000000000.js"></script>
	<link rel="stylesheet" href="./css/main.css">
	<script src="./js/commen.js"></script>
	<style>
		section#selectStyle article{
			background-color: #fff;
			margin-top: 0.8rem;
		}
		section#selectStyle article.one div.oneRow{
			line-height: 2.6rem;
			padding: 0 1rem;
			border-bottom: 1px solid #D9D9E2;
		}
		section#selectStyle article.one div.oneRow span{
			font-size: 1rem;
		}
		section#selectStyle article.one div.oneRow span.grayArrow{
			float: right;
			top: 0.66rem;
		}
		
		section#selectStyle article.two{
			border-top: 1px solid #D9D9E2;
		}
		div.theStyleRow{
			position: relative;
			border-bottom: 1px solid #D9D9E2;
			line-height: 2.6rem;
			padding: 0rem 1rem;
		}
		div.theStyleRow p{
			color: #595c5c;
			font-size: 1rem;
		}
		div.theStyleRow img{
			position: absolute;
			top: 0.8rem;
			right: 1.2rem;
			width: 1.2rem;
		}
		div.styleNext{
			position: fixed;
			background-color: #f55d5d;
			text-align: center;
			font-size: 1.2rem;
			line-height: 2.6rem;
			width: 90%;
			margin-left: 5%;
			border-radius: 6px;
			color: #fff;
			bottom: 1.2rem;
		}
	</style>
</head>
<body>
	<section id="selectStyle">
		<article class="one">
			<div class="modelRow oneRow">
				<span class="modelRowSe">选择车系</span>
				<span class="grayArrow"></span>
			</div>
			<div class="styleRow oneRow">
				<span class="styleRowSe">选择车型</span>
				<span class="grayArrow"></span>
			</div>
			<div class="styleNext">下一步</div>
		</article>
		<article class="two" style="display:none;">
		</article>
	</section>
</body>
<script type="text/javascript">
	$(function(){
		// 获取参数
		var url = window.location.search; 
	    var paramJson = {};
	    if(url!=''){
	    	var paramsArr = (url.split("?")[1]).split("&");
		    $.each(paramsArr,function(i){
		        var item = paramsArr[i].split("=");
		        paramJson[item[0]] = item[1]
		    });
	    }
		// 获取主车信息
		if(!(paramJson.theModelName)){
			$.ajax({
				url:'/yangchebao-app-ws/ws/0.1/user/carinfo/maincar?userId='+paramJson.userId+'&'+new Date().getTime(),
				type:'get',
				async:false,
				dataType:'json',
				contentType:'application/json;charset=utf-8',
				success:function(data){
					paramJson.carInfoId=data.carInfoId;
					if(data.modelName){
						$('section#selectStyle span.modelRowSe').html(data.modelName).attr('data-id',data.modelId)
					}
					if(data.styleId){
						$('section#selectStyle span.styleRowSe').attr('data-id',data.styleId).html(data.styleName);
					}
					
				}
			})
		}else{
			$.ajax({
				url:'/yangchebao-app-ws/ws/0.1/user/carinfo/maincar?userId='+paramJson.userId+'&'+new Date().getTime(),
				type:'get',
				async:false,
				dataType:'json',
				contentType:'application/json;charset=utf-8',
				success:function(data){
					paramJson.carInfoId=data.carInfoId
				}
			});
			$('section#selectStyle span.modelRowSe').html(decodeURI(decodeURI(paramJson.theModelName))).attr('data-id',paramJson.theModelId);
			$('section#selectStyle span.styleRowSe').attr('data-id','').html('请选择车型')
		}
		//选车系 
		$('section#selectStyle div.modelRow').unbind('click').bind('click',function(){
			window.location.href='selectBrand.html?userId='+paramJson.userId+'&customerId='+paramJson.customerId
		});
		//选车型
		$('section#selectStyle div.styleRow').unbind('click').bind('click',function(){
			var modelRowId=$('section#selectStyle span.modelRowSe').attr('data-id');
			var styleRowId=$('section#selectStyle span.styleRowSe').attr('data-id');
			$('section#selectStyle article.one').hide();
			$('section#selectStyle article.two').show();
			if(modelRowId){
				$.ajax({
					url:'/yangchebao-app-ws/ws/0.1/support/style/list?modelId='+modelRowId,
					type:'get',
					dataType:'json',
					contentType:'application/json;charset=utf-8',
					async:false,
					success:function(data){
						var styleStr='';
						data.forEach(function(key,i){
							styleStr+='<div id="'+key.id+'" class="theStyleRow">'
									 +'<p>'+key.name+'</p>'
									 +'</div>'
						});
						$('section#selectStyle article.two').html(styleStr);
						if(styleRowId){
							$('section#selectStyle article.two div.theStyleRow[id="'+styleRowId+'"]').append('<img src="./img/check_icon.png">')
						}
						$('div.theStyleRow').unbind('click').bind('click',function(){
							var theStyleRowId=$(this).attr('id');
							var theStyleRowName=$(this).find('p').html();
							$(this).append('<img src="./img/check_icon.png">');
							$(this).siblings().find('img').remove();
							$('section#selectStyle div.styleRow span.styleRowSe').html(theStyleRowName).attr('data-id',theStyleRowId);
							$('section#selectStyle article.one').show();
							$('section#selectStyle article.two').hide();
						})
					}
				})
			}
		});
		// 选完车型后，下一步
		$('section#selectStyle div.styleNext').unbind('click').bind('click',function(){
			if(!($('section#selectStyle span.modelRowSe').attr('data-id'))){
				errorLog('请选择车系');
				return false
			}
			if(!($('section#selectStyle span.styleRowSe').attr('data-id'))){
				errorLog('请选择车型');
				return false
			}
			var postData={};
			postData.carInfoId=paramJson.carInfoId;
			postData.customerId=paramJson.customerId;
			postData.modelId=$('section#selectStyle span.modelRowSe').attr('data-id');
			postData.styleId=$('section#selectStyle span.styleRowSe').attr('data-id');
			if(!(paramJson.carInfoId)){
				var _postData={};
				_postData.modelId=postData.modelId;
				_postData.customerId=postData.customerId;
				$.ajax({
					url:'/yangchebao-app-ws/ws/0.1/user/complete/addCarInfo',
					type:'post',
					dataType:'json',
					async:false,
					data:$.toJSON(_postData),
					contentType:'application/json;charset=utf-8',
					success:function(data){
						postData.carInfoId=data.carInfoId;
					},
					error:function(xhr){
						var error=eval('('+xhr.responseText+')');
						alert(error[0].message)
					}
				})
			}
			$.ajax({
				url:'/yangchebao-app-ws/ws/0.1/user/complete/editCarInfo',
				type:'post',
				data:$.toJSON(postData),
				async:false,
				dataType:'json',
				contentType:'application/json;charset=utf-8',
				success:function(data2){
					window.location.href="selectBattery.html?userId="+paramJson.userId+'&customerId='+paramJson.customerId
				}
			})
		});
		
	})
</script>
</html>