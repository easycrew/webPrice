<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,heihgt=device-height,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="format-detection" content="telephone=no" />
	<title>订单详情</title>
	<script src="http://app.yangchebao.com.cn/group1/M00/00/9F/jquery-1.9.1.min.00000000000000.js "></script> 
	<script src="http://app.yangchebao.com.cn/group1/M00/00/9F/jquery.json-2.2.000000000000000.js"></script>
	<link rel="stylesheet" href="./css/main.css">
	<script src="./js/commen.js"></script>
	<style>
		article{
			background-color: #fff;
		}
		article.top{
			border-bottom: 1px solid #D9D9E2;
		}
		div.batteryInfo{
			background-color: #FFA600;
			padding: 1.2rem 1rem;
		}
		div.batteryInfo p{
			color: #fff;
		}
		div.batteryInfo p:nth-of-type(1) span{
			font-size: 0.95rem;
		}
		div.batteryInfo p:nth-of-type(1) span.statusName{
			float: right;
		}
		div.batteryInfo p:nth-of-type(2),div.batteryInfo p:nth-of-type(2) span{
			font-size: 1.2rem;
		}

		div.orderInfo{
			padding: 1rem 1rem 0.7rem;
		}
		div.orderInfoRow{
			padding-bottom: 0.3rem;
		}
		div.orderInfoRow span,div.orderInfoRow p{
			font-size: 0.95rem;
		}
		div.orderInfoRow span{
			float: left;
			display: inline-block;
			width: 4.8rem;
		}
		div.orderInfoRow p{
			margin-left: 4.8rem;
		}

		article.middle{
			margin-top: 0.8rem;
			margin-bottom: 4.2rem;
			border-bottom: 1px solid #D9D9E2;
		}
		p.company{
			float: left;
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;
			padding: 1rem 0.8rem 1rem 1rem;
			font-size: 0.8rem;
		}
		a.servicePh{
			display: block;
			float: right;
			padding: 0 0.8rem;
			font-size: 0.8rem;
			border-left: 1px solid #D9D9E2;
			color: #1e1e1e;
		}
		a.servicePh img{
			width: 1.2rem;
			margin-left: 0.4rem;
		}
		article.bottom{
			position: fixed;
			bottom: 0;
			width: 100%;
		}
		article.bottom p{
			float: left;
			width: 50%;
			text-align: center;
			font-size: 1.2rem;
			line-height: 3rem;
		}
		article.bottom p.cancle{
			border-top: 1px solid #D9D9E2;
			color: #6eaade;
		}
		article.bottom p.payBtn{
			border-top: 1px solid #f55d5d;
			background-color: #f55d5d;
			color: #fff;
		}

		div.dialog{
			position: fixed;
			top: 0;
			z-index: 500;
			height: 100%;
			width: 100%;
			background-color: rgba(0,0,0,0.5);
		}
		div.dialogWraper{
			position: relative;
			width: 90%;
			margin: 5rem auto;
			background-color: #fff;
			border-radius: 8px;
		}
		div.dialogWraper div.payItem{
			padding: 1rem 1rem 1rem 0.4rem;
			border-bottom: 1px solid #D9D9E2;
			overflow: hidden;
		}
		div.dialogWraper div.payItem p{
			text-align: center;
		}
		div.cancleBtnTwo{
			text-align: center;
			overflow: hidden;
		}
		p.sureCancle{
			font-size: 1rem;
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;
			padding: 1rem;
			float: left;
			width: 50%;
		}
		p.notCancle{
			font-size: 1rem;
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;
			padding: 1rem;
			float: left;
			width: 50%;
			border-right: 1px solid #D9D9E2;
		}
	</style>
</head>
<body>
	<section>
		<article class="top">
			<div class="batteryInfo">
				<p><span class="batteryBrand">loading……</span> <span class="batteryModel">loading……</span><span class="statusName">loading……</span></p>
				<p>￥<span class="price">loading……</span></p>
			</div>
			<div class="orderInfo">
				<div class="orderInfoRow">
					<span>下单时间：</span>
					<p class="orderDate">loading……</p>
				</div>
				<div class="orderInfoRow">
					<span>联系姓名：</span>
					<p class="userName">loading……</p>
				</div>
				<div class="orderInfoRow">
					<span>联系手机：</span>
					<p class="userMobile">loading……</p>
				</div>
				<div class="orderInfoRow">
					<span>预约时间：</span>
					<p class="reserveDate">loading……</p>
				</div>
				<div class="orderInfoRow">
					<span>服务地址：</span>
					<p class="address">loading……</p>
				</div>
			</div>
		</article>
		<article class="middle clearfix">
			<p class="company">本服务由养车宝合作伙伴速电快保提供</p>
			<a class="servicePh" href="tel:4000773321">客服电话<img src="./img/dianhua.png"></a>
		</article>
		<article class="bottom clearfix" style="display:none;">
			<p class="cancle" style="display:none;"><span class="cancleBtn">取消订单</span></p>
			<p class="payBtn" style="display:none;">立即支付</p>
		</article>
	</section>
	<div class="dialog" style="display:none;" id="cancleDialog">
		<div class="dialogWraper" id="dialogWraper-cancle">
			<div class="payItem"><p>确认取消订单吗？</p></div>
			<div class="cancleBtnTwo"><p class="notCancle">取消</p><p class="sureCancle">确定</p></div>
		</div>
	</div>
</body>
<script type="text/javascript">
	$(function(){
		// 获取参数
		var url = window.location.search; 
	    var paramJson = {};
	    if(url!=''){
	    	var paramsArr = (url.split("?")[1]).split("&");
		    $.each(paramsArr,function(i){
		        var item = paramsArr[i].split("=");
		        paramJson[item[0]] = item[1]
		    });
	    }
		// phone图片垂直居中
		$('a.servicePh').each(function(){
			var rowH=$(this).closest('article.middle').height();
			$(this).css('line-height',rowH+'px')
		});
		var wWidth=$('article.middle').width()-$('a.servicePh').outerWidth()-1;
		$('p.company').css('width',wWidth+'px');
		// 获取订单详情
		$.ajax({
			url:'/yangchebao-app-ws/ws/0.1/battery/order/detail/bynumber?orderNumber='+paramJson.orderNumber+'&'+new Date().getTime(),
			type:'get',
			dataType:'json',
			async:false,
			contentType:"application/json;charset=utf-8",
			success:function(data){
				$.each(data,function(key,val){
					$('p.'+key).html(val);
					$('span.'+key).html(val)
				});
				if(data.status!='3' && data.status!='4'){
					$('article.bottom').show();
					$('p.cancle').show();
					// 取消订单
					$('span.cancleBtn').unbind('click').bind('click',function(){
						$('div#cancleDialog').show();
						var $cancle=$(this);
						if(data.ispay==1){
							$('div#cancleDialog div.payItem p').html('您的订单已经支付成功，若需取消，请拨打客服电话：4000-77-3321');
							$('div#cancleDialog p.sureCancle').unbind('click').bind('click',function(){
								$('div#cancleDialog').hide()
							})
						}else{
							var cancleData={};
							cancleData.batteryOrderId=data.batteryOrderId;
							cancleData.orderNumber=data.orderNumber;
							cancleData.customerId=paramJson.customerId;
							$('p.sureCancle').unbind('click').bind('click',function(){
								$.ajax({
									url:'/yangchebao-app-ws/ws/0.1/battery/order/cancel',
									type:'post',
									data:$.toJSON(cancleData),
									dataType:'json',
									async:false,
									contentType:'application/json;charset=utf-8',
									success:function(data2){
										$('span.statusName').html(data2.statusName);
										$('article.bottom').hide();
										$('div#cancleDialog').hide()
									},
									error:function(xhr){
										var error=eval('('+xhr.responseText+')');
										$('div#cancleDialog').hide();
										errorLog(error[0].message)
									}
								})
							})
						}
						$('p.notCancle').unbind('click').bind('click',function(){
							$('div#cancleDialog').hide()
						})
					});
					if(data.ispay==0){
						$('p.payBtn').show();
						$('p.payBtn').unbind('click').bind('click',function(){
							window.location.href='pay.html?sourceId='+data.sourceId+'&orderChannel='+data.orderChannel+'&userName='+data.userName+'&userMobile='+data.userMobile+'&batteryBrand='+data.batteryBrand+'&batteryModel='+data.batteryModel+'&batteryPrice='+data.price+'&address='+data.address+'&customerId='+paramJson.customerId+'&orderNumber='+data.orderNumber
						})
					}else{
						$('p.cancle').css('width','100%')
					}
				}
			}
		})
	})
</script>
</html>