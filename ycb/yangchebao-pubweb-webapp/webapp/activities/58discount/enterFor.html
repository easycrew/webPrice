<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=yes" />
	<meta content="yes" name="apple-mobile-web-app-capable"/>
	<meta content="black" name="apple-mobile-web-app-status-bar-style"/> 
	<meta name="format-detection" content="telephone=no" />
	<title>58折车险用户验证</title>
	<script src="http://app.yangchebao.com.cn/group1/M00/00/9F/jquery-1.9.1.min.00000000000000.js"></script> 
    <script src="http://app.yangchebao.com.cn/group1/M00/00/9F/jquery.json-2.2.000000000000000.js"></script>
	<script src="http://app.yangchebao.com.cn/group1/M00/00/9F/md50000000000000000000000000000.js"></script>
	<style>
		*{
			margin: 0;
			padding: 0;
			list-style: none;
		}
		html,body{
			width: 100%;
		}
		html{
			font-size: 62.5%;
		}
		body{
			background-color: #f4f7f8;
			font-family: 'Hiragino Sans GB',Helvetica,Arial,sans-serif;
			color: #1e1e1e;
		}
		img{
			border: none;
			vertical-align: middle;
		}
		a{
			text-decoration: none;
			outline:none;
			blr:expression(this.onFocus=this.blur());
		}
		input{
			border: none;
			background-color: #fff;
		}

		section{
			position: relative;
			/*min-width: 320px;
			max-width: 640px;*/
			height: 600px;
			margin: 0 auto;
			background-color: #f4f7f8;
			padding-bottom: 5rem;
		}
		p.please,p.lastTip{
			font-size: 1rem;
			color: #555;
		}
		
		input{
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;
			border-bottom: 1px solid #D9D9E2;
			padding: 15px;
			font-size: 1.8rem;
			line-height: 20px;
			color: #1e1e1e;
		}
		div.qrCode{  
			overflow: hidden;
		}
		div.mobileNo input{  
			width: 100%;
		}
		div.qrCode input{  
			float: left;
			width: 70%;
		}
		span.getQrcodeBtn{
			background-color: #88B8E2;
			color: #fff;
			font-size: 1.6rem;
			line-height: 51px;
			cursor: pointer;
			display: inline-block;
			text-align: center;
			width: 5rem;
			width: 30%;
		}
		div.row{
			overflow: hidden;
		}
		div.btn p{
			width: 95%;
			text-align: center;
			background-color: #FF6138;
			color: #fff;
			font-size: 1.8rem;
			line-height: 40px;
			cursor: pointer;
			margin: 2rem auto 0;
			color: #fff;
			-webkit-border-radius: 5px;
			-moz-border-radius: 5px;
			border-radius: 5px;
		}
		/*dialog*/
		.dialog {
		    background-color: rgba(0, 0, 0, 0.4);
		    bottom: 0;
		    height: 100%;
		    position: fixed;
		    top: 0;
		    width: 100%;
		    z-index: 100;
		    
		}
		.dialog > div {
		    background-color: #fff;
		    height: auto;
		    margin: 20% 10px 0;
		    overflow: auto;
		}
		.dialog h1 {
		    border-bottom: 1px solid #fb451f;
		    color: #fb451f;
		    font-size: 1.7em;
		    font-weight: normal;
		    height: 33px;
		    line-height: 33px;
		    text-align: center;
		}
		.dialog h1 {
		    border-bottom: 1px solid #fb451f;
		    color: #fb451f;
		    font-size: 1.7em;
		    font-weight: normal;
		    height: 33px;
		    line-height: 33px;
		    text-align: center;
		}
		.dialog p {
		    font-size: 1.6em;
		    font-weight: normal;
		    line-height: 150%;
		    padding: 20px;
		}
		.dialog .btn-wrap > div {
		    float: left;
		    width: 50%;
		}
		.dialog .dialog-btn {
		    background-color: #fb451f;
		    color: #fff;
		    cursor: pointer;
		    display: block;
		    font-size: 1.6em;
		    height: 34px;
		    line-height: 34px;
		    text-align: center;
		}
		.dialog .left {
		    margin: 0 9px 17px 27px;
		}
		.dialog .right {
		    background-color: #c2c2c6;
		    margin: 0 27px 17px 9px;
		} 
		.getQrcodeBtn.disabled{
			background-color: #ccc;
			color: #fff;
			cursor: default;
		}

		div.errorLog{
			position: fixed;
			top: 0;
			z-index: 500;
			height: 100%;
			width: 100%;
			background-color: rgba(0,0,0,0);
		}
		div.errorLog p{
			position: relative;
			width: 90%;
			margin: 10rem auto;
			background-color: rgba(0,0,0,0.5);
			font-size: 1.6rem;
			color: #fff;
			text-align: center;
			padding: 1rem 0;
			border-radius: 8px;
		}
	</style>
</head>
<body>
	<div class="backOverlay"></div>
	<div class="dialog" style="display: none;">
	  <div>
	    <h1>提示</h1>
	    <p>您已经是养车宝用户，点击下一步继续。</p>
	    <div class="btn-wrap">
	        <div><div class="dialog-btn left">下一步</div></div>
	        <div><div class="dialog-btn right">关闭</div></div>
	    </div>
	  </div>
	</div>
	<section>
		<article>
			<div class="mobileNo row">
				<input type="text" placeholder='请输入手机号' name="mobileNo" id="mobileNo">
			</div>
			<div class="qrCode row">
				<input type="text" placeholder='请输入验证码' name="qrCode" id="qrCode"><span class="getQrcodeBtn">获取验证码</span>
			</div>
			<div class="btn row">
				<p>提交验证</p>
			</div>
		</article>
	</section>
</body>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript">
// 获取参数
		var url = window.location.search; 
	    var paramJson = {};
	    if(url!=''){
	    	var paramsArr = (url.split("?")[1]).split("&");
		    $.each(paramsArr,function(i){
		        var item = paramsArr[i].split("=");
		        paramJson[item[0]] = item[1]
		    });
	    }
    // 错误框
var errorLog=function(msg){
	$('div.errorLog').remove();
	var errorStr='';
	errorStr+='<div class="errorLog" style="display:none;"><p></p></div>'
	$('body').append(errorStr);
	$('div.errorLog p').html(msg);
	$('div.errorLog').fadeIn();
	var errorHeight=$('div.errorLog p').outerHeight();
	$('div.errorLog p').css({'top':'50%','margin-top':'-'+errorHeight/2+'px'});
	$('div.errorLog').unbind('click').bind('click',function(){
		$('div.errorLog').fadeOut()
	});
	setTimeout(function(){
		$('div.errorLog').fadeOut()
	},3000)
};
// 区分ip
var urlIp=function(){
	if((window.location.href).indexOf('app.yangchebao.com.cn')!=-1){
		return 'app.yangchebao.com.cn'
	}else{
		return '172.18.180.11'
	}
}
// 本地存储
var store={
	set:function(key,value){
		if(window.localStorage){
			localStorage.setItem(key,JSON.stringify(value))
		}else{
			var name = key;
			document.cookie=name+'='+escape(JSON.stringify(value))
		}
	},
	get:function(key){
		if(window.localStorage){
			try{
				return JSON.parse(localStorage.getItem(key))
			}catch(e){
				return localStorage.getItem(key)
			}
		}else{
			var name = key;
			var arr =document.cookie.match(new RegExp("(^|)"+name+"=([^;]*)(;|$)"));
			if(arr != null) {
				try{
					return JSON.parse(unescape(arr[2]))
				}catch(e){
					return unescape(arr[2])
				}
			}else{
				return null
			}
		}
	},
	remove:function(key){
		if(window.localStorage){
			localStorage.removeItem(key)
		}else{
			var name = key;
			var exp = new Date();
		    exp.setTime(exp.getTime() - 1);
		    var cval=getCookie(name);
		    if(cval!=null)
	        document.cookie= name + "="+cval+";expires="+exp.toGMTString();
		}
	},
	clear:function(){
		if(window.localStorage){
			localStorage.clear()
		}else{
			var keys=document.cookie.match(/[^ =;]+(?=\=)/g); 
			if(keys){ 
				for(var i = keys.length; i--;){
					document.cookie=keys[i]+'=0;expires=' + new Date(0).toUTCString() 
				}
			} 
		}
	}
}

	var waiter=30;
	// 获取验证码
	function timer(){
		var $getQrcodeBtn=$('span.getQrcodeBtn');
		if(waiter==0){
			$getQrcodeBtn.html('获取验证码').removeClass('disabled');
			$('span.getQrcodeBtn').on('click',codeClick)
			waiter=30;
			return false
		}else{
			$getQrcodeBtn.html(waiter+'S').addClass('disabled',true);
			$('span.getQrcodeBtn').off('click')
		}
		waiter--;
		setTimeout(function() {
		timer();//循环调用
		},
		1000)
	};
	// 点击提交验证
	$('div.btn p').unbind('click').bind('click',function(){
		var mobile=$.trim($('input[name="mobileNo"]').val());
		var code=$.trim($('input[name="qrCode"]').val());
		if(mobile==''){
			errorLog('手机号不能为空');
			return false
		}
		if(!(/^1[0-9]{10}$/.test(mobile))){
			errorLog('手机号格式不正确');
			return false
		}
		$.ajax({
			url:'/yangchebao-app-ws/ws/0.1/user/mobile/check?mobile='+mobile,
			type:'get',
			async:false,
			dataType:'json',
			contentType:'application/json;charset=utf-8',
			success:function(data){
				if(data.isReg==0){
					if(code==''){
						errorLog('请输入验证码');
						return false
					}
					var postData={};
					postData.fastRegStatus=1;
					postData.alias=mobile;
					postData.code=code;
					$.ajax({
						url:'/yangchebao-uc/ws/0.1/registry/mobile',
						type:'post',
						dataType:'json',
						data:$.toJSON(postData),
						contentType:'application/json;charset=utf-8',
						success:function(data3){
                            store.remove('userId');
                            store.remove('customerId');

                            store.set('userId',data3.userInfoId);
                            store.set('customerId',data3.customerId);
							window.location.href="http://app.yangchebao.com.cn/yangchebao-app-ws/ws/0.1/urlMapper/rot/05871989?userId="+data3.userInfoId+'&customerId='+data3.customerId+'&channel='+paramJson.channel
						},
						error:function(xhr){
							var error=eval('('+xhr.responseText+')');
							errorLog(error[0].message)
						}
					})
				}else{
                    store.remove('userId');
                    store.remove('customerId');

                    store.set('userId',data.userId);
                    store.set('customerId',data.customerId);
					$('div.dialog').show();
					$('div.backOverlay').show();
					// 跳转保险
					$('div.dialog div.left').unbind('click').bind('click',function(){
						window.location.href="http://app.yangchebao.com.cn/yangchebao-app-ws/ws/0.1/urlMapper/rot/05871989?userId="+data.userId+'&customerId='+data.customerId+'&channel='+paramJson.channel
					});
					$('div.dialog div.right').unbind('click').bind('click',function(){
						$('div.dialog').hide();
						$('div.backOverlay').hide();
					})
				}
			},
			error:function(xhr){
				var error=eval('('+xhr.responseText+')');
				errorLog(error[0].message)
			}
		})
	});
	function codeClick(){
		if(!($(this).hasClass('disable'))){
			var mobile=$.trim($('input[name="mobileNo"]').val());
			if(mobile==''){
				errorLog('手机号不能为空');
				return false
			}
			if(!(/^1[0-9]{10}$/.test(mobile))){
				errorLog('手机号格式不正确');
				return false
			}
			$.ajax({
				url:'/yangchebao-app-ws/ws/0.1/user/mobile/check?mobile='+mobile,
				type:'get',
				async:false,
				dataType:'json',
				contentType:'application/json;charset=utf-8',
				success:function(data){
					if(data.isReg==0){
						timer();
						// setInterval(timer(),1000);
						$.ajax({
							url:'/yangchebao-app-ws/ws/0.1/common/update/ycbkey',
							async:false,
							type:'get',
							contentType:'application/json;charset=utf-8',
							dataType:'json',
							success:function(data2){
								var timestamp=new Date().getTime();
								var sign=hex_md5(mobile+data2.ycbkey+timestamp);
								$.ajax({
									url:'/yangchebao-uc/ws/0.1/registry/getcode/v2?user='+mobile+'&timestamp='+timestamp+'&sign='+sign,
									type:'get',
									async:false,
									dataType:'json',
									contentType:'application/json;charset=utf-8',
									success:function(data3){

									}
								})
							}
						})
					}else{
                        store.remove('userId');
                        store.remove('customerId');

                        store.set('userId',data.userId);
                        store.set('customerId',data.customerId);
						$('div.dialog').show();
						$('div.backOverlay').show();
						// 跳转保险
						$('div.dialog div.left').unbind('click').bind('click',function(){
							window.location.href="http://app.yangchebao.com.cn/yangchebao-app-ws/ws/0.1/urlMapper/rot/05871989?userId="+data.userId+'&customerId='+data.customerId+'&channel='+paramJson.channel
						});
						$('div.dialog div.right').unbind('click').bind('click',function(){
							$('div.dialog').hide();
							$('div.backOverlay').hide();
						})
					}
					
				},
				error:function(xhr){
					var error=eval('('+xhr.responseText+')');
					errorLog(error[0].message)
				}
			})
		}
	};
	$('span.getQrcodeBtn').on('click',codeClick)
</script>
</html>