<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,heihgt=device-height,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="format-detection" content="telephone=no" />
	<title>新用户专享红包</title>
	<script src="http://app.yangchebao.com.cn/group1/M00/00/9F/jquery-1.9.1.min.00000000000000.js "></script> 
	<script src="http://app.yangchebao.com.cn/group1/M00/00/9F/jquery.json-2.2.000000000000000.js"></script> 
	<script src="http://app.yangchebao.com.cn/group1/M00/00/9F/md50000000000000000000000000000.js"></script>
</head>
<style>	 
*{
	margin: 0;
	padding: 0;
	list-style: none;
}
html,body{
	min-height: 100%;
}
html{
	font-size: 62.5%;
}
body{
	background-color: #FB451F;
	font-family: 'STHeitiSC-Light',Helvetica,Arial,sans-serif,"Microsoft YaHei","微软雅黑";
	color: #1e1e1e;
}
img{
	border: none;
	vertical-align: middle;
}
a{
	text-decoration: none;
	outline: none;
	/*blr: expression(this.onFocus=this.blur);*/
}
input,textarea{
	border: none;
	-webkit-appearance: none;
}
input, textarea, button, a, span, div, p, img{ -webkit-tap-highlight-color:rgba(0,0,0,0); }
.clearfix::before,.clearfix::after{
	display: block;
	content: '';
	font-size: 0px;
}
.clearfix::after{
	clear: both;
}
header img{
	width: 100%;
	display: block;
}
.packet{
	margin:-6rem 1.5rem 0;
	padding:4%;
	background-color: #FFFCC1;
	border: 1px solid #7F2D2F;
	border-radius: 10px;
	position: relative;
	z-index: 1;
}
.packet img{
	display: block;
	width: 100%;
}
.input-wrap{
	margin: 1.5rem 1.5rem 0;
}
.input-wrap input{
	width: 100%;
	display:block;
	height: 4.4rem;
	line-height: 4.4rem;
	font-size: 1.6rem;
	padding: 0 2.1rem; 
	border-radius: 4px;
	background-color: #fff;
	box-sizing:border-box;
}
.button{
	background-color:#ffeb2f;
	border-radius:4px; 
	height:44px;
	line-height: 44px;
	text-align: center;
	font-size: 1.8rem;
	color:#7f2d2f;
	margin: 2rem 5rem 2.6rem;
	display: block; 
	text-decoration: none;
}
div.errorLog{
	position: fixed;
	top: 0;
	z-index: 500;
	height: 100%;
	width: 100%;
	background-color: rgba(0,0,0,0);
	text-align: center;
}
div.errorLog p{
	position: relative;
	display: inline-block;
	margin: 10rem auto;
	background-color: rgba(0,0,0,0.5);
	font-size: 1.6rem;
	color: #fff;
	padding: 0.6rem;
	border-radius: 8px;
}
.mobile-verify{
	height: auto;
	overflow: auto;
}
.mobile-verify input{
	width: 55%;
	float: left;
}
.mobile-verify a{
	background-color: #eceef3;
    border: 1px solid #d9d9e2;
    border-radius: 5px;
    cursor: pointer;
    float: right;  
    text-align: center;
    width: 35%;
    color: #7f2d2f;
    height:44px;
	line-height: 44px; 
	font-size: 1.6rem;
	box-sizing:border-box;
	overflow: hidden;
}
</style>
<body>
	 <header>
	 	<img src="head.png">
	 </header>
	 <div class="packet">
	 	<img src="packet.png">
	 </div>
	 <div class="input-wrap"><input type="text" placeholder="请输入手机号" id="mobile"/></div>
	 <div class="mobile-verify input-wrap">
		<input type="text" placeholder="请输入验证码" id="code">
		<a href="javascript:void(0);" class="verify-Btn">获取验证码</a>
	 </div>
	 <a href="javascript:void(0);" class="button">立即兑换</a>
	 
</body>
<script type="text/javascript">
	$(function(){
		// 获取参数
		var url = window.location.search; 
	    var paramJson = {};
	    if(url!=''){
	    	var paramsArr = (url.split("?")[1]).split("&");
		    $.each(paramsArr,function(i){
		        var item = paramsArr[i].split("=");
		        paramJson[item[0]] = item[1]
		    });
	    } 
	    $(".verify-Btn").click(function(){
			checkMobile();
	    });
		$(".button").click(function(){
			checkMobile();
			regist();
		});
	});
	//获取验证码按钮过30s可点击
	var waiter = 30;
	function timer() {
		var $getVerifyBtn = $('.verify-Btn');
		if (waiter == 0) {
			$getVerifyBtn.html('获取验证码').removeClass('disabled');
			$('.verify-Btn').on('click', codeClick);
			waiter = 30;
			return false
		} else {
			$getVerifyBtn.html(waiter + 'S').addClass('disabled', true);
			$('.verify-Btn').off('click')
		}
		waiter--;
		setTimeout(function() {
			timer(); //循环调用
		}, 1000)
	};
	function checkMobile(mobile){
		    var mobile = $.trim($("#mobile").val());
			if(mobile==""){
				errorLog("请输入手机号");
				return;
			}
			var phoneReg = /^((\+86)|(86)){0,}1\d{10}$/; 
            if(!phoneReg.test(mobile)){
              errorLog("请输入正确的手机号码"); 
              return;
            }  
			$.ajax({
				url: '/yangchebao-app-ws/ws/0.1/user/mobile/check?mobile='+ mobile,
				type: 'get',
				async: false,
				dataType: 'json',
				contentType: 'application/json;charset=utf-8',
				success: function(data) {
				i	if(data.isReg == 0) {
						timer();
						getCode(mobile);
					} else {
				 		window.location.href="oldUserResult.html";
				    }
				},
				error: function(xhr) {
					var error = eval('(' + xhr.responseText + ')');
					errorLog(error[0].message)
				}
			}) 
	}
    function getCode(mobile){
		$.ajax({
			url: '/yangchebao-app-ws/ws/0.1/common/update/ycbkey',
			async: false,
			type: 'get',
			contentType: 'application/json;charset=utf-8',
			dataType: 'json',
			success: function(data) {
				var timestamp = new Date().getTime();
				var sign = hex_md5(mobile + data.ycbkey + timestamp);
				$.ajax({
					url: '/yangchebao-uc/ws/0.1/registry/getcode/v2?user='+mobile + '&timestamp=' + timestamp +'&sign=' + sign,
					type: 'get',
					async: false,
					dataType: 'json',
					contentType: 'application/json;charset=utf-8',
					success: function(data2){},
					error:function(xhr){
						var error = eval('(' + xhr.responseText + ')');
						errorLog(error[0].message)
					}
				});
			},error:function(xhr){
				var error = eval('(' + xhr.responseText + ')');
				errorLog(error[0].message)
			}
		}); 
    }
    function regist(){
    	var mobile = $.trim($("#mobile").val());
    	var verifyCode = $.trim($("#code").val());
    	if (verifyCode == '') {
			errorLog('请输入验证码');
			return false
		}
		var postData = {};
		postData.fastRegStatus = 1;
		postData.alias = mobile;
		postData.code = verifyCode;
		$.ajax({
			url: '/yangchebao-uc/ws/0.1/registry/mobile',
			type: 'post',
			dataType: 'json',
			data: $.toJSON(postData),
			contentType: 'application/json;charset=utf-8',
			success: function(data) { 
			   alert("注册成功！");	 
			},
			error: function(xhr) {
				var error = eval('(' + xhr.responseText + ')');
				errorLog(error[0].message)
			}
		}); 
    }
	// 错误框
	function errorLog(msg){
		$('div.errorLog').remove();
		var errorStr='';
		errorStr+='<div class="errorLog" style="display:none;"><p></p></div>'
		$('body').append(errorStr);
		$('div.errorLog p').html(msg);
		$('div.errorLog').fadeIn();
		var errorHeight=$('div.errorLog p').outerHeight();
		$('div.errorLog p').css({'top':'50%','margin-top':'-'+errorHeight/2+'px'});
		$('div.errorLog').unbind('click').bind('click',function(){
			$('div.errorLog').fadeOut()
		});
		setTimeout(function(){
			$('div.errorLog').fadeOut()
		},3000)
	}
</script>
</html>