<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="format-detection" content="telephone=no" />
	<script language="javascript" src="./js/jquery-1.10.1.min.js"></script> 
	<script language="javascript" src="./js/jquery.json-2.2.js"></script> 
	<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
	<script language="javascript" src="./js/share.js"></script> 
	<title>免费空调清洗</title>
	<style>
		*{
			margin: 0;
			padding: 0;
			list-style: none;
			-webkit-tap-highlight-color: rgba(0,0,0,0);
		}
		html,body{
			min-height: 100%;
		}
		html{
			/*写在html中才会生效*/
			font-size: 62.5%;      
		}
		body{
			background-color: #f4f7f8;
			font-family: 'STHeitiSC-Light',Helvetica,Arial,sans-serif;
			color: #1e1e1e;
		}
		img{
			width: 100%;
			border: none;
			vertical-align: middle;
		}
		a, input{
			text-decoration: none;
			outline: none;
			blr: expression(this.onFocus=this.blur);
		}
		input,textarea{
			border: none;
			-webkit-appearance: none;
		}
		.clearfix::before,.clearfix::after{
			display: block;
			content: '';
			font-size: 0px;
		}
		.clearfix::after{
			clear: both;
		}

		.homepage {
			margin-bottom: 62px;
		}

		footer {
			width: 100%;
			position: fixed;
			bottom: 0;
			background: #E9E9E9;
			border-top: 2px solid #CFCFCF;
		}

		.ui-input{
			width: 100%;
			display: inline-block;
			background-color:#ffffff;
			border:1px #d5d5d5 solid;
			padding:4px 6px;
			border-radius: 6px;
			box-sizing: border-box;
			-webkit-box-sizing: border-box;
			-moz-box-sizing:border-box;
		}

		.ui-input input{
			width:100%;
			border:0px;
			padding:0px;
			height: 24px;
		}

		.btn {
			height: 60px;
			line-height: 60px;
			background: #6CB728;
			text-align: center;
			font-size: 3rem;
			color: #FFF;
			cursor: pointer;
			font-weight: bold;
		}

		.dialog {
			display: none;
		    background-color: #fff;
		    border: 1px solid #ceba7d;
		    color: #707c92;
		    position: fixed;
		    z-index: 1000;
		    border-radius: 10px;
		    padding: 15px;
		    margin: auto;
		    top: 0;
		    bottom: 0;
		    left: 0;
		    right: 0;
		    width:310px;
		    height: 180px;
		    box-sizing: border-box;
		    -webkit-box-sizing: border-box;
		    -moz-box-sizing:border-box;
		}
		.dialog-content {
		    display: table;
		    width: 100%;
		    box-sizing: border-box;
		    -webkit-box-sizing: border-box;
		    -moz-box-sizing: border-box;
		    font-size: 1.5rem;
		    text-align: center;

		}

		.dialog-overlay {
			display: none;
		    background-color: rgba(0, 0, 0, 0.5);
		    bottom: 0;
		    position: fixed;
		    top: 0;
		    width: 100%;
		    z-index: 900;
		} 

		.codeBtn {
			display: inline-block;
		    width: 96px;
		    color: #ffffff;
		    text-align: center;
		    background: #6eaade;
		    border-radius: 5px;
		    height: 34px;
		    line-height: 34px;
		    margin-left: 3px;
		}

		.cancel, .confirm {
			display: inline-block;
			background:#ff6138;
			border-radius:8px;
			width: 46%;
		    font-size: 1.8rem;
		    color: #FFF;
		    text-align: center;
		    padding: 4px 0;
		    margin-top: 15px;
		}

		.validateCode, .redeemCode {
			margin-top: 10px;
		}

		.cancel {
			margin-right:10px;
			border: 2px solid #ff6138;
			background: #fff;
			color: #ff6138;
		}

		.confirm {
			border: 2px solid #ff6138;
		}

		table {
			text-align: left;
		}

		table tr {
			height: 42px;
		}

		.error-msg {
			color: red;
			font-size: 1.4rem;
		}

		div.errorLog{
			position: fixed;
			top: 0;
			z-index: 500;
			height: 100%;
			width: 100%;
			background-color: rgba(0,0,0,0);
			text-align: center;
		}
		div.errorLog p{
			position: relative;
			display: inline-block;
			margin: 10rem auto;
			background-color: rgba(0,0,0,0.5);
			font-size: 1.6rem;
			color: #fff;
			text-align: center;
			padding: 0.6rem 1rem;
			border-radius: 8px;
		}


	</style>
</head>
<body>
	<div class="homepage">
		<img src="images/air-home.png"/>
		<br/>
		<img src="images/air-home2.png"/>
	</div>
	<footer>
		<div class="btn">立即申请</div>
	</footer>
	
	<div class="dialog">
		<div class="dialog-content">
			
			<table width="100%">
				<tr>
					<td width="50px"><label>手机号</label></td>
					<td colspan="2">
						<div class="ui-input">
						<input type="text" name="number">
					</div>
					</td>
				</tr>
				<tr>
					<td width="50px"><label>验证码</label></td>
					<td>
						<div class="ui-input">
							<input type="text" name="validateCode">
						</div>
					</td>
					<td><div class="codeBtn">获取验证码</div></td>
				</tr>
				<!-- <tr>
					<td width="50px"><label>兑换码</label></td>
					<td colspan="2">
						<div class="ui-input">
							<input type="text" name="code">
						</div>
					</td>
				</tr> -->
			</table>

			<div class="error-msg" style="display: none;">error-msg</div>
			<div class="cancel">取消</div>
			<div class="confirm">确定</div>
				
			
		</div>
	</div>
	<div class="dialog-overlay"></div>
</body>
<script type="text/javascript">
	var paramJson = {};
	var wait=60;
	var index = {};
	var channel = '';
	function passParamsFromApp2Web(info){   
		index.init(info);
	} 
	function connectWebViewJavascriptBridge(callback) {
		if (window.WebViewJavascriptBridge) {
			callback(WebViewJavascriptBridge)
		} else {
			document.addEventListener('WebViewJavascriptBridgeReady', function() {
				callback(WebViewJavascriptBridge)
			}, false)
		}
	}
	connectWebViewJavascriptBridge(function(bridge) {
		document.documentElement.style.webkitTouchCallout='none';
		bridge.init(function(message, responseCallback) {   
			if(message instanceof Object){  
				if(typeof index.init === 'function') {   
					responseCallback(index.init.apply(this,[message,bridge]));
				} 
			}else if(message=="pullUpRefresh"){
				 typeof index[message] == 'function' && responseCallback(index.pullUpRefresh.apply(this));  
			}else{
				 responseCallback(setCallCountFromClient.apply(this,[message]));
			}
		}) 
	 
	});
	index.init= function(info){  
	  paramJson = info;
	};

	$(function(){
        // 获取参数
		var url = window.location.search;     

	    if(url!=''){
	    	var paramsArr = (url.split("?")[1]).split("&");
		    $.each(paramsArr,function(i){
		        var item = paramsArr[i].split("=");
		        paramJson[item[0]] = item[1]
		    });
	    }

	    channel = paramJson.channel;

	    //微信分享链接修改为活动页面
	    var ua = navigator.userAgent.toLowerCase();
		if(ua.match(/MicroMessenger/i)=="micromessenger") {
			var shareData = {};
			shareData.title = "夏天到了，您的爱车空调洗澡了吗？";
			shareData.shareUrl = "http://app.yangchebao.com.cn/yangchebao-pubweb/onsite-testing/air-index-nocode.html?appFlag=OutApp&channel="+channel;
			shareData.desc = "夏季养车宝赠您冰爽福利，想在车内呼吸清新空气，那就快来体验吧！";
			shareData.headImgUrl = "http://app.yangchebao.com.cn/yangchebao-pubweb/onsite-testing/images/lALOJo0uX80B9M0B9A_500_500.png";
			share(shareData);
		}

	     //获得焦点时隐藏
	    $("input[name='number']").focus(function() {
	    	$('.dialog').outerHeight('180px');
	    	$('.error-msg').html('').hide();
	    });

	    $("input[name='validateCode']").focus(function() {
	    	$('.dialog').outerHeight('180px');
	    	$('.error-msg').html('').hide();
	    });

	    $("input[name='number']").blur(function(){
			var number = $("input[name='number']").val();
	    	if($.trim(number) == '') {
	    		errorLog("请输入手机号");
	    		return false;
	    	}

	    	if(!/^1[0-9]{10}$/.test(number)){
	    		errorLog("输入正确格式的手机号码");
			    return false;
			}

		});

	    //获取验证码
	    $(".codeBtn").unbind("click").bind("click", function() {
	    	var number = $("input[name='number']").val();
	    	if($.trim(number) == '') {
	    		errorLog("请输入手机号");
	    		return false;
	    	}

	    	if(!/^1[0-9]{10}$/.test(number)){
	    		errorLog("输入正确格式的手机号码");
			    return false;
			}
			codeBtnClick(number);
	    });


	    //立即申请
	    $(".btn").unbind("click").bind("click",function() {

	    	//app外appFlag : OutApp / InApp
	    	//是否有兑换码 hasCode : Y / N
	    	if(paramJson.appFlag && paramJson.appFlag == "OutApp") {
	    		$(".dialog-overlay").show();
	    		$(".dialog").show();
	    	} else {
	    		if(paramJson.customerId=='' || paramJson.customerId==null || paramJson.customerId=='null' || paramJson.customerId==undefined){  
					window.location.href = "http://w2l?presentType=2&androidName=8&iosName=LoginViewController";  
				} else {
					//校验用户是否已经申请过免费上门检测
					$.ajax({
						url: '/yangchebao-app-ws/ws/0.1/detectionService/userQualificationAudit?customerId='+paramJson.customerId+'&cost=0',
						type:'get',
						async:false,
						contentType:'application/json;charset=utf-8',
						success:function(data){
							window.location.href="apply.html?orderChannel=2&cost=0&customerId="+paramJson.customerId+"&hasCode=N&channel="+channel;
							
						},
						error: function(xhr) {
							var mes = eval('('+xhr.responseText+')'); 
							errorWin(mes[0].message);
						}

					})
				}
	    		
	    	}
	    	
	    });

	    //取消
	    $( ".cancel").unbind("click").bind("click", function() {
	    	$(".dialog").outerHeight('180px');
	    	$(".error-msg").html('').hide();
	    	$(".dialog").hide();
	    	$(".dialog-overlay").hide();
	    });

	    //确认
	    $(".confirm").unbind("click").bind("click", function() {

	    	//已注册用户再次点击之后进入下一页面
	    	// if(paramJson.customerId) {
	    	// 	window.location.href="apply.html?orderChannel=5&cost=0&customerId="+paramJson.customerId;
	    	// 	return false;
	    	// }

	    	var number = $("input[name='number']").val();
	    	if($.trim(number) == '') {
	    		errorLog("请输入手机号");
	    		return false;
	    	}

	    	if(!/^1[0-9]{10}$/.test(number)){
	    		errorLog("输入正确格式的手机号码");
			    return false;
			}

	    	var validateCode = $("input[name='validateCode']").val();
	    	if($.trim(validateCode) == '') {
	    		errorLog("请输入验证码");
	    		return false;
	    	}

	    	var postData = {};
	    	postData.mobile = number;
	    	postData.verifyCode = validateCode;

	    	//APP外没有兑换码去注册，注册成功直接进入下一页面
	    	$.ajax({
	    		url:'/yangchebao-app-ws/ws/0.1/appOutside/login',
				type:'post',
				async:false,
				data:$.toJSON(postData),
				contentType:'application/json;charset=utf-8',
				success:function(data){
					if(data.flag == 1) {
						paramJson.customerId = data.userInfo.customerId;

						//校验用户是否已经申请过免费上门检测
						$.ajax({
							url: '/yangchebao-app-ws/ws/0.1/detectionService/userQualificationAudit?customerId='+paramJson.customerId+'&cost=0',
							type:'get',
							async:false,
							contentType:'application/json;charset=utf-8',
							success:function(data){
								window.location.href="apply.html?orderChannel=5&cost=0&customerId="+paramJson.customerId+"&channel="+channel+"&hasCode=N";
								
							},
							error: function(xhr) {
								var mes = eval('('+xhr.responseText+')'); 
								errorLog(mes[0].message);
							}
						})

						
					} else {
						errorLog(data.message);
					}
					
				},
				error:function(xhr){
					var mes = eval('('+xhr.responseText+')'); 
					errorLog(mes[0].message);
				}
	    	})
	    });
	});

	// function getShareInfos() {

	// 	var isShare = "0";
	// 	var targetUrl = "";

	// 	if(paramJson.channel) {
	// 		isShare = "1";
	// 		targetUrl = $("input:eq(2)").val() + "?channel="+paramJson.channel;
	// 	}
 //        var content = $("input:eq(1)").val();
 //        var imgUrl = $("input:eq(3)").val();
 //        window.shareInfos.getShareInfos(content, targetUrl, imgUrl, isShare);
 //    }

    // 错误框
	var errorLog=function(msg){
		$('.dialog').outerHeight('200px');
		$('.error-msg').html(msg).show();
	};

	//错误弹出框
	var errorWin=function(msg){
		$('div.errorLog').remove();
		var errorStr='';
		errorStr+='<div class="errorLog" style="display:none;"><p></p></div>'
		$('body').append(errorStr);
		$('div.errorLog p').html(msg);
		$('div.errorLog').fadeIn();
		var errorHeight=$('div.errorLog p').outerHeight();
		$('div.errorLog p').css({'top':'50%','margin-top':'-'+errorHeight/2+'px'});
		$('div.errorLog').unbind('click').bind('click',function(){
			$('div.errorLog').fadeOut()
		});
		setTimeout(function(){
			$('div.errorLog').fadeOut()
		},3000)
	};

	function time(number) {
		var o = $("div.codeBtn");
		if (wait == 0) {
		o.unbind('click').bind('click',function(){
			var number = $("input[name='number']").val();
	    	if($.trim(number) == '') {
	    		errorLog("请输入手机号");
	    		return false;
	    	}

	    	if(!/^1[0-9]{10}$/.test(number)){
	    		errorLog("输入正确格式的手机号码");
			    return false;
			}
			codeBtnClick(number)
		});
		o.css('cursor','pointer');
		o.html("获取验证码"); 
		wait = 60;
		} else {
		o.unbind('click');
		o.css('cursor','default');
		o.html('还剩'+ wait + "秒");
		wait--;
		setTimeout(function() {
			time(number);//循环调用
		},
		1000)
		}
	}

	//发送验证码
	function codeBtnClick(number){
		
		$.ajax({
			type:'get',
			url:'/yangchebao-app-ws/ws/0.1/appOutside/sendVerifycode?mobile='+number,
			// data:$.toJSON(postData),
			dataType:'json',
			async:false,
			contentType:'application/json;charset=utf-8',
			success:function(data){
				if(data.statusCode == "200") {
					errorLog('向'+number+'成功发送验证码！');
				} else {
					errorLog(data.msg);
				}
				
			}
		});
		time(number);
	}
</script>
</html>