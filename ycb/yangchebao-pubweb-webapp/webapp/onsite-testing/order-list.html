<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="format-detection" content="telephone=no" />
	<title>上门全面检测</title>
	<script src="http://app.yangchebao.com.cn/group1/M00/00/9F/jquery-1.9.1.min.00000000000000.js "></script> 
	<script src="http://app.yangchebao.com.cn/group1/M00/00/9F/jquery.json-2.2.000000000000000.js"></script>
	<link rel="stylesheet" href="./css/main.css">
	<script src="./js/commen.js"></script>
	<style>
		ul.ul-batteryOrder li{
			margin-top: 0.8rem;
			border-bottom: 1px solid #D9D9E2;
			background-color: #FFF;
		}
		p.li-top{
			padding: 0rem 0.6rem 0rem 0.6rem;
			font-size: 1rem;
			line-height: 2.2rem;
		}
		p.li-top span.grayArrow{
			float: right;
			padding-right: 10px;
		}
		div.li-middle{
			padding: 1rem 1.2rem 1rem 0.6rem;
			border-bottom: 1px solid #D9D9E2;
		}
		p.imgWraper{
			float: left;
		}
		p.imgWraper img{
			width: 3.8rem;
			margin-right: 1rem;
		}
		div.textWraper{
			float: left;
		}
		
		div.textWraper p{
			padding: 0.1rem 0 0.4rem;
			font-size: 0.8rem;
		}
		p.priceWraper{
			float: right;
			color: #FF6138;
			font-size: 1.2rem;
		}
		div.li-bottomLeft{
			float: left;
			padding: 0.3rem 0 0.3rem 0.3rem;
		}
		div.li-bottomLeft p{
			font-size: 0.8rem;
		}
		div.li-bottomRight{
			float: right;
			line-height: 3rem;
		}
		div.li-bottomRight span.cancleBtn{
			color: #FF6138;
			margin-right: 0.8rem;
		}
		div.li-bottomRight span.payAgainBtn{
			display: inline-block;
			background-color: #FF6138;
			color: #fff;
			padding: 0 1rem;
		}
		div.getMore{
			text-align: center;
			color:#999;
			font-size:0.9rem;
			line-height:2rem;
			display: none;
		}

		div.dialog{
			position: fixed;
			top: 0;
			z-index: 500;
			height: 100%;
			width: 100%;
			background-color: rgba(0,0,0,0.5);
		}
		div.dialogWraper{
			position: relative;
			width: 90%;
			margin: 5rem auto;
			background-color: #fff;
			border-radius: 8px;
		}
		div.dialogWraper div.payItem{
			padding: 1rem 1rem 1rem 0.4rem;
			border-bottom: 1px solid #D9D9E2;
			overflow: hidden;
		}
		div.dialogWraper div.payItem p{
			text-align: center;
		}
		div.cancleBtnTwo{
			text-align: center;
			overflow: hidden;
		}
		p.sureCancle{
			font-size: 1rem;
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;
			padding: 1rem;
			float: left;
			width: 50%;
			border-right: 1px solid #D9D9E2;
		}
		p.notCancle{
			font-size: 1rem;
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;
			padding: 1rem;
			float: left;
			width: 50%;
		}

		@media(max-width:560px) {
			div.textWraper{
				max-width: 68%;
			}
		}

		@media(max-width:360px) {
			div.textWraper{
				max-width: 58%;
			}
		}
	</style>
</head>
<body>
	<section>
		<ul class="ul-batteryOrder">
			<!-- <li>
				<p class="li-top">YCB124567892</p>
				<div class="li-middle clearfix">
					<p class="imgWraper"><img src="./images/service.png"></p>
					<div class="textWraper">
						<p>预约电话：13455665414</p>
						<p>预约地点：回龙观</p>
						<p>预约时间：2016-02-02 11:14:00</p>
					</div>
					<p class="priceWraper">¥829</p>
				</div>
				<div class="li-bottom clearfix">
					<div class="li-bottomLeft">
						<p>状    态：待付款</p>
						<p>下单时间：2016-02-02 11:14:00</p>
					</div>
					<div class="li-bottomRight">
						<span class="cancleBtn">取消</span>
						<span class="payAgainBtn">付款</span>
					</div>
				</div>
			</li>
			<li>
				<p class="li-top">YCB124567892</p>
				<div class="li-middle clearfix">
					<p class="imgWraper"><img src="./images/service.png"></p>
					<div class="textWraper">
						<p>预约电话：13455665414</p>
						<p>预约地点：回龙观</p>
						<p>预约时间：2016-02-02 11:14:00</p>
					</div>
					<p class="priceWraper">¥829</p>
				</div>
				<div class="li-bottom clearfix">
					<div class="li-bottomLeft">
						<p>状    态：待付款</p>
						<p>下单时间：2016-02-02 11:14:00</p>
					</div>
					<div class="li-bottomRight">
						<span class="cancleBtn">取消</span>
						<span class="payAgainBtn">付款</span>
					</div>
				</div>
			</li>
			<li>
				<p class="li-top">YCB124567892<span class="grayArrow">查看检测报告</span></p>
				<div class="li-middle clearfix">
					<p class="imgWraper"><img src="./images/service.png"></p>
					<div class="textWraper">
						<p>预约电话：13455665414</p>
						<p>预约地点：回龙观</p>
						<p>预约时间：2016-02-02 11:14:00</p>
					</div>
					<p class="priceWraper">¥829</p>
				</div>
				<div class="li-bottom clearfix">
					<div class="li-bottomLeft">
						<p>状    态：已检测</p>
						<p>下单时间：2016-02-02 11:14:00</p>
					</div>
					<div class="li-bottomRight">
					</div>
				</div>
			</li> -->
		</ul>
		<div class="getMore">更多</div>
	</section>
	<div class="dialog" style="display:none;" id="cancleDialog">
		<div class="dialogWraper" id="dialogWraper-cancle">
			<div class="payItem"><p>确认取消订单吗？</p></div>
			<div class="cancleBtnTwo"><p class="sureCancle">确定</p><p class="notCancle">取消</p></div>
		</div>
	</div>
</body>
<script type="text/javascript">
	$(function(){
		// 获取参数
		var url = window.location.search; 
	    var paramJson = {};
	    if(url!=''){
	    	var paramsArr = (url.split("?")[1]).split("&");
		    $.each(paramsArr,function(i){
		        var item = paramsArr[i].split("=");
		        paramJson[item[0]] = item[1]
		    });
	    }
	    
		// battery图片垂直居中
		$('p.imgWraper,p.priceWraper').each(function(){
			var rowH=$(this).closest('div.li-middle').height();
			$(this).css('line-height',rowH+'px')
		});

		// 获取订单列表
		var getOrderList=function(page){
			$.ajax({
				url:'/yangchebao-app-ws/ws/0.1/detectionService/pageOrderInfo?pageindex='+page+'&pagesize=10'+'&customerId='+paramJson.customerId+'&'+new Date().getTime(),
				type:'get',
				async:false,
				dataType:'json',
				contentType:'application/json;charset=utf-8',
				success:function(data){
					var orderListStr='';
					if(data.items.length>0){
						data.items.forEach(function(key,i){
							orderListStr+='<li data-id="'+key.detectionOrderId+'">';

							//订单状态：1.待支付;2.待服务;3.已检测;4,已取消;5,已退款;6,已失效
							if(key.orderStatus == '3') {
								orderListStr+='<p class="li-top" data-id="'+key.orderNumber+'">'+key.orderNumber+'<span class="grayArrow" data-id="'+key.workOrderId+'">查看检测报告</span></p>';
							} else {
								orderListStr+='<p class="li-top" data-id="'+key.orderNumber+'">'+key.orderNumber+'</p>'
							}

							orderListStr+='<div class="li-middle clearfix">'
											+'<p class="imgWraper"><img src="./images/service.png"></p>'
											+'<div class="textWraper">'
											+'<p style="display:none;">'+key.name+'</p>'
											+'<p>预约电话：'+key.mobile+'</p>'
											+'<p>预约地点：'+key.address+'</p>'
											+'<p>预约时间：'+key.reserveServiceDate+'</p>'
											+'</div>'
											+'<p class="priceWraper">¥'+key.cost+'</p>'
											+'</div>'
											+'<div class="li-bottom clearfix">'
											+'<div class="li-bottomLeft">'
											+'<p class="orderStatusName" data-id="'+key.ispay+'">状    态：'+key.statusDesc+'</p>'
											+'<p>下单时间：'+key.createDate+'</p>'
											+'</div>'
											+'<div class="li-bottomRight">'

							//没有付款可以取消
							if(key.orderStatus=='1'){
								orderListStr+='<span class="cancleBtn">取消</span>';
								//if(key.ispay==0){
									orderListStr+='<span class="payAgainBtn">付款</span>'
								//}
							}
							orderListStr+='</div></div></li>'
						});
						$('ul.ul-batteryOrder').append(orderListStr);  
						
						// 查看订单详情
						// $('p.li-top').unbind('click').bind('click',function(){
						// 	window.location.href="http://"+urlIp()+"/yangchebao-pubweb/changeBattery/orderDetail.html?orderNumber="+$(this).attr('data-id')+'&userId='+paramJson.userId+'&customerId='+paramJson.customerId
						// });

						//查看检测报告
						$(".grayArrow").unbind("click").bind("click",function(){

							var workOrderId = $(this).closest('li').find('span.grayArrow').attr('data-id');

							$.ajax({
								url: '/yangchebao-weixin-ws/ws/0.1/weixinV2/getTestingResultV2?channelId=5&id='+workOrderId+'&'+parseInt(Math.random()*100000),
								type: 'get',
								async: false,
								dataType: 'json',
								success: function(data) {
									window.location.href="report.html?channelId=5&customerId="+paramJson.customerId+"&workOrderId="+workOrderId;
								},
								error: function(data) {
									window.location.href="report-null.html?channelId=5&customerId="+paramJson.customerId+"&workOrderId="+workOrderId;
								}
							});

						});

						// 取消订单
						$('span.cancleBtn').unbind('click').bind('click',function(){
							$('div#cancleDialog').show();
							var $cancle=$(this);
							if($cancle.parents('li').find('p.orderStatusName').attr('data-id')==1){
								$('div#cancleDialog div.payItem p').html('您的订单已经支付成功，若需取消，请拨打客服电话：4000-77-3321');
								$('div#cancleDialog p.sureCancle').unbind('click').bind('click',function(){
									$('div#cancleDialog').hide();
								})
							}else{
								$('div#cancleDialog div.payItem p').html('确认取消订单吗？');
								var cancleData={};
								cancleData.detectionOrderId=$(this).closest('li').attr('data-id');
								cancleData.orderNumber=$(this).closest('li').find('p.li-top').attr('data-id');
								cancleData.customerId=paramJson.customerId;
								$('div#cancleDialog p.sureCancle').unbind('click').bind('click',function(){
									$.ajax({
										url:'/yangchebao-app-ws/ws/0.1/detectionService/cancelOrder',
										type:'post',
										data:$.toJSON(cancleData),
										dataType:'json',
										async:false,
										contentType:'application/json;charset=utf-8',
										success:function(data2){
											$cancle.closest('li').find('p.orderStatusName').html('状    态：'+data2.msg);
											$cancle.closest('li').find('span.payAgainBtn').remove();
											$cancle.remove();
											$('div#cancleDialog').hide()
										},
										error:function(xhr){
											var error=eval('('+xhr.responseText+')');
											$('div#cancleDialog').hide();
											errorLog(error[0].message)
										}
									})
								})
							}
							$('div#cancleDialog p.notCancle').unbind('click').bind('click',function(){
								$('div#cancleDialog').hide()
							});
						});
						// 付款
						$('span.payAgainBtn').unbind('click').bind('click',function(){

							var $payAgainBtn=$(this);
							detectionOrderId = $payAgainBtn.closest('li').find('p.li-top').parent().attr('data-id');
							paramJson.detectionOrderId = detectionOrderId;
							paramJson.orderChannel = '2'; //app 内
							var username = $payAgainBtn.closest('li').find('p.li-top').parent().find('.textWraper p:eq(0)').html();
							var mobile = $payAgainBtn.closest('li').find('p.li-top').parent().find('.textWraper p:eq(1)').html().substring(5);
							var address = $payAgainBtn.closest('li').find('p.li-top').parent().find('.textWraper p:eq(2)').html().substring(5);
							var reserveServiceDate = $payAgainBtn.closest('li').find('p.li-top').parent().find('.textWraper p:eq(3)').html().substring(5);

							var cost = $payAgainBtn.closest('li').find('p.li-top').parent().find('.priceWraper').html().substring(1);


							window.location.href="pay.html?customerId="+paramJson.customerId+"&orderChannel="+paramJson.orderChannel+"&username="+username+"&address="+address+"&mobile="+mobile+"&reserveServiceDate="+reserveServiceDate+"&cost="+cost+"&sourceId="+paramJson.detectionOrderId;
							
							
						});

						if($('ul.ul-batteryOrder li').length<data.totalCount){
							$('div.getMore').show();
							$('div.getMore').unbind('click').bind('click',function(){
								getOrderList(page+1)
							})
						}else{
							$('div.getMore').hide()
						}
					}else{
						orderListStr+='<p style="text-align:center;margin-top:2.6rem;"><img src="./images/noOrder.png" /></p>'
										+'<p style="font-size:0.92rem;text-align:center;color:#A2A2A2;margin-top:2rem;">您还没有相关订单</p>';
						$('ul.ul-batteryOrder').append(orderListStr)
					}
					
				}
			})
		};

		getOrderList(0);
		
	})
</script>
</html>