<!doctype html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>上门全面检测</title>
    <script language="javascript" src="./js/jquery-1.10.1.min.js"></script> 
	<script language="javascript" src="./js/jquery.json-2.2.js"></script> 
	<link href="date/mobiscroll.custom-2.13.2.min.css" rel="stylesheet" type="text/css" />
	<script src="date/mobiscroll.custom-2.13.2.min.js" type="text/javascript"></script>

	<style type="text/css">
	  body{
		font-family:'华文细黑','HelveticaNeue-Light';
		font-weight:normal;
		font-style:normal;
		line-height:normal;
		font-size:62.5%;
		color:#1e1e1e;
		padding-bottom: 3em;
		-webkit-box-sizing:border-box;
		box-sizing:border-box;
	}
	body,html{
		min-height:100%;
	}
	a{
		text-decoration:none;
	}
	ul{
		list-style:none;
	}
	img{
		border:none;
	}
	*{
		margin:0;
		padding:0;
	}
	.clearfix {
	   *zoom: 1;
	}
	.clearfix:before,
	.clearfix:after {
	   display: table;
	   line-height: 0;
	   content: "";
	}
	.clearfix:after {
	  clear: both;
	}
	.y_btn{
		 background-color: #FF825F; 
	     /*box-shadow: 2px 2px 3px rgba(0, 0, 0, 0.5); */
		-webkit-border-radius:5px;
		-moz-border-radius:5px;
		border-radius:5px;	
		color: #fff;
		font-size: 2.3em;
		display: block;
		text-align: center;
		height: 2.11em;
		line-height: 2.11em;
		padding: 0 1em;
		margin:0 0em 0.56em;
		cursor: pointer;
	}  
	div.share{
		background-color: #34CC89; 
	}
	div.detail{
		background-color: #34CC89; 
	}
	div.detail a {
		color: #fff;
		width: 100%;
		height: 100%;
		display: inline-block;
	}
	.content-wrap{
		padding: 0em 1.4em;
		max-width: 640px;
		margin: 0 auto;
	}
	.content-wrap ul{
		margin: 3em 0;
	}
	.content-wrap li{
		margin-bottom: 0.8em;
	}
	.content-wrap label{
		font-size: 1.8em;
		color: #000;
		/*width: 3.4em;*/
		width: 2.78em;
		line-height:1.78em; 
		text-align: right;
		float: left;
	}
	.content-wrap li div{
		-webkit-box-sizing:border-box;
		-moz-box-sizing:border-box;
		box-sizing:border-box;
		/*margin-left: 7em;*/
		margin-left: 5.5em;
	}
	.content-wrap li input,.content-wrap li select,.content-wrap li textarea{
		border: 1px solid #DCDCE4;
		background-color: #ffffff; 
		-webkit-box-sizing:border-box;
		-moz-box-sizing:border-box;
		box-sizing:border-box;
		-webkit-border-radius:3px;
		-moz-border-radius:3px;
		border-radius:3px;
		font-size: 1.6em;
		width: 100%;
		line-height:1.25em; 
		padding:0.375em 0.5em;
	}
	.content-wrap li textarea{
		height:auto;
	}
	.content-wrap li input#mobileCode{
		width: 50%;
	}
	.content-wrap li span.codeBtn{
		display: inline-block;
		margin-left: 3%;
		width: 43.1%;
		padding: 0.1em 1%;
		border: 1px solid #DCDCE4;
		text-align: center;
		font-size: 1.6em;
		color: #FF825F;
		cursor: pointer;
	}
	.content-wrap .tips{
		color: #FFA892;
		font-size: 1.6em;
		margin-bottom: 1.875em;
	}
	.content-wrap .btn{
		margin:0;
	}
	.success-wrap{
		color:#009b53;
		text-align: center;
		position: absolute;
		top: 50%;
		width: 100%;
		margin-top: -8.8em;
	}
	.success-wrap h1{
		font-size: 3.6em;
		margin-bottom: 1em;
	}
	.success-wrap p{
		font-size: 1.6em;
	}

	.error{
		color: red; 
		font-size: 1.6em; 
		margin-bottom: 1em;
		display:none;
	}
	.comment{  
	    margin: 3em 0; 
	    padding: 1em 0em;
	    text-align: left; 
		color: #36545F;   
	}
	.comment div{
		margin-bottom: 0.2rem;
	}
	.comment span{
		float: left;
		display: inline-block;
		width: 1.2rem;
		font-size: 1.6em;
	   line-height: 150%;
	   color: #A2A2A2;
	}
	.comment p{ 
	   -webkit-box-sizing: border-box;
	   -moz-box-sizing: border-box;
	   box-sizing: border-box;
	   margin-left: 1.2rem;
	   font-size: 1.6em;
	   line-height: 150%;
	   color: #A2A2A2;
	}
	header img{
	    width: 100%;
	    display: block;
	}
	.success_pic img {
	    display: block;
	    margin: 0 auto 3em;
	    max-width: 286px;
	    padding-left:30px;
	    width: 100%;
	}
	div.failReason{
		display: none;
		font-size: 2.7em;
		text-align: center;
	}
	#sharecover {
	    background-color: rgba(0, 0, 0, 0.5);
	    bottom: 0; 
	    height: 100%;
	    left: 0;
	    position: fixed;
	    right: 0;
	    text-align: left;
	    top: 0;
	    width: 100%;
	    z-index:9;
	}
	#sharecover img{
	    width:100%;
	}


	.dialog {
	    background-color: #fff;
	    border: 1px solid #ceba7d;
	    color: #707c92;
	    left: 6.25%;
	    position: absolute;
	    top: 20%;
	    width: 87.5%;
	    z-index: 1000;
	}
	.dialog-content {
	    border-bottom: 2px solid #f3f3f5;
	    display: table;
	    width: 100%;
	}
	.dialog p {
	    display: table-cell;
	    font-size: 1.4em;
	    padding: 0.86em;
	    vertical-align: middle;
	}
	.dialog-overlay {
	    background-color: rgba(0, 0, 0, 0.8);
	    bottom: 0;
	    position: fixed;
	    top: 0;
	    width: 100%;
	    z-index: 900;
	} 
	div.dwo{
		position: fixed!important;
	}
	</style>
</head>

<body>    

    <div class="content-wrap edit_form_wrap">
        <div class="edit_form"> 
            <ul>
                <li><label>姓名</label><div><input type="text" id="username"></div></li>
                <li><label>手机</label><div><input type="text" id="mobile"></div></li>
                <li><label>城市</label><div>
	                <select id="areaId"><option value="">请选择</option></select>
	                <select id="areaIdTwo" style="margin-top: 0.3em;"><option value="">请选择</option></select>
	                <select id="areaIdThree" style="margin-top: 0.3em;"><option value="">请选择</option></select>
                </div></li>
                <li><label>地址</label><div><input type="text" id="address"></div></li>
                <li><label>时间</label><div><input type="text" id="time"/></div></li>
                <li class="mobileCode" style="display:none;"><label>验证码</label><div><input type="text" id="mobileCode"/><span class="codeBtn">获取验证码</span></div></li>
				<li><label>问题</label>
				<div><textarea id="carOwnerQuestion" rows="2" placeholder="请描述您爱车的问题，方便我们检测师带相应工具前往，非必填"></textarea></div></li>
				<li><p class="error nError">&nbsp;</p></li>
            </ul>
        </div>  
        <div class="y_btn" id="save">
            立即下单
        </div> 
        <div class="comment">
            <div><span>1. </span><p>养车宝客服将于2个工作日内与您电话联系，确认检测预约时间、地点及车辆信息；</p></div>
            <div><span>2. </span><p>完成检测后，检测技师将为您的爱车出据1份检测报告，并标明问题建议；</p></div>
            <div><span>3. </span><p>您关注养车宝微信公众号或下载养车宝客户端，可以收到爱车电子版检测报告，还能分享到朋友圈，提醒好友注意行车安全；</p></div>
            <div><span>4. </span><p>如超过预约时间仍无法与您取得联系，请联系客服电话010-58377979；</p></div>
            <div><span>5. </span><p>养车宝上门检测服务的范围限于北京、广州两地的市区范围。北京市支持五环路以内及天通苑、回龙观地区。广州市支持海珠区、越秀区、番禹区、天河区及荔湾区、白云区的部分区域。</div>
			<div><span>6. </span><p>北京车盈科技有限公司享有活动最终解释权。</div> 
        </div> 
    </div> 
    
<script language="javascript">
var paramJson={};
var wait=60;
var mobile;
var isReg;
var customerId;
$(function(){ 

     var url = window.location.search; 
     var paramsArr = (url.split("?")[1]).split("&"); 
     $.each(paramsArr,function(i){
       var item = paramsArr[i].split("=");
           paramJson[item[0]] = item[1];
     });

     if(paramJson.orderChannel == "2") {
     	var agent = navigator.userAgent.toLowerCase(); 
		var bIsIpad = agent.match(/ipad/i) == "ipad";
		var bIsIphone = agent.match(/iphone/i) == "iphone";
		var bIsIphoneOs = agent.match(/iphone os/i) == "iphone os";
		var bIsAndroid = agent.match(/android/i) == "android"; 
		if(bIsIpad || bIsIphone || bIsIphoneOs){
			
		}else{
			try{
				window.shareInfos.isNeedSwipeRefresh(0); //去掉
			} catch(e) {
				console.log(e);
			}
			
		}
     	
     }

     //禁用微信分享
	function onBridgeReady(){
		WeixinJSBridge.call('hideOptionMenu');
	}

	if(typeof WeixinJSBridge == "undefined"){
	if(document.addEventListener){
		document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
		}else if(document.attachEvent){
			document.attachEvent('WeixinJSBridgeReady', onBridgeReady); 
			document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
		}
	}else{
		onBridgeReady();
	}

     //2 ~ 15
    var minDate = new Date();
    minDate.setDate(minDate.getDate()+1);	
	minDate.setHours("0");
	minDate.setMinutes("0");
	minDate.setSeconds("0");

	var maxDate = new Date();
	maxDate.setDate(maxDate.getDate() + 14);
	maxDate.setHours("23");
	maxDate.setMinutes("59");
	maxDate.setSeconds("59");

	$("#time").mobiscroll().datetime({
	        theme: "bootstrap", 
	        mode: "scroller",   
	        display: "model", 
	        lang: "zh",       
	        minDate:minDate,
	        maxDate:maxDate, 
	        dateFormat: 'yy-mm-dd', 
	        stepMinute: 5  
	    });


	var judgeData = {};
    var postData = {};
    $("#username").focus(function(){
    	var ediv = $(".error");
    	if(ediv.attr("etype")=="nError"){
    		ediv.hide();
    	}
    });
    $("#mobile").focus(function(){
    	var ediv = $(".error");
    	if(ediv.attr("etype")=="mError"){
    		ediv.hide();
    	}
    });
	//if(is_weixin()||paramJson.channel!=""){
		$("#mobile").blur(function(){
			mobile = $.trim($("#mobile").val());
			if(mobile==""){
				$(".error").html("请输入手机号码").attr("etype","mError").show(); 
				return false;
			} 
			if(!/^1[0-9]{10}$/.test(mobile)){
			  $(".error").html("输入正确格式的手机号码").attr("etype","mError").show(); 
			  return false;
			}

			//app外
			// if(paramJson.orderChannel == '5') {
			// 	register(mobile); 
			// }

		});
	//}
    $("#address").focus(function(){
    	var ediv = $(".error");
    	if(ediv.attr("etype")=="aError"){
    		ediv.hide();
    	}
    });
    $("#time").click(function(){
    	var ediv = $(".error");
    	if(ediv.attr("etype")=="tError"){
    		ediv.hide();
    	}
    });
    $("#mobileCode").focus(function(){
    	var ediv = $(".error");
    	if(ediv.attr("etype")=="codeError"){
    		ediv.hide();
    	}
    });
    $("#save").click(function(){ 

       var _this = $(this);
		_this.attr("id","save2");  
    	var username = $.trim($("#username").val());
    	var mobile = $.trim($("#mobile").val());
 		var time = $.trim($("#time").val());
 		var areaIdLast=$.trim($("select:last").val());
 		var address = $.trim($("#address").val()); 
		var carOwnerQuestion = $.trim($("#carOwnerQuestion").val()); 
		if(username==""){
			$(".error").html("请输入姓名").attr("etype","nError").show(); 
			return false;
		}
		var reg1 = /^[^*\/\\?]+$/;
		var reg=/^[\u4e00-\u9fa5]+$/;
		if(!reg.test(username)){
		  $(".error").html("输入的姓名只能是汉字").attr("etype","nError").show(); 
		  return false;
		} 
		if(username.length>20){
			$(".error").html("姓名最多20个汉字").attr("etype","nError").show(); 
			return false;
		}
		if(mobile==""){
			$(".error").html("请输入手机号码").attr("etype","mError").show(); 
			return false;
		} 
		if(!/^1[0-9]{10}$/.test(mobile)){
		  $(".error").html("输入正确格式的手机号码").attr("etype","mError").show(); 
		  return false;
		}
		if(areaIdLast==''){
			$(".error").html("请选择区域").attr("etype","aError").show(); 
			return false;
		}
		if(address==""){
			$(".error").html("请输入地址").attr("etype","aError").show(); 
			return false;
		}   
		if(!reg1.test(address)){
		  $(".error").html("输入的地址含非法字符").attr("etype","aError").show(); 
		  return false;
		} 
		if(time==""){
			$(".error").html("请选择时间").attr("etype","tError").show(); 
			return false;
		}
		if(!$('span.codeBtn').is(':hidden')){
			if($.trim($('#mobileCode').val())==''){
				$(".error").html("请输入验证码").attr("etype","codeError").show(); 
				return false;
			}
		} 
		var areaId=$('select#areaId').val();
		var areaName=$('option[value="'+areaId+'"]').text();
		var areaIdTwo=$('select#areaIdTwo').val();
		var areaNameTwo=$('option[value="'+areaIdTwo+'"]').text();
		var areaIdThree=$('select#areaIdThree').val();
		var areaNameThree=$('option[value="'+areaIdThree+'"]').text();
		areaName+=areaNameTwo+areaNameThree;  //省市区
 		postData.name = username;			//username
 		postData.areaName=areaName;				//省市区
 		postData.areaId=areaIdThree;
 		postData.provinceId=areaId;			//province id
 		postData.cityId=areaIdTwo;		//city id
 		postData.countyId=areaIdThree;		//area id
 		postData.mobile = mobile;				//phone number
 		postData.reserveServiceDate = time;					//date
 		postData.address = address;				//street
		postData.problemDesc = carOwnerQuestion; 	//question
		// postData.orderChannel = paramJson.orderChannel;       //2 app内  5 app外
		postData.orderChannel = paramJson.channel;

		postData.cost = paramJson.cost;			//cost : 0, 69
		
		postData.customerId = paramJson.customerId; 

		//paramJson存入支付所需要的参数
		paramJson.username = username;
		paramJson.address = areaName + address;
		paramJson.mobile = mobile;	
		paramJson.reserveServiceDate = time;	
		
		submitOrder(postData);

    });


    //省市联动
	$.ajax({
		url:'/yangchebao-weixin-ws/ws/0.1/weixinV2/getWxArea?parentId=-1',
		type:'get',
		async:false,
		contentType:'application/json;charset=utf-8',
		success:function(data){
			var areaOptionStr='';
			$.each(data,function(i){
				areaOptionStr+='<option value="'+this.areaId+'">'+this.areaName+'</option>'
			});
			$('select#areaId').html(areaOptionStr);
			var areaIdOne=$('select#areaId').val();
			$.ajax({
				url:'/yangchebao-weixin-ws/ws/0.1/weixinV2/getWxArea?parentId='+areaIdOne,
				type:'get',
				async:false,
				contentType:'application/json;charset=utf-8',
				success:function(data2){
					var areaOptionStrTwo='<option value="">请选择</option>';
					$.each(data2,function(i){
						if(areaIdOne == "21" && this.areaId == "22") {
							areaOptionStrTwo+='<option value="'+this.areaId+'" selected="selected">'+this.areaName+'</option>';
							getGZArea(this.areaId);
						} else {
							areaOptionStrTwo+='<option value="'+this.areaId+'">'+this.areaName+'</option>'
						}
						
					});
					$('select#areaIdTwo').html(areaOptionStrTwo);
					$('select#areaIdTwo').change(function(){
						var areaIdTwo=$(this).val();
						if($(this).val()!=''){
							document.getElementById('areaIdThree').style.display='inline-block';
							$.ajax({
								url:'/yangchebao-weixin-ws/ws/0.1/weixinV2/getWxArea?parentId='+areaIdTwo,
								type:'get',
								async:false,
								contentType:'application/json;charset=utf-8',
								success:function(data3){
									var areaOptionStrThree='<option value="">请选择</option>';
									$.each(data3,function(i){
										areaOptionStrThree+='<option value="'+this.areaId+'">'+this.areaName+'</option>'
									});
									$('select#areaIdThree').html(areaOptionStrThree)
								}
							})
						}else{
							$('select#areaIdThree').html('<option value="">请选择</option>')
						}
					})
				}
			});
			$('select#areaId').change(function(){
				var areaId=$(this).val();
				if($(this).val()!=''){
					$('select#areaIdTwo').html('<option value="">请选择</option>');
					$('select#areaIdThree').html('<option value="">请选择</option>');
					$.ajax({
						url:'/yangchebao-weixin-ws/ws/0.1/weixinV2/getWxArea?parentId='+areaId,
						type:'get',
						async:false,
						contentType:'application/json;charset=utf-8',
						success:function(data2){
							var areaOptionStrTwo='<option value="">请选择</option>';
							$.each(data2,function(i){
								if(areaId == "21" && this.areaId == "22") {
									areaOptionStrTwo+='<option value="'+this.areaId+'" selected="selected">'+this.areaName+'</option>'
									getGZArea(this.areaId);
								} else {
									areaOptionStrTwo+='<option value="'+this.areaId+'">'+this.areaName+'</option>'
								}
							});
							$('select#areaIdTwo').html(areaOptionStrTwo);
							$('select#areaIdTwo').change(function(){
								var areaIdTwo=$(this).val();
								if($(this).val()!=''){
									document.getElementById('areaIdThree').style.display='inline-block';
									$.ajax({
										url:'/yangchebao-weixin-ws/ws/0.1/weixinV2/getWxArea?parentId='+areaIdTwo,
										type:'get',
										async:false,
										contentType:'application/json;charset=utf-8',
										success:function(data3){
											var areaOptionStrThree='<option value="">请选择</option>';
											$.each(data3,function(i){
												areaOptionStrThree+='<option value="'+this.areaId+'">'+this.areaName+'</option>'
											});
											$('select#areaIdThree').html(areaOptionStrThree)
										}
									})
								}else{
									$('select#areaIdThree').html('<option value="">请选择</option>')
								}
							})
						}
					})
				}else{
					$('select#areaIdTwo').html('<option value="">请选择</option>');
					$('select#areaIdThree').html('<option value="">请选择</option>')
				}
				

			})
		},error:function(xhr){
			var mes = eval('('+xhr.responseText+')'); 
			alert(mes[0].message);
		}
	}); 
});

/**
* 获取广州-环城高速内范围内的区
*/
function getGZArea(id) {
	document.getElementById('areaIdThree').style.display='inline-block';
	$.ajax({
		url:'/yangchebao-weixin-ws/ws/0.1/weixinV2/getWxArea?parentId='+id,
		type:'get',
		async:false,
		contentType:'application/json;charset=utf-8',
		success:function(data3){
			var areaOptionStrThree='<option value="">请选择</option>';
			$.each(data3,function(i){
				areaOptionStrThree+='<option value="'+this.areaId+'">'+this.areaName+'</option>'
			});
			$('select#areaIdThree').html(areaOptionStrThree);
		}
	})
}


//提交订单
function submitOrder(postData){

	$.ajax({
		url: '/yangchebao-app-ws/ws/0.1/detectionService/placeOrder',
		type: 'post',
		async: false,
		data:$.toJSON(postData),
		dataType: 'json',
		contentType:'application/json;charset=utf-8',
		success:function(data){
			 $(".edit_form_wrap").hide();
			 $("header").hide();
			if(paramJson.cost == "0") {
	    		// $(".success_wrap").show();  
	    		// alertDialog("服务时间以确认后的时间为准");
	    		if(paramJson.orderChannel == '5' && paramJson.hasCode == 'N') {
	    			window.location.href="http://weixin.yangchebao.com.cn/yangchebao-pubweb/onsite-testing/apply-suc-wx.html?customerId="+paramJson.customerId+"&orderChannel="+paramJson.orderChannel+"&channel="+paramJson.channel;
	    		} else {
	    			window.location.href="apply-suc.html?customerId="+paramJson.customerId+"&orderChannel="+paramJson.orderChannel;
	    		}
	    		
	    	} else {
	    		paramJson.detectionOrderId = data.detectionOrderId;
	    		window.location.href="pay.html?customerId="+paramJson.customerId+"&orderChannel="+paramJson.orderChannel+"&username="+paramJson.username+"&address="+paramJson.address+"&mobile="+paramJson.mobile+"&reserveServiceDate="+paramJson.reserveServiceDate+"&cost="+paramJson.cost+"&sourceId="+paramJson.detectionOrderId;
	    	}
		},
		error:function(xhr){ 
			 var mes = eval('('+xhr.responseText+')'); 
			 $(".error").html(mes[0].message).attr("etype","tError").show()
		} 
	});
	
}
// function alertDialog(m){
// 	var dialog = $("<div>").addClass("dialog");
// 	var content = $("<div>").addClass("dialog-content").html("<p>"+m+"</p>");
// 	var overlay = $("<div>").addClass("dialog-overlay");
// 	$("body").append(dialog.append(content)).append(overlay); 
// 	setTimeout(function(){
// 		dialog.remove();
// 		overlay.remove()
// 	},2000)
// }
function time() {
	var o = $("span.codeBtn");
	if (wait == 0) {
	o.unbind('click').bind('click',function(){
		codeBtnClick()
	});
	o.css('cursor','pointer');
	o.html("获取验证码"); 
	wait = 60;
	} else {
	o.unbind('click');
	o.css('cursor','default');
	o.html('还剩'+ wait + "秒");
	wait--;
	setTimeout(function() {
	time();//循环调用
	},
	1000)
	}
}

//发送验证码
function codeBtnClick(){
	var postData={};
	postData.mobile=mobile;
	$.ajax({
		type:'post',
		url:'/yangchebao-weixin-ws/ws/0.1/weixinV2/getMobileCode',
		data:$.toJSON(postData),
		dataType:'json',
		async:false,
		contentType:'application/json;charset=utf-8',
		success:function(){
			window.scrollTo(0,0);
			alertDialog('向'+mobile+'成功发送验证码！');
		}
	});
	time();
}
function  is_weixin(){
    var flag = false;
	var ua = navigator.userAgent.toLowerCase();
	if(ua.match(/MicroMessenger/i)=="micromessenger") {
		flag = true; 
	} 
	return flag;
}

//手机号注册
function register(mobile){
	$.ajax({
		type:'get',
		url:'/yangchebao-weixin-ws/ws/0.1/weixinV2/isReg?mobile='+mobile,
		async:false,
		contentType:'application/json;charset=utf-8',
		success:function(data){
			isReg=data.isReg;
			if(data.isReg=='no'){
				$('li.mobileCode').show();
				$('.content-wrap label').css('width','3.4em');
				$('.content-wrap li div').css('margin-left','7em');
				$('span.codeBtn').unbind('click').bind('click',function(){
					codeBtnClick()
				})
			}else{
				paramJson.customerId=data.customerId;
				var ediv = $(".error");
				if(ediv.attr("etype")=="codeError"){
					ediv.hide();
				}
				$('li.mobileCode').hide();
				$('.content-wrap label').css('width','2.78em');
				$('.content-wrap li div').css('margin-left','5.5em');
			}
		},error:function(xhr){
			var error=eval('('+xhr.responseText+')');
			$(".error").html(error[0].message).attr("etype","mError").show()
		}
	});
}

</script>
</body>
</html>
