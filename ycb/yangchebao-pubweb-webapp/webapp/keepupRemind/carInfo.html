<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=yes" />
	<meta content="yes" name="apple-mobile-web-app-capable"/>
	<meta content="black" name="apple-mobile-web-app-status-bar-style"/> 
	<meta name="format-detection" content="telephone=no" />
	<title>填写车辆信息</title>
	<script src="http://app.yangchebao.com.cn/group1/M00/00/9F/jquery-1.9.1.min.00000000000000.js "></script> 
	<script src="http://app.yangchebao.com.cn/group1/M00/00/9F/jquery.json-2.2.000000000000000.js"></script>
	<link rel="stylesheet" href="./date/mobiscroll.custom-2.13.2.min.css">
	<script src="./date/mobiscroll.custom-2.13.2.min.js"></script>
	<script src="./js/commen.js"></script>
	<style>
		*{
			margin: 0;
			padding: 0;
			list-style: none;
		}
		html,body{
			min-height: 100%;
		}
		body{
			background-color: #f4f7f8;
			font-size: 62.5%;
			font-family: 'Hiragino Sans GB',Helvetica,Arial,sans-serif;
			color: #1e1e1e;
		}
		input, textarea, button, a, span, div, p, img{ -webkit-tap-highlight-color:rgba(0,0,0,0); }
		img{
			border: none;
			vertical-align: middle;
		}
		a{
			text-decoration: none;
			outline:none;
			blr:expression(this.onFocus=this.blur());
		}
		input,textarea{
			border: none;
			-webkit-appearance: none;
		}
		.clearfix::before,.clearfix::after{
			display: block;
			content: '';
			font-size: 0px;
		}
		.clearfix::after{
			clear: both;
		}

		.grayArrow{
			position: relative;
		}
		.grayArrow::after,.grayArrow::before{
			position: absolute;
			content: '';
			font-size: 0;
			width: 0;
			height: 0;
			border-top: 0.7rem solid transparent;
			border-bottom: 0.7rem solid transparent;
			top: -0.12rem;
		}
		.grayArrow::before{
			border-left: 0.7rem solid #C2C2C6;
			right: -0.12rem;
		}
		.grayArrow::after{
			right: 0px;
			border-left: 0.7rem solid #fff;
		}
		div.errorLog{
			position: fixed;
			top: 0;
			z-index: 500;
			height: 100%;
			width: 100%;
			background-color: rgba(0,0,0,0);
			text-align: center;
		}
		div.errorLog p{
			position: relative;
			display: inline-block;
			margin: 6rem auto;
			background-color: rgba(0,0,0,0.5);
			font-size: 1rem;
			color: #fff;
			padding: 0.6rem;
			border-radius: 8px;
		}

		div.selectModel{
			padding: 0.8rem 0.8rem 0.8rem 1rem;
		}
		p.modelName{
			float: left;
			font-size: 1.25rem;
			line-height: 27px;
		}
		p.modelBtn{
			float: right;
			font-size: 1rem;
			color: #6EAADE;
			padding: 0.1rem 0.4rem;
			border: 1px solid #6EAADE;
			-webkit-border-radius: 5px;
			-moz-border-radius: 5px;
			border-radius: 5px;
		}
		div.carRow{
			background-color: #fff;
			padding: 0.6rem 0.8rem 0.6rem 1rem;
			border-bottom: 1px solid #D9D9E2;
		}
		p.rowL{
			float: left;
			font-size: 1rem;
		}
		p.rowR{
			float: right;
			font-size: 1rem;
		}
		span.arrowL{
			margin-right: 1rem;
		}
		span.mark{
			color: #FF6138;
		}
		div.itemTip{
			font-size: 0.9rem;
			color: #FF6138;
			text-align: right;
			padding: 0.1rem 0.8rem 0.8rem 1rem;
		}
		div.nextBtn{
			width: 90%;
			margin: 2rem auto 0;
			background-color: #FF6138;
			color: #fff;
			text-align: center;
			font-size: 1.1rem;
			line-height: 2.6rem;
			-webkit-border-radius: 6px;
			-moz-border-radius: 6px;
			border-radius: 6px;
		}
		.noWord{
			color: #C2C2C6!important;
		}

		.dialog{
		   position: fixed;
		   width: 100%;
		   height: 100%; 
		   background-color: rgba(0,0,0,0.4);
		   top:0;
		   bottom: 0;
		   z-index:100;
		}
		.dialog>div{ 
		   position: relative;
		   margin: 100px 10px 0;
		   background-color: #fff; 
		   height: auto;
		   overflow: auto;
		   -webkit-border-radius: 5px;
		   -moz-border-radius: 5px;
		   border-radius: 5px;
		}
		canvas#closeBtn{
			position: absolute;
			top: 0.6rem;
			right: 0.6rem;
		}
		div.dialogTitle{
			border-bottom: 1px solid #ff6138;
		}
		div.dialogTitle h3{
			font-size: 0.9rem;
			text-align: center;
			line-height: 2.2rem;
			font-weight: normal;
		}
		p.textItem{
			width: 90%;
			margin: 0 auto;
			padding: 2rem 0;
		}
		p.textItem input{
			width: 100%;
			border: 1px solid #D9D9E2;
			font-size: 0.9rem;
			padding: 0.6rem 0;
			text-align: center;
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;
		}
		p.dialogBtn{
			width: 90%;
			margin: 0 auto 0.6rem;
			-webkit-border-radius: 6px;
			-moz-border-radius: 6px;
			border-radius: 6px;
			color: #fff;
			background-color: #FF6138;
			text-align: center;
			font-size: 1rem;
			line-height: 2.4rem;
		}


		article.two{
			border-top: 1px solid #D9D9E2;
			background-color: #fff;
		}
		div.theStyleRow{
			position: relative;
			border-bottom: 1px solid #D9D9E2;
			line-height: 2.6rem;
			padding: 0rem 1rem;
		}
		div.theStyleRow p{
			color: #595c5c;
			font-size: 1rem;
		}
		div.theStyleRow img{
			position: absolute;
			top: 0.8rem;
			right: 1.2rem;
			width: 1.2rem;
		}
		.btn-primary{
			background-color: #ff6138!important;
			border: 1px solid #ff6138!important;
		}
	</style>
</head>
<body>
	<section>
		<div class="selectModel clearfix">
			<p class="modelName"></p>
			<p class="modelBtn">重选车系></p>
		</div>
		<div class="carRow selectStyle clearfix">
			<p class="styleLeft rowL">车型<span class="mark">*</span></p>
			<p class="styleRight rowR"><span class="styleName arrowL noWord">未填写</span><span class="grayArrow"></span></p>
		</div>
		<div class="carRow carCourse clearfix">
			<p class="carCourseL rowL">车辆总里程<span class="mark">*</span></p>
			<p class="carCourseR rowR"><span class="carCourseD arrowL noWord">未填写</span><span class="grayArrow carCourseArrow" style="display:none;"></span></p>
		</div>
		<div class="carRow bayCarDate clearfix">
			<p class="bayCarDateL rowL">购车日期<span class="mark">*</span></p>
			<p class="bayCarDateR rowR"><span class="bayCarDateD arrowL noWord">未填写</span><span class="grayArrow"></span></p>
		</div>
		<div class="itemTip">正确填写保养记录，保养检测更准确</div>
		<div class="carRow prevCourse clearfix">
			<p class="prevCourseL rowL">上次保养里程</p>
			<p class="prevCourseR rowR"><span class="prevCourseD arrowL noWord">未填写</span><span class="grayArrow"></span></p>
		</div>
		<div class="carRow prevTime clearfix">
			<p class="prevTimeL rowL">上次保养时间</p>
			<p class="prevTimeR rowR"><span class="prevTimeD arrowL noWord">未填写</span><span class="grayArrow"></span></p>
		</div>
		<div class="nextBtn">下一步</div>
	</section>
	<article class="two" style="display:none;">
	</article>
	<div class="dialog" style="display:none;">
		<div class="dialogWraper">
			<div class="dialogTitle">
				<h3></h3>
				<canvas id="closeBtn" width='15' height="15"></canvas>
				<script type="text/javascript">
					var canvas=document.getElementById('closeBtn');
					var cxt=canvas.getContext('2d');
					cxt.beginPath();
					cxt.lineWidth=1.5;
					cxt.strokeStyle="#ff6138";
					cxt.moveTo(0,0);
					cxt.lineTo(15,15);
					cxt.stroke();
					cxt.closePath();
					cxt.beginPath();
					cxt.lineWidth=1.5;
					cxt.strokeStyle="#ff6138";
					cxt.moveTo(15,0);
					cxt.lineTo(0,15);
					cxt.stroke();
					cxt.closePath();
				</script>
			</div>
			<div class="dialogCon">
				<p class="textItem"><input type="text" placeholder=""></p>
				<p class="dialogBtn">确定</p>
			</div>
		</div>
	</div>
</body>
<script type="text/javascript">
	$(function(){
		// 获取参数
		var url = window.location.search; 
	    var paramJson = {};
	    if(url!=''){
	    	var paramsArr = (url.split("?")[1]).split("&");
		    $.each(paramsArr,function(i){
		        var item = paramsArr[i].split("=");
		        paramJson[item[0]] = item[1]
		    });
	    }
	    var readStatus;
	    var postdata={};
	    postdata.userInfoId=paramJson.userId;
	    if(paramJson.customerId=='null' || paramJson.customerId==null || paramJson.customerId=='' || paramJson.customerId==undefined){
	    	if(getCustomerId(paramJson.userId)==-1){
	    		window.location.href="http://w2l/?presentType=2&androidName=8&iosName=LoginViewController&needLogin=1"
	    	}else{
	    		postdata.customerId=getCustomerId(paramJson.userId)
	    	}
	    }else{
	    	postdata.customerId=paramJson.customerId
	    }
	    
	    // 获取车辆信息
	    $.ajax({
	    	url:'/yangchebao-app-ws/ws/0.1/maintenance/initMaintainInfo/v2?userInfoId='+paramJson.userId+'&osInfo=7',
	    	type:'get',
	    	dataType:'json',
	    	contentType:'application/json;charset=utf-8',
	    	success:function(data){
	    		readStatus=data.readStatus;
	    		postdata.carInfoId=data.carInfoId;
	    		if(paramJson.brandId){
	    			$('p.modelName').html(decodeURI(decodeURI(decodeURI(paramJson.theModelName)))).attr({'data-id':paramJson.theModelId,'data-brandId':paramJson.brandId});
	    			// $('span.styleName').removeClass('noWord')
	    		}else{
	    			if(data.modelId){
		    			$('p.modelName').html(data.modelName).attr({'data-id':data.modelId,'data-brandId':data.brandId})
		    		}
		    		if(data.styleId>-1){
		    			$('span.styleName').html(data.styleName).attr({'data-id':data.styleId,'data-carId':data.carInfoId}).removeClass('noWord')
		    		}
	    		}
	    		if(data.totalMileage){
	    			$('span.carCourseD').html(parseInt(data.totalMileage)+'公里').removeClass('noWord')
	    		}
	    		if(data.buyDate){
	    			$('span.bayCarDateD').html(data.buyDate).removeClass('noWord')
	    		}
	    		if(data.lastMaintainMileage){
	    			$('span.prevCourseD').html(parseInt(data.lastMaintainMileage)+'公里').removeClass('noWord')
	    		}
	    		if(data.lastMaintainDate){
	    			$('span.prevTimeD').html(data.lastMaintainDate).removeClass('noWord')
	    		}
	    		
	    		if(readStatus=="Y"){
					$('span.carCourseArrow').show();
					$('div.carCourse').unbind('click').bind('click',function(){
						var prevCourseDL=$('span.prevCourseD').html().length;
						var carCourseD=$('span.carCourseD').html();
						var carCourseDL=$('span.carCourseD').html().length;
						$('div.dialog').show();
						$('div.dialog h3').html('车辆总里程');
						$('p.textItem').html('<input type="number" placeholder="">');
						$('div.dialogCon input').attr('placeholder','请输入里程数');
						if(carCourseD!='未填写'){
							carCourseD=parseFloat(carCourseD.substring(0,carCourseDL-2));
							$('div.dialogCon input').val(carCourseD)
						}
						$('p.dialogBtn').unbind('click').bind('click',function(){
							var diaVal=$.trim($('div.dialogCon input').val());
							var prevCourseD=$('span.prevCourseD').html();
							if((/^\d{1,6}$/.test(diaVal)) && diaVal!=0){
								if(prevCourseD!='未填写'){
									prevCourseD=parseFloat(prevCourseD.substring(0,prevCourseDL-2));
									if(prevCourseD>diaVal){
										errorLog('总里程不能小于上次保养里程');
										return false
									}
								}
								$('span.carCourseD').html(diaVal+'公里').removeClass('noWord');
								$('div.dialog').hide();
							}else{
								errorLog('请输入不为0且最长为6位的数字')
							}
						});
						$('#closeBtn').unbind('click').bind('click',function(){
							$('div.dialog').hide()
						})
					});
				}
	    	}
	    });
		// 重选车系
		$('p.modelBtn').unbind('click').bind('click',function(){
			window.location.href="brand.html?userId="+paramJson.userId+'&customerId='+paramJson.customerId
		});
		// 选择车型
		$('div.selectStyle').unbind('click').bind('click',function(){
			var modelRowId=$('p.modelName').attr('data-id');
			var styleRowId=$('span.styleName').attr('data-id');
			$('section').hide();
			$('article.two').show();
			if(modelRowId){
				$.ajax({
					url:'/yangchebao-app-ws/ws/0.1/support/style/list?modelId='+modelRowId,
					type:'get',
					dataType:'json',
					contentType:'application/json;charset=utf-8',
					async:false,
					success:function(data){
						var styleStr='';
						data.forEach(function(key,i){
							styleStr+='<div id="'+key.id+'" class="theStyleRow">'
									 +'<p>'+key.name+'</p>'
									 +'</div>'
						});
						$('article.two').html(styleStr);
						if(styleRowId){
							$('article.two div.theStyleRow[id="'+styleRowId+'"]').append('<img src="http://app.yangchebao.com.cn/group1/M00/02/99/ChoCK1Zqn4yAcyAXAAAEo4ujsAM796.png">')
						}
						$('div.theStyleRow').unbind('click').bind('click',function(){
							var theStyleRowId=$(this).attr('id');
							var theStyleRowName=$(this).find('p').html();
							$(this).append('<img src="http://app.yangchebao.com.cn/group1/M00/02/99/ChoCK1Zqn4yAcyAXAAAEo4ujsAM796.png">');
							$(this).siblings().find('img').remove();
							$('span.styleName').html(theStyleRowName).attr('data-id',theStyleRowId).removeClass('noWord');
							$('section').show();
							$('article.two').hide();
						})
					}
				})
			}
		});
		// 填写信息
		$('div.bayCarDate').unbind('click').bind('click',function(){
			var prevTimeD=$('span.prevTimeD').html();
			var bayCarDateD=$('span.bayCarDateD').html();
			$('div.dialog').show();
			$('div.dialog h3').html('购车日期');
			$('p.textItem').html('<input type="text" placeholder="">');
			$('div.dialogCon input').attr('placeholder','请选择购车日期');
			if(bayCarDateD!='未填写'){
				$('div.dialogCon input').val(bayCarDateD)
			}
			// 时间控件
			var date = new Date();
			var nowYear=date.getFullYear();
			$("div.dialogCon input").mobiscroll().date({
		        theme: "bootstrap", 
		        mode: "clickpick",   
		        display: "modal", 
		        lang: "zh",       
		        maxDate:date, 
		        dateFormat: 'yy-mm', 
		        onBeforeShow: function (inst) { inst.settings.wheels[0].length>2?inst.settings.wheels[0].pop():null; },//弹掉“日”滚轮
		        startYear:1996,
		        endYear:nowYear 
		    });
		    $("div.dialogCon input").bind('click',function(){
				var dwHeight=$('div.dw').outerHeight();
				$('div.dw').css({'top':'50%','margin-top':'-'+(dwHeight/2)+'px'});
				 $(window).off("scroll")
		    });
			$('p.dialogBtn').unbind('click').bind('click',function(){
				var diaVal=$.trim($('div.dialogCon input').val());
				if(diaVal){
					if(prevTimeD!='未填写'){
						var prevTimeDArr=prevTimeD.split('-');
						prevTimeD=prevTimeDArr.join('')+'00';
						var diaValArr=diaVal.split('-');
						var _diaVal=diaValArr.join('');
						if(prevTimeD<_diaVal){
							errorLog('购车日期不能大于上次保养时间');
							return false
						}
					}
					$('span.bayCarDateD').html(diaVal).removeClass('noWord');
					$('div.dialog').hide();
				}
			});
			$('#closeBtn').unbind('click').bind('click',function(){
				$('div.dialog').hide()
			})
		});

		$('div.prevCourse').unbind('click').bind('click',function(){
			var carCourseDL=$('span.carCourseD').html().length;
			var prevCourseD=$('span.prevCourseD').html();
			var prevCourseDL=$('span.prevCourseD').html().length;
			$('div.dialog').show();
			$('div.dialog h3').html('上次保养里程');
			$('p.textItem').html('<input type="number" placeholder="">');
			$('div.dialogCon input').attr('placeholder','请输入里程数');
			if(prevCourseD!='未填写'){
				prevCourseD=parseFloat(prevCourseD.substring(0,carCourseDL-2));
				$('div.dialogCon input').val(prevCourseD)
			}
			$('p.dialogBtn').unbind('click').bind('click',function(){
				var diaVal=$.trim($('div.dialogCon input').val());
				var carCourseD=$('span.carCourseD').html();
				if((/^\d{1,6}$/.test(diaVal)) && diaVal!=0){
					if(carCourseD!='未填写'){
						carCourseD=parseFloat(carCourseD.substring(0,carCourseDL-2));
						if(carCourseD<diaVal){
							errorLog('上次保养里程不能大于总里程');
							return false
						}
					}
					$('span.prevCourseD').html(diaVal+'公里').removeClass('noWord');
					$('div.dialog').hide();
				}else{
					errorLog('请输入不为0且最长为6位的数字')
				}

			});
			$('#closeBtn').unbind('click').bind('click',function(){
				$('div.dialog').hide()
			})
		});

		$('div.prevTime').unbind('click').bind('click',function(){
			var bayCarDate=$('span.bayCarDateD').html();
			var prevTimeD=$('span.prevTimeD').html();
			$('div.dialog').show();
			$('div.dialog h3').html('上次保养时间');
			$('p.textItem').html('<input type="text" placeholder="">');
			$('div.dialogCon input').attr('placeholder','请选择日期');
			if(prevTimeD!='未填写'){
				$('div.dialogCon input').val(prevTimeD)
			}
			// 时间控件
			var date = new Date();
			var nowYear=date.getFullYear();
			$("div.dialogCon input").mobiscroll().date({
		        theme: "bootstrap", 
		        mode: "clickpick",   
		        display: "modal", 
		        lang: "zh",       
		        maxDate:date, 
		        dateFormat: 'yy-mm-dd',
		        startYear:1996, 
		        endYear:nowYear 
		    });
		    $("div.dialogCon input").bind('click',function(){
				var dwHeight=$('div.dw').outerHeight();
				$('div.dw').css({'top':'50%','margin-top':'-'+(dwHeight/2)+'px'});
				$(window).off("scroll")
		    });
			$('p.dialogBtn').unbind('click').bind('click',function(){
				var diaVal=$.trim($('div.dialogCon input').val());
				if(diaVal){
					if(bayCarDate!='未填写'){
						var bayCarDateArr=bayCarDate.split('-');
						bayCarDate=bayCarDateArr.join('')+'00';
						var diaValArr=diaVal.split('-');
						var _diaVal=diaValArr.join('');
						if(bayCarDate>_diaVal){
							errorLog('上次保养时间不能小于购车日期');
							return false
						}
					}
					$('span.prevTimeD').html(diaVal).removeClass('noWord');
					$('div.dialog').hide();
				}
			});
			$('#closeBtn').unbind('click').bind('click',function(){
				$('div.dialog').hide()
			})
		});

		$('div.nextBtn').unbind('click').bind('click',function(){
			postdata.brandId=$('p.modelName').attr('data-brandId');
			postdata.modelId=$('p.modelName').attr('data-id');
			if(!($('span.styleName').attr('data-id'))){
				errorLog('请选择车型');
				return false
			}else{
				postdata.styleId=$('span.styleName').attr('data-id')
			}
			
			if(!(parseInt($('span.carCourseD').html()))){
				errorLog('请填写车辆总里程');
				return false
			}else{
				postdata.totalMileage=parseInt($('span.carCourseD').html())
			}

			if($('span.bayCarDateD').html()=='未填写'){
				errorLog('请选择购车日期');
				return false
			}else{
				postdata.buyDate=$('span.bayCarDateD').html()
			}

			if(parseInt($('span.prevCourseD').html())){
				postdata.lastMaintainMileage=parseInt($('span.prevCourseD').html())
			}
			
			if($('span.prevTimeD').html()!="未填写"){
				postdata.lastMaintainDate=$('span.prevTimeD').html()
			}

			$.ajax({
				url:'/yangchebao-app-ws/ws/0.1/maintenance/editCarInfo',
				type:'post',
				async:false,
				data:$.toJSON(postdata),
				contentType:'application/json;charset=utf-8',
				success:function(data){
					var postdata2={};
					postdata2.carInfoId=postdata.carInfoId;
					postdata2.styleId=postdata.styleId;
					postdata2.buyDate=postdata.buyDate;
					postdata2.totalMileage=postdata.totalMileage;
					postdata2.cityName=decodeURI(decodeURI(paramJson.cityName));
					$.ajax({
						url:'/yangchebao-app-ws/ws/0.1/maintenance/addMaintenanceAdvice',
						type:'post',
						async:false,
						data:$.toJSON(postdata2),
						contentType:'application/json;charset=utf-8',
						success:function(data2){
							window.location.href="http://w2nw?http://"+urlIp()+"/yangchebao-pubweb/keepupRemind/keepUpTest.html"
						},
						error:function(xhr){
							var error=eval('('+xhr.responseText+')');
							errorLog(error[0].message)
						}
					})
				},
				error:function(xhr){
					var error=eval('('+xhr.responseText+')');
					errorLog(error[0].message)
				}
			})
		})
	})
</script>
</html>