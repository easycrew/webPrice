<!DOCTYPE html>
<html>
<head> 
<meta charset="utf-8" />
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" name="viewport" />
<meta content="yes" name="apple-mobile-web-app-capable" />
<meta content="black" name="apple-mobile-web-app-status-bar-style" />
<script type="text/javascript" src="./js/jquery-1.9.1.min.js"></script>  
<script type="text/javascript" src="./js/jquery.json-2.2.js"></script> 
<script type="text/javascript" src="./js/index.js"></script> 
<link rel="stylesheet" href="css/index.css">
<title>违章查询</title>
</head> 
<style type="text/css">  
.trafficCar-wrap{
  padding: 0 1em;
}
.trafficCar-wrap h1{
  height: 52px;
  line-height: 52px;
  font-size: 1.3em;
  font-weight: normal;
}
.number-first{
  height: 40px;
  line-height: 40px;
  display: inline-block;
  width: 72px;
  color: #979797;
  font-size: 1.5em;
  text-align: center;
  border: 1px solid #d9d9e2;
  border-radius: 3px;
  position: absolute;
  top: 0;
  left: 0;
  background-color: #fff;
} 
.input-wrap{ 
    background-color: #fff; 
    border: none; 
    display: block;
    font-size: 1.5em;
    height: 40px;
    line-height: 40px; 
    border: 1px solid #d9d9e2;
    border-radius: 3px;
    padding-left: 10px;
}
.input-wrap input{  
    border: none; 
    width: 100%;
    background-color: #fff;
    font-size: 1em;
}
.trafficCar-wrap .button{
  margin: 28px 80px 0;
  width: auto;
}  
.province-wrap{
  background-color:rgba(0,0,0,0.6);
  padding-top: 50px;
  position: absolute;
  top: 0;  
  width: 100%;
  min-height: 100%;
} 
.province-wrap span{
  width: 50px;
  height: 50px;
  text-align: center;
  line-height: 50px;
  display: inline-block;
  font-size: 1.8em;
  border: 1px solid #fff;
  margin: 0 0 15px 15px;
  color: #fff;
  border-radius: 5px; 
  cursor: pointer;
} 
.down-arrow {
    border-bottom: 1px solid #ccc;
    border-right: 1px solid #ccc;
    display: inline-block;
    height: 8px;
    margin:-2px 0 0 5px;
    transform: rotate(45deg) ;
    -ms-transform: rotate(45deg);
    -moz-transform: rotate(45deg) ;
    -webkit-transform: rotate(45deg) ;
    -o-transform: rotate(45deg);
    width: 8px;
}
.number-first strong{
	font-weight:normal;
}
</style>
<body style="background-color:#f4f7f8;">  
  <section class="trafficCar-wrap" style="display:none;">
    <article class="first-wrap">
    <h1>请填写并确认你的车牌号码</h1>
    <ul>
    <li style="position:relative;padding-left: 86px;">
     <span class="number-first"><strong>京</strong><label class="down-arrow"></label></span>
     <div class="input-wrap"><input type="text" placeholder="填入车牌号" id="plateNumber"></div>
    </li> 
    </ul> 
    <div id="submit" class="button bg-org">确认</div>
    </article>    
    <article class="second-wrap" style="display:none;">
    <h1>还需要填写以下信息</h1>
    <ul>
    <li style="display:none; padding: 0;" class="machineNumber-li"><div class="input-wrap"><input type="text" id="machineNumber" placeholder="请输入发动机号"></div>
    </li> 
    <li style="display:none; padding: 0;" class="vinNumber-li"><div class="input-wrap"><input type="text" id="vinNumber" placeholder="请输入车架号"></div>
    </li>
    </ul>  
    <div id="next" class="button bg-org">确认</div>
    </article> 
  </section>
  <section class="province-wrap" style="display:none;"> 
    <div class="close"><label></label></div>
    <span>京</span><span>沪</span><span>粤</span><span>苏</span><span>浙</span><span>鲁</span>
    <span>晋</span><span>冀</span><span>豫</span><span>川</span><span>渝</span><span>辽</span>
    <span>吉</span><span>黑</span><span>皖</span><span>鄂</span><span>湘</span><span>赣</span>
    <span>闽</span><span>陕</span><span>甘</span><span>宁</span><span>蒙</span><span>津</span>
    <span>贵</span><span>云</span><span>桂</span><span>琼</span><span>青</span><span>新</span>
    <span>藏</span>
  </section>  
<script type="text/javascript">
   $(document).ready(function(){
      var url =window.location.search;    
      var paramJson = {};  
      if(url!=undefined&&url!=""){
        var paramsArr = (url.split("?")[1]).split("&"); 
        $.each(paramsArr,function(i){
         var item = paramsArr[i].split("=");
         paramJson[item[0]] = item[1];
        });    
      }
      $("#submit").click(function(){
        var plateNumber = $.trim($("#plateNumber").val());
        if(plateNumber==""){
          alertTasat("请输入车牌号");
          return;
        } 
        var reg = /^[A-Z0-9]{6,7}$/; 
        if(!reg.test(plateNumber)){
          alertTasat("请输入正确的车牌号");
          return;
        }
        plateNumber = $(".number-first strong").html()+plateNumber; 
        getTrafficInfo(plateNumber);
      }); 
      $("#plateNumber").keyup(function(){
        $(this).val($(this).val().toUpperCase());
      }); 
      $("#machineNumber").keyup(function(){
        $(this).val($(this).val().toUpperCase());
      });
       $("#vinNumber").keyup(function(){
        $(this).val($(this).val().toUpperCase());
      });
      $("#next").click(function(){
           if($(".machineNumber-li").css('display')!="none"){
              var machineNumber = $.trim($("#machineNumber").val());
              if(machineNumber==""){
                alertTasat("请输入发动机号");
                return;
              }
               var mreg = /^[A-Z0-9]{1,15}$/; 
              if(!mreg.test(machineNumber)){
                alertTasat("请输入正确的发动机号");
                return;
              }   
           }
          if($(".vinNumber-li").css('display')!="none"){
              var vinNumber = $.trim($("#vinNumber").val());
              if(vinNumber==""){
                alertTasat("请输入车架号");
                return;
              } 
              var vreg = /^[A-Z0-9]{17}$/; 
              if(!vreg.test(vinNumber)){
                alertTasat("请输入正确的车架号");
                return;
              }    
           } 
          editPlateInfo();
      });  
      $(".close").click(function(){
          $(".province-wrap").fadeOut();
      });       
      $(".number-first").click(function(){
          $(".province-wrap").fadeIn();
      });  
      $(".province-wrap span").click(function(){
          $(".province-wrap").fadeOut();
          $(".number-first strong").html($(this).html());
      }); 
      if(paramJson.openid!=undefined&&paramJson.openid!=""){ 
        getTrafficMsg(); 
      }else{ 
        getOpenId(); 
      }
      function getOpenId(){  
          $.ajax({
              url: '/yangchebao-weixin-ws/ws/0.1/common/getWxUserBaseInfo?code='+paramJson.code,
              type: 'get', 
              dataType: 'json',
              success: function(data) {    
                paramJson.openid = data.openid; 
                getTrafficMsg();
              },error:function(xhr){  
              aler("error"); 
              }
          });  
      }    
      function getTrafficMsg(){    
          $.ajax({
              url: '/yangchebao-weixin-ws/ws/0.1/traffic/getTrafficMsg?openid='+paramJson.openid+'&pagesize=1&pageindex=0',
              type: 'get', 
              dataType: 'json',
              success: function(data) {  
                 if(data.isBound=="yes"){  
                   if(data.isHavePlate=="yes"&&data.trafficMsg!=undefined&&paramJson.type==undefined){
                    window.location.href = "trafficList.html?openid="+paramJson.openid;
                   }else{
                    $(".trafficCar-wrap").show();
                    paramJson.userId = data.userInfoId;
                    var carNumber = data.carNumber||""; 
                    if(carNumber!=""){
                      var reg=/[\u4E00-\u9FA5]/g; 
                      $(".number-first strong").html(carNumber.match(reg)[0]);
                      carNumber = carNumber.replace(reg,'');   
                    } 
                    $("#plateNumber").val(carNumber);
                    $("#machineNumber").val(data.machineNumber?data.machineNumber:"");
                    $("#vinNumber").val(data.vinNumber?data.vinNumber:"");
                   }
                 }else{
                    window.location.href = "traffic-regist.html?openid="+paramJson.openid;
                 } 
              },error:function(xhr){  
                 var mes = eval('('+xhr.responseText+')');   
              }
          });  
      }  
      function getTrafficInfo(plateNumber){  
          $.ajax({
              url: '/yangchebao-weixin-ws/ws/0.1/traffic/getTrafficInfoByCarNumber?plateNumber='+plateNumber,
              type: 'get', 
              dataType: 'json',
              success: function(data) {   
                 $(".first-wrap").hide();
                 $(".second-wrap").show();
                 if(data.engine=="1"){  //engine  int 1需要发动机号 0 不需要
                    $(".machineNumber-li").show();
                 }
                 if(data.frame=="1"){  //frame  int 1 需要车架号 0 不需要
                    $(".vinNumber-li").show();
                 }
              },error:function(xhr){
                var mes = eval('('+xhr.responseText+')'); 
                 alertTasat(mes[0].message);
              }
          });  
      }  
      function editPlateInfo(){ 
          var plateNumber = $(".number-first strong").html()+$("#plateNumber").val();
          var vinNumber = $("#vinNumber").val();
          var machineNumber = $("#machineNumber").val();
          var postData = {};      
          postData.userId = paramJson.userId;
          postData.plateNumber  =plateNumber  ;
          postData.vinNumber =vinNumber ;
          postData.machineNumber=machineNumber;
           $.ajax({
                url: '/yangchebao-weixin-ws/ws/0.1/traffic/editPlateInfo',
                type: 'post',
                async: false,
                data:$.toJSON(postData),
                dataType: 'json',
                contentType:'application/json;charset=utf-8',
                success:function(data){ 
                    window.location.href = "trafficList.html?openid="+paramJson.openid;
                },error:function(xhr){ 
                    var mes = eval('('+xhr.responseText+')'); 
                    alertTasat(mes[0].message);
                } 
            }); 
      } 
   });
</script>  
</body>
</html>