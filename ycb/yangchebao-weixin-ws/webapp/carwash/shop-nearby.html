<!DOCTYPE html>
<html>
<head> 
<meta charset="utf-8" />
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" name="viewport" />
<meta content="yes" name="apple-mobile-web-app-capable" />
<meta content="black" name="apple-mobile-web-app-status-bar-style" />
<meta name="format-detection" content="telephone=no" />
<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script> 
<link rel="stylesheet" href="css/index.css">
<title>附近商家</title>
</head> 
<body style="background-color:#f4f7f8;">   
<section id="shopNearby" style="display:none;">
  <h1 class="ui-tit" style="margin:10px 0;" id="toOrderList">
      用户<span id="mobile">13678901123</span>
      <span class="more">我的订单(<span id="orderCount">0</span>)<label class="arrow"></label></span>
  </h1>
  <h1 class="tit-link">最近的洗车店<span class="more" id="toShopList">更多<label class="arrow"></label></span></h1>
    <ul class="list-module-pic">  
    </ul>
    <article class="two-ads">
     <div class="left">
       <img src="css/images/carcash.png">
       <p>新用户下载养车宝领取免费洗车！<br/><span>[新用户]</span></p>
     </div>
     <div class="middle">or</div>
     <div class="right">
       <img src="css/images/carcash2.png">
       <p>老用户周周领红包每月最高80元！<br/><span>[老用户]</span></p>
     </div> 
    </article>
    <div class="btn-wrap"><a href="javascript:void(0);" class="button" id="download">下载养车宝手机客户端</a></div>
</section> 
 <div class="dialog" style="display:none;">
      <div>
        <h1>提示</h1>
        <p>请在公共号信息设置中打开"提供定位信息"。</p>
        <div class="btn-wrap">
            <div class="dialog-btn">关闭</div>
        </div>
      </div>
</div> 
<script type="text/javascript">
     function  is_weixin(){
        var ua = navigator.userAgent.toLowerCase();
        if(ua.match(/MicroMessenger/i)=="micromessenger") {
            $('#download').attr('path','http://a.app.qq.com/o/simple.jsp?pkgname=com.carsmart.emaintain');
        }else{
            var sUserAgent = navigator.userAgent.toLowerCase(); 
            var bIsIpad = sUserAgent.match(/ipad/i) == "ipad";
            var bIsIphone = sUserAgent.match(/iphone/i) == "iphone";
            var bIsIphoneOs = sUserAgent.match(/iphone os/i) == "iphone os";
            var bIsAndroid = sUserAgent.match(/android/i) == "android"; 
            if(bIsIpad || bIsIphone || bIsIphoneOs){
                $('#download').attr('path','https://itunes.apple.com/us/app/yang-che-bao/id736543893');
            }else{   
                $('#download').attr('path','http://yangchebao.com.cn/website-ws/ws/0.1/app/download');
            }
        } 
    } 
    function getOpenId(){   
		  $.ajax({
              url: '/yangchebao-weixin-ws/ws/0.1/carwash/getWxOpenid?code='+paramJson.code,
              type: 'get', 
              dataType: 'json',
              success: function(data) {   
                paramJson.openid = data.msg;
                getShopList();
              },error:function(xhr){  
              }
          });  
      }    
     function getShopList(){  
          $.ajax({
              url: '/yangchebao-weixin-ws/ws/0.1/carwash/getShopList?openid='+paramJson.openid+'&pagesize=1&pageindex=0',
              type: 'get', 
              dataType: 'json',
              success: function(data) {    
                 if(data.isBound=="yes"){ 
                   if(data.isLocation=="ok"){
        		    $("#shopNearby").show();
                    paramJson.customerId = data.customerId;
                    $("#mobile").html(data.mobile);
                    $("#orderCount").html(data.orderCount); 
                     var item = data.shopList.items[0];
                     var _li = '<li style="margin-top:0;" shopid="'+item.id+'"> '
                        +'<div class="clearfix">'
                        +'<div class="pic"><img src="'+item.logo+'"/></div>'
                        +'<div>'
                        +'<h3><span class="tit">'+item.name+'</span><span class="distanceLabel">'+item.distance+'</span></h3> '
                        +'<p class="info">'+item.address+'</p> '
                        +'<p class="notice">关注：'+item.attentionNumber+'<span class="price">￥'+item.totalPrivilegePrice+'</span></p> '
                        +'</div>'
                        +'</div>'
                        +'</li>';
                        $(".list-module-pic").append(_li);
                   }else{ 
				       $(".dialog").show();
				   }
                 }else{
                    window.location.href = "regist.html?openid="+paramJson.openid;
                 } 
              },error:function(xhr){  
              }
          });  
   } 
   var paramJson = {};
   $(document).ready(function(){
      var url =window.location.search;  
      if(url!=undefined&&url!=""){
        var paramsArr = (url.split("?")[1]).split("&"); 
        $.each(paramsArr,function(i){
         var item = paramsArr[i].split("=");
         paramJson[item[0]] = item[1];
        });    
      }  
	  is_weixin();    
      $("#download").click(function(){ 
            window.location.href = $(this).attr("path");
     });
      $("#toShopList").click(function(){ 
          window.location.href = "shopList.html?openid="+paramJson.openid+"&customerId="+paramJson.customerId;
      });   
      $("#toOrderList").click(function(){
          window.location.href = "order.html?customerId="+paramJson.customerId;
      }); 
      $(".list-module-pic").on('click','li',function(){
          var id = $(this).attr("shopid"); 
          window.location.href = "shop-detail.html?businessInfoId="+id+"&customerId="+paramJson.customerId+"&openid="+paramJson.openid; 
      });
	  $(".dialog-btn").click(function(){
          $(".dialog").hide();
      });  
   });
   window.onload = function(){ 
	  if(paramJson.openid!=undefined&&paramJson.openid!=""){
        getShopList(); 
      }else{
        getOpenId(); 
      }
	}
</script>  
</body>
</html>