<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black" name="apple-mobile-web-app-status-bar-style"/>  
<title>银行卡账户</title>
<script language="javascript" src="./js/jquery-1.10.1.min.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script> 
<script language="javascript" src="./js/jquery.json-2.2.js"></script>
<script language="javascript" src="./js/share.js"></script> 
<link rel="stylesheet" href="./css/index.css">
</head> 
<body> 
	<section style="" class="bank-wrap">
        <!-- <p class="error uError">&nbsp;</p> -->
        <p class="error pError">&nbsp;</p>
        <p class="error bError">&nbsp;</p>
        <p class="error cError">&nbsp;</p>
        <ul>
            <li class="info">
                <label>账户姓名</label>
                <span id="realName"></span>
            </li>
            <li class="model-wrap">
                <div class="select"><p id="provinceName">请选择省</p></div>
                <div class="model-list" id="provinceList"> 
                </div> 
            </li>
            <li class="model-wrap"> 
                <div class="select"><p id="cityName">请选择市</p></div>
                <div class="model-list" id="cityList">
                    <p>请选择市</p> 
                </div>  
            </li>
            <li><input type="text" id="bankName" placeholder="输入银行，例如：中国农业银行"/></li>
            <li><input type="text" id="branch" placeholder="开户分行"/></li>
            <li><input type="text" id="bankNumber" placeholder="卡号"/></li>
            <li><input type="text" id="bankNumberRe"placeholder="再次输入卡号"/></li>
             
        </ul>
        <p class="tips">修改账户姓名请拨打电话01058377979</p>
        <div class="btn-wrap"><a id="submit" class="btn" href="javascript:void(0)">确定</a></div>
    </section>
    <div class="overlay-wrap"></div>
	<script type="text/javascript">
    $(document).ready(function(){ 
        var postData = {};  
        var url = window.location.search; 
        var paramsArr = (url.split("?")[1]).split("&");
        var paramJson = {};
        $.each(paramsArr,function(i){
            var item = paramsArr[i].split("=");
            paramJson[item[0]] = item[1];
        });  
        $("#realName").html(decodeURIComponent(paramJson.realName));
        getProvince();

        var _postData={};
        $.ajax({
            url:'/yangchebao-weixin-ws/ws/0.1/salesman/getSalaryList?openid='+paramJson.openid,
            type:'get',
            async:false,
            dataType:'json',
            success:function(data){
                _postData=data
            }
        });
        if(_postData.bankAcount!=undefined){
            $('#provinceName').html(_postData.bankAcount.province.provinceName).attr('provinceId',_postData.bankAcount.province.provinceId);
            $('#cityName').html(_postData.bankAcount.city.cityName).attr('cityId',_postData.bankAcount.city.cityId);
            $('#bankName').val(_postData.bankAcount.bankName);
            getCityList(_postData.bankAcount.province.provinceId);
            $('#branch').val(_postData.bankAcount.branch);
            $('#bankNumber').val(_postData.bankAcount.brankNumber);
            $('#bankNumberRe').val(_postData.bankAcount.brankNumber);
        }
        
        $("#submit").click(function(){
            $('.error').hide();
            var provinceName=$('#provinceName').html();
            if(provinceName=="请选择省"){
                $('.pError').html('请选择省').show();
                return;
            }
            var cityName=$('#cityName').html();
            if(cityName=="请选择市"){
                $('.pError').html('请选择市').show();
                return;
            }
            $('.pError').hide();
            var bankName=$.trim($('#bankName').val());
            if(bankName==""){
                $('.bError').html('请输入银行').show();
                return;
            }
            var branch=$.trim($('#branch').val());
            if(branch==""){
                $('.bError').html('请输入开户分行').show();
                return;
            }
            $('.bError').hide();
            var bankNumber=$.trim($('#bankNumber').val());
            if(bankNumber==""){
                $('.cError').html('请输入卡号').show();
                return;
            }
            var bankNumberRe=$.trim($('#bankNumberRe').val());
            if(bankNumberRe!=bankNumber){
                $('.cError').html('两次输入卡号不一致').show();
                return;
            }
            $('.cError').hide();
            editBank();
        }); 
        $('.model-wrap .select').on('click',function(){
            $('.overlay-wrap').toggle();
            $(this).next(".model-list").toggleClass('open');
        });
        $('#provinceList p').on('click',function(){
            $('.overlay-wrap').hide();
            $(this).parent(".model-list").removeClass('open'); 
            $("#provinceName").html($(this).html()).attr("provinceId",$(this).attr("pId"));
            $('#cityName').html('请选择市');
            getCityList($(this).attr("pId"));
        }); 
        $('#cityList').on('click','p',function(){
            $('.overlay-wrap').hide();
            $(this).parent(".model-list").removeClass('open'); 
            $("#cityName").html($(this).html()).attr("cityId",$(this).attr("cId"));
        });  
        function editBank(){ 
           var postData = {};
           postData.salesmanInfoId = paramJson.salesmanInfoId;
           if(paramJson.bankId!=undefined||paramJson.bankId!=""){
           postData.bankId = paramJson.bankId;
           } 
           postData.provinceId = $("#provinceName").attr("provinceId");
           postData.cityId = $("#cityName").attr("cityId");
           postData.bankName = $("#bankName").val();
           postData.branch = $("#branch").val();
           postData.bankNumber = $("#bankNumber").val();
           $.ajax({
                url: '/yangchebao-weixin-ws/ws/0.1/salesman/editBankMessage',
                type: 'post',
                async: false,
                data:$.toJSON(postData),
                dataType: 'text',
                contentType:'application/json;charset=utf-8',
                success:function(data){
                    window.location.href = "cash.html?openid="+paramJson.openid;
                },error:function(xhr){
                    var mes = eval('('+xhr.responseText+')'); 
                    alert("error");
                     
                } 
            }); 
        } 
    }); 
    function getProvince(){ 
            $.ajax({
                url: '/yangchebao-weixin-ws/ws/0.1/salesman/getProvinceMessage',
                type: 'get',
                async: false,
                dataType: 'json',
                success:function(data){ 
                    $.each(data,function(i){
                        var item = data[i];
                        var _p = '<p pId="'+item.provinceId+'">'+item.provinceName+'</p>';
                        $("#provinceList").append(_p);
                    });
                  
                },error:function(xhr){ 
                     var mes = eval('('+xhr.responseText+')'); 
                     alert(mes[0].message);  
                } 
            });   
        }  
        function getCityList(pId){ 
            $.ajax({
                url: '/yangchebao-weixin-ws/ws/0.1/salesman/getCityMessage?provinceId='+pId,
                type: 'get',
                async: false,
                dataType: 'json',
                success:function(data){ 
                    $("#cityList").html("");
                    $.each(data,function(i){
                        var item = data[i];
                        var _p = '<p cId="'+item.cityId+'">'+item.cityName+'</p>';
                        $("#cityList").append(_p);
                    });
                  
                },error:function(xhr){ 
                     var mes = eval('('+xhr.responseText+')'); 
                     alert(mes[0].message);  
                } 
            });   
        } 
    </script>
</body>

</html>

