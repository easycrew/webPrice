<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black" name="apple-mobile-web-app-status-bar-style"/>  
<title>推广养车宝</title>
<script language="javascript" src="./js/jquery-1.10.1.min.js"></script> 
<script language="javascript" src="./js/jquery.json-2.2.js"></script> 
<script language="javascript" src="./js/index.js"></script> 
<script language="javascript" src="http://app.yangchebao.com.cn/group1/M00/00/9F/md50000000000000000000000000000.js"></script>
<link rel="stylesheet" href="./css/index.css">
</head> 
<body> 
<!--活动页-->
<section class="activity-wrap" style="display:none;" id="activityPage">
        <figure>
            <div><img src="css/images/share_1.jpg" alt="申请推广养车宝"></div> 
        </figure> 
        <article class="content-wrap"> 
            <div class="tit-center" style="margin:1.5em 1.5em 2em;"><img src="css/images/share_2.jpg" alt="收入倍增不是梦" /></div> 
            <a class="btn" href="javascript:void(0);" id="toRegist" style="margin-bottom: 2.2em;background-color:#fcb507;">立即申请</a>
            <div class="procedure" style="border:1px solid #f6a305;">
                <div class="intro" style="padding:1.2em 1em 0;overflow:hidden;"><p class="one" style="color:red;float:left;width:25.8%;height:2.6em;">第1步：</p><p class="two">申请成为养车宝推广业务员；</p></div>
                <div class="intro" style="padding:1.2em 1em 0;overflow:hidden;"><p class="one" style="color:red;float:left;width:25.8%;height:2.6em;">第2步：</p><p class="two">推荐用户扫描“推广二维码”，下载养车宝；</p></div>
                <div class="intro" style="padding:1.2em 1em 1.2em;overflow:hidden;"><p class="one" style="color:red;float:left;width:25.8%;height:4.4em;">第3步：</p><p class="two">用户手机号注册后，即可获得2元工资；注册当天完成首个订单，再得8元工资！</p></div> 
                <p style="margin-bottom:-0.4em;"><img src="css/images/share_3.png"></p>
            </div> 
        </article>   
</section>
<!--注册业务员页-->
<section class="user-info" style="display:none;" id="registPage"> 
    <p class="error rError"></p> 
    <p class="error mError"></p> 
    <p class="error oError"></p> 
    <p class="error cError"></p> 
    <ul>
        <li><div><input type="text" id="realName" placeholder="姓名"/></div></li>
        <li><div><input type="text" id="mobile" placeholder="手机号码"/></div></li>
        <li><div><input type="text" id="ownedBusiness" placeholder="所属商家"/></div></li>
        <li class="captcha">
            <div><input type="text" id="code" placeholder="验证码"/></div>
            <div><a class="captcha-btn" href="javascript:void(0);">获取验证码</a></div>
        </li> 
    </ul>
    <p class="tips">请填写正确的基本信息,此信息将用于设置收款帐号</p>
    <a id="submit" class="btn" href="javascript:void(0)">立即申请</a>
</section>
<script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?a4342595b97ccda5e3c67b0975f2aea9";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();


    var postData = {};  
    var url = window.location.search; 
    var paramsArr = (url.split("?")[1]).split("&");
    var paramJson = {};
    $.each(paramsArr,function(i){
        var item = paramsArr[i].split("=");
        paramJson[item[0]] = item[1];
    });   
    var postData = {}; 
    var openid = ""; 
    var weixinInfo = {};
    //alert(paramJson.code);
    $(document).ready(function(){ 
        $("#toRegist").click(function(){ 
              // openid = data.openid;
              postData.openid = weixinInfo.openid;
              // $("#realName").val(weixinInfo.openid);
              postData.nickname = weixinInfo.nickname;
              postData.countryWeixin = weixinInfo.country;
              postData.sex = weixinInfo.sex;
              postData.provinceWeixin = weixinInfo.province;
              postData.cityWeixin = weixinInfo.city;
              postData.headimgurl = weixinInfo.headimgurl; 
              $("#activityPage").hide();
              $("#registPage").show()
        });  
        var wait = 60;
        $(".captcha-btn").click(function(){
            if($(this).hasClass("disabled")){
                return false;
            }
            $(".error").hide();
            var mobile = $.trim($("#mobile").val());
            if(mobile==""){
                $(".mError").html("请输入手机号码").show();
                return;
            }
            var phoneReg = /^((\+86)|(86)){0,}1\d{10}$/; 
            if(!phoneReg.test(mobile)){
              $(".mError").html("请输入正确的手机号码").show(); 
              return;
            }  
            $(".mError").hide(); 
             sendMsg(mobile); 
        }); 
        $("#submit").click(function(){
            $(".error").hide();
            var realName = $.trim($("#realName").val());
            if(realName==""){
                $(".rError").html("请输入姓名").show();
                return;
            }
            if(realName.length>20){
                $(".rError").html("姓名不能超过20个字").show();
                return false;
            }
            var zReg = /^[^*\/\\?]+$/;
            if(!zReg.test(realName)){
              $(".rError").html("输入的姓名含非法字符").show(); 
              return false;
            }  
            $(".rError").hide();
            var mobile = $.trim($("#mobile").val());
            if(mobile==""){
                $(".mError").html("请输入手机号码").show();
                return;
            }
            var phoneReg = /^((\+86)|(86)){0,}1\d{10}$/; 
            if(!phoneReg.test(mobile)){
              $(".mError").html("请输入正确的手机号码").show(); 
              return;
            }  
            $(".mError").hide(); 
            var ownedBusiness = $.trim($("#ownedBusiness").val());
            // if(ownedBusiness==""){
            //     $(".oError").html("请输入所属商家").show();
            //     return;
            // }  
            if(!zReg.test(ownedBusiness)&&ownedBusiness!=''){
              $(".oError").html("输入的所属商家含非法字符").show(); 
              return;
            }
            if(ownedBusiness.length>20){
                $(".oError").html("所属商家不能超过20个字").show();
                return false;
            }  
            $(".oError").hide();
            var code = $.trim($("#code").val()); 
            if(code==""){
                $(".cError").html("请输入验证码").show();
                return;
            }
            var cReg = /^\d{6}$/; 
            if(!cReg.test(code)){
              $(".cError").html("请输入正确的验证码").show(); 
              return;
            }  
            $(".cError").hide(); 
            postData.realName = realName;
            postData.mobile = mobile;
            postData.ownedBusiness = ownedBusiness;
            postData.code = code; 
            regist(); 
        });    
       function sendMsg(mobile){   
       		//防止用户刷单
			var sign = "";
			$.ajax({
				url: '/yangchebao-app-ws/ws/0.1/common/shop/sjlist',
				type: "post",
				async: false,
				dataType: 'json',
				contentType: 'application/json;charset=utf-8',
				success: function(data) {
					sign = hex_md5(mobile + data.ycbkey);
	            },
				error: function(xhr) {
					var error = eval('(' + xhr.responseText + ')');
					alertRe(error[0].message)
				}
			});
			//alert("获取到的sign的值为" + sign);
            $.ajax({
                url: '/yangchebao-weixin-ws/ws/0.1/salesman/getMobileCode?mobile='+mobile +'&sign='+sign,
                type: 'get',
                async: false,
                dataType: 'json',
                success: function(data) { 
                  alertRe("如果您在1分钟内没有收到验证码，请检查您填写的手机号码是否正确或重新发送。"); 
                },
                error:function(){
                  alertRe(errormsg[0].message,"error");
                  wait = 0;   
                }
            });
			time();
        }
        function regist(){ 
            $.ajax({
                url: '/yangchebao-weixin-ws/ws/0.1/salesman/salesManRegist',
                type: 'post',
                async: false,
                data:$.toJSON(postData),
                dataType: 'text',
                contentType:'application/json;charset=utf-8',
                success:function(data){
                      window.location.href = "result.html?openid="+openid;
                },error:function(xhr){ 
                     var mes = eval('('+xhr.responseText+')'); 
                     alertRe(mes[0].message)
                     
                } 
            }); 
        }
        function time() {
            var o = $(".captcha-btn");
            if (wait == 0) {
            o.removeClass("disabled");
            o.html("获取验证码"); 
            wait = 60;
            } else {
            o.addClass("disabled", true);
            o.html(wait + " 秒");
            wait--;
            setTimeout(function() {
            time();//循环调用
            },
            1000)
            }
        } 
      
    });
    getWXInfo();
    function getWXInfo(){  
        $.ajax({
            url: '/yangchebao-weixin-ws/ws/0.1/salesman/getWxUserBaseInfo?code='+paramJson.code,
            type: 'get',
            async: false,
            dataType: 'json',
            success: function(data) {  
                   openid = data.openid; 
                   if(data.isReg=="success"){ 
                        window.location.href="tg-step.html?openid="+openid
                    }else{
                       $("#activityPage").show();
                        weixinInfo = data
                    }
            },
            error:function(){ 
                alertRe('当前网络不稳定，请重新尝试。');
            }
        });
    }
</script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script language="javascript" src="./js/share.js"></script>
</body> 
</html>

