<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,heihgt=device-height,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="format-detection" content="telephone=no" />
	<title></title>
	<script src="../js/jquery-1.10.1.min.js"></script>
	<link rel="stylesheet" href="./css/main.css">
	<script src="./js/commen.js"></script>
	<style>
		body{
			background-color: #f4f7f8;
		}
		article.top{
			text-align: center;
			padding: 2.6rem 0;
			margin: 0 2rem;
			border-bottom: 1px solid #d9d9e2;
		}
		div.resultWaper{
			display: inline-block;
		}
		p.resultWaperL{
			float: left;
		}
		div.resultWaperR{
			float: left;
			margin-left: 1rem;
			margin-top: 1.6rem;
		}
		p.resultWaperL img{
			width: 8rem;
		}
		p.rTop{
			font-size: 1.8rem;
			color: #ff6138;
		}
		p.rBottom{
			font-size: 1.5rem;
			color: #a2a2a2;
		}
		div.btns{
			margin: 2.2rem 1rem;
		}
		p.closeBtn{
			float: left;
			width: 48%;
			background-color: #6eaade;
			color: #fff;
			-webkit-border-radius: 8px;
			-moz-border-radius: 8px;
			border-radius: 8px;
			text-align: center;
			font-size: 1.8rem;
			line-height: 3.6rem;
		}
		p.loadBtn,p.repayBtn{
			float: right;
			width: 48%;
			background-color: #ff6e47;
			color: #fff;
			-webkit-border-radius: 8px;
			-moz-border-radius: 8px;
			border-radius: 8px;
			text-align: center;
			font-size: 1.8rem;
			line-height: 3.6rem;
		}
		div.tipsWraper{
			position: relative;
			margin: 5rem 2.2rem;
			background-color: #e3f0f6;
			border: 1px solid #6eaade;
			-webkit-border-radius: 8px;
			-moz-border-radius: 8px;
			border-radius: 8px;
			padding: 2.6rem 1.2rem 1.2rem;
		}
		p.notice{
			position: absolute;
			color: #fff;
			font-size: 1.4rem;
			display: inline-block;
			background-color: #6eaade;
			padding: 0.5rem 2rem;
			-webkit-border-radius: 2rem;
			-moz-border-radius: 2rem;
			border-radius: 2rem;
			left: 1.2rem;
			top: -1.4rem;
		}
		div.tipItem{
			color: #6eaade;
			font-size: 1.3rem;
		}
		div.tipItem span{
			float: left;
		}
		div.tipItem p{
			margin-left: 1.2rem;
		}
	</style>
</head>
<body>
	<section id="paySuc" style="display:none;">
		<article class="top">
			<div class="resultWaper clearfix">
				<p class="resultWaperL"><img src="./img/sucIcon.jpg"></p>
				<div class="resultWaperR">
					<p class="rTop">恭喜土豪！</p>
					<p class="rBottom">您已成功付款</p>
				</div>
			</div>
		</article>
		<article class="bottom">
			<div class="btns clearfix">
				<p class="closeBtn">关闭</p>
				<p class="loadBtn">下载养车宝</p>
			</div>
			<div class="tipsWraper">
				<p class="notice">注意</p>
				<div class="tipItems">
					<div class="tipItem clearfix"><span>1.</span><p>购买成功后，必须下载养车宝客户端使用；</p></div>
					<div class="tipItem clearfix"><span>2.</span><p>服务可到养车宝的个人中心查看订单详情；</p></div>
					<div class="tipItem clearfix"><span>3.</span><p>车主卡可在卡内标注的“支持商家”内使用；</p></div>
					<div class="tipItem clearfix"><span>4.</span><p>每个用户只能以活动价格购买一次；</p></div>
					<div class="tipItem clearfix"><span>5.</span><p>如有使用问题，请拨打客服电话400-607-1222。</p></div>
				</div>
			</div>
		</article>
	</section>
	<section id="payFail" style="display:none;">
		<article class="top">
			<div class="resultWaper clearfix">
				<p class="resultWaperL"><img src="./img/failIcon.jpg"></p>
				<div class="resultWaperR">
					<p class="rTop">支付失败！</p>
					<p class="rBottom">钱没花出去郁闷</p>
				</div>
			</div>
		</article>
		<article class="bottom">
			<div class="btns clearfix">
				<p class="closeBtn">关闭</p>
				<p class="repayBtn">重新支付</p>
			</div>
		</article>
	</section>
</body>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript">
	$(function(){
		var url = window.location.search; 
	    var paramsArr = (url.split("?")[1]).split("&");
	    var paramJson = {};
	    $.each(paramsArr,function(i){
	        var item = paramsArr[i].split("=");
	        paramJson[item[0]] = item[1];
	    });

		if(paramJson.isPay==1){
			$('title').html('支付成功');
			$('section#paySuc').show()
		}else{
			$('title').html('支付失败');
			$('section#payFail').show();
			// 重新支付
		    $('p.repayBtn').on('click',function(){
		    	var postData={};
			    postData.userInfoId=paramJson.userInfoId;
			    postData.assistInId=paramJson.assistInId;
			    postData.openid='ovqUJsxxID-ZgoxnnddPFivoV9kA';
			    $.ajax({
			    	url:'/yangchebao-app-ws/ws/0.1/ordersale/placeorder',
			    	type:'post',
			    	dataType:'json',
			    	data:$.toJSON(postData),
			    	contentType:'application/json;charset=utf-8',
			    	success:function(data){
			    		onBridgeReady(data)
			    	},
			    	error:function(xhr){
			    		var error=eval('('+xhr.responseText+')');
			    		alert(error[0].message)
			    	}
			    });

			    function onBridgeReady(data){ 
			       var postData = data.payInfoObject;
				   WeixinJSBridge.invoke(
				       'getBrandWCPayRequest', {
				           "appId" : postData.appId,     //公众号名称，由商户传入     
				           "timeStamp":postData.timeStamp,         //时间戳，自1970年以来的秒数     
				           "nonceStr" : postData.nonceStr, //随机串     
				           "package" : postData.package,     
				           "signType" : postData.signType,         //微信签名方式:     
				           "paySign" : postData.paySign //微信签名 
				        },
				        function(res){     
				           if(res.err_msg == "get_brand_wcpay_request:ok" ) {  
				        	  window.location.href='payResult.html?isPay=1';
				           }else{  
				        	  window.location.href = 'payResult.html?isPay=0&userInfoId='+paramJson.userInfoId+'&assistInId='+paramJson.assistInId+'&openid='+paramJson.openid;
							  //+"?customerId="+paramJson.customerId+"&openid="+paramJson.openid+"&orderId="+data.orderId;
				           }    
				       }
				   ); 
				} 
		    })
		}
		// 关闭
		$('p.closeBtn').on('click',function(){
			window.close()
		});
		// 分享
		var sharedata={};
		$.ajax({
			url:'/yangchebao-weixin-ws/ws/0.1/buying/getShareUrl?type=1&sponsorId='+paramJson.openid+'&buyingActivityId='+paramJson.state,
			type:'get',
			async: false,
            dataType: 'json',
            contentType:'application/json;charset=utf-8',
            success:function(data){
            	sharedata.title=data.title;
				sharedata.desc = data.desc;
				sharedata.shareUrl=data.shareUrl;
				sharedata.headImgUrl=data.headImgUrl;
				share(sharedata);
            },
            error:function(xhr){
            	var error=eval('('+xhr.responseText+')');
            	errorLog(error[0].message)
            }
		})
	})
	
</script>
</html>