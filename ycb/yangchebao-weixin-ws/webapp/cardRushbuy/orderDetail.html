<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,heihgt=device-height,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="format-detection" content="telephone=no" />
	<title>订单确认</title>
	<script src="../js/jquery-1.10.1.min.js"></script>
	<script src="../js/jquery.json-2.2.js"></script>
	<link rel="stylesheet" href="./css/main.css">
	<script src="./js/commen.js"></script>
	<style>
		body{
			background-color: #f2f7f8;
		}
		article.top{
			background-color: #ffa600;
			padding: 1.5rem;
			color: #fff;
		}
		p.cardName{
			font-size: 1.6rem;
			padding-bottom: 0.6rem;
		}
		span.prePrice{
			font-size: 1.4rem;
			text-decoration: line-through;
			padding-right: 1rem;
		}
		span.nowPrice{
			font-size: 1.8rem;
		}
		article.bottom{
			padding: 4rem 2rem;
		}
		div.tipsW{
			position: relative;
			background-color: #e3f0f6;
			border: 1px solid #6eaade;
			padding: 1rem;
			-webkit-border-radius: 6px;
			-moz-border-radius: 6px;
			border-radius: 6px;
		}
		p.tipsT{
			position: absolute;
			top: -1.2rem;
			left: 1.5rem;
			width: 7rem;
			text-align: center;
			padding: 0.2rem 0;
			background-color: #6eaade;
			font-size: 1.4rem;
			-webkit-border-radius: 1.5rem;
			-moz-border-radius: 1.5rem;
			border-radius: 1.5rem;
			color: #fff;
		}
		div.tipsC{
			padding-top: 1rem;
			color: #6eaade;
			font-size: 1.3rem;
		}
		div.tipsC span{
			float: left;
		}
		div.tipsC p{
			margin-left: 1.5rem;
			padding-bottom: 0.2rem;
		}
		div.pay{
			position: fixed;
			bottom: 0;
			width: 100%;
			border-top: 1px solid #d9d9e2;
		}
		p.payL{
			float: left;
			width: 55%;
			line-height: 5rem;
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;
			font-size: 1.6rem;
			padding-left: 1rem;
			background-color: #fff;
		}
		span.payMoney{
			color: #ff6138;
		}
		p.payBtn{
			float: right;
			width: 45%;
			background-color: #ff6138;
			text-align: center;
			color: #fff;
			font-size: 1.8rem;
			line-height: 5rem;
		}
	</style>
</head>
<body>
	<section>
		<article class="top">
			<p class="cardName">京城通轿车10次洗车卡</p>
			<div><span class="prePrice">￥2889</span><span class="nowPrice">¥ 259</span></div>
		</article>
		<article class="bottom">
			<div class="tipsW">
				<p class="tipsT">注意</p>
				<div class="tipsC">
					<div><span>1.</span><p>购买成功后，必须下载养车宝客户端使用；</p></div>
					<div><span>2.</span><p>车主卡可在卡内标注的“支持商家”内使用；</p></div>
					<div><span>3.</span><p>每个用户只能以活动价格购买一次。</p></div>
				</div>
			</div>
		</article>
		<div class="pay clearfix">
			<p class="payL">还需支付：<span class="payMoney">￥20</span></p>
			<p class="payBtn">立即支付</p>
		</div>
	</section>
</body>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript">
	$(function(){
		var url = window.location.search; 
	    var paramsArr = (url.split("?")[1]).split("&");
	    var paramJson = {};
	    $.each(paramsArr,function(i){
	        var item = paramsArr[i].split("=");
	        paramJson[item[0]] = item[1];
	    });
	    //获取订单详情
	    $('p.cardName').html(decodeURI(decodeURI(paramJson.tradeName)));
	    $('span.prePrice').html('￥'+paramJson.reservePrice);
	    $('span.nowPrice,span.payMoney').html('￥'+paramJson.currentCash);
	    // 支付
	    $('p.payBtn').on('click',function(){
	    	var postData={};
		    postData.userInfoId=paramJson.userInfoId;
		    postData.assistInId=paramJson.assistInId;
		    postData.openid=paramJson.openid;
		    // 'ovqUJsxxID-ZgoxnnddPFivoV9kA'
		    $.ajax({
		    	url:'/yangchebao-app-ws/ws/0.1/ordersale/placeorder',
		    	type:'post',
		    	dataType:'json',
		    	data:$.toJSON(postData),
		    	contentType:'application/json;charset=utf-8',
		    	success:function(data){
		    		onBridgeReady(data)
		    	},
		    	error:function(xhr){
		    		var error=eval('('+xhr.responseText+')');
		    		alert(error[0].message)
		    	}
		    })
	    });
	    // 分享
		var sharedata={};
		$.ajax({
			url:'/yangchebao-weixin-ws/ws/0.1/buying/getShareUrl?type=1&sponsorId='+paramJson.openid+'&buyingActivityId='+paramJson.state+'&nickname='+paramJson.nickname+'&headImgUrl='+paramJson.headImgUrl,
			type:'get',
			async: false,
            dataType: 'json',
            contentType:'application/json;charset=utf-8',
            success:function(data){
            	sharedata.title=data.title;
				sharedata.desc = data.desc;
				sharedata.shareUrl=data.shareUrl;
				sharedata.headImgUrl=data.headImgUrl;
				share(sharedata);
            },
            error:function(xhr){
            	var error=eval('('+xhr.responseText+')');
            	errorLog(error[0].message)
            }
		})
	});
	function onBridgeReady(data){ 
       var postData = data.payInfoObject;
	   WeixinJSBridge.invoke(
	       'getBrandWCPayRequest', {
	           "appId" : postData.appId,     //公众号名称，由商户传入     
	           "timeStamp":postData.timeStamp,         //时间戳，自1970年以来的秒数     
	           "nonceStr" : postData.nonceStr, //随机串     
	           "package" : postData.package,     
	           "signType" : postData.signType,         //微信签名方式:     
	           "paySign" : postData.paySign //微信签名 
	       },
	       function(res){     
	           if(res.err_msg == "get_brand_wcpay_request:ok" ) {  
	        	  window.location.href='payResult.html?isPay=1'+'&state='+paramJson.state;
	           }else{  
	        	  window.location.href = 'payResult.html?isPay=0&userInfoId='+paramJson.userInfoId+'&assistInId='+paramJson.assistInId+'&openid='+paramJson.openid+'&state='+paramJson.state;
				  //+"?customerId="+paramJson.customerId+"&openid="+paramJson.openid+"&orderId="+data.orderId;
	           }    
	       }
	   ); 
	} 
</script>
</html>