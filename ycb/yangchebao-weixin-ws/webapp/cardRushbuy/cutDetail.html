<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,heihgt=device-height,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="format-detection" content="telephone=no" />
	<title></title>
	<script src="../js/jquery-1.10.1.min.js"></script>
	<script src="../js/jquery.json-2.2.js"></script>
	<link rel="stylesheet" href="./css/main.css">
	<script src="./js/commen.js"></script>
	<style>
		div.banner img{
			width: 100%;
		}
		p.joinBtn{
			width: 46%;
			margin-left: 27%;
			background-color: #ff6e47;
			-webkit-border-radius: 6px;
			-moz-border-radius: 6px;
			border-radius: 6px;
			color: #fff;
			text-align: center;
			margin-top: 2rem;
			margin-bottom: 2rem;
			font-size: 1.7rem;
			padding: 0.6rem 0;
		}
		article.bottom{
			padding: 0 1.6rem;
		}
		div.details{
			border-top: 1px dashed #04A199;
		}
		div.details p.title{
			font-size: 1.4rem;
			padding: 1rem 0 0.6rem 0;
		}
		p.detail{
			color: #a2a2a2;
			font-size: 1.3rem;
			padding-bottom: 0.2rem;
		}
		div.goodsDetail{
			margin-top: 1.6rem;
			margin-bottom: 2rem;
		}
		div.banner{
			background-color: #f4f7f8;
		}
		p.switch{
			font-size: 1.3rem;
			color: #707C92;
			padding: 5px 0;
			background-color: #fff;
		}
		p.switch img{
			width: 1.6rem;
			margin-right: 0.4rem;
			margin-left: 1rem;
			position: relative;
			top: -1px;
		}
		div.frinedsDetail{
			padding: 1.2rem;
		}
		p.friendsT{
			font-size: 1.4rem;
			color: #A2A2A2;
			padding: 1rem 0;
		}
		div.friendsTop{
			background-color: #fffdde;
			border: 1px solid #f8d082;
			-webkit-border-radius: 5px;
			-moz-border-radius: 5px;
			border-radius: 5px;
			padding: 1rem;
		}
		div.friendsTop p{
			font-size: 1.3rem;
			text-align: center;
		}
		div.friendsTop span.num{
			font-size: 1.6rem;
			color: #ff6e47;
		}
		div.btns,div.btnsM,div.btnsBuy{
			padding: 1.6rem 1rem;
			display: none;
		}
		div.btns p{
			width: 46%;
			text-align: center;
			font-size: 1.7rem;
			color: #fff;
			padding: 0.6rem 0;
			border-radius: 6px;
		}
		div.btnsM p,p.buyBtn{
			width: 50%;
			margin-left: 25%;
			text-align: center;
			font-size: 1.7rem;
			color: #fff;
			padding: 0.6rem 0;
			border-radius: 6px;
		}
		div.btnsM p{
			background-color: #ff6e47;
		}
		p.buyBtn{
			background-color: #6eaade;
			margin-bottom: 10px;
		}
		p.kanBtn{
			float: left;
			background-color: #ff6e47;
		}
		p.iJoinBtn{
			float: right;
			background-color: #6eaade;
		}
		#Table-records{
			width: 100%;
			border-top: 1px solid #CBD4E2;
			border-left: 1px solid #CBD4E2;
		}
		#Table-records thead tr th{
			border-right: 1px solid #CBD4E2;
			border-bottom: 1px solid #CBD4E2;
			background-color: #F7F8FC;
			text-align: center;
			line-height: 25px;
			font-size: 1.3rem;
			color: #707C92;
			font-weight: normal;
		}
		#Table-records tr td{
			border-right: 1px solid #CBD4E2;
			border-bottom: 1px solid #CBD4E2;
			text-align: center;
			line-height: 25px;
			font-size: 1.3rem;
			color: #a2a2a2;
		}


		.dialog,div.shareW{
		   position: fixed;
		   width: 100%;
		   height: 100%; 
		   background-color: rgba(0,0,0,0.5);
		   top:0;
		   bottom: 0;
		   z-index:100;
		}
		.dialog>div{ 
		   position: relative;
		   margin: 100px 10px 0;
		   background-color: #fff; 
		   height: auto;
		   overflow: auto;
		   -webkit-border-radius: 5px;
		   -moz-border-radius: 5px;
		   border-radius: 5px;
		}
		canvas#closeBtn{
			position: absolute;
			top: 1.2rem;
			right: 1.2rem;
		}
		div.dialogTitle{
			border-bottom: 1px solid #ff6138;
		}
		div.dialogTitle h3{
			font-size: 1.8rem;
			text-align: center;
			padding: 10px 0;
			font-weight: normal;
		}
		p.textItem{
			width: 90%;
			margin: 0 auto;
			padding: 2.8rem 0;
			font-size: 1.8rem;
			text-align: center;
		}
		p.dialogBtn{
			width: 90%;
			margin: 0 auto 1rem;
			-webkit-border-radius: 6px;
			-moz-border-radius: 6px;
			border-radius: 6px;
			color: #fff;
			background-color: #FF6138;
			text-align: center;
			font-size: 1.8rem;
			line-height: 3.6rem;
		}
		div.sharePic{
			padding: 1rem 2rem;
		}
		img.shareImg{
			float: right;
			width: 145px;
		}
		p.shareText{
			float: right;
			margin-top: 5px;
			margin-right: 90px;
			text-align: center;
			color: #fff;
			font-size: 1.5rem;
			line-height: 2rem;
		}
		span.nickName{
			color: #ff6138;
		}
	</style>
</head>
<body>
	<section>
		<article class="top noActivity">
			<div class="banner" style="padding-bottom: 0.8rem;">
				<p class="bannerPic"></p>
				<p class="switch"></p>
			</div>
			<div class="frinedsDetail">
				<p class="friendsT">亲爱的<span class="nickName"></span>：</p>
				<div class="friendsTop">
					<p>已有<span class="friendNum num"></span>位亲友帮<span class="holderName"></span>砍价了,当前价格为<span class="moneyNum num"></span>元，离福利更近一步了,<span class="canText">疯狂要求亲友帮忙吧</span>！</p>
				</div>
				<div class="btns clearfix"><p class="kanBtn"></p><p class="iJoinBtn">我要参加</p></div>
				<div class="btnsM clearfix"><p class="FkanBtn">请好友帮砍</p></div>
				<div class="records">
					<table cellspacing="0" cellpadding="0" border="0" id="Table-records">
						<thead>
							<th>亲友团</th>
							<th>砍掉价格</th>
							<th>砍后价格</th>
						</thead>
						<tbody>
							<!-- <tr>
								<td>橘子小李</td>
								<td>300</td>
								<td>5600</td>
							</tr>
							<tr>
								<td>橙子小王</td>
								<td>300</td>
								<td>5300</td>
							</tr>
							<tr>
								<td>栗子校长</td>
								<td>300</td>
								<td>5000</td>
							</tr> -->
						</tbody>
					</table>
				</div>
			</div>
			<div class="btnsBuy clearfix"><p class="buyBtn">立即购买</p></div>
		</article>
		<article class="bottom">
			<!-- <div class="activityTips details">
				<p class="title">活动说明</p>
				<p class="detail">砍价时间：2016-1-10至2016-1-30</p>
				<p class="detail">订购时间：2016-1-10至2016-1-30</p>
				<p class="detail">原价2094元手机，亲友团每人帮砍100-1000元，砍到最低200元；</p>
				<p class="detail">购买成功后，下载养车宝APP使用。</p>
			</div>
			<div class="goodsDetail details">
				<p class="title">商品详情</p>
				<p class="detail">车主卡便宜卖，快点来买啊，再不来就没有了。</p>
			</div> -->
		</article>
		<div class="dialog" style="display:none;">
			<div class="dialogWraper">
				<div class="dialogTitle">
					<h3>提示</h3>
					<canvas id="closeBtn" width='20' height="20"></canvas>
					<script type="text/javascript">
						var canvas=document.getElementById('closeBtn');
						var cxt=canvas.getContext('2d');
						cxt.beginPath();
						cxt.lineWidth=1.5;
						cxt.strokeStyle="#ff6138";
						cxt.moveTo(0,0);
						cxt.lineTo(20,20);
						cxt.stroke();
						cxt.closePath();
						cxt.beginPath();
						cxt.lineWidth=1.5;
						cxt.strokeStyle="#ff6138";
						cxt.moveTo(20,0);
						cxt.lineTo(0,20);
						cxt.stroke();
						cxt.closePath();
					</script>
				</div>
				<div class="dialogCon">
					<p class="textItem">活动已结束</p>
					<p class="dialogBtn">确定</p>
				</div>
			</div>
		</div>
		<div class="shareW" style="display:none;">
			<div class="sharePic clearfix">
				<p class="clearfix"><img src="./img/shareImg.png" class="shareImg"></p>
				<p class="shareText">点击右上角，<br />请好友帮忙砍价</p>
			</div>
		</div>
	</section>
</body>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript">
	
	$(function(){
		var url = window.location.search; 
	    var paramsArr = (url.split("?")[1]).split("&");
	    var paramJson = {};
	    $.each(paramsArr,function(i){
	        var item = paramsArr[i].split("=");
	        paramJson[item[0]] = item[1];
	    }); 
	    var openid = '';
	    var nowOpenid='';
	    var nowNickname='';
	    var nowHeadimgurl='';
	    var buyingActivityId='';
	    var nickname='';
	    var isUser=1;
	    var isActive=1;
	    	buyingActivityId=paramJson.state;
	    if(paramJson.openid){
	    	$('div.btnsM').show();
	    	$('span.holderName').html('您');
	    	$('span.canText').html('疯狂要求亲友帮忙吧');
	    	openid=paramJson.openid;
	    	nowHeadimgurl=paramJson.headImgUrl;
	    	nowNickname=decodeURI(decodeURI(paramJson.nickname));
	    	nowOpenid=openid;
	    }else{
	    	// 获取openid
	    	if(paramJson.code){
	    		$.ajax({
		            url: '/yangchebao-weixin-ws/ws/0.1/common/getWxUserBaseInfoNew?code='+paramJson.code,
		            type: 'get',
		            async: false,
		            dataType: 'json',
		            contentType:'application/json;charset=utf-8',
		            success: function(data) { 
		                nowOpenid=data.openid; 
		                nowNickname=data.nickname; 
		                nowHeadimgurl=data.headimgurl; 

		                store.remove('openid');
		                store.remove('nickname');
		                store.remove('headimgurl');

		                store.set('openid',nowOpenid);
		                store.set('nickname',nowNickname);
		                store.set('headimgurl',nowHeadimgurl);
		                events()
	                    
		            },
		            error:function(xhr){ 
		                // errorLog('当前网络不稳定，请重新尝试。');
		                var error=eval('('+xhr.responseText+')');
		            	// errorLog(error[0].message)
		            	nowOpenid=store.get('openid');
		                nowNickname=store.get('nickname');
		                nowHeadimgurl=store.get('headimgurl');
		                events()
		            }
		        });
			}else{
				nowOpenid=store.get('openid');
                nowNickname=store.get('nickname');
                nowHeadimgurl=store.get('headimgurl');
                events()
			}
			function events(){
				if(nowOpenid==paramJson.sponsorId){
	            	$('div.btnsM').show();
			    	$('span.holderName').html('您');
			    	$('span.canText').html('疯狂要求亲友帮忙吧');
	           	    openid=nowOpenid
	            }else{
	            	isUser=0;
	            	openid=paramJson.sponsorId;
	            	$('div.btns').show();
	            	// 判断好友是否助战
	            	$.ajax({
	            		url:'/yangchebao-weixin-ws/ws/0.1/buying/checkIsBeAssisted?openid='+nowOpenid+'&sponsorId='+paramJson.sponsorId+'&buyingActivityId='+paramJson.state,
	            		type: 'get',
			            async: false,
			            dataType: 'json',
			            contentType:'application/json;charset=utf-8',
			            success:function(data2){
			            	if(data2.statusCode==0){
			            		// 好友砍刀
			            		$('p.kanBtn').html('砍一刀');
			            		$('p.kanBtn').on('click',function(){
			            			var postData={};
			            			postData.openid=nowOpenid;
			            			postData.buyingActivityId=paramJson.state;
			            			postData.sponsorId=openid;
			            			postData.nickname=nowNickname;
			            			postData.headImgUrl=nowHeadimgurl;
			            			$.ajax({
			            				url:'/yangchebao-weixin-ws/ws/0.1/buying/addBuyingFriendAssitIn',
			            				type: 'post',
							            async: false,
							            dataType: 'json',
							            data:$.toJSON(postData),
							            contentType:'application/json;charset=utf-8',
							            success:function(data3){
							            	$('div.dialog').show();
							            	if(data3.statusCode==200){
							            		$('div.dialog p.textItem').html('小手一挥，帮'+data3.nickname+'砍下<span style="color:#ff6138;">'+data3.cutDownCash+'</span>元，快让'+data3.nickname+'请吃饭吧！');
							            		$('p.dialogBtn,canvas#closeBtn').on('click',function(){
								            		$('div.dialog').hide();
								            		getCutPriceDetail();
								            		$('p.kanBtn').html('请好友帮TA砍');
								            		$('p.kanBtn').unbind('click').bind("click",function(){
								            			$('div.shareW').show();
														$('div.shareW').on('click',function(){
															$('div.shareW').hide()
														})
								            		})
								            	})
							            	}else{
							            		$('div.dialog p.textItem').html(data3.msg);
							            		$('p.dialogBtn').on('click',function(){
								            		$('div.dialog').hide();
								            	})
							            	}
							            },
							            error:function(xhr){ 
							                var error=eval('('+xhr.responseText+')');
							            	errorLog(error[0].message)
							            }
			            			})
			            		})
			            	}else{
			            		$('p.kanBtn').html('请好友帮TA砍');
			            		$('p.kanBtn').on('click',function(){
			            			$('div.shareW').show();
									$('div.shareW').on('click',function(){
										$('div.shareW').hide()
									})
			            		})
			            	}
			            },
			            error:function(xhr){ 
			                var error=eval('('+xhr.responseText+')');
			            	errorLog(error[0].message)
			            }
	            	})
			    	$('span.canText').html('你也来帮他砍一刀吧');
	            }
			}
			
	    }
	    // 获取砍价详情
	    getCutPriceDetail();
	    function getCutPriceDetail(){
	    	$.ajax({
		    	url:'/yangchebao-weixin-ws/ws/0.1/buying/initBuyingData?openid='+openid+'&buyingActivityId='+buyingActivityId+'&pageindex=0&pagesize=1000&'+new Date().getTime(),
		    	type:'get',
		    	async: false,
	            dataType: 'json',
	            contentType:'application/json;charset=utf-8',
	            success: function(data) {
	            	data.startTime=data.startTime.replace(/-/g,'/');
	            	data.endTime=data.endTime.replace(/-/g,'/');
	            	var startTime=new Date(data.startTime);
	            	var endTime=new Date(data.endTime);
	            	var nowTime=new Date().getTime();
	            	startTime=startTime.getTime();
	            	endTime=endTime.getTime();
	            	var timeChange=function(){
	            		if(nowTime<startTime){
		            		$('p.switch').html('<img src="./img/warIcon.png">活动尚未开始！');
		            		isActive=0;
		            	}else if(nowTime>endTime){
		            		$('p.switch').html('<img src="./img/warIcon.png">活动已结束！');
		            		isActive=0;
		            	}else if(nowTime>=startTime || nowTime<=endTime){
		            		var difTime=endTime-nowTime;
		            		//计算出相差天数
							var days=Math.floor(difTime/(24*3600*1000));
							 
							//计算出小时数
							var leave1=difTime%(24*3600*1000);    //计算天数后剩余的毫秒数
							var hours=Math.floor(leave1/(3600*1000));
							 
							//计算相差分钟数
							var leave2=leave1%(3600*1000);       //计算小时数后剩余的毫秒数
							var minutes=Math.floor(leave2/(60*1000));
							 
							//计算相差秒数
							var leave3=leave2%(60*1000);      //计算分钟数后剩余的毫秒数
							var seconds=Math.round(leave3/1000);
							$('p.switch').html('<img src="./img/timeIcon.png">活动倒计时：'+days+'天'+hours+'小时'+minutes+'分'+seconds+'秒')
		            	}
		            	setTimeout(function(){
		            		nowTime+=1000;
		            		timeChange()
		            	},1000);
	            	};
	            	timeChange();
	            	nickname=data.sponsorNickname;
            		$('span.nickName').html(nowNickname);
	            	$('title').html(data.title);
	            	$('p.bannerPic').html('<img src="'+data.tradePicUrl+'">');
	            	$('article.bottom').html(data.activityDesc);
	            	$('span.friendNum').html(data.friendAssistInNumber);
	            	$('span.moneyNum').html(data.currentCash);
	            	if($('span.holderName').html()==''){
	            		$('span.holderName').html(nickname)
	            	}
			    	// 是否可购买
	            	if(isUser==1 && data.isOrdered==0 && isActive==1){
	            		$('div.btnsBuy').show();
	            		$('div.btnsBuy').unbind('click').bind('click',function(){
            				window.location.href="orderDetail.html?userInfoId="+data.userInfoId+'&assistInId='+data.buyingFriendAssistInId+'&openid='+openid+'&tradeName='+data.tradeName+'&currentCash='+data.currentCash+'&reservePrice='+data.reservePrice+'&state='+paramJson.state+'&nickname='+nickname+'&headImgUrl='+nowHeadimgurl
	            		})
	            	}
	            	var tbodyStr='';
	                if(data.assistInList.items.length==0 || !data.assistInList.items){
						
						tbodyStr+='<tr>'
								 +'<td colspan="3">暂无数据</td>'
								 +'</tr>';
						$('tbody').html(tbodyStr)
	                }else{
	            		var dataItems=data.assistInList.items;
	            		dataItems.forEach(function(key,i){
	            			tbodyStr+='<tr>'
	            					 +'<td>'+key.friendNickname+'</td>'
	            					 +'<td>'+key.cash+'</td>'
	            					 +'<td>'+key.remark+'</td>'
	            					 +'</tr>'
	            		});
	            		$('tbody').html(tbodyStr)
	                }
	            },
	            error:function(xhr){
	            	var error=eval('('+xhr.responseText+')');
	            	errorLog(error[0].message)
	            }
		    });
	    }
	    
		// 请好友帮砍
		$('div.btnsM').on('click',function(){
			$('div.shareW').show();
			$('div.shareW').on('click',function(){
				$('div.shareW').hide()
			})
		});
		// 我要参加
		$('p.iJoinBtn').on('click',function(){
			window.location.href="http://"+urlIp()+"/yangchebao-weixin-ws/cardRushbuy/signUp.html?state="+paramJson.state+'&openid='+nowOpenid+'&nickname='+nowNickname+'&headimgurl='+nowHeadimgurl
		});
		// 分享
		var sharedata={};
		$.ajax({
			url:'/yangchebao-weixin-ws/ws/0.1/buying/getShareUrl?type=2&sponsorId='+openid+'&buyingActivityId='+paramJson.state,
			type:'get',
			async: false,
            dataType: 'json',
            contentType:'application/json;charset=utf-8',
            success:function(data){
            	sharedata.title=data.title;
				sharedata.desc = data.desc;
				sharedata.shareUrl=data.shareUrl;
				sharedata.headImgUrl=data.headImgUrl;
				share(sharedata);
            },
            error:function(xhr){
            	var error=eval('('+xhr.responseText+')');
            	errorLog(error[0].message)
            }
		})

	});

</script>
</html>