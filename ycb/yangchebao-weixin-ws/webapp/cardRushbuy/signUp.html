<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,heihgt=device-height,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="format-detection" content="telephone=no" />
	<title></title>
	<script src="../js/jquery-1.10.1.min.js"></script>
	<script src="../js/jquery.json-2.2.js"></script>
	<link rel="stylesheet" href="./css/main.css">
	<script src="./js/commen.js"></script>
	<style>
		div.banner img{
			width: 100%;
		}
		div.hundred{
			position: relative;
			top: 2.8rem;
			margin: 0 1.2rem;
			height: 3px;
			font-size: 0;
			background:-webkit-linear-gradient(90deg,#fff,#5DC8C3 50%,#fff);
			background:-moz-linear-gradient(90deg,#fff,#5DC8C3 50%,#fff);
			background:linear-gradient(90deg,#fff,#5DC8C3 50%,#fff);
		}
		div.hundred p{
			position: absolute;
			top: -14px;
			font-size: 1.5rem;
			background-color: #5DC8C3;
			color: #fff;
			line-height: 28px;
			width: 100px;
			text-align: center;
			border-radius: 6px;
			left: 50%;
			margin-left: -50px;
		}
		p.tip{
			margin-top: 4rem;
			text-align: center;
			font-size: 1.4rem;
			padding: 1rem 0 0.2rem 0;
		}
		div.formRow{
			margin-right: 1.6rem;
			margin-left: 1.6rem;
			margin-top: 1rem;
			margin-bottom: 1rem;
		}
		div.formRow input{
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;
			border: 1px solid #D8D8D8;
			background-color: #F4F7F8;
			-webkit-border-radius: 6px;
			-moz-border-radius: 6px;
			border-radius: 6px;
			font-size: 1.4rem;
			padding: 0.8rem 1.2rem;
			line-height: 20px;
		}
		input#mobile{
			width: 100%;
		}
		input#code{
			width: 65%;
			margin-right: 5%;
		}
		span.getCode{
			width: 30%;
			display: inline-block;
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;
			background-color: #fff;
			border: 1px solid #ff6e47;
			-webkit-border-radius: 6px;
			-moz-border-radius: 6px;
			border-radius: 6px;
			font-size: 1.4rem;
			color: #ff6e47;
			padding: 0.8rem 0;
			text-align: center;
			line-height: 20px;
		}
		p.joinBtn{
			width: 46%;
			margin-left: 27%;
			background-color: #ff6e47;
			-webkit-border-radius: 6px;
			-moz-border-radius: 6px;
			border-radius: 6px;
			color: #fff;
			text-align: center;
			margin-top: 2rem;
			margin-bottom: 2rem;
			font-size: 1.7rem;
			padding: 0.6rem 0;
		}
		article.bottom{
			padding: 0 1.6rem;
		}
		div.details{
			border-top: 1px dashed #04A199;
		}
		div.details p.title{
			font-size: 1.4rem;
			padding: 1rem 0 0.6rem 0;
		}
		p.detail{
			color: #a2a2a2;
			font-size: 1.3rem;
			padding-bottom: 0.2rem;
		}
		div.goodsDetail{
			margin-top: 1.6rem;
			margin-bottom: 2rem;
		}
		div.banner{
			background-color: #f4f7f8;
		}
		p.switch{
			font-size: 1.3rem;
			color: #707C92;
			padding: 5px 0;
			background-color: #fff;
		}
		p.switch img{
			width: 1.6rem;
			margin-right: 0.4rem;
			margin-left: 1rem;
			position: relative;
			top: -1px;
		}
		div.frinedsDetail{
			padding: 1.2rem;
		}
		p.friendsT{
			font-size: 1.4rem;
			color: #A2A2A2;
			padding: 1rem 0;
		}
		div.friendsTop{
			background-color: #fffdde;
			border: 1px solid #f8d082;
			-webkit-border-radius: 5px;
			-moz-border-radius: 5px;
			border-radius: 5px;
			padding: 1rem;
		}
		div.friendsTop p{
			font-size: 1.3rem;
			text-align: center;
		}
		div.friendsTop span{
			font-size: 1.6rem;
			color: #ff6e47;
		}
		div.btns{
			padding: 1.6rem 1rem;
		}
		div.btns p{
			width: 46%;
			text-align: center;
			font-size: 1.7rem;
			color: #fff;
			padding: 0.6rem 0;
			border-radius: 6px;
		}
		p.kanBtn{
			float: left;
			background-color: #ff6e47;
		}
		p.iJoinBtn{
			float: right;
			background-color: #6eaade;
		}
		#Table-records{
			width: 100%;
			border-top: 1px solid #CBD4E2;
			border-left: 1px solid #CBD4E2;
		}
		#Table-records thead tr th{
			border-right: 1px solid #CBD4E2;
			border-bottom: 1px solid #CBD4E2;
			background-color: #F7F8FC;
			text-align: center;
			line-height: 25px;
			font-size: 1.3rem;
			color: #707C92;
			font-weight: normal;
		}
		#Table-records tr td{
			border-right: 1px solid #CBD4E2;
			border-bottom: 1px solid #CBD4E2;
			text-align: center;
			line-height: 25px;
			font-size: 1.3rem;
			color: #a2a2a2;
		}


		.dialog,div.shareW{
		   position: fixed;
		   width: 100%;
		   height: 100%; 
		   background-color: rgba(0,0,0,0.5);
		   top:0;
		   bottom: 0;
		   z-index:100;
		}
		.dialog>div{ 
		   position: relative;
		   margin: 100px 10px 0;
		   background-color: #fff; 
		   height: auto;
		   overflow: auto;
		   -webkit-border-radius: 5px;
		   -moz-border-radius: 5px;
		   border-radius: 5px;
		}
		canvas#closeBtn{
			position: absolute;
			top: 1.2rem;
			right: 1.2rem;
		}
		div.dialogTitle{
			border-bottom: 1px solid #ff6138;
		}
		div.dialogTitle h3{
			font-size: 1.8rem;
			text-align: center;
			padding: 10px 0;
			font-weight: normal;
		}
		p.textItem{
			width: 90%;
			margin: 0 auto;
			padding: 2.8rem 0;
			font-size: 1.8rem;
			text-align: center;
		}
		/*p.textItem input{
			width: 100%;
			border: 1px solid #D9D9E2;
			font-size: 0.9rem;
			padding: 0.6rem 0;
			text-align: center;
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: border-box;
		}*/
		p.dialogBtn{
			width: 90%;
			margin: 0 auto 1rem;
			-webkit-border-radius: 6px;
			-moz-border-radius: 6px;
			border-radius: 6px;
			color: #fff;
			background-color: #FF6138;
			text-align: center;
			font-size: 1.8rem;
			line-height: 3.6rem;
		}
		div.sharePic{
			padding: 1rem 2rem;
		}
		img.shareImg{
			float: right;
			width: 145px;
		}
		p.shareText{
			float: right;
			margin-top: 5px;
			margin-right: 90px;
			text-align: center;
			color: #fff;
			font-size: 1.5rem;
			line-height: 2rem;
		}
	</style>
</head>
<body>
	<section style="display:none;">
		<article class="top regist">
			<div class="banner"><img src="./img/banner_1.jpg"></div>
			<div class="hundred"><p>仅限前100名</p></div>
			<p class="tip">快邀请小伙伴们来砍一刀吧</p>
			<div class="formWraper">
				<div class="mobileW formRow"><input type="number" name="mobile" id="mobile" placeholder="填写手机号"></div>
				<!-- <div class="codeW formRow"><input type="number" name="code" id="code" placeholder="输入验证码"><span class="getCode">获取验证码</span></div> -->
				<p class="joinBtn">报名参加</p>
			</div>
		</article>
		<article class="bottom">
			<!-- <div class="activityTips details">
				<p class="title">活动说明</p>
				<p class="detail">砍价时间：2016-1-10至2016-1-30</p>
				<p class="detail">订购时间：2016-1-10至2016-1-30</p>
				<p class="detail">原价2094元手机，亲友团每人帮砍100-1000元，砍到最低200元；</p>
				<p class="detail">购买成功后，下载养车宝APP使用。</p>
			</div>
			<div class="goodsDetail details">
				<p class="title">商品详情</p>
				<p class="detail">车主卡便宜卖，快点来买啊，再不来就没有了。</p>
			</div> -->
		</article>
		<div class="dialog" style="display:none;">
			<div class="dialogWraper">
				<div class="dialogTitle">
					<h3>提示</h3>
					<canvas id="closeBtn" width='20' height="20"></canvas>
					<script type="text/javascript">
						var canvas=document.getElementById('closeBtn');
						var cxt=canvas.getContext('2d');
						cxt.beginPath();
						cxt.lineWidth=1.5;
						cxt.strokeStyle="#ff6138";
						cxt.moveTo(0,0);
						cxt.lineTo(20,20);
						cxt.stroke();
						cxt.closePath();
						cxt.beginPath();
						cxt.lineWidth=1.5;
						cxt.strokeStyle="#ff6138";
						cxt.moveTo(20,0);
						cxt.lineTo(0,20);
						cxt.stroke();
						cxt.closePath();
					</script>
				</div>
				<div class="dialogCon">
					<p class="textItem">活动已结束</p>
					<p class="dialogBtn">确定</p>
				</div>
			</div>
		</div>
		<!-- <div class="shareW">
			<div class="sharePic clearfix">
				<p class="clearfix"><img src="./img/shareImg.png" class="shareImg"></p>
				<p class="shareText">点击右上角，<br />请好友帮忙砍价</p>
			</div>
			
		</div> -->
	</section>
</body>
<script type="text/javascript">
	var isToCutDetail=0;

	var url = window.location.search; 
    var paramsArr = (url.split("?")[1]).split("&");
    var paramJson = {};
    $.each(paramsArr,function(i){
        var item = paramsArr[i].split("=");
        paramJson[item[0]] = item[1];
    }); 
    var sharedata={};
    var openid='';
    var headImgUrl='';
    var nickname='';
    var title='';
	// 获取openid
	if(paramJson.code!=null && paramJson.code!='' && paramJson.code!=undefined){
		$.ajax({
            url: '/yangchebao-weixin-ws/ws/0.1/common/getWxUserBaseInfoNew?code='+paramJson.code,
            type: 'get',
            async: false,
            dataType: 'json',
            contentType:'application/json;charset=utf-8',
            success: function(data) {  
                   openid = data.openid;
                   headImgUrl=data.headimgurl;
                   nickname=data.nickname;
                   // shareInfo();
    			   turnPage();
            },
            error:function(xhr){ 
                // errorLog('当前网络不稳定，请重新尝试。');
                var error=eval('('+xhr.responseText+')');
            	errorLog(error[0].message)
            }
        });
	}else{
		openid = paramJson.openid;
        headImgUrl = paramJson.headimgurl;
        nickname = decodeURI(decodeURI(paramJson.nickname));
        // shareInfo();
        turnPage();
	}
	$(function(){

        // 判断首页跳转
        $.ajax({
        	url:'/yangchebao-weixin-ws/ws/0.1/buying/jump?openid='+openid+'&buyingActivityId='+paramJson.state,
        	type:'get',
        	async: false,
            dataType: 'json',
            contentType:'application/json;charset=utf-8',
            // success:function(data){
            	
            // },
            error:function(xhr){
            	var error=eval('('+xhr.responseText+')');
            	errorLog(error[0].message)
            }
        }).then(function(data){
        	if(data.statusCode==1){
        		$('section').show();
        		// 获取活动信息
        		$.ajax({
        			url:'/yangchebao-weixin-ws/ws/0.1/buying/initRegData?buyingActivityId='+paramJson.state,
        			type:'get',
		        	async: false,
		            dataType: 'json',
		            contentType:'application/json;charset=utf-8',
		            success:function(data2){
		            	title=data2.name;
		            	$('title').html(data2.name);
		            	$('div.banner').html(data2.titleDesc);
		            	$('article.bottom').html(data2.activityDesc);
		            	shareInfo()
		            },
		            error:function(xhr){
		            	var error=eval('('+xhr.responseText+')');
		            	errorLog(error[0].message)
		            }
        		});
        		// 报名
        		$('p.joinBtn').unbind('click').bind('click',function(){
        			var mobile=$.trim($('input#mobile').val());
        			if(mobile==''){
        				errorLog('请输入手机号');
        				return false
        			}
        			if(!(/^1[0-9]{10}$/.test(mobile))){
        				errorLog('请输入正确格式的手机号');
        				return false
        			}
        			var postData={};
        			postData.mobile=mobile;
        			postData.openid=openid;
        			postData.buyingActivityId=paramJson.state;
        			postData.headImgUrl=headImgUrl;
        			postData.nickname=nickname;
        			$.ajax({
        				url:'/yangchebao-weixin-ws/ws/0.1/buying/regist',
        				type:'post',
        				async: false,
			            dataType: 'json',
			            data:$.toJSON(postData),
			            contentType:'application/json;charset=utf-8',
			            success:function(data){
			            	window.location.href="cutDetail.html?openid="+openid+'&state='+paramJson.state+'&nickname='+nickname+'&headImgUrl='+headImgUrl
			            },
			            error:function(xhr){
			            	var error=eval('('+xhr.responseText+')');
			            	errorLog(error[0].message)
			            }
        			})
        		})
        	}
        });
		
		

	});
 	function turnPage(){
 		$.ajax({
			url:'/yangchebao-weixin-ws/ws/0.1/buying/jump?openid='+openid+'&buyingActivityId='+paramJson.state,
			type:'get',
        	async: false,
            dataType: 'json',
            contentType:'application/json;charset=utf-8',
            error:function(xhr){
            	var error=eval('('+xhr.responseText+')');
            	errorLog(error[0].message)
            }
		}).then(function(data2){
			// shareInfo();
			if(data2.statusCode!=1){
				window.location.href="cutDetail.html?openid="+openid+'&state='+paramJson.state+'&nickname='+nickname+'&headImgUrl='+headImgUrl
				return false
			}
		});
 	}

	// 分享
	function shareInfo(){
		$.ajax({
			url:'/yangchebao-weixin-ws/ws/0.1/buying/getShareUrl?type=1&sponsorId='+openid+'&buyingActivityId='+paramJson.state+'&nickname='+nickname+'&headImgUrl='+headImgUrl,
			type:'get',
			async: false,
            dataType: 'json',
            contentType:'application/json;charset=utf-8',
            success:function(data3){
            	sharedata.title = title;
				sharedata.desc = data3.desc;
				sharedata.shareUrl = data3.shareUrl;
				sharedata.headImgUrl = headImgUrl;
				share(sharedata);
            },
            error:function(xhr){
            	var error=eval('('+xhr.responseText+')');
            	errorLog(error[0].message)
            }
		})
	}
</script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
</html>