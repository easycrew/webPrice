 <style>
 	 #Wraper_user_memberManage span.getCode{
		background-color: #508ae8;
		border:1px solid #4178d2;
		border-radius: 3px;
		padding:3px 5px;
		margin-left:10px;
		position:relative;
		top:4px;
		left:0;
		color:#fff;
		cursor: pointer;
	 }
	 .remove{
		background-color: #e9e9e9!important;
		border:1px solid #c8c8c8!important;
		color:#5e6770!important;
		cursor: default!important;
	 }
	 #Wraper_user_memberManage #Form_user_memberManage .regist{
	 	display:none;
	 }
	 #Wraper_user_memberManage table th,#Wraper_user_memberManage table td{
		text-align: center;
	 }
 </style>
 <div class="urlContentWraper" id="Wraper_user_memberManage">
    <div class="ui-info-layout">
        <div class="vdiv">
	        <!-- 列表显示 -->
			<table id="Table_user_memberManage"></table>
		</div>
    </div>
    <div id="Form_user_memberManage" style="display:none;">
        <div class="grid-layout-main jrad-form">
            <input name="shopAccountId" type="hidden">
            <div class="grid-row-fluid">
                <label class="span4 grid-layout-label">客户手机：</label>
                <div class="span8 grid-layout-content fluid-wrap">
                    <div name="mobile" class="jrad-input-container"></div>
				</div> 
            </div>
            <div class="grid-row-fluid regist">
                 <label class="span4 grid-layout-label">手机验证码：</label>
                 <div class="span6 grid-layout-content fluid-wrap">
                       <div name="code" class="jrad-input-container"></div>  
                 </div>
                 <span class="getCode">获取验证码</span>
            </div>
            <div class="grid-row-fluid regist">
            	<label class="span4 grid-layout-label"></label>
            	<p class="span9"><a href="javascript:" id="sound">短信收不到，获取语音验证码。</a></p>
            </div>
            <p class="ui-note regist">此手机号码未注册，已向用户手机发送验证码，填入用户手机收到的验证码后，点击“确定”即可快速注册。</p>
			
			<div class="grid-row-fluid">
                 <label class="span4 grid-layout-label">赠送车主卡：</label>
                 <div class="span10 grid-layout-content fluid-wrap">
                       <div name="memberDonateRelId" class="jrad-radio-container"></div>
				 </div>
            </div>

        </div>
		
        <div class="jrad-buttons-container ui-buttons-container">
			<button class="jrad-btn-primary btn btn-small btn-primary">
				确定
			</button>
			<button class="jrad-btn-normal btn btn-small btn-default">
				取消
			</button>
		</div>
    </div>
    <div id="Form_user_registSuccess" style="display:none;">
        <div class="grid-layout-main jrad-form" style="text-align:center;">
            <h1>用户养车宝账号注册成功！</h1>
        </div>
        <div class="jrad-buttons-container ui-buttons-container">
			<button class="jrad-btn-primary btn btn-small btn-primary">
				确定
			</button>
		</div>
    </div>
</div>
<script type="text/javascript">
$(document).ready(function(){
    var wraper = $('#Wraper_user_memberManage');
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array();
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel}); 
    var fields_params={};
	
    $('#Form_user_memberManage div[name="memberDonateRelId"]',wraper).radio({
    	vertical: true,
		urlData: {
			url: '/vip-ws/ws/0.1/userMember/giftList',
			id: 'memberDonateRelId',
			name: 'donateName'
		}
    });

    jRad.validators['mobile'] = [{"msg":"注册手机号不能为空","type":"min","value":"1"},{msg:"手机号格式不正确",type:'regex',value:/^1{1}\d{10}$/}];
	// jRad.validators['code'] = [{"msg":"请填写验证码","type":"min","value":"1"}];
    page_column_model.push({display: '会员昵称', name : 'nicName',diy:function(item,$div){
    	if(item.nicName == ''){
    		$div.html("--")
    	}else{
    		$div.html(item.nicName)
    	}
    }});
    page_column_model.push({display: '会员手机号码', name : 'mobile'});
    page_column_model.push({display: '赠送物品', name : 'donate',diy:function(item,$div){
    	if(item.donate == ' '){
    		$div.html("--")
    	}else{
    		$div.html(item.donate)
    	}
    }});
	page_column_model.push({display: '生效时间', name : 'takingEffectDate'});
    
	page_search_items.push({row:'1',type:'jrad-input',display:'会员手机',name:'mobile'});
	page_search_items.push({row:'2',type:'jrad-dateinput',display:'生效时间始',name:'takingEffectDateStart'});
	page_search_items.push({row:'2',type:'jrad-dateinput',display:'生效时间终',name:'takingEffectDateEnd'});
	var _mobile="";
	var _code="";
	var _item="";
	var wait=60;
	var timer='';
    $('#Form_user_memberManage').form({
		title: '创建',
		validators: jRad.validators,
		fields_params:jRad.params,
		item:{}, 
		url:'/vip-ws/ws/0.1/userMember/registerUserMember',
		preSubmit:function(json){
			_mobile = $('#Form_user_memberManage div[name="mobile"]',wraper).input('val');
			_code = $('#Form_user_memberManage div[name="code"]',wraper).input('val');
			json.shopAccountId=carsmart_config.shopId;
			json.modifyPerson=carsmart_config.operatorName;
			return json
		},
		autobinding: false
	}); 
	$('#Form_user_memberManage .jrad-btn-primary').button();
	$('#Form_user_memberManage .jrad-btn-normal').button();
	$('#Form_user_memberManage .jrad-btn-primary').bind('click',function(){
		var _memberDonateRelId = $("#Form_user_memberManage div[name='memberDonateRelId']").radio('val');
		var con = $('#Form_user_memberManage div[name="memberDonateRelId"] div.selected label',wraper).html();
		var isDonate = 0;
		if(_memberDonateRelId == '-99'){
			isDonate = 0;
		}else{
			isDonate = 1;
		}
		//$('#Form_user_memberManage div[name="memberDonateRelId"] div.modal-backdrop',wraper).css('display','none');
		$.jRadConfirm('确认'+con+'?',"1",function(){
			var getData = $('#Form_user_memberManage').form('getValue');
			getData.isDonate=isDonate;
			getData.modifyPerson=carsmart_config.operatorName;
			getData.shopAccountId =carsmart_config.shopId
			$.jRadPost({
                url:"/vip-ws/ws/0.1/userMember/registerUserMember",
                data:getData, 
                success:function(){ 
                	 $('#Form_user_memberManage').form('close');
                     $('#Table_user_memberManage').flexMessage('创建成功', 'success');
					 $('#Table_user_memberManage').flexReload()
                },
                error:function(xhr){
					var errormsg = eval("(" + xhr.responseText + ")");
					$.jRadAlert(errormsg[0].message,"error",-1);
					return false;
				}
            });
		});
	});

	$('#Form_user_memberManage .jrad-btn-normal').bind('click',function(){
		 $('#Form_user_memberManage').form('close');
	});

	function time(){
		var o=$('#Form_user_memberManage .getCode',wraper);
		if(wait==0){
			o.removeClass('disabled').removeClass('remove');
			o.html('获取验证码');
			wait=60
		}else{
			o.addClass('disabled',true).addClass('remove');
			o.html(wait+'秒后获取验证码');
			wait--;
			timer=setTimeout(time,1000)
		}
	};

    page_list_buttons.push({title: '创建',displayname:'创建',bclass: 'icon-plus',onpress : function(){ 
		   $('#Form_user_memberManage').form({item:{}}).form('open');
		   $('#Form_user_memberManage div[name="memberDonateRelId"]',wraper).radio('val','-99'); 
		   $('#Form_user_memberManage .regist',wraper).hide();
		   $($('#Form_user_memberManage div[name="mobile"] input',wraper)).unbind('blur').bind('blur',function(){
		   		_mobile=$('#Form_user_memberManage div[name="mobile"]',wraper).input('val');
		   		setTimeout(onBlur,800);
		   		function onBlur(){
		   			$.jRadGet({
						url:'/vip-ws/ws/0.1/userInfo/isRegistered?mobile='+_mobile,
						success:function(data){
							if(data.isRegistered==0){
								$('#Form_user_memberManage .regist',wraper).show();
								clearTimeout(timer);
								$('#Form_user_memberManage .getCode',wraper).removeClass('disabled').removeClass('remove').html("获取验证码");
								wait=60;
								$('#Form_user_memberManage #sound',wraper).show();
								$('#Form_user_memberManage span.ui-note',wraper).remove();
								$('#Form_user_memberManage .getCode',wraper).unbind('click').bind('click',function(){
									if($(this).hasClass('disabled')){
										return false
									}
									var input=$('#Form_user_memberManage div[name="mobile"]',wraper);
									var flag=input.input('validate');
									if(flag){
										$.jRadGet({
											url:'/vip-ws/ws/0.1/userInfo/registry/getcode?user='+_mobile,
											error:function(xhr){
												var errormsg = eval("(" + xhr.responseText + ")");
												$.jRadAlert(errormsg[0].message,"error","",-1);
												wait = 0
											}
										});
										time()
									}
								});
								$('#Form_user_memberManage #sound',wraper).unbind('click').bind('click',function(){
									$.jRadGet({
										url:'/vip-ws/ws/0.1/userInfo/registry/getcode?user='+_mobile+'&voice=1',
										success:function(){
											$('#Form_user_memberManage #sound',wraper).after('<span class="ui-note">用户将会接到系统自动拨打的电话，请接听并记录4位验证码。</span>');
											$('#Form_user_memberManage #sound',wraper).hide()
										},
										error:function(xhr){
											var errormsg = eval("(" + xhr.responseText + ")");
											$.jRadAlert(errormsg[0].message,"error","",-1)
										}
									})
								})
							}else{
								$('#Form_user_memberManage .regist',wraper).hide()
							}
						
						},
						error:function(xhr){
							var errormsg = eval("(" + xhr.responseText + ")");
							$('#Form_user_memberManage',wraper).flexMessage(errormsg[0].message, 'error')
						}
					});
		   		}
		   	 	
		   })
        }
    });
  
	$('#Table_user_memberManage').flexigrid({
		reload:true,
		method:'get', 
		colModel : page_column_model,
		buttons : page_list_buttons,
		searchitems :page_search_items,
		showSearch:true,
		showCheckbox:false,
		pagination: {
			diaplay_pages: 5,
			align: 'bottom' 
		},
		overflow:true,
		url:'/vip-ws/ws/0.1/userMember/queryUserMembers?shopAccountId='+carsmart_config.shopId,
		onError:showRemarkError,
		checkBoxType:'single'
	})
	
    $('.tDiv',wraper).before('<span style="margin:0 20px 0 14px;font-size:15px;float:left;line-height:60px;">会员列表</span>');
    $('.hDiv',wraper).css('overflow','hidden');
    $('.bDiv',wraper).css('overflow-x','scroll');
});
function showRemarkError(xhr){
 	var errormsg = eval("(" + xhr.responseText + ")");
  	var cDiv = $("#Wraper_user_memberManage .cDiv");
  	$.jRadMessage({level:'error',message:errormsg[0].message,selector:cDiv});
}
</script>
