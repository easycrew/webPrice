<style>
	#Wraper_voucher_manage .ui-checkbox{
		display:block;
	}
	.cDiv table tr td, .cDiv table tr th{text-align:center;}
</style>
<div class="urlContentWraper" id="Wraper_voucher_manage">
	<!-- 列表显示 -->
    <div class="ui-info-layout">
    	<div class="vdiv">
            <table id="Table_voucher_manage">
            </table>
        </div>
        <div class="udiv" style="margin-top:10px;">
           <!-- <h2 class="ui-tit"><strong>代金券列表</strong></h2> -->
           <table id="Table_voucher_manage_uselist"></table>
        </div>
	</div>
	<div id="Form_voucher_manage" class="grid-layout ui-form">
		<div class="grid-layout-main jrad-form">
			<div class="grid-row-fluid"> 
				<label class="span5 grid-layout-label">
				   <span class="ui-form-required">*</span>
					代金券主题：
				</label>
				<div class="span8 grid-layout-content fluid-wrap">
					<div data-name="voucherTopic" class="jrad-input-container">
					</div>
				</div>
			</div>
			<div class="grid-row-fluid">
				<label class="span5 grid-layout-label">
				<span class="ui-form-required">*</span>
					数量：
				</label>
				<div class="span8 grid-layout-content fluid-wrap">
					<div data-name="issuanceNum" class="jrad-input-container">
					</div>
				</div>
			</div> 
			<div id="readonlyDiv">
			<div class="grid-row-fluid">
				<label class="span5 grid-layout-label">
				<span class="ui-form-required">*</span>
					金额：
				</label>
				<div class="span8 grid-layout-content fluid-wrap">
					<div data-name="money" class="jrad-input-container">
					</div>
				</div>
			</div>
			 <div class="grid-row-fluid">
				<label class="span5 grid-layout-label">
				   是否指定服务：
				</label>
				<div class="span8 grid-layout-content fluid-wrap">
					<div data-name="assignService" class="jrad-select-container">
					</div>
				</div>
			</div>
			<div class="servicesDiv" style="display:none;">
			  <div class="grid-row-fluid">
				<label class="span5 grid-layout-label"> 
					绑定服务：
				</label>
				<div class="span8 grid-layout-content fluid-wrap">
					<div data-name="serviceId" class="jrad-select-container service">
					</div>
					<p id="serviceNames"></p>
				</div>
			  </div>
			</div>
			<div class="grid-row-fluid limitDiv">
				<label class="span5 grid-layout-label"> 
					满多少元可用：
				</label>
				<div class="span8 grid-layout-content fluid-wrap">
					<div data-name="spendingBottomLimit" class="jrad-input-container">
					</div>
				</div>
			</div>
			<div class="grid-row-fluid">
				<label class="span5 grid-layout-label"><span class="ui-form-required">*</span>
				   有效期开始：
				</label>
				<div class="span8 grid-layout-content fluid-wrap">
					<div data-name="startDate" class="jrad-dateinput-container">
					</div>
				</div>
			</div>
			<div class="grid-row-fluid">
				<label class="span5 grid-layout-label"><span class="ui-form-required">*</span>
				   有效期结束：
				</label>
				<div class="span8 grid-layout-content fluid-wrap">
					<div data-name="endDate" class="jrad-dateinput-container">
					</div>
				</div>
			</div>
			 <div class="grid-row-fluid">
				<label class="span5 grid-layout-label"><span class="ui-form-required">*</span>
				   分店是否通用：
				</label>
				<div class="span8 grid-layout-content fluid-wrap">
					<div data-name="branchUseable" class="jrad-select-container">
					</div>
				</div>
			</div>
			<div class="grid-row-fluid branchShopDiv" style="display:none;"> 
				<label class="span5 grid-layout-label"> 
					选择分店：
				</label>
				<div class="span16 grid-layout-content fluid-wrap">
					<div data-name="branchBusiIds" class="jrad-checkbox-container">
					</div> 
				</div>
			</div>
			<div class="grid-row-fluid">
				<label class="span5 grid-layout-label"><span class="ui-form-required">*</span>
				   代金券详情：
				</label>
				<div class="span14 grid-layout-content fluid-wrap">
					<div data-name="illustrate" class="jrad-textarea-container" placeholder="您可以参照以下格式：亲们,为答谢大家对本店的支持，免费向在本店服务过的车主发送代金券啦。">
					</div>
				</div>
			</div>
			<div class="grid-row-fluid">
				<label class="span5 grid-layout-label">
				   备注：
				</label>
				<div class="span14 grid-layout-content fluid-wrap">
					<div data-name="remarks" class="jrad-textarea-container">
					</div>
				</div>
			</div>
			</div>
			<input type="hidden" name="businessInfoId"/>
			<input type="hidden" name="shopAccountId"/>
		</div>
		<div class="jrad-buttons-container ui-buttons-container">
			<button class="jrad-btn-primary btn btn-small btn-primary">
				确定
			</button>
			<button class="jrad-btn-normal btn btn-small btn-default">
				取消
			</button>
		</div>
	</div> 
</div>
<script type="text/javascript">
$(document).ready(function() {
	var wraper = $('#Wraper_voucher_manage');
	var parentId = carsmart_config.shopId;
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array(); 
    var page_column_model_c = new Array();
    var page_search_items_c = new Array();
    var page_list_buttons_c = new Array();
    var entityModel = {};
    var fields_params={};
    fields_params['branchUseable'] = {              
		data:[{id:"0",name:"否"},{id:"1",name:"是"}],
		onchange: function(val){ 
			if(val=='1'){
				var branchShopList =$.jRadGetDataSources('/vip-ws/ws/0.1/voucherVip/getBranchShopList?shopAccountId='+carsmart_config.shopId,'businessInfoId','shopName');
				//var branchStr=branchShopList.join(',');
				$("#Form_voucher_manage .branchShopDiv",wraper).show();
				$("#Form_voucher_manage div[data-name='branchBusiIds']",wraper).checkbox({
					data: branchShopList,
					selectAll: true
				}); 
			}else{ 
				$("#Form_voucher_manage .branchShopDiv",wraper).hide(); 
			}	 
		}
	};
	fields_params['assignService'] = {              
		data:[{id:"0",name:"否"},{id:"1",name:"是"}],
		onchange: function(val){ 
		    if(val=='0'){
				$("#Form_voucher_manage .limitDiv",wraper).show();
				$("#Form_voucher_manage .servicesDiv",wraper).hide();
			}else{
				$("#Form_voucher_manage .limitDiv",wraper).hide();
			}
			if(val=='1'){
				$("#Form_voucher_manage .servicesDiv",wraper).show(); 
				$("#Form_voucher_manage .limitDiv",wraper).hide();
			}else{
				$("#Form_voucher_manage .servicesDiv",wraper).hide();
			}
		}
	};
	fields_params['serviceId'] = {
		urlData: {
			url:'/vip-ws/ws/0.1/business/getServiceListByShopId?parentId=-1&level=0&shopAccountId='+carsmart_config.shopId,
			id: 'serviceId',
			name: 'serviceName',
			type: 'get',
			dataType: 'json'
		}, 
		unshiftData:{id:'',name:'请选择'},
		onchange: function(val){  
			getServiceSonNode("1",val,wraper);  
		}
	};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel});   
	jRad.validators['voucherTopic'] = [{msg:"代金券主题不能为空",type:'min',value:1},{"msg":"最多30个字符","type":"max","value":"30"}];	
	jRad.validators['issuanceNum'] = [{msg:"代金券数量不能为空",type:'min',value:1}];	
	jRad.validators['money'] = [{msg:" 代金券金额不能为空",type:'min',value:1}];
	jRad.validators['illustrate'] = [{msg:"代金券详情不能为空",type:'min',value:1},{msg:"最多500个字符",type:"max",value:"500"}];
	jRad.validators['remarks'] = [{msg:"最多500个字符",type:"max",value:"500"}];
	
    $('#Form_voucher_manage').form({
        title: '创建',
        fluid: true,
        validators: jRad.validators,
        fields: fields_params,
        autobinding:true, 
		url:'/vip-ws/ws/0.1/voucherVip/addVoucherTopic',
		preSubmit:function(json){ 
			var _branchShopList=$("#Form_voucher_manage div[data-name='branchBusiIds']",wraper).checkbox("val");
			var branchStr=_branchShopList.join(','); 
			json.shopAccountId=carsmart_config.shopId;
			json.publisher=carsmart_config.operatorName;
			json.modifyPerson=carsmart_config.operatorName;
			json.branchBusiIds=branchStr;
			json.status = 1;
			return json;
		},
        success: function() {
            $('#Table_voucher_manage').flexMessage('创建成功', 'success','3');
            $('#Table_voucher_manage').flexReload();
         }
    });
    page_column_model.push({display: '代金券主题', name : 'voucherTopic'});
    page_column_model.push({display: '使用数/领取数/总量', name : 'voucherAmount',diy:function(item,$div){
    	$div.html(item.usedNum+"&nbsp;&nbsp;/&nbsp;&nbsp;"+item.claimedNum+"&nbsp;&nbsp;/&nbsp;&nbsp;"+item.issuanceNum);
    }});
    page_column_model.push({display: '金额', name : 'money'}); 
    page_column_model.push({display: '满多少消费可用', name : 'spendingBottomLimit'});
    page_column_model.push({display: '绑定服务', name : 'serviceName',diy:function(item,$div){
    	if(item.serviceName == ''|| item.serviceName == undefined){
    		$div.html("--")
    	}else{
    		$div.html(item.serviceName)
    	}
    }}); 
    page_column_model.push({display: '有效期开始', name : 'startDate',diy:function(item,$div){
    	if(item.startDate == ''){
    		$div.html("--")
    	}else{
    		$div.html(item.startDate)
    	}
    }}); 
    page_column_model.push({display: '有效期结束', name : 'endDate',diy:function(item,$div){
    	if(item.endDate == ''){
    		$div.html("--")
    	}else{
    		$div.html(item.endDate)
    	}
    }}); 
    page_column_model.push({display: '备注', name : 'remarks',diy:function(item,$div){
    	if(item.remarks == '' || item.remarks == undefined){
    		$div.html("--")
    	}else{
    		$div.html(item.remarks)
    	}
    }}); 
   
    page_list_buttons.push({
        title: '创建',
		displayname:'创建',
        bclass: 'icon-plus',
        onpress: function() { 
			$('#Form_voucher_manage').form({
				item:{"branchUseable":"0","assignService":"0"}
			}).form('open');
        }
    });

    page_list_buttons.push({
        title: '删除',
		displayname:'删除',
        bclass: 'icon-trash',
        prefunc: function() {
            var checked = $('#Table_voucher_manage').getCheckedTrs();
            if (checked.length != 0) {
                return true;
            } else {
                return false;
            }
        },
        onpress: function() {
            var checked = $('#Table_voucher_manage').getCheckedTrs();
            var postData = {};
	        postData.voucherTopicId = checked[0].voucherTopicId;
	        postData.status = 2;
            $.jRadConfirm('确认删除？', 1,
            function() {
            	$.jRadPost({
            		url:'/vip-ws/ws/0.1/voucherVip/setVoucherTopicStatus',
	        	data:postData, 
	        	success:function(){ 
							$('#Table_voucher_manage').flexMessage('删除成功!', 'success');
	           	    		$('#Table_voucher_manage').flexReloadSearch(); 
					 
				},error:function(xhr){
				    var errormsg = eval("(" + xhr.responseText + ")"); 
					if (errormsg != undefined) {
						$('#Table_voucher_manage').flexMessage(errormsg[0].message, 'error');
					}
				}
			  });
            });
        }
    });

    $('#Table_voucher_manage').flexigrid({
        reload: true,
        grid:40,
        pagination: {diaplay_pages: 10,align:'bottom',showText: '从第_start_到_end_项 共_total_项'},
        colModel: page_column_model,
        buttons: page_list_buttons,
        searchitems: page_search_items,
        pagedStyle: 'oc',
		method:'get',
		showSearch:true,
		showCheckbox:false,
        url:'/vip-ws/ws/0.1/voucherVip/queryVoucherTopics?shopAccountId='+carsmart_config.shopId,     
         //1.CMS查询0.总店查询分店，此时userId为当前登录用户的ID 
        trEvent:function(){		//监听行事件 
			var checked = $('#Table_voucher_manage').getCheckedTrs();  
			$('#Table_voucher_manage_uselist').flexOptions({ 
				extParam:{
					voucherTopicId: checked[0].voucherTopicId
				}
			}).flexReload();
		}
    }); 

    $('.vdiv .tDiv',wraper).before('<span style="margin:0 20px 0 14px;font-size:15px;float:left;line-height:60px;">代金券列表</span>');
    page_column_model_c.push({display: '代金券ID', name : 'voucherId'});
    page_column_model_c.push({display: '是否领取', name : 'isClaimedName'}); 
    page_column_model_c.push({display: '是否使用', name : 'isUsedName'});
    page_column_model_c.push({display: '领取时间', name : 'claimTime',diy:function(item,$div){
    	if(item.claimTime == '' || item.claimTime == undefined){
    		$div.html("--")
    	}else{
    		$div.html(item.claimTime)
    	}
    }});  
    page_column_model_c.push({display: '使用时间', name : 'usedTime',diy:function(item,$div){
    	if(item.usedTime == '' || item.usedTime == undefined){
    		$div.html("--")
    	}else{
    		$div.html(item.usedTime)
    	}
    }}); 
    page_column_model_c.push({display: '领取用户昵称', name : 'nickName',diy:function(item,$div){
    	if(item.nickName == '' || item.nickName == undefined){
    		$div.html("--")
    	}else{
    		$div.html(item.nickName)
    	}
    }}); 
    page_column_model_c.push({display: '使用服务', name : 'serviceName',diy:function(item,$div){
    	if(item.serviceName == '' || item.serviceName == undefined){
    		$div.html("--")
    	}else{
    		$div.html(item.serviceName)
    	}
    }}); 
    page_column_model_c.push({display: '使用商家', name : 'businessRegName',diy:function(item,$div){
    	if(item.businessRegName == '' || item.businessRegName == undefined){
    		$div.html("--")
    	}else{
    		$div.html(item.businessRegName)
    	}
    }}); 

    $('#Table_voucher_manage_uselist').flexigrid({
        reload:true,
        autoload: false,
		method:'get',
		onError:showError,
		pagination: {diaplay_pages: 10,align:'bottom',showText: '从第_start_到_end_项 共_total_项'},
        colModel : page_column_model_c,
        buttons : page_list_buttons_c,
        dataType: 'json',
        searchitems: [],
		showSearch:true, 
		showCheckbox:false, 
        url:'/vip-ws/ws/0.1/voucherVip/queryVouchersByTopic', //此时userId为当前登录用户的ID 
        pagedStyle: 'oc'
    });

    $('.udiv .tDiv',wraper).before('<span style="margin:0 20px 0 14px;font-size:15px;float:left;line-height:60px;">领取用户列表</span>');
    $('.hDiv',wraper).css('overflow','hidden');
    $('.bDiv',wraper).css('overflow-x','scroll');

    function getServiceSonNode(node,val,wraper){   
		var label = "";
		var serviceClass = "";
		if(node==1){
			label = "一级";
			serviceClass = "firstService"; 
			$("#Form_voucher_manage .addService").parents(".grid-row-fluid").remove();
		}else if(node==2){
			label = "二级";
			serviceClass = "secondService"; 
			$("#Form_voucher_manage div[name='secondService']").parents(".grid-row-fluid").remove();
			$("#Form_voucher_manage div[name='thirdService']").parents(".grid-row-fluid").remove();
		}else if(node==3){
			label = "三级";
			serviceClass = "thirdService";
			$("#Form_voucher_manage div[name='thirdService']").parents(".grid-row-fluid").remove();
		}else if(node==4){
			label = "四级";
			serviceClass = "fourService";
			$("#Form_voucher_manage div[name='fourService']").parents(".grid-row-fluid").remove();
		}
		if(val!=""){
			var item = $.jRadGetDataSources('/vip-ws/ws/0.1/business/getServiceListByShopId?parentId='+val+'&level='+node+'&shopAccountId='+carsmart_config.shopId,"serviceId","serviceName");
			if(item.length>0){
				item.unshift({id:'',name:'请选择'}); 
				var row = '<div class="grid-row-fluid">'
							+'<label class="span5 grid-layout-label">'+label+'：</label>'
							+'<div class="span8 grid-layout-content">'
							+'<div name="'+serviceClass+'" class="jrad-select-container service addService"></div>'
							+'</div>'
							+'</div>' ; 
				if(node==1){
					$("#Form_voucher_manage .servicesDiv .grid-row-fluid:eq(0)",wraper).after(row);
				}else if(node==2){
					$("#Form_voucher_manage .servicesDiv .grid-row-fluid:eq(1)",wraper).after(row);
				}else if(node==3){
					$("#Form_voucher_manage .servicesDiv .grid-row-fluid:eq(2)",wraper).after(row);
				}else if(node==4){
					$("#Form_voucher_manage .servicesDiv .grid-row-fluid:eq(3)",wraper).after(row);
				}
				node++; 
				$('#Form_voucher_manage div[name='+serviceClass+']').select({
					data:item,
					unshiftData: {id:'',name:'请选择'}, 
					onchange: function(val){ 
						getServiceSonNode(node,val,wraper); 
					} 
				});
			}
		}
	}

	function showError(){
		var checked=$('#Table_voucher_manage').getCheckedTrs();
		if(checked.length==0){
			$('#Table_voucher_manage_uselist').flexMessage('请先选择代金券主题',"error");
		}
	}
});
</script>