<style type="text/css">
   .shopCheckRow .ui-checkbox{
        display: block;
    }
    .cDiv table tr td, .cDiv table tr th{text-align:center;}
</style>
<div class="urlContentWraper" id="Wraper_dinner_manage">
	<!-- 列表显示 -->
    <div class="ui-info-layout">
        <table id="Table_dinner_manage">
        </table>
	</div>
	<div id="Form_dinner_manage" class="grid-layout ui-form" style="display:none">
		<div class="grid-layout-main jrad-form">
			<!-- <input type="hidden" name="dinnerId"/> -->
		    <div class="grid-row-fluid branch_detailHide"> 
                <label class="span5 grid-layout-label">
                    分店是否通用：
                </label>
                <div class="span8 grid-layout-content fluid-wrap">
                    <div data-name="isCommon" class="jrad-radio-container">
                    </div>
                </div>
            </div>	
            <div class="grid-row-fluid shopCheckRow" style="display:none;"> 
				<label class="span5 grid-layout-label">
					分店：
				</label>
				<div class="span16 grid-layout-content fluid-wrap">
					<div data-name="busiIds" class="jrad-checkbox-container">
					</div>
				</div>
			</div> 
			<div class="grid-row-fluid">
				<label class="span5 grid-layout-label">
				<span class="ui-form-required">*</span>
					套餐主题：
				</label>
				<div class="span8 grid-layout-content fluid-wrap">
					<div data-name="name" class="jrad-textarea-container" placeholder="您可以参照以下格式：漆面养护套餐：洗车、手工上蜡、玻璃滑水镀膜、臭氧负离子消毒">
					</div>
				</div>
			</div>
			<div class="grid-row-fluid">
				<label class="span5 grid-layout-label">
				<span class="ui-form-required">*</span>
					门市价：
				</label>
				<div class="span8 grid-layout-content fluid-wrap">
					<div data-name="shopPrice" class="jrad-input-container">
					</div>
                    <p style="color:#999;">用户直接上门购买需要付出的价格</p>
				</div>
			</div>
            <div class="grid-row-fluid">
                <label class="span5 grid-layout-label">
                <span class="ui-form-required">*</span>
                    预订价：
                </label>
                <div class="span8 grid-layout-content fluid-wrap">
                    <div data-name="reservePrice" class="jrad-input-container">
                    </div>
                    <p style="color:#999;">用户在养车宝购买实际支付的优惠价，一般需要低于门市价，养车宝默认按照预订价与商户结算。</p>
                </div>
            </div>
            <div class="grid-row-fluid">
                <label class="span5 grid-layout-label">
                <span class="ui-form-required">*</span>
                    套餐分类：
                </label>
                <div class="span18 grid-layout-content fluid-wrap">
                    <div data-name="offerServiceId" class="jrad-radio-container">
                    </div>
                     <p style="color:#999;">APP上显示的分类</p>
                </div>
            </div>
            <div class="grid-row-fluid">
                <label class="span5 grid-layout-label">
                <span class="ui-form-required">*</span>
                    使用开始时间：
                </label>
                <div class="span8 grid-layout-content fluid-wrap">
                    <div data-name="startTime" class="jrad-dateinput-container">
                    </div>
                </div>
            </div>
            <div class="grid-row-fluid">
                <label class="span5 grid-layout-label">
                <span class="ui-form-required">*</span>
                    使用结束时间：
                </label>
                <div class="span8 grid-layout-content fluid-wrap">
                    <div data-name="endTime" class="jrad-dateinput-container">
                    </div>
                </div>
            </div>
            <div class="grid-row-fluid">
                <label class="span5 grid-layout-label">
                <span class="ui-form-required">*</span>
                    预约信息：
                </label>
                <div class="span18 grid-layout-content fluid-wrap">
                    <div data-name="reserveInfo" class="jrad-select-container">
                    </div>
                </div>
            </div>
            <div class="grid-row-fluid">
                <label class="span5 grid-layout-label">
                <span class="ui-form-required">*</span>
                    使用规则：
                </label>
                <div class="span18 grid-layout-content fluid-wrap">
                    <div data-name="useRole" class="jrad-textarea-container" placeholder="您可以参照以下格式：团购券使用时段：8:30-17:30；只适用于7座以下非运营车型，每个车牌号最多使用一张团购券，不再与其他优惠同享，团购券请于到店时出示；如需代金券发票，请您在消费时向商户提出。">
                    </div>
                </div>
            </div>
            <div class="grid-row-fluid">
                <label class="span5 grid-layout-label">
                <span class="ui-form-required">*</span>
                    服务说明：
                </label>
                <div class="span18 grid-layout-content fluid-wrap">
                    <div data-name="illustrate" class="jrad-mediaarea-container">
                    </div>
                </div>
            </div>
        </div>
		<div class="jrad-buttons-container ui-buttons-container detailHide">
            <button class="jrad-btn-primary btn btn-small btn-primary">
                确定
            </button>
            <button class="jrad-btn-normal btn btn-small btn-default">
                取消
            </button>
        </div>
		<div id="dinner_check_reason" style="display:none;">
			<p class="reason">	</p>
		</div>
	</div> 
</div>
<script type="text/javascript">
$(document).ready(function() {
	var wraper = $('#Wraper_dinner_manage');
	var parentId = carsmart_config.shopId;
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array(); 
    var entityModel = {};
    var rescueServices = [];
    var _dinner = $.jRadGet({
        url: '/vip-ws/ws/0.1/shopAccountBack/listRescueService'
    });
    $.each(_dinner.rescueServices,
    function(index, vo) {
        var __id = vo['rescueServiceId'];
        var __name = vo['rescueServiceName'];
        var __tm = {
            'id': __id,
            'name': __name
        };
        rescueServices.push(__tm);
    });
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel});  
    jRad.validators['illustrate'] = [{msg:"服务说明不能为空",type:'min',value:'1'}]; 
	var fields_params = {};
    fields_params['isCommon']={
        data:[{id:'0',name:'否'},{id:'1',name:'是'}],
        onclick:function(){  
            if($("div[data-name='isCommon']",wraper).radio('val')=='0'){ 
                $(".shopCheckRow",wraper).hide();
            }else{
                $("div[data-name='busiIds']",wraper).checkbox('val','');
                $(".shopCheckRow",wraper).show();
            }
        }
    };
    fields_params['offerServiceId']={data:[{id:'1',name:'洗车'},{id:'2',name:'美容'},{id:'3',name:'保养'},{id:'4',name:'维修'}]};
    var reserveInfoSelect = $.jRadGetDataSources('/vip-ws/ws/0.1/datadictionary/dictionarylist?type=reserve_info','id','name'); 
    fields_params['reserveInfo'] = {
        data:reserveInfoSelect
    };
    fields_params['illustrate'] = {
        theme:"Full",
        resizing: false, 
        grid: 24, 
        height: 200,
        uploadImg: { //上传图片参数 
            url :'/vip-ws/ws/0.1/file/upload', 
            filename:"file",
            params: {type:""},
            note: '仅支持 JPG图片文件，且建议大小小于20M,宽高不能小于180*135。',
            beforeSubmit: function(obj){
                var re = /^.*\.(jpg|JPG)$/;
                if(re.test(obj.val())){
                    return true;
                }else{  
                    $.jRadAlert("只能上传jpg文件", "error");
                    return false;
                }
            },
            validator : [{
                msg : "请选择要上传的文件",
                type : "min",
                value : "1"
            }],
            error:function(data){
                 $.jRadAlert(data,"error"); 
            },
            show:true,
            showLarge:true,
            single:true,
            prev:'large'    
        }
    };
    var branchShopList = $.jRadGetDataSources('/vip-ws/ws/0.1/shopAccountBack/getBranchShopList?shopAccountId='+carsmart_config.shopId+'&hasmain=false','businessInfoId','shopName'); 
    if(carsmart_config.shopId != carsmart_config.parentId){
        $(".branch_detailHide",wraper).remove();
    }
    fields_params['busiIds'] = {
        data:branchShopList,
        selectAll:true
    };
    $('#Form_dinner_manage').form({
        grid:20,
        fluid: false,
        item:{},
        validators: jRad.validators,
        fields: fields_params,
        autobinding:true 
    });
    page_column_model.push({display: '套餐主题', name : 'name'});
    page_column_model.push({display: '门市价', name : 'shopPrice'}); 
    page_column_model.push({display: '预订价', name : 'reservePrice'});
    page_column_model.push({display: '使用开始时间', name : 'startTime'});
    page_column_model.push({display: '使用结束时间', name : 'endTime'}); 
    page_column_model.push({display: '审核状态', name : 'auditStatusName',width:200,diy:function(item,$div){
		if(item.auditStatusName=='审核驳回'){
			var $reason = $("<a>").addClass('flexOperate').html("点击查看原因");
			$div.html(item.auditStatusName+"&nbsp;&nbsp;&nbsp;&nbsp;").append($reason);
			$reason.click(function(){ 
				$("#dinner_check_reason .reason",wraper).html(item.auditDesc);
				$("#dinner_check_reason",wraper).dialog('open'); 
			});
		}else {
			$div.html(item.auditStatusName);
		}
	}}); 
    page_column_model.push({display: '操作', name : 'modify',width:200,diy:function(item,$div){ 
        var _detail=$("<a>").addClass("detail_dinner").attr({href:"javascript:void(0);"}).css("margin-right","5px").html("详情");  
        var preview=$("<a>").addClass("preview").attr({href:item.illustrateUrl,target:'_blank'}).css("margin-right","5px").html("预览服务内容"); 
        var deldinner=$("<a>").addClass("del_dinner").attr({href:"javascript:"}).html("删除");  
        $div.html(_detail); 
        $div.append(preview);
        $div.append(deldinner);
        $("a.detail_dinner",$div).bind('click',function(){
            var _item = $ .jRadGet({url : '/vip-ws/ws/0.1/dinner/getDinnerById?dinnerId='+item.dinnerId+'&businessInfoId='+carsmart_config.businessInfoId});  
            if(_item.isCommon=="1"){
                $("#Form_dinner_manage .shopCheckRow").show(); 
            }  
            _item.busiIds = _item.busiIds.split(',');
            $("#Form_dinner_manage").form({
                title: '详情',
                item:_item 
            }).form('open'); 
            $(".jrad-buttons-container").hide();
        });     
        $("a.del_dinner",$div).bind('click',function(){ 
            $.jRadConfirm('确认删除？', 1,
            function() {
                $.jRadPost({
                    url:'/vip-ws/ws/0.1/dinner/deleteDinner?dinnerId='+item.dinnerId+'&businessInfoId='+carsmart_config.businessInfoId, 
                    success:function(){ 
                        $('#Table_dinner_manage').flexMessage('删除成功!', 'success');
                        $('#Table_dinner_manage').flexReloadSearch();  
                    },error:function(xhr){
                        var errormsg = eval("(" + xhr.responseText + ")"); 
                        if (errormsg != undefined) {
                            $('#Table_dinner_manage').flexMessage(errormsg[0].message, 'error');
                        }
                    }
                });
            });
        });
    }});
   
   
    page_list_buttons.push({
        title: '新增',
		displayname:'新增',
        bclass: 'icon-plus',
        onpress: function() { 
            $(".shopCheckRow",wraper).hide();
			// $(".branch_detailHide",wraper).show();
            $('#Form_dinner_manage').form({
                title: '新增',
                item:{'isCommon':'0','illustrate':'套餐包含：'},
				validators: jRad.validators, 
				url:'/vip-ws/ws/0.1/dinner/addDinner',
                preSubmit:function(json){
                    json.busiIds = json.busiIds.join(",");
                    json.businessInfoId=carsmart_config.businessInfoId; 
                    return json;
                },
                success: function() {
                    $('#Table_dinner_manage').flexMessage('创建成功', 'success','3');
                    $('#Table_dinner_manage').flexReload();
                }
            }).form('open');
            $(".jrad-buttons-container").show();
        }
    });

    $('#Table_dinner_manage').flexigrid({
        reload: true,
        grid:40,
        pagination: {diaplay_pages: 10,align:'bottom',showText: '从第_start_到_end_项 共_total_项'},
        colModel: page_column_model,
        buttons: page_list_buttons,
        searchitems: page_search_items,
        pagedStyle: 'oc',
		method:'get',
		showSearch:true,
        showCheckbox:false,
        url:'/vip-ws/ws/0.1/dinner/queryDinners?businessInfoId='+carsmart_config.businessInfoId,      
        overflow:true 
    }); 
    
    $('.tDiv',wraper).before('<span style="margin:0 20px 0 14px;font-size:15px;float:left;line-height:60px;">套餐列表</span>');
    $('.hDiv',wraper).css('overflow','hidden');
    $('.bDiv',wraper).css('overflow-x','scroll');
	$("#dinner_check_reason",wraper).dialog({
		title: '驳回原因',
		grid: 15, 
		buttons: false
	}); 
});
</script>