<style type="text/css">
    #Wraper_out_table .hDivBox table th,#Wraper_out_table .hDivBox table td,
    #Table_out_table th,#Table_out_table td,
    #Table_putInstorage th,#Table_putInstorage td
    {
        text-align:center;
    }

    .page{
      float: right;
      margin-right: 25.8%;
      margin-top: 10px;
    }

    .page a{
        text-decoration:none;
    }
    .page a span{
      padding:4px 16px 4px 16px;
      border:1px solid #AAAAEE;
      color: #1155BB;
      font-size:12px;
      font-weight:bold;
      font-family: 'helvetica neue', arial, sans-serif;
    }

    .page a span:hover,.click_page{
      background:#2266BB;
      color:#ffffff;
     }

     #Table_out_goods th, #Table_out_goods td{
        text-align: center;
     }
</style>

<div class="urlContentWraper" id="Wraper_out_table">
    <div class="ui-info-layout" id="jrad-table">
        <div class="vdiv">
            <table id="Table_out_table"></table>
        </div>
    </div>

    <div class="grid-layout ui-form"  style="display:none;" id="Form_outInfo">
        <div class="jrad-form">  
            <div class="grid-layout-main">
                <h2 id="return" style="float:right;margin-right: 10px;" class="icon-reply"><a style="color: #383737">返回</a></h2>
                <h2 style="margin-left: 50px;clear: both;">基本信息</h2>
                <div class="grid-row-fluid">
                    <label class="span8 grid-layout-label">订单号：</label>
                    <div class="span10 grid-layout-content">
                     	<div name="code" style="margin-top: 5px;"></div>
                    </div>
                </div>
                <div class="grid-row-fluid">
                    <label class="span8 grid-layout-label">出库库房：</label>
                    <div class="span10 grid-layout-content">
                       <div name="storageName" style="margin-top: 5px;"></div>
                    </div>
                </div>
                <div class="grid-row-fluid">
                    <label class="span8 grid-layout-label">出库类型：</label>
                    <div class="span10 grid-layout-content">
                       <div name="storageTypeName" style="margin-top: 5px;"></div>
                    </div>
                </div>
                <div class="grid-row-fluid">
                    <label class="span8 grid-layout-label">出库时间：</label>
                    <div class="span10 grid-layout-content">
                       <div name="orderDate" style="margin-top: 5px;"></div>
                    </div>
                </div>  
                <h2 style="margin-left: 50px;">出库商品</h2>
                <div class="grid-row-fluid">
                    <table id="Table_out_goods" style="width: 800px;margin: 0 auto;">
                        <thead>
                            <tr>
                                <th>商品编号</th>
                                <th>商品名称</th>
                                <th>品牌</th>
                                <th>规格</th>
                                <th>单位</th>
                                <th>数量</th>
                                <th>单价</th>
                                <th>金额</th>
                            </tr>
                        </thead>
                    </table>
                </div>                          
            </div>
        </div>
	</div>
</div>

<script type="text/javascript">
	
	$(function(){
		var wraper = $('#Wraper_out_table');
        var parentId = carsmart_config.shopId;
        var page_column_model = new Array();
        var page_search_items = new Array();
        var page_list_buttons = new Array(); 
        var page_column_model_b = new Array(); 
        var entityModel = {};
        var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel});
        // fields: false, 初始化form中的组件
        var fields_params ={};

        jRad.params['storageTypeId'] = {
            urlData:{
                url:'/vip-ws/ws/0.1/storageType/queryOutStorageTypelist?shopAccountId='+carsmart_config.shopId+"&status=2",
                id: 'id',       // 隐含值
                name: 'name',   // 展示值
                type: 'get',    // 请求方式
                dataType: 'json'              
            },
            unshiftData:{id:'',name:'请选择'}
        };



        page_search_items.push({row:'1',type:'jrad-input',display:'出库单号',name:'orderCode'});
        page_search_items.push({row:'1',type:'jrad-select',display:'出库状态',name:'orderStatus',params:
            {data:[
                {"id":"2","name":"全部"},
                {"id":"1","name":"完成"},
                {"id":"0","name":"取消"},
                {"id":"3","name":"待出库"}]
            }
    	});
        page_search_items.push({row:'1',type:'jrad-select',display:'出库类型',name:'storageTypeId',
            params:jRad.params['storageTypeId']
        });
    	page_search_items.push({row:'2',type:'jrad-daterange',display:'订单生成时间',name:'data',grid:7}); 


 		page_column_model.push({display: '出库单号', name : 'code',diy:function(item,$div){
            var _span = $("<a>"+item.code+"</a>");
            $div.append(_span);
            var _id=item.id;
            _span.click(function(){
                $("#Form_outInfo").show();
                information(item);
                var dtails = $.jRadGet({url:'/vip-ws/ws/0.1/transferOrder/querydeliveryTransferOrderById?orderId='+item.id});
                $('#Form_outInfo div[name="code"]',wraper).html(dtails.code);
                $('#Form_outInfo div[name="storageName"]',wraper).html(dtails.storageName);
                $('#Form_outInfo div[name="storageTypeName"]',wraper).html(dtails.storageTypeName);
                $('#Form_outInfo div[name="orderDate"]',wraper).html(dtails.orderDate);


                $.jRadGet({
                    url:'/vip-ws/ws/0.1/transferOrder/querydeliveryTransferOrderById?orderId='+item.id,
                    success:function(data){                      
                        var str="";
                        $.each(data.commodityJsonArray,function(i){
                            var _item=data.commodityJsonArray[i];
                            $("#Table_out_goods").find("tbody").children().remove();
                            str+="<tr>"
                                +"<td>"+_item.commodityCode+"</td>"
                                +"<td>"+_item.commodityNname+"</td>"
                                +"<td>"+_item.brand+"</td>"
                                +"<td>"+_item.norms+"</td>"
                                +"<td>"+_item.salesUnit+"</td>"
                                +"<td>"+_item.amount+"</td>"
                                +"<td>"+_item.salePrice+"</td>"
                                +"<td>"+_item.totalMoney+"</td>"
                                +"</tr>";
                        });
                        $("#Table_out_goods",wraper).append(str);
                        TablePage("#Table_out_goods",10);
                        $(".grid-row-fluid .page").eq(1).css("display","none") 
                    }
                })
            })
        }
    });
 		page_column_model.push({display: '出库类型', name : 'storageTypeName'});
 		page_column_model.push({display: '出库库房', name : 'storageName'});
 		page_column_model.push({display: '出库金额', name : 'totalMoney'});
                         page_column_model.push({display: '出库状态', name : 'orderStatusName'});
 		page_column_model.push({display: '出库时间', name : 'orderDate'});
 		page_column_model.push({display: '操作',width:200,name : 'operate',
 			diy:function(item,$div){
 				var $cancel = $("<a>").addClass('flexOperate').html("取消");
 				var $print = $("<a>").addClass('flexOperate').html("打印入库单");
 				var $view = $("<a>").addClass('flexOperate').html("出库详情");
                                                    var _id=item.id;
 				$div.append($view); 
                                                    if(item.orderStatusName != "取消"){
     				$.each(item,function(i){
                                                        function currentTime(){
                                                            var d = new Date(),str = '';
                                                            str += d.getFullYear()+'-';
                                                            str  += d.getMonth() + 1+'-';
                                                            str  += d.getDate()+' ';
                                                            str += d.getHours()+':'; 
                                                            str  += d.getMinutes()+':'; 
                                                            str+= d.getSeconds(); 
                                                            return str;
                                                    }
                                                    function Days1(day1, day2){
                                                        var y1, y2, y3, m1, m2, m3, d1, d2, d3, h1, h2, h3, _m1, _m2, _m3, s1, s2, s3;
                                                        var reg = /年|月|日 |\/|:|-| /;
                                                        //dayinfo -  用正则分割
                                                        var DI1 = day1.split(reg);
                                                        var DI2 = day2.split(reg);
                                                        var date1 = new Date(DI1[0], DI1[1], DI1[2], DI1[3], DI1[4], DI1[5]);
                                                        var date2 = new Date(DI2[0], DI2[1], DI2[2], DI2[3], DI2[4], DI2[5]);
                                                        //用距标准时间差来获取相距时间
                                                        var minsec = Date.parse(date1) - Date.parse(date2);
                                                        var days = minsec / 1000 / 60 / 60 / 24; //factor: second / minute / hour / day
                                                        return days;
                                                    }
                                                    var str1 = currentTime().toString();
                                                    var str2 = item.orderDate;
                                                   if(str2 !=undefined){
                                                        var poor=Days1(str1, str2);
                                                        if(poor<1 && item.storageTypeName != "开单出库"){
                                                            $div.append($cancel)
                                                        }
                                                   }
                                                })
                                            }

        	$view.click(function(){
        		$("#Form_outInfo").show();
        		information(item);
        		var dtails = $.jRadGet({
                    url:'/vip-ws/ws/0.1/transferOrder/querydeliveryTransferOrderById?orderId='+item.id+"&shopAccountId="+carsmart_config.shopId
                });
                $('#Form_outInfo div[name="code"]',wraper).html(dtails.code);
                $('#Form_outInfo div[name="storageName"]',wraper).html(dtails.storageName);
                $('#Form_outInfo div[name="storageTypeName"]',wraper).html(dtails.storageTypeName);
                $('#Form_outInfo div[name="orderDate"]',wraper).html(dtails.orderDate);


                $.jRadGet({
                    url:'/vip-ws/ws/0.1/transferOrder/querydeliveryTransferOrderById?orderId='+item.id+"&shopAccountId="+carsmart_config.shopId,
                    success:function(data){                      
                        var str="";
                        $("#Table_out_goods").find("tbody").children().remove();
                        $.each(data.commodityJsonArray,function(i){
                            var _item=data.commodityJsonArray[i];
                            str+="<tr>"
                                +"<td>"+_item.commodityCode+"</td>"
                                +"<td>"+_item.commodityNname+"</td>"
                                +"<td>"+_item.brand+"</td>"
                                +"<td>"+_item.norms+"</td>"
                                +"<td>"+_item.salesUnit+"</td>"
                                +"<td>"+_item.amount+"</td>"
                                +"<td>"+_item.salePrice+"</td>"
                                +"<td>"+_item.totalMoney+"</td>"
                                +"</tr>";
                        });
                        $("#Table_out_goods",wraper).append(str);
                        TablePage("#Table_out_goods",10);
                        $(".grid-row-fluid .page").eq(1).css("display","none") 
                    }
                })
        	})

        	 $cancel.click(function(){
                $.jRadConfirm('确认取消吗？',1,function(){
                    var checked = $('#Table_out_table').getCheckedTrs();                    
                    var postData = {};
                    postData.orderId = item.id;
                    postData.shopAccountId=carsmart_config.shopId;  
                    $.jRadAjax({
                        type:'post',
                        data:postData,
                        url:'/vip-ws/ws/0.1/transferOrder/cancelTransferOrder', 
                        success: function(){
                            $('#Table_out_table').flexReload();
                        },
                        error:function(xhr){
                            var errormsg = eval("(" + xhr.responseText + ")"); 
                            if (errormsg != undefined) {
                                $('#Table_out_table').flexMessage(errormsg[0].message, 'error');
                            }
                        }
                    });

                }); 
            });
	            
 			},width:150});
 		

        $('#Table_out_table').flexigrid({
            reload: true,   //是否有刷新按钮
            pagination: {diaplay_pages: 10,align:'bottom',showText: '从第_start_到_end_项 共_total_项'},   //是否分页
            colModel: page_column_model,
            searchitems: page_search_items,   //设置查询条件
            buttons : page_list_buttons,      //操作按钮
            pagedStyle: 'oc',        //请求分页参数格式 默认OC ，RAD GRID
            method:'get',
            showSearch:true,      //设置是否默认显示高级查询
            showCheckbox: false,   //是否加复选框
            overflow:true,        //当数据的宽度大于屏幕宽度时，是否显示横向滚动条。false：表示不显示 true:表示显示
            checkBoxType:'single', //表格但多选，默认空串（多选），如果 'single'单选
            onError:showError2,
            url:'/vip-ws/ws/0.1/transferOrder/querydeliveryOrderList?shopAccountId='+carsmart_config.shopId
            
        });
        $('.tDiv',wraper).before('<span style="margin:0 20px 0 14px;font-size:16px;float:left;line-height:60px;">出库单列表</span>');

        function showError2(xhr){
            var errormsg = eval("(" + xhr.responseText + ")");
            var vdiv = $("#Wraper_out_table .vdiv");
            $.jRadMessage({level:'error',message:errormsg[0].message,selector:vdiv});
        }

        function information(item){
            $('#jrad-table',wraper).hide();
            $('.details-box',wraper).show(); 
        }

        $('#return').click(function(){
            $('#jrad-table',wraper).show();
            $('.details-box',wraper).hide(); 
            $('#Form_outInfo').hide();
        })

        // 分页函数
        function TablePage(id,size){
           var $table = $(id);
            var currentPage = 0;  //当前页
            var pageSize = size;  //每页行数（不包括表头）
            $table.bind("repaginate", function()
            {
               //console.log($table.find("tbody tr").eq(0));
              $table.find("tbody tr").hide().slice(currentPage * pageSize, (currentPage + 1) * pageSize).show();
             // $table.find("tbody tr").eq(0).show();
            });
            var numRows = $table.find("tbody tr").length;  //记录宗条数
            var numPages = Math.ceil(numRows/pageSize);    //总页数
            //console.log(numPages);
            var $pager = $("<div class='page'><a href='javascript:void(0)'><span id='Prev' style='margin-right:4px;'>« Prev</span></a></div>");  //分页div
            for( var page = 0; page < numPages; page++ )
            {

              //为分页标签加上链接
              //if(page==0){$("<a href='javascript:void(0)'><span id='1' class="click_page"></span></a>")}
              $("<a href='javascript:void(0)'><span id='"+(page+1)+"'>"+ (page+1) +"</span></a>")
                   .bind("click", { "newPage": page }, function(event){
                        currentPage = event.data["newPage"];
                        //console.log($(this).children("span"));
                        $(this).children("span").attr("class","click_page");
                        $(this).children("span").css({"color":"#FFFFFF"});
                        $(".page a span").not($(this).children("span")).attr("class","");
                        $(".page a span").not($(this).children("span")).css({"color":"#1155BB"});
                        $table.trigger("repaginate");
                    })
                    .appendTo($pager);

                $pager.append("  ");
            }
            //$table.trigger("repaginate");
            var next=$("<a href='javascript:void(0)'><span id='Next'>Next »</span></a>");
            $pager.append(next);
            $pager.insertAfter($table);//分页div插入table
            $("#1").attr("class","click_page");
            $("#1").css({"color":"#FFFFFF"});
            $table.trigger("repaginate");
            //console.log($("#1"));
            //$("#1").attr("class","click_page");
            //$("#1").css({"background":"#FFFFFF"});
            $("#Prev").bind("click",function(){
               var prev=Number($(".click_page").text())-2;
               currentPage=prev;
               $(this).css({"background":"#000000"});
               if(currentPage<0) {
                 $(this).css({"background":"#c0c0c0"});
                 return;
         }
               $("#"+(prev+1)).attr("class","click_page");
               $("#"+(prev+1)).css({"color":"#FFFFFF"});
               $(".page a span").not($("#"+(prev+1))).attr("class","");
               $(".page a span").not($("#"+(prev+1))).css({"color":"#1155BB"});
               //console.log(currentPage);
               $table.trigger("repaginate");
            });
             $("#Next").bind("click",function(){
               var next=$(".click_page").attr("id");
               currentPage=Number(next);
               //console.log($(".click_page").text());
               $(this).css({"background":"#FFFFFF"});
               if((currentPage+1)>numPages) {
                 $(this).css({"background":"#c0c0c0"});
                 return;
                 }
               $("#"+(currentPage+1)).attr("class","click_page");
               $("#"+(currentPage+1)).css({"color":"#FFFFFF"});
               $(".page a span").not($("#"+(currentPage+1))).attr("class","");
               $(".page a span").not($("#"+(currentPage+1))).css({"color":"#1155BB"});
               $table.trigger("repaginate");
            });
        }

	})

</script>