<div class="urlContentWraper" id="Wraper_unusual_order"> 
	<div class="row-fluid ui-data-show"> 
			<div class="hDiv">
				 <h2 class="ui-tit"><strong>异常商家列表</strong><bottom class="all-work-info numb53">页面说明</bottom></h2>
				 <table id="Table_unusual_order"></table>
			</div> 
			<div class="bDiv">
				<br/>
				 <h2 class="ui-tit"><strong>商家订单列表</strong></h2> 
				<table id="Table_shopOrder_list"></table>
			</div> 
    </div> 
	
    <div id="Form_set_rule" style="display:none;">
        <div class="grid-layout-main jrad-form">  
			<div class="row"> 
				<label class="span4 grid-layout-label"> 
					(第二天生效)预警天数：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div name="warnDay" class="jrad-input-container">
					</div> 
				</div>
			</div>
			<div class="row"> 
				<label class="span4 grid-layout-label"> 
					订单数不低于：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div name="orderMinCnt" class="jrad-input-container">
					</div> 
				</div>
			</div>
			 <div class="row">
				 <label class="span4 grid-layout-label">手机标识重复度不低于：</label>
				 <div class="span5 grid-layout-content fluid-wrap">
					   <div name="imeiUuidRepaMinRate" class="jrad-input-container"></div>
				 </div>
			</div>
			<div class="row">
				<label class="span4 grid-layout-label"> 
					支付重复度不低于：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div class="jrad-input-container" name="payRepaMinRate">
					</div>
				</div>
			</div>
			<div class="row">
				<label class="span4 grid-layout-label"> 
					余额支付比例不低于：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div class="jrad-input-container" name="balanceMinRate">
					</div>
				</div>
			</div>
			<div class="row"> 
				<label class="span4 grid-layout-label fluid-wrap"> 
					老用户下单比例不低于：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div name="oldUserRate" class="jrad-input-container">
					</div>
				</div>
			</div> 
			<div class="row"> 
				<label class="span4 grid-layout-label fluid-wrap"> 
					城市异常订单数不低于：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div name="cityUnusualCnt" class="jrad-input-container">
					</div>
				</div>
			</div> 
			<div class="row"> 
				<label class="span4 grid-layout-label fluid-wrap"> 
					未开定位订单比例不低于：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div name="unLocationRate" class="jrad-input-container">
					</div>
				</div>
			</div> 
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span>
			<span class="jrad-btn-normal">取消</span>
        </div>
    </div>
    <div id="Form_set_remark" style="display:none;">
        <div class="grid-layout-main jrad-form">
        	<input type="hidden" name="id" >   
			<div class="row"> 
				<label class="span3 grid-layout-label  fluid-wrap"> 
					添加备注：
				</label>
				<div class="span11 grid-layout-content fluid-wrap">
					<div name="remark" class="jrad-textarea-container">
					</div> 
				</div>
			</div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span>
			<span class="jrad-btn-normal">取消</span>
        </div>
    </div>
    <div id="Form_explain_eg53" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                <label class="span3 grid-layout-label">业务说明：</label>
                <div class="span12 grid-layout-content">
                    <div><strong>功能简介：</strong>订单防刷功能，按照设置的规则，筛选出有刷单嫌疑的商家。</div>
                    <div><strong>重要功能说明：</strong>无。</div>
                    <div><strong>注意事项：</strong>无。</div>
                </div> 
            </div> 
            <div class="row">
                <label class="span3 grid-layout-label">备注：</label>
                <div class="span12 grid-layout-content">
                    <div class="jrad-textarea-container" name="remark">
                    </div>
                </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div> 
</div>
<script type="text/javascript">
$(document).ready(function(){
	var ExchangeCodeId = "";
    var wraper = $('#Wraper_unusual_order');
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array(); 
	
	var page_column_model_c = new Array(); 
	var page_list_buttons_c = new Array();
	
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel}); 
    jRad.validators['zeroService'] = [{"msg":"绑定服务不能为空","type":"min","value":"1"}]; 

	jRad.validators['remarks'] = [{"msg":"内容超长","type":"max","value":"2000"}];  
	var fields_params = {}; 

	page_column_model.push({display: 'ID', name : 'id'}); 
    page_column_model.push({display: '商户ID', name : 'businessId'}); 
    page_column_model.push({display: '商户名称', name : 'businessName'}); 
    page_column_model.push({display: '订单数', name : 'orderCnt'}); 
    page_column_model.push({display: '订单用户数', name : 'userCnt'}); 
    page_column_model.push({display: '老用户下单占比', name : 'oldUserRate'}); 
    page_column_model.push({display: '手机标识重复度', name : 'imeiUuidRepateCnt'}); 
    page_column_model.push({display: '支付重复度', name : 'payBankRate'}); 
    page_column_model.push({display: '余额支付比率', name : 'balancePayrate'}); 
    page_column_model.push({display: '预警天数', name : 'warnDay'});  
    page_column_model.push({display: '城市异常订单数', name : 'unusualOrderCnt'});  
    page_column_model.push({display: '未定位订单比例', name : 'unLocationOrderRate'});  
    page_column_model.push({display: '更新时间', name : 'updateDateStr'});  
    page_column_model.push({display: '备注', name : 'remark'});  
   
   page_search_items.push({row:'1',type:'jrad-input',display:'商家ID',name:'businessInfoId'});
   page_search_items.push({row:'1',type:'jrad-input',display:'商家简称',name:'businessRegName'});
   page_search_items.push({row:'2',type:'jrad-dateinput',display:'更新开始时间',name:'updateStartDate',params:{'dateFmt':'yyyy-MM-dd HH:mm:ss'}}); 
   page_search_items.push({row:'2',type:'jrad-dateinput',display:'更新结束时间',name:'updateEndDate',params:{'dateFmt':'yyyy-MM-dd HH:mm:ss'}});   
 
   page_list_buttons.push({displayname: '规则设定',name:'setrule', bclass: 'setrule',onpress : function(){  
   			var json = $.jRadGet({url:'/shopmanage-ws/ws/0.1/orderWarn/getRule'})
			$('#Form_set_rule').form({
				type:'post',
                title: '规则设定',
               	item:json,
               	url:'/shopmanage-ws/ws/0.1/orderWarn/setRule',		
				success_callback:function(){ 
                            $('#Table_unusual_order').flexMessage('设置成功', 'success');
                            $('#Table_unusual_order').flexReload();
                } 
            }).form('open');  
        }
    }); 
	
	page_list_buttons.push({displayname: '添加备注', name:'remark', bclass: 'remark',prefunc:function(){
            var checked = $('#Table_unusual_order').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
        	var checked = $('#Table_unusual_order').getCheckedTrs();
        	$('#Form_set_remark textaea[name="remarks"]').attr("style","width:135px")
			$('#Form_set_remark').form({
        		fluid: true,
                title: '添加备注', 
                url:'/shopmanage-ws/ws/0.1/orderWarn/addRemark', 
				before_submit:function(json){
					json.id = checked[0].id;
					json.remark = json.remark;
				},
				success_callback:function(){ 
                            $('#Table_unusual_order').flexMessage('添加成功', 'success');
                            $('#Table_unusual_order').flexReload();
				} 
            }).form('open'); 
		}			
	});   

	page_list_buttons.push({displayname: '重算(谨慎使用)', name:'rerun', bclass: 'rerun',onpress : function(){
        	var checked = $('#Table_unusual_order').getCheckedTrs();
			$.jRadConfirm('确认要重算吗？',1,function(){
				$.jRadAjax({
				    type:'post',
					data:{operator:carsmart_config.operatorName},
					url:'/shopmanage-ws/ws/0.1/orderWarn/retryRecord', 
					success: function(){
						$('#Table_unusual_order').flexMessage('重算成功!', 'success');
           	    		$('#Table_unusual_order').flexReloadSearch();
					},
					error:function(xhr){
					    var errormsg = eval("(" + xhr.responseText + ")"); 
						if (errormsg != undefined) {
							$('#Table_unusual_order').flexMessage(errormsg[0].message, 'error');
						}
					}
				});
			}); 
		}			
	}); 
    page_list_buttons.push({separator: true});
    
    $('#Table_unusual_order').flexigrid({
            reload:true,
			method:'get',
            colModel : page_column_model,
            buttons : page_list_buttons,
            searchitems :page_search_items,
            pagination: {
				diaplay_pages: 5,
				align: 'bottom' 
			},
			overflow:true, 
            url:'/shopmanage-ws/ws/0.1/orderWarn/getOrderWarnStaticList', 
			onError:showError,
			checkBoxType:'single',
			trEvent:function(){		
				var checked = $('#Table_unusual_order').getCheckedTrs();
				$('#Table_shopOrder_list').flexOptions({ 
					url: '/shopmanage-ws/ws/0.1/orderWarn/getOrderWarnDetailList',
					extParam:{
						businessInfoId: checked[0].businessId,
						updateDate: checked[0].updateDateStr,
						warnDay : checked[0].warnDay
					}
				}).flexReload();
			}
    });  
	page_column_model_c.push({display: 'ID', name : 'id'});	
	page_column_model_c.push({display: '订单ID', name : 'orderNum'});	
	page_column_model_c.push({display: '商户名称', name : 'businessName'});
	page_column_model_c.push({display: '服务名称', name : 'serviceName'});
	page_column_model_c.push({display: '支付渠道', name : 'payChannelName'});
	page_column_model_c.push({display: '用户手机', name : 'mobile'});
	page_column_model_c.push({display: '用户手机imei', name : 'imei'});
	page_column_model_c.push({display: '用户手机uuid', name : 'uuid'});
	page_column_model_c.push({display: '支付信息', name : 'payBank'});  
	page_column_model_c.push({display: '历史下单数', name : 'orderCnt'});
    page_column_model_c.push({display: '用户城市', name : 'userCountryName'});  
    page_column_model_c.push({display: '商家城市', name : 'busiCountryName'});
	page_column_model_c.push({display: '预定时间', name : 'orderDate'}); 
	page_column_model_c.push({display: '服务时间', name : 'serviceDate'});   

 	page_list_buttons_c.push({displayname: '导出EXCEL',name:'excel', bclass: 'excel',onpress : function(){ 
		 $ .jRadConfirm('确认导出吗？',1,function(){
			 	var checked = $('#Table_unusual_order').getCheckedTrs();

			 	var businessInfoId = checked[0].businessId;
			 	var updateDate = checked[0].updateDateStr;
			 	var warnDay = checked[0].warnDay;
			 
				window.open('/shopmanage-ws/ws/0.1/orderWarn/exportWarnOrder?businessInfoId='+businessInfoId+'&updateDate='+updateDate+'&warnDay='+warnDay);
			}); 
        }
    });
	$('#Table_shopOrder_list').flexigrid({  
			colModel : page_column_model_c,
			buttons : page_list_buttons_c, 
			pagination: {
					diaplay_pages: 5,
					align: 'bottom'
			},
			overflow:true, 
			checkBoxType:'single',
			method:'get',
			pagedStyle: 'oc'	
	}); 
	$(".numb53").click(function(){
        $('.overcurtainDiv').hide();
        var menuId = $(".tabs-selected").attr("menuId")
        var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        $("#Form_explain_eg53").form({}).form('close');
        $("#Form_explain_eg53").form({
            title:'页面说明',
            item:data,
            autobinding: true, 
			submit:function(){
            	var postData = {};
                postData.operator = carsmart_config.operatorName;
                postData.menuName = $(".tabs-selected").attr("menuName");
                postData.menuId = $(".tabs-selected").attr("menuId");
                postData.remark = $("#Form_explain_eg53 div[name='remark']").textarea("val")
				$.jRadPost({
				    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
				    data:postData,
				    success:function(){
						$("#Form_explain_eg53").form('close')
      					$('.overcurtainDiv').hide();
				   	}
				});
			}, 
			cancel:function(){
				$("#Form_explain_eg53").form('close')
      			$('.overcurtainDiv').hide();
			}
        }).form('open')
        $("#Form_explain_eg53 .textarea-content").removeClass("span4").addClass("span12")
        $('.overcurtainDiv').hide();
        $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
    })     
	
});
function showError(xhr){
		 var errormsg = eval("(" + xhr.responseText + ")"); 
		  $.jRadMessage({level:'error',message:errormsg[0].message});
		} 
</script>
