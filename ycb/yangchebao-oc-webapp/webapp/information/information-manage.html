<div class="urlContentWraper" id="Wraper_info_manage">
	<div class="ui-info-layout">
		<div class="ui-info-layout-subbox "> 
			<div class="jrad-table">
		        <h2 class="ui-tit"><strong>资讯列表</strong><bottom class="all-work-info numb102">页面说明</bottom></h2>
		        <!-- 列表显示 -->
		        <table id="Table_info_manage"></table>
		    </div>
			<div class="details-box" style="display:none;">
					<ul class="details-tab">
						<li class="tab-cur tab-cur-first f-left"><span name="title">资讯信息</span></li>
						<li><span class="return"></span></li>
					</ul>
					<div class="details-content">
						<div class="details-scroll">
							<div class="details-content-inner">
								<div class="grid-layout ui-form" id="Form_infor_manage">
									<div class="jrad-form">  
										<div class="grid-layout-main">
										<input name="id" type="hidden"> 
										<input type="hidden" name="adPicId">
										<input type="hidden" name="adPicAddress">
										<input type="hidden" name="adPicMiddleAddress">
										<input type="hidden" name="adPicSmallAddress">
										<div name="brands"></div>
										<div name="regions"></div>
										<div class="row-fluid">
										 <label class="span3 grid-layout-label">标题：</label>
										 <div class="span5 grid-layout-content">
											   <div name="title" class="jrad-input-container"></div>
															</div>
										</div>
										<div class="row-fluid">
										 <label class="span3 grid-layout-label">标签：</label>
										 <div class="span5 grid-layout-content">
											   <div name="tag" class="jrad-input-container"></div>
															</div>
										</div> 
										<div class="row-fluid area">
											<label class="span3 grid-layout-label"> 绑定地域： </label>
											<div class="span14 grid-layout-content fluid-wrap">
												<div class="jrad-buttons-container" name="area_check_btn">
													<span id="jrad-button-area" class="jrad-primary">
														点击选择 </span>
												</div>
												<div id="area_check_string" style="margin: 10px 0;"></div>
											</div>
										</div>  
										<div class="row-fluid">
											<label class="span3 grid-layout-label"> 绑定车系： </label>
											<div class="span14 grid-layout-content fluid-wrap">
												<div class="jrad-buttons-container" name="brand_check_btn">
													<span id="jrad-button-brand" class="jrad-primary">
														点击选择 </span>
												</div>
												<p id="brand_check_string" style="margin: 10px 0;"></p>
											</div>
										</div>   
										<div class="row-fluid"> 
											 <label class="span3 grid-layout-label">绑定商家：</label>
											 <div class="span14 grid-layout-content fluid-wrap">
												<div class="jrad-buttons-container" >
													<span id="business_bind_button" class="jrad-primary">
														点击添加 </span>
												</div>
												<div id="business_bind_string" style="margin: 10px 0;"></div>
											</div>
										</div> 
										<div class="row-fluid">
											 <label class="span3 grid-layout-label">详情：</label>
											 <div class="span5 grid-layout-content">
												   <div name="content" class="jrad-mediaarea-container" style="margin-left:0"></div>
																</div>
										</div>
										<div class="row-fluid">
											 <label class="span3 grid-layout-label">缩略图：</label>
											 <div class="span5 grid-layout-content">
												   <div name="infoLitimgFile" class="jrad-uploadimg-container"> 
												   </div>
											 </div>
										</div>  
										<input type="hidden" name="infoPic"/>
										<input type="hidden" name="infoLitimg"/>
										<div class="row-fluid">
											 <label class="span3 grid-layout-label">摘要：</label>
											 <div class="span5 grid-layout-content">
												   <div name="summary" class="jrad-textarea-container"></div>
											 </div>
										</div> 
										<div class="row-fluid">
											 <label class="span3 grid-layout-label">资讯类型：</label>
											 <div class="span5 grid-layout-content">
												   <div name="informationTypeId" class="jrad-select-container"></div>
											 </div>
										</div> 
										<div class="row-fluid">
											 <label class="span3 grid-layout-label">状态：</label>
											 <div class="span5 grid-layout-content">
												   <div name="status" class="jrad-select-container"></div>
											 </div>
										</div>
										<div class="row-fluid syncInformationTypeId">
											 <label class="span3 grid-layout-label">同步资讯：</label>
											 <div class="span5 grid-layout-content">
												   <div name="syncInformationTypeId" class="jrad-select-container"></div>
											 </div>
										</div> 
										</div> 
									</div>
									<div class="jrad-buttons-container ui-buttons-container">
										<span class="jrad-btn-primary">确定</span> 
										<span class="jrad-btn-normal">取消</span>
									</div>
								</div>
							</div>
							
						</div>
					</div>
					<div class="details-content">
						<table id="Table_info_comment"></table>
					</div>
		    </div>
		</div>
	</div>

	<!--服务品牌--> 
	<div id="Form_service_brand" style="display:none;">
		<div class="grid-layout-main jrad-form"> 
			 <div class="jrad-tree" id="brandsTree">
			 </div>
			 <div class="jrad-checkbox-container" name="vendor" style="position:absolute;bottom:25px;font-weight:bold;"></div>
		</div>
		<div class="jrad-buttons-container ui-buttons-container"> 
			<span class="jrad-btn-primary">确定</span> 
			<span class="jrad-btn-normal">取消</span>
		</div>
	</div> 
	<!-- 地区选择-->
	<div id="Form_area" style="display:none;">
		<div class="grid-layout-main jrad-form"> 
			  <div class="row-fluid">
				<label class="span3 grid-layout-label"> 省：</label>
				<div class="span5 grid-layout-content">
					<div class="jrad-select-container" name="provinceId">
					</div>
				</div> 
				<label class="span3 grid-layout-label">	市：</label>
				<div class="span5 grid-layout-content">
					<div class="jrad-select-container" name="areaCodeId">
					</div>
				</div>
			</div> 
		</div>
		<div class="jrad-buttons-container ui-buttons-container"> 
			<span class="jrad-btn-primary">确定</span> 
			<span class="jrad-btn-normal">取消</span>
		</div>
	</div> 

	<!-- 绑定商家-->
	<div id="Form_business_bind" style="display:none;">
		<div class="grid-layout-main jrad-form"> 
			  <div class="row">
				<label class="span3 grid-layout-label"> 商家ID：</label>
				<div class="span8 grid-layout-content">
					<div class="jrad-input-container" name="id">
					</div>
					<span>绑定全部商家请填写 0 </span>
				</div>  
			</div> 
		</div>
		<div class="jrad-buttons-container ui-buttons-container"> 
			<span class="jrad-btn-primary">确定</span> 
			<span class="jrad-btn-normal">取消</span>
		</div>
	</div> 
	<!-- 添加、修改资讯评论 -->
	<div id="Form_info_comment" style="display:none;">
	        <div class="grid-layout-main jrad-form">   
				<div class="row"> 
					<label class="span4 grid-layout-label">
						用户ID：
					</label>
					<div class="span5 grid-layout-content">
						<div name="userInfoId" class="jrad-input-container"></div>
					</div>
				</div>
				<div class="row">
					<label class="span4 grid-layout-label">
						评论内容：
					</label>
					<div class="span5 grid-layout-content">
						<div name="remarks" class="jrad-textarea-container"></div>
					</div>
				</div>
	        </div>
	        <div class="jrad-buttons-container ui-buttons-container"> 
	            <span class="jrad-btn-primary">确定</span>
				<span class="jrad-btn-normal">取消</span>
	        </div>
	</div>

	<div id="Form_delete_pinglun" style="display:none;">
		<div class="grid-layout-main jrad-form">  
			 <div class="row">
				 <label class="span3 grid-layout-label"><span class="ui-form-required">*</span>用户ID：</label>
				 <div class="span6 grid-layout-content fluid-wrap">
					   <div name="userInfoId" class="jrad-input-container"></div>
					   <p class="ui-note">确定后，将删除该用户的所有评论。</p>
				 </div>
			</div> 
		</div>
		<div class="jrad-buttons-container ui-buttons-container"> 
			<span class="jrad-btn-primary">确定</span> 
			<span class="jrad-btn-normal">取消</span>
		</div>
	</div> 

	<div id="Form_explain_eg102" style="display:none;">
	    <div class="grid-layout-main jrad-form"> 
	        <div class="row">
	            <label class="span3 grid-layout-label">业务说明：</label>
	            <div class="span12 grid-layout-content">
	                <div><strong>功能简介：</strong>客户端每日早读课的文章都是在这里创建的。</div>
	                <div><strong>重要功能说明：</strong>创建：标题：资讯的标题，会显示在客户端；
	                标签：资讯的短标题，会显示在客户端；
	                绑定地域：资讯只会在选择的地域显示；
	                绑定车系：资讯只会在选择车系用户APP显示；
	                详情：就是具体的资讯文章内容了；
	                缩略图：APP资讯列表显示的图片；
	                摘要：APP资讯列表显示的摘要；
	                资讯类型：即创建的资讯的分类；
	                状态：只有有效的资讯才能在APP展示；
	                同步资讯：选择分类后，创建的资讯会同步到这个分类。
	           评论删除：输入用户ID后，将删除此用户所有在资讯的评论。</div>
	                <div><strong>注意事项：</strong>无。</div>
	            </div> 
	        </div> 
	        <div class="row">
	            <label class="span3 grid-layout-label">备注：</label>
	            <div class="span12 grid-layout-content">
	                <div class="jrad-textarea-container" name="remark">
	                </div>
	            </div>
	        </div>
	    </div>
	    <div class="jrad-buttons-container ui-buttons-container"> 
	        <span class="jrad-btn-primary">确定</span> 
	        <span class="jrad-btn-normal">取消</span>
	    </div>
	</div>   							
</div>
<script type="text/javascript">
$(document).ready(function(){  
    var informationType = $.jRadGetDataSources(
		"/shopmanage-ws/ws/0.1/informationTypeCms/listInformationType?status=1" ,"id","name"//status 0 无效 1 有效
	);
	var wraper = $('#Wraper_info_manage');
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array();
	 	
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel}); 
    jRad.validators['title'] = [{"msg":"标题不能为空","type":"min","value":"1"}]; 
	jRad.validators['content'] = [{"msg":"详情不能为空","type":"min","value":"1"}]; 
	jRad.validators['tag'] = [{"msg":"最多输入2个汉字","type":"max","value":"2"}]; 
    jRad.validators['userInfoId'] = [{"msg":"用户ID不能为空","type":"min","value":"1"}]; 
	jRad.params['provinceCodeSearch'] = {
		urlData:{
			url:'/euc/ws/0.1/user/provinces?userId='+carsmart_config.userId
		},
		unshiftData: {id:'',name:'请选择'},
		onchange: function(){
			var provinceCode = $('.searchContent div[name=provinceId]',wraper).select('val'); 
			if(provinceCode==''){ 
				$('.searchContent div[name=areaCodeId]',wraper).select({
																urlData:{url:''},
																data:[{id:'',name:'请选择'}],
																val:''});
			}else{  
			$('.searchContent div[name=areaCodeId]',wraper).select({ 
				urlData:{
					url:  '/euc/ws/0.1/user/cities?provinceId='+provinceCode+'&userId='+carsmart_config.userId 
				},
				unshiftData: {id:'0',name:'全部'}
			}).select('val','0');
			}
		}
	}; 
	jRad.params['areaCodeSearchId'] = {
		data: [{id:'',name:'请选择'}]
	};
	
	var fields_params = {}; 
	fields_params['title'] = {grid: 9}; 
	fields_params['summary'] = {grid: 9}; 
	fields_params['status'] ={ data:[ 
		{"id":"1",name:"有效"},
		{"id":"0",name:"无效"}
	]};  
	fields_params['informationTypeId'] ={data:informationType};  
	fields_params['syncInformationTypeId'] ={data:[
		{id:'',name:'无'},
		{id:'1',name:'头条'}

	]};  	 
	fields_params['content'] = {
 			theme:"Full",
 			resizing: false, 
 			grid: 18, 
 			height: 200,
			uploadImg: { //上传图片参数
				url: '/shopmanage-ws/ws/0.1/file/uploadThree',
				fileName: 'file', 
				delFunc: function(item) { 
					item.list.remove(); 
				}, 
				validator : [{
					msg : "只能上传jpg文件",
					type : "regex",
					value : /^.*\.(jpg|JPG)$/
				}], 
				success: function(data){  
					   if(data[0]&&data[0].code=="400"){
						 $.jRadMessage({level:'error',message:data[0].message});
					   }
					},
				note: '仅支持 JPG图片文件。',
				show:true,
				showLarge:true,  
				prev:'fileUrl', 
				params: {type:"",cutPicType:''}, 
				single: true 
			},
			CKOpt:{
				fullPage:false,
				basicEntities:false, 
				startupMode:'source' 
			} 
 	};
	fields_params['infoLitimgFile'] = { 
				url: '/shopmanage-ws/ws/0.1/file/uploadThree',
				fileName: 'file', 
				delFunc: function(item) { 
					item.list.remove(); 
					$("#Form_infor_manage",wraper).find("input[name='infoPic']").val("");  //图片地址
				    $("#Form_infor_manage",wraper).find("input[name='infoLitimg']").val("");//缩略图
				}, 
				validator : [{
					msg : "只能上传jpg文件",
					type : "regex",
					value : /^.*\.(jpg|JPG)$/
				}], 
				success: function(data){ 
					   if(data[0]&&data[0].code=="400"){
						 $.jRadMessage({level:'error',message:data[0].message});
					   }else{  
						 $("#Form_infor_manage",wraper).find("input[name='infoPic']").val(data.fileUrl);  //图片地址
						 $("#Form_infor_manage",wraper).find("input[name='infoLitimg']").val(data.smallUrl);//缩略图 
					   }  
					},
				note: '仅支持 JPG图片文件。',
				show:true,
				showLarge:true, 
				prev:'smallUrl', 
				params: {type:"",cutPicType:'2'}, 
				single: true 
			 
 	};
	var _form = $("#Form_infor_manage");  
	page_column_model.push({display: '资讯ID', name : 'id',width:70});
    page_column_model.push({display: '标题', name : 'title'});
    page_column_model.push({display: '绑定地域', name : 'region'}); 
	page_column_model.push({display: '绑定车系', name : 'modelName'});
    page_column_model.push({display: '绑定商家(简称)', name : 'businessName',width:150});
    page_column_model.push({display: '标签', name : 'tag'}); 
	page_column_model.push({display: '评论数', name : 'remarkNum',diy:function(item,$div){
    	$div.html('<a href="javascript:" class="titleLink" titleId="'+item.id+'">'+item.remarkNum+'</a>')
    }});
    page_column_model.push({display: '最后评论时间', name : 'lastRemarkDate'});
    page_column_model.push({display: '创建人', name : 'createPerson',width:150});
    page_column_model.push({display: '创建时间', name : 'createDate',width:150}); 
    page_column_model.push({display: '资讯链接', name : 'contentUrl'}); 
	page_column_model.push({display: '状态', name : 'statusName',width:100});
    
	page_search_items.push({row:'1',type:'jrad-input',display:'ID',name:'id'});
	page_search_items.push({row:'1',type:'jrad-select',display:'省',name:'provinceId',params:jRad.params['provinceCodeSearch']});
	page_search_items.push({row:'1',type:'jrad-select',display:'市',name:'areaCodeId',params:jRad.params['areaCodeSearchId']}); 
	page_search_items.push({row:'2',type:'jrad-input',display:'绑定车系',name:'modelName'});  
	page_search_items.push({row:'2',type:'jrad-dateinput',display:'创建时间开始',name:'startTime',params:{
			grid:4,
	    	dateFmt:'yyyy-MM-dd HH:mm:ss',
	}});
	page_search_items.push({row:'2',type:'jrad-dateinput',display:'创建时间结束',name:'endTime',params:{
			grid:4,
	    	dateFmt:'yyyy-MM-dd HH:mm:ss',
	}});
	page_search_items.push({row:'3',type:'jrad-input',display:'标题',name:'title'}); 
	page_search_items.push({row:'3',type:'jrad-input',display:'创建人',name:'createPerson'}); 
	page_search_items.push({row:'3',type:'jrad-select',display:'状态',name:'status',params:{
	  data:[
	    {"id":"",name:"全部"},
	    {"id":"1",name:"有效"},
		{"id":"0",name:"无效"}
	  ]
	}});     

	$('.titleLink',wraper).live('click',function(){
		var id=$(this).attr('titleId');
		updateInfoView(id,wraper)
	});
    $('#Form_infor_manage .jrad-btn-normal',wraper).button({
		click: function(){
			$('.details-box',wraper).slideUp();
			$('.jrad-table',wraper).slideDown(); 
			$(".scroll-up-btn").click();
		}
	});  
	$('#Form_infor_manage .jrad-btn-primary',wraper).button({
		click: function(){
			var flag = $('#Form_infor_manage',wraper).form('validateAll');
			if(!flag) {
			   return;
			}  
			var json = $('#Form_infor_manage',wraper).form('getValue');   
			//绑定区域
			json.regions = []; 
			if(carsmart_config.isAgentor!=0){
				json.regions=carsmart_config.regions
			}else{
				var regions = $("div[name='regions']",wraper).data("areaList"); 
				if(regions.length==0){
				 $.jRadMessage({level:'error',message:"请选择要绑定的地域。"});
				 return;
				}else{
				$.each(regions,function(){
				  var region = {};
				  region.provinceId = this.provinceId+"";  
				  var areaList = this.areaList;
				  var areaCodeId = [];
				  for(var i=0;i<areaList.length;i++){
				  areaCodeId.push(areaList[i].areaCodeId);
				  } 
				  region.areaCodeId =  areaCodeId.join(","); 
				  json.regions.push(region);
				});  
				}
			}
			json.modelIds = [];
			var modelIds = $("div[name='brands']",wraper).data("brandIds");  
			if(modelIds!=undefined){
				json.modelIds = modelIds;  
			}   
			if(json.modelIds.length==0){ 
				$.jRadMessage({level:'error',message:"请选择要绑定的车系。"});
			    return;
			}		
			json.createPerson = carsmart_config.operatorName;//创建人 即为当前登录人名字 
			//绑定商家 
			var businessAreas = $("#business_bind_string .areaSpan",wraper);
			var businessArr = [];
			$.each(businessAreas,function(){
			 businessArr.push($(this).data("businessId"));
			});
			json.businessInfoIds = businessArr.join(",");
			
			if($(".details-box .details-tab",wraper).find("span[name='title']").html()=="资讯添加"){
			$.jRadPost({
				    	url:'/shopmanage-ws/ws/0.1/informationCms/addInformation',
				    	data:json,
				    	success:function(){
				    		$('.details-box',wraper).slideUp();
							$('.jrad-table',wraper).slideDown();  
							$(".scroll-up-btn").click();
							$('#Table_info_manage').flexMessage('创建成功', 'success');
							$('#Table_info_manage').flexReload();
				    	},error:function(data){
				    		var mes = eval('('+data.responseText+')');
				    		 $.jRadMessage({
				    			 level:'error', 
			    				 message:mes[0].message 
				    		 });
				    	}
				    });
		 }else{
			$.jRadPost({
				    	url:'/shopmanage-ws/ws/0.1/informationCms/editInformation',
				    	data:json,
				    	success:function(){
				    		$('.details-box',wraper).slideUp();
							$('.jrad-table',wraper).slideDown();  
							$(".scroll-up-btn").click();
							$('#Table_info_manage').flexMessage('修改成功', 'success');
							$('#Table_info_manage').flexReload();
				    	},error:function(data){
				    		var mes = eval('('+data.responseText+')');
				    		 $.jRadMessage({
				    			 level:'error', 
			    				 message:mes[0].message 
				    		 });
				    	}
				    });
		 }
		}	 
	}); 
	$('#Form_infor_manage',wraper).form({
		validators: jRad.validators,
		fields_params:fields_params,
		layout: 'grid', 
		autobinding: false
	 }); 
    
	var readonlyFields2 = {};
	readonlyFields2['users'] = false; 
	page_list_buttons.push({title: '创建',name:'Add', bclass: 'add',
		onpress : function(){
			 initInfo(wraper); 
			 $('#Form_infor_manage',wraper).form({item:{}}); 
			 $(".details-box .details-tab",wraper).find("span[name='title']").html("资讯添加");
			 $('.jrad-table',wraper).slideUp();
			 $('.details-box',wraper).slideDown();
			 $('.details-box .details-content:eq(0)',wraper).slideDown();
			 $('.details-box .details-content:eq(1)',wraper).slideUp();
			 $('.details-box div.syncInformationTypeId',wraper).show();
			 $(".scroll-up-btn").click();
			 if(carsmart_config.isAgentor!=0){
			 	$('.details-box div.area',wraper).hide()
			 }  
        }
    });
	var readonlyFields = {};
	readonlyFields['users'] = true; 
	page_list_buttons.push({title: '修改',name:'Edit', bclass: 'edit',
		prefunc:function(){
            var checked = $('#Table_info_manage').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },
        onpress : function(){
            var checked = $('#Table_info_manage').getCheckedTrs(); 
            if(checked[0]) {
			     var id = checked[0].id;
                 updateInfo(id,wraper);
                 if(carsmart_config.isAgentor!=0){
				 	$('.details-box div.area',wraper).hide()
				 } 
            }
        }
    }); 
  
	page_list_buttons.push({name:'delete',bclass: 'delete',
		prefunc:function(){
            var checked = $('#Table_info_manage').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },
        onpress : function(){
	    	var checked = $('#Table_info_manage').getCheckedTrs();
			$.jRadConfirm('确认删除吗？',1,function(){
				var id =  checked[0].id; 
				$.jRadAjax({
				    type:'post',
					url:'/shopmanage-ws/ws/0.1/informationCms/deleteInformation?id='+id, 
					success: function(){
						$('#Table_info_manage').flexMessage('删除成功!', 'success');
           	    		$('#Table_info_manage').flexReload();
					},
					error:function(xhr){
					    var errormsg = eval("(" + xhr.responseText + ")"); 
						if (errormsg != undefined) {
							$('#Table_info_manage').flexMessage(errormsg[0].message, 'error');
						}
					}
				});
			});
		}
	});
	page_list_buttons.push({displayname: '评论删除',name:'send',bclass: 'send',
		prefunc:function(){
        },
        onpress : function(){
			$('#Form_delete_pinglun').form({
	  			title:'评论删除', 
	  			grid:12,
	  			type:'get',
				validators: jRad.validators,
	            url:'/shopmanage-ws/ws/0.1/informationRemarkCms/deleteInformationRemarkByUserId',
	            before_submit:function(json){
	            	return json
	            },
	            success_callback:function(data){ 
					$('#Table_info_manage').flexMessage('删除成功', 'success');
					$('#Table_info_manage').flexReload();
	  			}  
      	  	}).form('open'); 
		}
	});
	 
    page_list_buttons.push({separator: true});
    
    $('#Table_info_manage').flexigrid({
            reload:true,
			method:'get',
            colModel : page_column_model,
            buttons : page_list_buttons,
            searchitems :page_search_items,
            pagination: {
				diaplay_pages: 5,
				align: 'bottom' 
			},
			showSearch:true,
			checkBoxType:'single',
            url:'/shopmanage-ws/ws/0.1/informationCms/queryInformation',
			onError:showInfoError,
			overflow:true
    }); 

    var _span3=$('div.searchButtons:eq(0)',wraper).parent().removeClass('span3').addClass('span20');
    var _div=$('<div>').addClass('row-fluid').append(_span3);
    $('div.searchContent:eq(0)',wraper).append(_div);
	$(".details-tab .return",wraper).click(function(){
		$('.details-box',wraper).slideUp();
		$('.jrad-table',wraper).slideDown(); 
		$(".scroll-up-btn").click();
		$('.details-box .details-content:eq(1)').html('<table id="Table_info_comment"></table>');
		$('#Table_info_manage').flexReloadCurrentPage(); 
	}); 
	//服务品牌
	$('#Form_service_brand',wraper).form({
						title: '绑定车系选择', 
						item: {},  
						fields_params:{'vendor':{data: [{id:'全部',name:'全部'}]}},		
						height: 500,
						submit:function(){   
						var vendor = $('#Form_service_brand div[name="vendor"]',wraper).checkbox('val');  
						if(vendor.length==0||vendor[0]==""){
						 var treeObj = getZtreeObj(wraper);
						 var filter = function(node){
							return (node.level == 1 && node.checked==true);
						 }
						 var nodes = treeObj.getNodesByFilter(filter); 
						 var arr = [];
						 var modelNameList = [];
						 $.each(nodes,function(){
						   var json = {};
							   json.brandId = this.id;
						   json.modelId = [];
						   var modelFilter = function(node){ 
							return (node.brandId ==json.brandId && node.level == 3 && node.checked==true);
						   }
							var modelNodes = treeObj.getNodesByFilter(modelFilter); 
							$.each(modelNodes,function(i){
							  json.modelId.push(modelNodes[i].id);
							  modelNameList.push(modelNodes[i].name);
							});
							json.modelId = json.modelId.join(",");
							arr.push(json);
						 }); 
						  $("#Form_infor_manage",wraper).find("div[name='brand_check_btn']").next("#brand_check_string").html("已选择："+modelNameList.join(" , "));	
						  $("div[name='brands']",wraper).data("brandIds",arr); 
						}else{
							 $("#Form_infor_manage",wraper).find("div[name='brand_check_btn']").next("#brand_check_string").html("已选择：全部");	
							  $("div[name='brands']",wraper).data("brandIds",[{"brandId":"", "modelId":"0"}]); 
						}
						$("#Form_service_brand",wraper).form('close'); 
		}
	}); 
	$("#jrad-button-brand",wraper).button({
		click : function() {
		var brandIds = $("div[name='brands']",wraper).data("brandIds");
		var data = {}
		if(brandIds.length==1&&brandIds[0].modelId=="0"){
		 data = {"vendor":"全部"};
		}else{
		var treeObj = getZtreeObj(wraper);
		$.each(brandIds,function(i,json){   
			var modelIds = json.modelId.split(",");
			$.each(modelIds,function(i){ 
				var modelId = modelIds[i];
				var modelFilter = function(node){  
					return (node.brandId ==json.brandId && node.level == 3 && node.id == modelId);
				} 
				var modelNode = treeObj.getNodesByFilter(modelFilter,true);  
				treeObj.checkNode(modelNode, true, true);  
			}); 
		}); 
		}  		
			$('#Form_service_brand',wraper).form({
			item:data
			}).form('open');
		}
	});  
	//地区选择
    var area_fields_params = {};	
	area_fields_params['provinceId'] = {
		urlData:{
			url: '/euc/ws/0.1/user/provinces?userId='+carsmart_config.userId
		},
		unshiftData: {id:'0',name:'全部'},
		onchange: function(){
			var provinceCode = $('#Form_area div[name=provinceId]',wraper).select('val');
			if(provinceCode=='0'){
				$('#Form_area div[name=areaCodeId]',wraper).select({data:[{id:'0',name:'全部'}]});
			}else{
			$('#Form_area div[name=areaCodeId]',wraper).select("val","0");
			$('#Form_area div[name=areaCodeId]',wraper).select({
				urlData:{
					url: '/euc/ws/0.1/user/cities?provinceId='+provinceCode+'&userId='+carsmart_config.userId
				},
				unshiftData: {id:'0',name:'全部'}
			});
			}
		}
	}
	area_fields_params['areaCodeId'] = {
		data: [{id:'0',name:'全部'}]
	};
	$('#Form_area',wraper).form({
	        title:"地区", 
			fields_params:area_fields_params,
			item:{"provinceId":"0","areaCodeId":"0"},
			submit:function(){  
				var json = {};
				json.provinceId = $("#Form_area div[name='provinceId']",wraper).select('val');
				json.provinceName = $("#Form_area div[name='provinceId']",wraper).select('text');
				json.areaList = [];
				json.areaList[0] = {};
				json.areaList[0].areaCodeId = $("#Form_area div[name='areaCodeId']",wraper).select('val');
				json.areaList[0].areaCodeName = $("#Form_area div[name='areaCodeId']",wraper).select('text');  
				var array = $("div[name='regions']",wraper).data("areaList");
				var pId = json.provinceId; 
				var aId = json.areaList[0].areaCodeId;
				if(pId=="0"){
					array = []; 
					array.push(json);
				}else{
				    if(array.length==1&&array[0].provinceId=="0"){
					array = []; 
					array.push(json);
					}else{
						var flag = true;
						$.each(array,function(){
							if(this.provinceId == pId){
							  flag = false;
							  var areaList = this.areaList;
							  if(aId=="0"){
									this.areaList = json.areaList;
							  }else{ 
									var areaflag = true;
									for(var i=0;i<areaList.length;i++){
									if(areaList[i].areaCodeId==0){
									areaflag = false;
									this.areaList = json.areaList;
									break;
									}
									if(areaList[i].areaCodeId==aId){ 
									areaflag = false;
									$.jRadMessage({level:'error',message:"该地区已经选择",selector:$("#Form_area",wraper)});
									return;
									}
									
									}
									if(areaflag){
									this.areaList.push(json.areaList[0]);
									}
							  }
							}
						});
						if(flag){  
						  array.push(json);
						}  
					}
				}
				addAreaList(array,wraper); 
				$("div[name='regions']",wraper).data("areaList",array);
				$("#Form_area div[name='areaCodeId']",wraper).select('destroy');
				$("#Form_area",wraper).form("close");
			}
			});
	$("#jrad-button-area",wraper).button({
		click : function() {  
			$('#Form_area',wraper).form({ 
			fields_params:area_fields_params,
			item:{"provinceId":"0","areaCodeId":"0"},
			}).form('open');
		}
	});
	//删除地区
	$("#area_check_string .delArea",wraper).live('click',function(){
		var info = $(this).data('info'); 
		var arr = $("div[name='regions']",wraper).data("areaList");   
		$.each(arr,function(i){
			var json = this;
			if(json.provinceId==info.provinceId){
				if(info.areaId=="0"){
					arr.splice(i,1);
				}else if(json.areaList.length==1){
					arr.splice(i,1);
				}else{   
					$.each(json.areaList,function(j){
					var area = this;
					if(area.areaCodeId==info.areaId){ 
					json.areaList.splice(j,1); 
					}
					});
				}
			}
		}); 
		$(this).parent('.areaSpan').remove();
	});
	//绑定商家
	$('#Form_business_bind',wraper).form({
		validators:{'id':[{msg:"商家id不能为空",type:'min',value:"1"},{msg:"商家id只能是数字",type:'regex',value:/^\d+$/}]}, 
		title:'绑定商家', 
		submit: businessBind 
	 }); 
	$("#business_bind_button",wraper).button({
		click : function() {  
			$('#Form_business_bind',wraper).form({
			item:{}
			}).form('open');
		}
	 });  
	 $("#business_bind_string .delBusiness",wraper).live('click',function(){ 
		$(this).parent('.areaSpan').remove();
	}); 

	$(".numb102").click(function(){
        $('.overcurtainDiv').hide();
        var menuId = $(".tabs-selected").attr("menuId")
        var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        $("#Form_explain_eg102").form({}).form('close');
        $("#Form_explain_eg102").form({
            title:'页面说明',
            item:data,
            autobinding: true, 
			submit:function(){
            	var postData = {};
                postData.operator = carsmart_config.operatorName;
                postData.menuName = $(".tabs-selected").attr("menuName");
                postData.menuId = $(".tabs-selected").attr("menuId");
                postData.remark = $("#Form_explain_eg102 div[name='remark']").textarea("val")
				$.jRadPost({
				    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
				    data:postData,
				    success:function(){
						$("#Form_explain_eg102").form('close')
      					$('.overcurtainDiv').hide();
				   	}
				});
			}, 
			cancel:function(){
				$("#Form_explain_eg102").form('close')
      			$('.overcurtainDiv').hide();
			}
        }).form('open')
        $("#Form_explain_eg102 .textarea-content").removeClass("span4").addClass("span12")
        $('.overcurtainDiv').hide();
        $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
    })
}); 

function showInfoError(xhr){
			 var errormsg = eval("(" + xhr.responseText + ")");
			  var cDiv = $("#Wraper_info_manage .cDiv");
			  $.jRadMessage({level:'error',message:errormsg[0].message,selector:cDiv});
			}
function businessBind(){
            var wraper = $('#Wraper_info_manage');
			var _form = $("#Form_business_bind",wraper);  
			var id = _form.find("input[name='id']").val();
			var flag = _form.form('validateAll');
		   if(!flag) {
			   return;
		   }
		   if(id == 0){
		    _form.form('close');
			var _div = $("<div>").addClass("areaSpan").html(id+" 全部").data('businessId',id);
			var _span = $("<span>").addClass("delspan delBusiness").html("X").attr("title","移除");
			$("#business_bind_string",wraper).html(_div.append(_span));
		   }else{
		   if($($("#business_bind_string",wraper).children(".areaSpan")[0]).data("businessId")==0){
		    $("#business_bind_string",wraper).html("");
		   }
		   var data =  $.jRadGet({
					url:'/shopmanage-ws/ws/0.1/shopmanage/shop/name?id='+id, 
					success: function(data){ 
					    _form.form('close');
						var name =data.businessName;
						var _div = $("<div>").addClass("areaSpan").html(id+" "+name).data('businessId',id);
						var _span = $("<span>").addClass("delspan delBusiness").html("X").attr("title","移除");
						$("#business_bind_string",wraper).append(_div.append(_span));
					},
					error:function(){ 
						 _form.form('message',"查询商家不存在！",'error');
					}
				});
			 
			
		   }			
}

function initInfo(wraper){ 
	   //服务品牌 
	   $("#Form_infor_manage",wraper).find("div[name='brand_check_btn']").next("#brand_check_string").html("");
	   $("#Form_infor_manage #business_bind_button",wraper).parent().next("#business_bind_string").html("");
	   $("div[name='brands']",wraper).data("brandIds",[]); 
		try{
		$("#Form_service_brand .jrad-tree",wraper).tree('destroy');   
		}catch(e) {
		} 
	   var treeOption = setBrandTree(wraper); 
	   $("#Form_service_brand .jrad-tree",wraper).tree(treeOption);
	  //地区
	   $("#Form_infor_manage div[name='regions']",wraper).data("areaList",[]); 
	   $("#Form_infor_manage #area_check_string",wraper).html("");
	   $("#Form_infor_manage .nameTips",wraper).html(""); 
	 //缩略图 
	 var _ul = $("div[name='infoLitimgFile']",wraper).children(".pic-show"); 
	 _ul.html("");
}
//修改时赋值
function infoShow(wraper,item){   
     
	//车系ids   
	if(item.modelIds.length==1&&item.modelIds[0].modelId =="0"){
	}else{
	$.each(item.modelIds,function(i,json){    
		var node = $("#brandsTree",wraper).tree('getNodeByParam','id',json.brandId); 
		var pNode = node.getParentNode();
		$("#brandsTree",wraper).tree('open',pNode,true); 
		$("#brandsTree",wraper).tree('open',node,true);  
	});  
    }	
	$("div[name='brands']",wraper).data("brandIds",item.modelIds);
    //车系名字显示
	var brandCheckString = [];
	if(item.modelNames!=undefined&&item.modelNames.length > 0){
	  $.each(item.modelNames,function(i){ 
		 if(item.modelNames[i].modelName!=undefined&&item.modelNames[i].modelName!=""){
			$.merge(brandCheckString,item.modelNames[i].modelName.split(",")); 
		 }else{
			brandCheckString.push(item.modelNames[i].brandName);
		 }
	   }); 
	}  
	$.unique(brandCheckString); 
	$("#brand_check_string",wraper).html("已选择："+brandCheckString.join(",")); 	   
   //地区
   var areaList = item.regions;
   $.each(areaList,function(i){
       if(areaList[i].areaList.length==0){
	    areaList[i].areaList=[{"areaCodeId":"0"}];
	   }
   });
   $("#Form_infor_manage div[name='regions']",wraper).data('areaList',areaList); 
   addAreaList(areaList,wraper);
   //绑定商家
	if(item.businessInfoIds=="0"){ 
		var _div = $("<div>").addClass("areaSpan").html("0 全部").data('businessId','0');
		var _span = $("<span>").addClass("delspan delBusiness").html("X").attr("title","移除");
		$("#business_bind_string",wraper).append(_div.append(_span));
	}else{ 
		if(item.businessInfoIds!=""){
			var businessList = (item.businessInfoIds).split(",");    
			$.each(businessList,function(i){
				var id = businessList[i]; 
				$.jRadGet({
					url:'/shopmanage-ws/ws/0.1/shopmanage/shop/name?id='+id, 
					success: function(data){ 
						var name =data.businessName; 
						var _div = $("<div>").addClass("areaSpan").html(id+" "+name).data('businessId',id);
						var _span = $("<span>").addClass("delspan delBusiness").html("X").attr("title","移除");
						$("#business_bind_string",wraper).append(_div.append(_span));
					}});
			});
		}	
	}
	//缩略图
   var _ul = $("div[name='infoLitimgFile']",wraper).children(".pic-show");  
   var src = $("input[name='infoLitimg']",wraper).val();
   if(src!=""){ 
	  var _li = '<li name="" class="infoLitimgFileLi"><div class="large-pic"><div class="pic-box"><div class="pic-content"><div class="pic-vc">'
				+'<img src="'+src+'">'
				+'</div></div><span name="small" class="del-btn"></span></div></div></li>'
	  _ul.html(_li); 
	  $(".infoLitimgFileLi .del-btn").click(function(){
		   var small = $(this).prev(".pic-content").find("img").attr("src");
		   $(this).parents(".infoLitimgFileLi").remove(); 
		   $("#Form_infor_manage",wraper).find("input[name='infoPic']").val("");  //图片地址
		   $("#Form_infor_manage",wraper).find("input[name='infoLitimg']").val("");//缩略图
		   
	  });
	 } 
	
} 
function updateInfo(id,wraper){ 
	 var item = $.jRadGet({url : '/shopmanage-ws/ws/0.1/informationCms/detailInformation?id='+id}); 	 
	 $(".details-box .details-tab",wraper).find("span[name='title']").html("资讯修改"); 
	 initInfo(wraper);  
	 $('.jrad-table',wraper).slideUp();
	 $('.details-box',wraper).slideDown();
	 $('.details-box .details-content:eq(0)',wraper).slideDown();
	 $('.details-box .details-content:eq(1)',wraper).slideUp();  
	 $('.details-box div.syncInformationTypeId',wraper).hide();
	 $(".scroll-up-btn").click();  
	 $('#Form_infor_manage',wraper).form({item: item});  
	 item.id = id;
	 $('#Form_infor_manage',wraper).form({item: item}); 
	 infoShow(wraper,item); 
} 

function updateInfoView(id,wraper){	
	$(".details-box .details-tab",wraper).find("span[name='title']").html("资讯评论");  
	$('.jrad-table',wraper).slideUp();
	$('.details-box',wraper).slideDown();
	$('.details-box .details-content:eq(0)',wraper).slideUp();
	$('.details-box .details-content:eq(1)',wraper).slideDown(); 
	$(".scroll-up-btn").click();
	var page_column_model_c = new Array();
    var page_list_buttons_c = new Array();
    var page_search_items_c = new Array(); 
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel}); 
    
	jRad.validators['userInfoId'] = [{"msg":"用户ID不能为空","type":"min","value":"1"},{msg:"请输入正整数",type:'regex',value:/^[0-9]*[1-9][0-9]*$/}];
	jRad.validators['remarks'] = [{"msg":"评论内容不能为空","type":"min","value":"1"},{"msg":"评论内容度不能超过130个汉字","type":"max","value":"130"}];

	$('#Form_info_comment div[name="remarks"]').textarea({
		rows:5,
		grid:10
	});
	 $('#Form_info_comment').form({
	 	validators: jRad.validators,
        grid: 20
    });
	page_column_model_c.push({display: '用户ID', name : 'userInfoId'}); 
	page_column_model_c.push({display: '用户昵称', name : 'nicName'});
    page_column_model_c.push({display: '评论内容', name : 'remarks'}); 
    page_column_model_c.push({display: '评论时间', name : 'createDate'});

    page_search_items_c.push({row:'1',type:'jrad-input',display:'用户ID',name:'userInfoId'});
	page_search_items_c.push({row:'1',type:'jrad-input',display:'用户昵称',name:'nicName'}); 
	page_search_items_c.push({row:'2',type:'jrad-dateinput',display:'评论时间开始',name:'createDateStart',params:{dateFmt: 'yyyy-MM-dd HH:mm:ss'}});
	page_search_items_c.push({row:'2',type:'jrad-dateinput',display:'评论时间结束',name:'createDateEnd',params:{dateFmt: 'yyyy-MM-dd HH:mm:ss'}});
  
    page_list_buttons_c.push({title: '创建',name:'Add', bclass: 'add',onpress : function(){ 
			$('#Form_info_comment').form({
                title: '创建',
                validators: jRad.validators, 
                item:{},
                style:{height:'300px'}, 
                url:'/shopmanage-ws/ws/0.1/informationRemarkCms/addInformationRemark', 
				before_submit:function(json){
					json.informationId=id;
					return json
				},
				success_callback:function(){ 
                            $('#Table_info_comment').flexMessage('创建成功', 'success');
                            $('#Table_info_comment').flexReload();
                        } 
            }).form('open');
        }
    }); 
	
	page_list_buttons_c.push({name:'edit',bclass: 'edit',
		prefunc:function(){
            var checked = $('#Table_info_comment').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },
        onpress : function(){
        	var checked=$("#Table_info_comment",wraper).getCheckedTrs();
				$('#Form_info_comment').form({
                title: '编辑',
                validators: jRad.validators, 
                url:'/shopmanage-ws/ws/0.1/informationRemarkCms/editInformationRemark', 
                before_submit:function(json){
                	json.informationRemarkId=checked[0].informationRemarkId;
					return json
                },
				success_callback:function(){ 
                            $('#Table_info_comment').flexMessage('编辑成功', 'success');
                            $('#Table_info_comment').flexReload();
                        } 
            }).form('open');
				$('#Form_info_comment div[name="userInfoId"]').input('val',checked[0].userInfoId);
				$('#Form_info_comment div[name="remarks"]').textarea('val',checked[0].remarks);
		}
	});
	page_list_buttons_c.push({name:'delete',bclass: 'delete',
		prefunc:function(){
            var checked = $('#Table_info_comment').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },
        onpress : function(){
	    	var checked = $('#Table_info_comment').getCheckedTrs();  
			$.jRadConfirm('确认删除吗？',1,function(){
				$.jRadPost({
					url:'/shopmanage-ws/ws/0.1/informationRemarkCms/deleteInformationRemark?informationRemarkId='+checked[0].informationRemarkId,
					success:function(){
						$('#Table_info_comment').flexMessage('已删除', 'success');
                        $('#Table_info_comment').flexReload();
					}
				})
			}) 
		}
	});   
    page_list_buttons_c.push({separator: true});
    
    $('#Table_info_comment').flexigrid({
            reload:true,
			method:'get',
            colModel : page_column_model_c,
            buttons : page_list_buttons_c,
            searchitems :page_search_items_c,
            checkBoxType:'single',
            pagination: {
				diaplay_pages: 5,
				align: 'bottom' 
			}, 
			showSearch:true,
            url:'/shopmanage-ws/ws/0.1/informationRemarkCms/queryInformationRemarks?informationId='+id, 
            overflow:true,
			onError:showError
    });

    $('div.searchButtons:eq(1)',wraper).parent().removeClass('span3').addClass('span6');
	function showError(xhr){
	 	var errormsg = eval("(" + xhr.responseText + ")"); 
	  	$.jRadMessage({level:'error',message:errormsg[0].message});
	} 
};
 
function showAdsError(xhr){
 	var errormsg = eval("(" + xhr.responseText + ")");
 	 var cDiv = $("#Wraper_info_manage .cDiv");
  	$.jRadMessage({level:'error',message:errormsg[0].message,selector:cDiv});
}
</script>
