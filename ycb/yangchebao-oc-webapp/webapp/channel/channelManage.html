<div class="urlContentWraper" id="Wraper_channel_manage">
    <div class="ui-info-layout">
        <h2 class="ui-tit"><strong>渠道账号列表</strong><bottom class="all-work-info numb171">页面说明</bottom></h2>
        <!-- 列表显示 -->
        <table id="Table_channel_manage"></table>
    </div>
    <div id="Form_channel_manage" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                 <label class="span3 grid-layout-label">
											<span class="ui-form-required">
												*
											</span>账号：</label>
                 <div class="span5 grid-layout-content">
                       <div name="name" class="jrad-input-container"></div>
                                    </div>
            </div>
            <div class="row">
                 <label class="span3 grid-layout-label">密码：</label>
                 <div class="span5 grid-layout-content">
                       <div name="password" class="jrad-input-container"></div>
                                    </div>
            </div>  
            <div class="row">
                 <label class="span3 grid-layout-label">渠道名称：</label>
                 <div class="span5 grid-layout-content">
                       <div name="displayName" class="jrad-input-container"></div>
                                    </div>
            </div>
			      <div class="row">
                 <label class="span3 grid-layout-label"><span class="ui-form-required">*</span>邮箱：</label>
                 <div class="span5 grid-layout-content">
                       <div name="email" class="jrad-input-container"></div>
                 </div>
            </div> 
            <!-- <div class="row">
                 <label class="span3 grid-layout-label">状态：</label>
                 <div class="span5 grid-layout-content">
                       <div name="status" class="jrad-select-container"></div>
                                    </div>
            </div> -->
             <input type="hidden" name="id"/> 
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span>
			<span class="jrad-btn-normal">取消</span>
        </div>
    </div>
    <div id="Form_explain_eg171" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                <label class="span3 grid-layout-label">业务说明：</label>
                <div class="span12 grid-layout-content">
                    <div><strong>功能简介：</strong>APP上传应用市场的渠道管理，管理数据为登录这个渠道的账号和密码及一些基本信息。</div>
                    <div><strong>重要功能说明：</strong>无。</div>
                    <div><strong>注意事项：</strong>无。</div>
                </div> 
            </div> 
            <div class="row">
                <label class="span3 grid-layout-label">备注：</label>
                <div class="span12 grid-layout-content">
                    <div class="jrad-textarea-container" name="remark">
                    </div>
                </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
</div>
<script type="text/javascript">
$(document).ready(function(){
    var wraper = $('#Wraper_channel_manage');
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array();
	//var jRad = $.jRad('/radsample-ws','ent','Menu');	
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel}); 
    
	jRad.validators['name'] = [{"msg":"账号不能为空","type":"min","value":"1"}];
    /**jRad.validators['displayName'] = [{"msg":"员工姓名不能为空","type":"min","value":"1"},{msg:"姓名含非法字符",type:'regex',value:/^[^*\/\\<>?]+$/}];
	jRad.validators['email'] = [{"msg":"邮箱不能为空","type":"min","value":"1"},{msg:"邮箱格式不正确",type:'regex',value:/^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/}];
	**/
    var fields_params = {};
    // fields_params['status'] ={ data:[ 
    //     {"id":"1",name:"有效"},
    //     {"id":"2",name:"无效"}
    // ]}

    page_column_model.push({display: '账号', name : 'name',  sortable : true,diy:function(item,$div){
	   var json = $.toJSON(item);
	   $div.html("<a class='userLink' data-item='"+json+"'>"+item.name+"</a>");
	  }});
    page_column_model.push({display: '渠道名称', name : 'displayName',  sortable: true}); 
    page_column_model.push({display: '创建时间', name : 'created',  sortable : true});
    
    page_search_items.push({row:'1',type:'jrad-input',display:'账号',name:'name'}); 
   // page_search_items.push({row:'1',type:'jrad-select',display:'状态',name:'status',params:{
   //    data:[
   //      {"id":"1",name:"有效"},
   //      {"id":"2",name:"无效"}
   //    ]
   //  }});   
   
    page_list_buttons.push({title: '创建',name:'Add', bclass: 'add',onpress : function(){
            $('#Form_channel_manage').form({
                title: '创建',
                validators: jRad.validators,
                //fields_params:fields_params, 
                item:{},
                style:{height:'300px'}, 
                url:'/channel-euc/ws/0.1/user/add', 
				submit: addUser
            }).form('open');
        }
    }); 
	page_list_buttons.push({title: '修改',name:'Edit', bclass: 'edit',prefunc:function(){
            var checked = $('#Table_channel_manage').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
            var checked = $('#Table_channel_manage').getCheckedTrs(); 
            if(checked[0]) {
                updateUserView(checked[0]);   
            }
        }
    }); 
	page_list_buttons.push({displayname: '重置密码',name:'enabled',bclass: 'enabled',prefunc:function(){
            var checked = $('#Table_channel_manage').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
	    	var checked = $('#Table_channel_manage').getCheckedTrs();
			$ .jRadConfirm('确认重置密码？',1,function(){
				var id =  checked[0].id; 
				$.jRadPost({
					url:'/channel-euc/ws/0.1/user/password/reset?id='+id, 
					success: function(){
						$('#Table_channel_manage').flexMessage('密码重置为123456，请通知相关人员尽快修改密码。', 'success');
           	    		$('#Table_channel_manage').flexReload();
					}
				});
			});
		}
	}); 
    page_list_buttons.push({separator: true});
    
    $('#Table_channel_manage').flexigrid({
            reload:true,
			method:'get',
            colModel : page_column_model,
            buttons : page_list_buttons,
            searchitems :page_search_items,
            pagination: {
				diaplay_pages: 5,
				align: 'bottom' 
			},
			showSearch:true,
			preProcess:userDataProcess,
            url:'/channel-euc/ws/0.1/user/all',
		    queryUrl:'/channel-euc/ws/0.1/user/query',
			onError:showUserError
    });
	$(".userLink",wraper).live('click',function(){
		var item = $(this).data("item");
		updateUserView(item);
	});
    
    $(".numb171").click(function(){
        $('.overcurtainDiv').hide();
        var menuId = $(".tabs-selected").attr("menuId")
        var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        $("#Form_explain_eg171").form({}).form('close');
        $("#Form_explain_eg171").form({
            title:'页面说明',
            item:data,
            autobinding: true, 
            submit:function(){
                var postData = {};
                postData.operator = carsmart_config.operatorName;
                postData.menuName = $(".tabs-selected").attr("menuName");
                postData.menuId = $(".tabs-selected").attr("menuId");
                postData.remark = $("#Form_explain_eg171 div[name='remark']").textarea("val")
                $.jRadPost({
                    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
                    data:postData,
                    success:function(){
                        $("#Form_explain_eg171").form('close')
                        $('.overcurtainDiv').hide();
                    }
                });
            }, 
            cancel:function(){
                $("#Form_explain_eg171").form('close')
                $('.overcurtainDiv').hide();
            }
        }).form('open')
        $("#Form_explain_eg171 .textarea-content").removeClass("span4").addClass("span12")
        $('.overcurtainDiv').hide();
        $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
    })
	function updateUserView(item){
		 $('#Form_channel_manage').form({grid:'16',
                        title: '修改',
                        validators: jRad.validators, 
                        item:item, 
						submit:addUser,
                        url:'/channel-euc/ws/0.1/user/update',
                        success_callback:function(){ 
                            $('#Table_channel_manage').flexMessage('修改成功', 'success');
                            $('#Table_channel_manage').flexReload();
                        } 
                    }).form('open');
	
	}
	
});
function showUserError(xhr){
		 var errormsg = eval("(" + xhr.responseText + ")");
		  var cDiv = $("#Wraper_channel_manage .cDiv");
		  $.jRadMessage({level:'error',message:errormsg[0].message,selector:cDiv});
		}
function addUser(){
	   var _form = $("#Form_channel_manage");
	   var flag = _form.form('validateAll');
	   if(!flag) {
		   return;
	   }
	   var json = _form.form('getValue');
	   json.description = "";
	   if(json.password != "" ){
	     json.password = hex_md5(json.password);
	   }else{
	     delete json.password;
	   }
	   json.mobile ="";
	   var obj = {
			user : json,
			departmentId : "1",
			positionId : "1" 
	   }
	   var url = '/channel-euc/ws/0.1/user/add'; 
	   if($(".pop-up-tit",_form).html()=="修改"){
	      url = '/channel-euc/ws/0.1/user/update';
	   }
		$.jRadPost({
			url:url,
			data:obj,
			success:function(){ 
				$('#Table_channel_manage').flexMessage('修改成功', 'success');
				$('#Table_channel_manage').flexReload();
			},error:function(data){
				var mes = eval('('+data.responseText+')');
				 $.jRadMessage({
					 level:'error', 
					 message:mes[0].message 
				 });
			}
		});
	   _form.form('close');
}

function dateTurn(second, type) {
    var str = "";
    if (second != null && second != "") {
        var date = new Date(second);
        str = date.getFullYear() + "-";
        if ((date.getMonth() + 1) < 10) {
            str += "0" + (date.getMonth() + 1);
        } else {
            str += (date.getMonth() + 1);
        }
        str += "-" + date.getDate();
        if (type == 2) {
            str += " " + date.getHours() + ":" + date.getMinutes() + ":"
                    + date.getSeconds();
        }
    }
    return str;
}

function userDataProcess(data){
   for(var i=0;i<data.count;i++){
     data.items[i].created = dateTurn(data.items[i].created,2); 
   }
   return data;
} 
</script>
