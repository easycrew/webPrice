<div class="urlContentWraper" id="Wraper_integral_shop">
    <div class="ui-info-layout">
        <div class="ui-info-layout-subbox "> 
          <div class="jrad-table">
                <h2 class="ui-tit"><strong>积分商城</strong><bottom class="all-work-info numb141">页面说明</bottom></h2>
                <!-- 列表显示 -->
                <table id="Table_integral_shop"></table>
          </div>
          <div class="jrad-table" style="margin-top:10px;">
                <h2 class="ui-tit"><strong>领取列表</strong></h2>
                <!-- 列表显示 -->
                <table id="Table_integral_shop_list"></table>
          </div>

          <div class="details-box" style="display:none;">
              <ul class="details-tab">
                <li class="tab-cur tab-cur-first f-left"><span name="title">广告信息</span></li>
                <li><span class="return"></span></li>
              </ul>
              <div class="details-content">
                <div class="details-scroll">
                  <div class="details-content-inner">
                    <div class="grid-layout ui-form" id="Form_ads_manage">
                        <div class="jrad-form">  
                          <div class="grid-layout-main">
                              <input name="id" type="hidden"> 
                              <input type="hidden" name="itemHomeUrl">
                              <input type="hidden" name="itemAdvertiseUrl">
                              <input type="hidden" name="operator">
                              <input type="hidden" name="serviceId"/>
                              <div name="regions"></div>
                              <div class="row-fluid">
                                   <label class="span4 grid-layout-label"><span class="ui-form-required">*</span>商品名称：</label>
                                   <div class="span6 grid-layout-content">
                                         <div name="name" class="jrad-input-container"></div>
                                   </div>
                              </div>
                              <div class="row-fluid">
                                   <label class="span4 grid-layout-label"><span class="ui-form-required">*</span>商品分类：</label>
                                   <div class="span6 grid-layout-content">
                                         <div name="categoryId" class="jrad-select-container"></div>
                                   </div>
                              </div>
                              <div class="row-fluid">
                                   <label class="span4 grid-layout-label"><span class="ui-form-required">*</span>商品活动：</label>
                                   <div class="span6 grid-layout-content">
                                        <div name="activityType" class="jrad-select-container"></div>
                                   </div>
                              </div>
                              <div class="row-fluid">
                                   <label class="span4 grid-layout-label"><span class="ui-form-required">*</span>积分价：</label>
                                   <div class="span6 grid-layout-content">
                                         <div name="pointPrice" class="jrad-input-container"></div>
                                   </div>
                              </div>
                              <div class="row-fluid">
                                <label class="span4 grid-layout-label"><span class="ui-form-required">*</span>城市： </label>
                                <div class="span14 grid-layout-content">
                                  <div class="jrad-buttons-container" name="area_check_btn">
                                    <span id="jrad-button-area" class="jrad-primary">
                                      点击选择 </span>
                                  </div>
                                  <div id="area_check_string" style="margin: 10px 0;"></div>
                                </div>
                              </div> 
                              <div class="row-fluid">
                                   <label class="span4 grid-layout-label"><span class="ui-form-required">*</span>兑换商品类型：</label>
                                   <div class="span6 grid-layout-content">
                                         <div name="awardType" class="jrad-select-container"></div>
                                   </div>
                              </div>
                              <div class="row-fluid typeid">
                                   <label class="span4 grid-layout-label"><span class="ui-form-required">*</span><span class="changeName">代金券ID：</span></label>
                                   <div class="span4 grid-layout-content">
                                         <div class="jrad-input-container" name="awardSource"></div>
                                   </div>
                              </div>
                              <div class="row-fluid thred" style="display:none">
                                   <label class="span4 grid-layout-label"><span class="ui-form-required">*</span><span class="changeName">第三方奖品URL：</span></label>
                                   <div class="span10 grid-layout-content">
                                         <div class="jrad-input-container" name="awardAcquireUrl"></div>
                                   </div>
                              </div>
                              <div class="row-fluid">
                                   <label class="span4 grid-layout-label"><span class="ui-form-required">*</span>发放方式：</label>
                                   <div class="span4 grid-layout-content" name="maxFrequency">
                                         <div name="awardChanne" class="jrad-select-container"></div>
                                   </div>
                              </div>
                              <div class="row-fluid choose">
                                   <label class="span4 grid-layout-label"><span class="ui-form-required">*</span>抽奖概率：</label>
                                   <div class="span6 grid-layout-content">
                                         <div name="awardProbability" class="jrad-input-container"></div>
                                   </div>
                              </div>
                              <div class="row-fluid">
                                   <label class="span4 grid-layout-label"><span class="ui-form-required">*</span>是否需要兑换码：</label>
                                   <div class="span6 grid-layout-content">
                                         <div name="isNeedExchangecode" class="jrad-select-container"></div>
                                   </div>
                              </div>
                              <div class="row-fluid isduihuan">
                                   <label class="span4 grid-layout-label"><span class="ui-form-required">*</span>上传兑换码：</label>
                                   <div class="span6 grid-layout-content">
                                         <div name="exchangecodeFile" class="jrad-upload-container"></div>
                                         <p class="ui-note">多次上传，以最后一次为准！</p>
                                   </div>
                              </div> 
                              <div class="row-fluid wholeCard">
                                   <label class="span4 grid-layout-label"><span class="ui-form-required">*</span>最大领取数量：</label>
                                   <div class="span6 grid-layout-content">
                                         <div name="acquireLimit" class="jrad-input-container"></div>
                                   </div>
                              </div>
                              <div class="row-fluid wholeCard">
                                   <label class="span4 grid-layout-label"><span class="ui-form-required">*</span>总发放数量：</label>
                                   <div class="span6 grid-layout-content">
                                         <div name="totalProvideNum" class="jrad-input-container"></div>
                                   </div>
                              </div>
                              <div class="row-fluid">
                                   <label class="span4 grid-layout-label"><span class="ui-form-required">*</span>商品首页图：</label>
                                   <div class="span6 grid-layout-content">
                                         <div name="adPicId" class="jrad-uploadimg-container"></div>
                                   </div>
                              </div>
                              <div class="row-fluid">
                                   <label class="span4 grid-layout-label"><span class="ui-form-required">*</span>商品描述：</label>
                                   <div class="span6 grid-layout-content">
                                         <div name="itemDescription" class="jrad-input-container"></div>
                                   </div>
                              </div> 
                              <div class="row-fluid">
                                   <label class="span4 grid-layout-label">商品广告图：</label>
                                   <div class="span6 grid-layout-content">
                                         <div name="adPicId2" class="jrad-uploadimg-container"></div>
                                   </div>
                              </div> 
                              <div class="row-fluid">
                                   <label class="span4 grid-layout-label">商品有效时间：</label>
                                   <div class="span2 grid-layout-content">
                                         <div name="goodsEffStartDate" class="jrad-dateinput-container"></div>
                                   </div>
                                   <p style="float:left;margin:4px 0 0 30px">--</p>
                                   <div class="span3 grid-layout-content" style="margin-left:0;">
                                         <div name="goodsEffEndDate" class="jrad-dateinput-container"></div>
                                   </div>
                              </div> 
                              <div class="row-fluid">
                                 <label class="span4 grid-layout-label"><span class="ui-form-required">*</span>活动简介：</label>
                                 <div class="span5 grid-layout-content">
                                     <div name="summary" class="jrad-mediaarea-container" style="margin-left:0"></div>
                                 </div>
                              </div>
                              <div class="row-fluid">
                                   <label class="span4 grid-layout-label"><span class="ui-form-required">*</span>排序权重：</label>
                                   <div class="span6 grid-layout-content">
                                         <div name="priority" class="jrad-input-container"></div>
                                   </div>
                              </div>
                              <div class="row-fluid">
                                   <label class="span4 grid-layout-label"><span class="ui-form-required">*</span>有效期：</label>
                                   <div class="span2 grid-layout-content">
                                         <div name="effStartDate" class="jrad-dateinput-container"></div>
                                   </div>
                                   <p style="float:left;margin:4px 0 0 30px">--</p>
                                   <div class="span3 grid-layout-content" style="margin-left:0;">
                                         <div name="effEndDate" class="jrad-dateinput-container"></div>
                                   </div>
                              </div>
                              <div class="row-fluid">
                                   <label class="span4 grid-layout-label"><span class="ui-form-required">*</span>状态：</label>
                                   <div class="span6 grid-layout-content">
                                         <div name="status" class="jrad-select-container"></div>
                                   </div>
                              </div>
                          </div> 
                        </div>
                        <div class="jrad-buttons-container ui-buttons-container">
                          <span class="jrad-btn-primary">确定</span> 
                          <span class="jrad-btn-normal">取消</span>
                        </div>
                    </div>
                  </div>  
                </div>
              </div>
          </div>

        </div>
    </div>
    <!-- 地区选择-->
    <div id="Form_area" style="display:none;">
      <div class="grid-layout-main jrad-form"> 
          <div class="row-fluid">
          <label class="span3 grid-layout-label"> 省：</label>
          <div class="span7 grid-layout-content">
            <div class="jrad-select-container" name="provinceId">
            </div>
          </div> 
          <label class="span3 grid-layout-label"> 市：</label>
          <div class="span7 grid-layout-content">
            <div class="jrad-select-container" name="areaCodeId">
            </div>
          </div>
        </div> 
      </div>
      <div class="jrad-buttons-container ui-buttons-container"> 
        <span class="jrad-btn-primary">确定</span> 
        <span class="jrad-btn-normal">取消</span>
      </div>
    </div> 
    
    <div id="Form_explain_eg141" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                <label class="span3 grid-layout-label">业务说明：</label>
                <div class="span12 grid-layout-content">
                    <div><strong>功能简介：</strong>APP个人中心的积分商城，商城兑换商品在此设置。</div>
                    <div><strong>重要功能说明：</strong>创建：商品名称：兑换商品的名称；
                    商品分类：活动属性的分类，为预留字段，现在没有使用到；
                    商品活动：商品展示区域的分类；
                    积分价：商品兑换需要支付的积分；
                    城市：对应只有对应城市的用户才会看到此商品；
                    兑换商品类型：需要商家的商品种类，现在有代金券、车主卡、服务、套餐、第三方商品；
                    发放方式：抽奖和兑换两种，若抽奖的话，下面需要填入抽到的概率；
                    是否需要兑换码：主要针对第三方合作的商品，用户兑换或抽到后，给用户一个兑换码，到对应网站自己去领取；
                    最大领取数量：此商品，同一用户最大的获取数量；
                    总发放数量：此商品最大的发放数量；
                    商品首页图：商品显示在首页的那个LOGO图片；
                    商品描述：商品显示在商家列表的描述文字；
                    商品广告图：非必填，若不填则和“商品首页图”相同；
                    商品有效时间：显示在APP的商品的有效时间；
                    活动简介：在APP点击商品后，进入页面的详情；
                    排序权重：即在APP的排序位置，数字小的在前面；
                    有效期：活动的有效期，超过有效期，商品领取不成功；
                    状态：只有有效的商品才会在APP显示。</div>
                    <div><strong>注意事项：</strong>商品详情各位老大用富文本好好编辑下，不要写几个汉字上去就可以，很难看的。</div>
                </div> 
            </div> 
            <div class="row">
                <label class="span3 grid-layout-label">备注：</label>
                <div class="span12 grid-layout-content">
                    <div class="jrad-textarea-container" name="remark">
                    </div>
                </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>       
</div>
<script type="text/javascript">
$(document).ready(function(){ 
  var wraper = $('#Wraper_integral_shop');
  var page_column_model = new Array();
  var page_column_model_c = new Array();
  var page_search_items = new Array();
  var page_list_buttons = new Array();
  
  var entityModel = {};
  var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel}); 
  jRad.validators['name'] = [{"msg":"商品名称不能为空","type":"min","value":"1"}]; 
  jRad.validators['pointPrice'] = [{"msg":"积分价不能为空","type":"min","value":"1"},{msg:'请填写1000000以内正整数',type:'regex',value:/^\s*([0-9]*[1-9][0-9]*){1,6}\s*$/}]                                                 
  jRad.validators['regions'] = [{"msg":"城市不能为空","type":"min","value":"1"}]; 
  jRad.validators['awardSource'] = [{"msg":"商品ID不能为空","type":"min","value":"1"}]; 
  jRad.validators['awardProbability'] = [{"msg":"抽奖概率不能为空","type":"min","value":"1"}]; 
  //jRad.validators['exchangecodeFile'] = [{"msg":"上传兑换码不能为空","type":"min","value":"1"}]; 
  jRad.validators['acquireLimit'] = [{"msg":"最大领取数量不能为空","type":"min","value":"1"},{msg:'请填写最多4位的正整数',type:'regex',value:/^\s*([0-9]*[1-9][0-9]*){1,3}\s*$/}]; 
  jRad.validators['totalProvideNum'] = [{"msg":"总发放数量不能为空","type":"min","value":"1"},{msg:'请填写最多4位的正整数',type:'regex',value:/^\s*([0-9]*[1-9][0-9]*){1,3}\s*$/}]; 
  // jRad.validators['goodsEffStartDate'] = [{"msg":"商品有效时间不能为空","type":"min","value":"1"}];
  // jRad.validators['goodsEffEndDate'] = [{"msg":"商品有效时间不能为空","type":"min","value":"1"}];
  jRad.validators['itemDescription'] = [{"msg":"商品描述不能为空","type":"min","value":"1"}]; 
  jRad.validators['summary'] = [{"msg":"活动简介不能为空","type":"min","value":"1"}]; 
  jRad.validators['priority'] = [{"msg":"排序权重不能为空","type":"min","value":"1"},{msg:'请正确填写',type:'regex',value:/[^0]\d?$|[^0]\d?.\d{1,2}$|0.0?[^0]$/}];  
  jRad.validators['effStartDate'] = [{"msg":"有效期不能为空","type":"min","value":"1"}]; 
  jRad.validators['effEndDate'] = [{"msg":"有效期不能为空","type":"min","value":"1"}]; 
  //jRad.validators['awardAcquireUrl'] = [{"msg":"URL不能为空","type":"min","value":"1"}]; 

  jRad.params['awardChannel'] = {
      data: [{id:' ',name:'全部'},{id:'1',name:'兑换'},{id:'2',name:'抽奖'}]
  };
  jRad.params['status'] = {
      data: [{id:'3',name:'未删除'},{id:' ',name:'全部'},{id:'0',name:'无效'},{id:'1',name:'有效'},{id:'2',name:'删除'}]
  };

  var fields_params = {}; 

  var convert = [];
  var convertPlus = [];
  var _result = $.jRadGet({url: '/shopmanage-ws/ws/0.1/jfMall/awardTypeList'});
  $.each(_result,function(index, vo){
    var __id = vo['id'];
    var __name = vo['name'];
    var __tm = {'id':__id,'name': __name};
    convert.push(__tm);
    convertPlus.push(__tm)
  });
  convertPlus.unshift({id:'',name:'全部'})

  fields_params['awardType'] = {
    data: convert,
    onchange: function(){ 
      var val = $("#Form_ads_manage div[name='awardType']",wraper).select('val');  
      if(val=='1'){ 
        $('.typeid').show();
        $('.thred').hide();
        $('.isduihuan').hide();
        $('.typeid .changeName').html('代金券ID：'); 
        $("#Form_ads_manage div[name='isNeedExchangecode']",wraper).select('val','0'); 
        $("#Form_ads_manage div[name='isNeedExchangecode']",wraper).select('readonly',true); 
      }
      if(val=='2'){
        $('.typeid').show();
        $('.thred').hide();
        $('.isduihuan').hide();
        $('.typeid .changeName').html('车主卡ID：');
        $("#Form_ads_manage div[name='isNeedExchangecode']",wraper).select('val','0'); 
        $("#Form_ads_manage div[name='isNeedExchangecode']",wraper).select('readonly',true); 
      }
      if(val=='3'){
        $('.typeid').show();
        $('.thred').hide();
        $('.isduihuan').hide();
        $('.typeid .changeName').html('服务ID：');
        $("#Form_ads_manage div[name='isNeedExchangecode']",wraper).select('val','0'); 
        $("#Form_ads_manage div[name='isNeedExchangecode']",wraper).select('readonly',true); 
      }
      if(val=='4'){
        $('.typeid').show();
        $('.thred').hide();
        $('.isduihuan').hide();
        $('.typeid .changeName').html('套餐ID：'); 
        $("#Form_ads_manage div[name='isNeedExchangecode']",wraper).select('val','0'); 
        $("#Form_ads_manage div[name='isNeedExchangecode']",wraper).select('readonly',true); 
      }
      if(val=='5'){
        $('.typeid').hide();
        $('.thred').show();
        $('.thred .ui-input-content').addClass('span10').removeClass('span4');
        $("#Form_ads_manage div[name='isNeedExchangecode']",wraper).select('val','1'); 
        $("#Form_ads_manage div[name='isNeedExchangecode']",wraper).select('readonly',false); 
      }
    }
  }; 
  jRad.params['awardType']={
    data:convertPlus
  }; 

  var goodsList = [];
  var _result2 = $.jRadGet({url: '/shopmanage-ws/ws/0.1/jfMall/categoryList'});
  $.each(_result2,function(index, vo){
    var __id = vo['id'];
    var __name = vo['name'];
    var __tm = {'id':__id,'name': __name};
    goodsList.push(__tm);
  });
  fields_params['categoryId'] = {
    data: goodsList
  };
  fields_params['activityType'] ={data:[
    {"id":"1",name:"普通商品"},
    {"id":"2",name:"精洗商品"},
    {"id":"3",name:"热门商品"}
  ]}; 
  fields_params['awardChanne'] ={
    data:[{"id":"2",name:"抽奖"},{"id":"1",name:"兑换"}],
    onchange:function(){
         var val = $("#Form_ads_manage div[name='awardChanne']",wraper).select('val'); 
         if(val == 1){
            $('.choose').hide();
         }else{
            $('.choose').show();
         }
      }
  };
  fields_params['isNeedExchangecode'] ={
    data:[
      {"id":"0",name:"否"},
      {"id":"1",name:"是"}
    ],
    onchange: function(){ 
      var val = $("#Form_ads_manage div[name='isNeedExchangecode']",wraper).select('val');  
      if(val=='1'){ 
        $('.isduihuan').show();
      }
      else{
        $('.isduihuan').hide();
      }
    }
  };
  fields_params['status'] = {
      data: [{id:'1',name:'有效'},{id:'0',name:'无效'},{id:'2',name:'删除'}]
  };
  var _form = $('#Form_ads_manage')

  // 上传图片
  fields_params['adPicId'] = {
    url:'/shopmanage-ws/ws/0.1/file/uploadThree',
    delFunc: function(item){
       item.list.remove();
       $("input[name='itemHomeUrl']",_form).val("");
    },
    fileName:"file",
    note: '仅支持 JPG图片文件。',
    show: false,
    params: {type:""},
    success: function(data){ 
       if(data[0]&&data[0].code=="400"){
         $.jRadMessage({level:'error',message:data[0].message});
       }else{
        $("input[name='itemHomeUrl']",_form).val(data.fileUrl);
       }
    },
     beforeSubmit: function(obj){
      var re = /^.*\.(jpg|JPG)$/;
      if(re.test(obj.val())){
      return true;
      }else{  
      $.jRadAlert("只能上传jpg文件", "error");
      return false;
      }
    },
    single: true,
    showInfo:false,
    prev:'smallUrl'
  };

  //上传首页广告图片
  fields_params['adPicId2'] = {
    url:'/shopmanage-ws/ws/0.1/file/uploadThree',
    delFunc: function(item){
       item.list.remove();
       $("input[name='itemAdvertiseUrl']",_form).val("");
    },
    fileName:"file",
    note: '仅支持 JPG图片文件。',
    show: false,
    params: {type:""},
    success: function(data){ 
       if(data[0]&&data[0].code=="400"){
         $.jRadMessage({level:'error',message:data[0].message});
       }else{
         $("input[name='itemAdvertiseUrl']",_form).val(data.fileUrl);
       }
    },
     beforeSubmit: function(obj){
      var re = /^.*\.(jpg|JPG)$/;
      if(re.test(obj.val())){
      return true;
      }else{  
      $.jRadAlert("只能上传jpg文件", "error");
      return false;
      }
    },
    single: true,
    showInfo:false,
    prev:'smallUrl'
  };

  //商品简介
  fields_params['summary'] = {
      theme:"Full",
      resizing: false, 
      grid: 18, 
      height: 200 ,
      uploadImg: { //上传图片参数
      url: '/shopmanage-ws/ws/0.1/file/uploadThree',
      filename: 'file', 
      delFunc: function(item) { 
        item.list.remove(); 
      }, 
      validator : [{
        msg : "只能上传jpg文件",
        type : "regex",
        value : /^.*\.(jpg|JPG)$/
      }], 
      success: function(data){ 
           if(data[0]&&data[0].code=="400"){
           $.jRadMessage({level:'error',message:data[0].message});
           } 
        },
      note: '仅支持 JPG图片文件。',
      show:true,
      showLarge:true, 
      prev:'fileUrl', 
      params: {type:""}, 
      single: true 
    },
    CKOpt:{
      fullPage:true,//是否使用完整的html编辑模式
      basicEntities:false, //Whether to escape basic HTML entities in the document, including:  nbsp gt lt amp 
      startupMode:'source' //载入时，以何种方式编辑 源码和所见即所得 "source"和"wysiwyg"
    } 
  };  

  page_column_model.push({display: 'ID', name : 'id'});
  page_column_model.push({display: '商品名称', name : 'name'});
  page_column_model.push({display: '积分价', name : 'pointPrice'});  
  page_column_model.push({display: '支持城市', name : 'supportCity'});
  page_column_model.push({display: '兑换商品类型', name : 'awardTypeDesc'});
  page_column_model.push({display: '发放方式', name : 'awardChanneDesc',diy:function(item,$div){
    if(item.awardChanneDesc == '抽奖'){
      $div.html(item.awardChanneDesc+'&nbsp;&nbsp;'+item.awardProbability)
    }else{
      $div.html(item.awardChanneDesc)
    }
  }}); 
  page_column_model.push({display: '最大领取数量', name : 'acquireLimit'});
  page_column_model.push({display: '发放数量', name : 'yetProvideNum'});
  page_column_model.push({display: '最大发放数量', name : 'totalProvideNum'});    
  page_column_model.push({display: '排序权重', name : 'sort_seq',sortable:true}); 
  page_column_model.push({display: '有效期', name : 'effStartDate',width:200,diy:function(item,$div){
     var Start = item.effStartDate;
     var End = item.effEndDate;
     $div.html(Start+"&sim;"+End); 
  }}); 
  page_column_model.push({display: '状态', name : 'statusDesc'});
  page_column_model.push({display: '最后操作时间', name : 'updateDate'});
  page_column_model.push({display: '最后操作人', name : 'operator'});

  page_search_items.push({row:'1',type:'jrad-input',display:'ID',name:'id'}); 
  page_search_items.push({row:'1',type:'jrad-input',display:'商品名称',name:'name'}); 
  page_search_items.push({row:'1',type:'jrad-select',display:'兑换商品类型',name:'awardType',params:jRad.params['awardType']}); 
  page_search_items.push({row:'2',type:'jrad-select',display:'发放方式',name:'awardChannel',params:jRad.params['awardChannel']}); 
  page_search_items.push({row:'2',type:'jrad-select',display:'状态',name:'status',params:jRad.params['status']}); 
  page_search_items.push({row:'2',type:'jrad-input',display:'最后操作人',name:'operator'}); 
  page_search_items.push({row:'3',type:'jrad-input',display:'领取用户手机',name:'mobile'});

  //取消按钮
  $('#Form_ads_manage .jrad-btn-normal',wraper).button({
    click: function(){
      $('.details-box',wraper).slideUp();
      $('.jrad-table',wraper).slideDown(); 
      $(".scroll-up-btn").click();
    }
  });  
  
  $("#Form_ads_manage div[name='exchangecodeFile']",wraper).upload({
      url:'/shopmanage-ws/ws/0.1/jfMall/save',
      autocomplete : false,
      success : function(data) {
        $('.details-box',wraper).slideUp();    //隐藏 
        $('.jrad-table',wraper).slideDown();  //显示隐藏的
        $(".scroll-up-btn").click();
        $('#Table_integral_shop').flexMessage(data.msg, 'success');
        $('#Table_integral_shop').flexReload();
      },
      error:function(xhr){
              var errormsg = eval("(" + xhr.responseText + ")"); 
            if (errormsg != undefined) {
              //$('#Form_ads_manage').flexMessage(errormsg[0].message, 'error');
              $.jRadMessage({level:'error',message:errormsg[0].message});
            }
      }
  }); 
  //确定按钮
  $('#Form_ads_manage .jrad-btn-primary',wraper).button({
      click: function(){
        var flag = $('#Form_ads_manage',wraper).form('validateAll');
        var json = $('#Form_ads_manage',wraper).form('getValue'); 

        json.regions = []; 
        var regions = $("div[name='regions']",wraper).data("areaList");
        if(regions.length==0){
          $.jRadMessage({level:'error',message:"请选择要绑定的城市。"});
          return;
        }
        else{
          $.each(regions,function(){
            var region = {};
            region.provinceId = this.provinceId+""; 
            var areaCodeId = [];
            var areaList = this.areaList;
            for(var i=0;i<areaList.length;i++){
              areaCodeId.push(areaList[i].areaCodeId);
            }
            region.areaCodeId = areaCodeId.join(",");
            json.regions.push(region)
          });
        }
        json.regions = JSON.stringify(json.regions)
        // delete json.adPicFile;
        //delete json.itemHomeUrl;
        delete json.exchangecodeFile;
        $("#Form_ads_manage div[name='exchangecodeFile']",wraper).upload({
          params: json
        }).upload('upload');
      }  
  }); 

  page_list_buttons.push({title: '创建',name:'Add', bclass: 'add',onpress : function(){
       initAdsInfo(wraper); 
       $('#Form_ads_manage',wraper).form({
         item:{'operator':carsmart_config.operatorName},
         fields_params:fields_params,
         validators: jRad.validators,
         layout: 'grid', 
         autobinding: false
       }); 
       $("#Form_ads_manage div[name='isNeedExchangecode']",wraper).select('val','0'); 
       $("#Form_ads_manage div[name='isNeedExchangecode']",wraper).select('readonly',true); 
       $(".details-box .details-tab",wraper).find("span[name='title']").html("创建");
       $('.jrad-table',wraper).slideUp();
       $('.details-box',wraper).slideDown();
       $(".scroll-up-btn").click();  
    }
  });

  page_list_buttons.push({title: '修改',name:'Edit', bclass: 'edit',prefunc:function(){
            var checked = $('#Table_integral_shop').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
           var checked = $('#Table_integral_shop').getCheckedTrs(); 
           if(checked[0]){
             var id = checked[0].id;
             var item = $.jRadGet({url : '/shopmanage-ws/ws/0.1/jfMall/detail?id='+id});
             $('#Form_ads_manage',wraper).form({
              item:item,
              fields_params:fields_params,
              //validators: jRad.validators, 
              autobinding: false,
              layout: 'block', //popup弹出方式 block和grid为非弹出式
              url:'/shopmanage-ws/ws/0.1/jfMall/save',
              success_callback:function(){
                    $('#Table_integral_shop').flexMessage('修改成功','success');
                    $('#Table_integral_shop').flexReload()
                  }
             });
             updateAdsView(id,wraper);
           }
        }
  }); 
  
  page_list_buttons.push({name:'delete',bclass: 'delete',prefunc:function(){
        var checked = $('#Table_integral_shop').getCheckedTrs();
        if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
        var checked = $('#Table_integral_shop').getCheckedTrs();
        var postData={};
        postData.id=checked[0].id;
        postData.operator=carsmart_config.operatorName;
        $.jRadConfirm('确认删除吗？',1,function(){
          var id =  checked[0].id; 
          $.jRadAjax({
            type:'post',
            data:postData,
            url:'/shopmanage-ws/ws/0.1/jfMall/del',
            success: function(){
              $('#Table_integral_shop').flexMessage('删除成功!', 'success');
                $('#Table_integral_shop').flexReload();
            },
            error:function(xhr){
              var errormsg = eval("(" + xhr.responseText + ")"); 
              if (errormsg != undefined) {
                $('#Table_integral_shop').flexMessage(errormsg[0].message, 'error');
              }
            }
          });
        });
    }
  });
  
  page_list_buttons.push({separator: true}); 

  $('#Table_integral_shop').flexigrid({
        reload:true,
        method:'get',
        showSearch:true,
        colModel : page_column_model,
        buttons : page_list_buttons,
        searchitems :page_search_items,
        pagination: {
          diaplay_pages: 5,
          align: 'bottom' 
        },  
        queryParam: {'status':'3'},
        url:'/shopmanage-ws/ws/0.1/jfMall/list',
        onError:showError, 
        checkBoxType:'single',
        overflow:true,
        trEvent:function(){   //监听行事件 
          var checked = $('#Table_integral_shop').getCheckedTrs();  
          $('#Table_integral_shop_list').flexOptions({ 
            extParam:{
              id: checked[0].id
            }
          }).flexReload();
        }
  });   

  page_column_model_c.push({display: 'ID', name : 'takeId'}); 
  page_column_model_c.push({display: '用户手机', name : 'mobile'});
  page_column_model_c.push({display: '兑换码', name : 'exchangecode'});
  page_column_model_c.push({display: '领取时间', name : 'takeTime'});

  $('#Table_integral_shop_list').flexigrid({
        reload:true,
        autoload: false,
        method:'get',
        colModel : page_column_model_c,
        searchitems: [],
        pagination: {
           diaplay_pages: 5,
           align: 'bottom' 
        },
        showSearch:true,  
        overflow:true,
        url:'/shopmanage-ws/ws/0.1/jfMall/takeList', 
        onError:showError_2, 
        checkBoxType:'single'
  });
  function showError(xhr){
     var errormsg = eval("(" + xhr.responseText + ")"); 
     $.jRadMessage({level:'error',message:errormsg[0].message})
  }
  function showError_2(xhr){
     var errormsg = eval("(" + xhr.responseText + ")"); 
     $.jRadMessage({level:'error',message:errormsg[0].message})
  } 
  
  $(".details-tab .return",wraper).click(function(){
    $('.details-box',wraper).slideUp();
    $('.jrad-table',wraper).slideDown(); 
    $(".scroll-up-btn").click();
  });  
  
  //地区选择
  var area_fields_params = {};  
  area_fields_params['provinceId'] = {
    urlData:{
      url:'/shopmanage-ws/ws/0.1/userInfoCms/provinceAll' 
    },
    unshiftData: {id:'0',name:'全部'},
    onchange: function(){
      var provinceCode = $('#Form_area div[name=provinceId]',wraper).select('val');
      if(provinceCode=='0'){
        $('#Form_area div[name=areaCodeId]',wraper).select({data:[{id:'0',name:'全部'}]});
      }else{
      $('#Form_area div[name=areaCodeId]',wraper).select("val","0");
      $('#Form_area div[name=areaCodeId]',wraper).select({
        urlData:{
          url: '/shopmanage-ws/ws/0.1/userInfoCms/municipalities?provinceId=' + provinceCode 
        },
        unshiftData: {id:'0',name:'全部'}
      });
      }
    }
  }
  area_fields_params['areaCodeId'] = {
      data: [{id:'0',name:'全部'}]
  };
  $('#Form_area',wraper).form({
      title:"地区", 
      fields_params:area_fields_params,
      item:{"provinceId":"0","areaCodeId":"0"},
      submit:function(){  
        var json = {};
        json.provinceId = $("#Form_area div[name='provinceId']",wraper).select('val');
        json.provinceName = $("#Form_area div[name='provinceId']",wraper).select('text');
        json.areaList = [];
        json.areaList[0] = {};
        json.areaList[0].areaCodeId = $("#Form_area div[name='areaCodeId']",wraper).select('val');
        json.areaList[0].areaCodeName = $("#Form_area div[name='areaCodeId']",wraper).select('text');  
        var array = $("div[name='regions']",wraper).data("areaList");
        var pId = json.provinceId; 
        var aId = json.areaList[0].areaCodeId;
        if(pId=="0"){
          array = []; 
          array.push(json);
        }else{
            if(array.length==1&&array[0].provinceId=="0"){
          array = []; 
          array.push(json);
          }else{
            var flag = true;
            $.each(array,function(){
              if(this.provinceId == pId){
                flag = false;
                var areaList = this.areaList;
                if(aId=="0"){
                  this.areaList = json.areaList;
                }else{ 
                  var areaflag = true;
                  for(var i=0;i<areaList.length;i++){
                  if(areaList[i].areaCodeId==0){
                  areaflag = false;
                  this.areaList = json.areaList;
                  break;
                  }
                  if(areaList[i].areaCodeId==aId){ 
                  areaflag = false;
                  $.jRadMessage({level:'error',message:"该地区已经选择",selector:$("#Form_area",wraper)});
                  return;
                  }
                  
                  }
                  if(areaflag){
                  this.areaList.push(json.areaList[0]);
                  }
                }
              }
            });
            if(flag){  
              array.push(json);
            }  
          }
        }
        addAreaList(array,wraper); 
        $("div[name='regions']",wraper).data("areaList",array);
        $("#Form_area",wraper).form("close");
      }
  });

  $("#jrad-button-area",wraper).button({
    click : function() {  
      $('#Form_area',wraper).form({ 
        fields_params:area_fields_params,
        item:{"provinceId":"0","areaCodeId":"0"},
      }).form('open');
    }
  });

  //删除地区
  $("#area_check_string .delArea",wraper).live('click',function(){
    var info = $(this).data('info'); 
    var arr = $("div[name='regions']",wraper).data("areaList");
    $.each(arr,function(i){
      var json = this;
      if(json.provinceId==info.provinceId){
        if(info.areaId=="0"){
          arr.splice(i,1);
        }else if(json.areaList.length==1){
          arr.splice(i,1);
        }else{
          $.each(json.areaList,function(j){
          var area = this;
          if(area.areaCodeId==info.areaId){ 
          json.areaList.splice(j,1); 
          }
          });
        }
      }
    }); 
    $(this).parent('.areaSpan').remove();
  });
  
    $(".numb141").click(function(){
        $('.overcurtainDiv').hide();
        var menuId = $(".tabs-selected").attr("menuId")
        var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        $("#Form_explain_eg141").form({}).form('close');
        $("#Form_explain_eg141").form({
            title:'页面说明',
            item:data,
            autobinding: true, 
            submit:function(){
                var postData = {};
                postData.operator = carsmart_config.operatorName;
                postData.menuName = $(".tabs-selected").attr("menuName");
                postData.menuId = $(".tabs-selected").attr("menuId");
                postData.remark = $("#Form_explain_eg141 div[name='remark']").textarea("val")
                $.jRadPost({
                    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
                    data:postData,
                    success:function(){
                        $("#Form_explain_eg141").form('close')
                        $('.overcurtainDiv').hide();
                    }
                });
            }, 
            cancel:function(){
                $("#Form_explain_eg141").form('close')
                $('.overcurtainDiv').hide();
            }
        }).form('open')
        $("#Form_explain_eg141 .textarea-content").removeClass("span4").addClass("span12")
        $('.overcurtainDiv').hide();
        $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
    })
  // 初始化
  function initAdsInfo(wraper){
       //广告图
       var _ul = $("div[name='itemHomeUrl']",wraper).children(".pic-show"); 
       _ul.html(""); 

       var _ul2 = $("div[name='itemAdvertiseUrl']",wraper).children(".pic-show"); 
       _ul2.html(""); 

       //地区
       $("#Form_ads_manage div[name='regions']",wraper).data("areaList",[]); 
       $("#Form_ads_manage #area_check_string",wraper).html(""); 
  }

  //修改时赋值
  function Form_ads_manageVal(wraper,item){ 
     var _ul = $("div[name='adPicId']",wraper).children(".pic-show"); 
     var _ul2 = $("div[name='adPicId2']",wraper).children(".pic-show"); 
     var src = item.itemHomeUrl;
     var src2 = item.itemAdvertiseUrl;
     if(src!=undefined&&src!=""){ 
      var _li = '<li name="" class="adPicBoxli"><div class="large-pic"><div class="pic-box"><div class="pic-content"><div class="pic-vc">'
          +'<img src="'+src+'">'
          +'</div></div><span name="small" class="del-btn"></span></div></div></li>'
      _ul.html(_li); 
      $(".adPicBoxli .del-btn",wraper).click(function(){
        var small = $(this).prev(".pic-content").find("img").attr("src");
        $(this).parents(".adPicBoxli").remove();  
      });
     } 
     if(src2!=undefined&&src2!=""){ 
      var _li2 = '<li name="" class="adPicBoxli"><div class="large-pic"><div class="pic-box"><div class="pic-content"><div class="pic-vc">'
          +'<img src="'+src2+'">'
          +'</div></div><span name="small" class="del-btn"></span></div></div></li>'
      _ul2.html(_li2); 
      $(".adPicBoxli .del-btn",wraper).click(function(){
        var small = $(this).prev(".pic-content").find("img").attr("src");
        $(this).parents(".adPicBoxli").remove();  
      });
     } 
    
     //地区
     var areaList = item.regions; 
     $.each(areaList,function(i){
         if(areaList[i].areaList.length==0){
           areaList[i].areaList=[{"areaCodeId":"0"}];
         }
     });
     $("#Form_ads_manage div[name='regions']",wraper).data('areaList',areaList); 
     addAreaList(areaList,wraper);
  }

  function updateAdsView(id,wraper){ 
     var item = $.jRadGet({url : '/shopmanage-ws/ws/0.1/jfMall/detail?id='+id});  
     $(".details-box .details-tab",wraper).find("span[name='title']").html("修改"); 
     initAdsInfo(wraper);  
     $('.jrad-table',wraper).slideUp();
     $('.details-box',wraper).slideDown(); 
     $(".scroll-up-btn").click();  
     item.operator=carsmart_config.operatorName;
     item.id = id;
     $('#Form_ads_manage',wraper).form({item: item});  
     Form_ads_manageVal(wraper,item); 
  } 

})
</script>

