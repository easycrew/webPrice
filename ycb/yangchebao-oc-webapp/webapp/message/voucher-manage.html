<style type="text/css">
.marginleft .span18{margin-left:28px;}
</style>
<div class="urlContentWraper" id="Wraper_voucher"> 
	<div class="row-fluid ui-data-show"> 
			<div class="hDiv">
				 <h2 class="ui-tit"><strong>代金券管理列表</strong><bottom class="all-work-info numb99">页面说明</bottom></h2> 
				 <table id="Table_voucher"></table>
			</div> 
			<div class="bDiv">
				<br/>
				 <h2 class="ui-tit"><strong>商家列表</strong></h2> 
				<table id="Table_voucher_shoplist"></table>
			</div> 
			<div class="bDiv">
				<br/>
				 <h2 class="ui-tit"><strong>代金券列表</strong></h2> 
				<table id="Table_voucher_vlist"></table>

			</div> 
    </div> 
	
    <div id="Form_voucher" style="display:none;">
        <div class="grid-layout-main jrad-form">  
		    <input name="dinnerId" type="hidden"/>  
			<div class="row"> 
				<label class="span3 grid-layout-label voucherType"> 
					<span class="ui-form-required">*</span>
					代金劵类型：
				</label>
				<div class="span5 grid-layout-content fluid-wrap voucherType">
					<div name="voucherType" class="jrad-select-container">
					</div> 
				</div>
				<label class="span3 grid-layout-label"> 
					<span class="ui-form-required">*</span>
					最大领取数量：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div name="numLimit" class="jrad-input-container">
					</div> 
				</div>
			</div>
			<div class="row"> 
				<label class="span3 grid-layout-label"> 
					代金劵主题：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div name="voucherTopic" class="jrad-input-container">
					</div> 
				</div>
			</div>
			<div class="row"> 
				<label class="span3 grid-layout-label"> 
					<span class="ui-form-required">*</span>
					发布方：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div name="publisher" class="jrad-input-container">
					</div> 
				</div>
			</div>
			<div class="row issuanceNum"> 
				<label class="span3 grid-layout-label"> 
				<span class="ui-form-required">*</span>
					数量：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div name="issuanceNum" class="jrad-input-container">
					</div> 
				</div>
			</div>
			<div class="row money"> 
				<label class="span3 grid-layout-label"> 
				<span class="ui-form-required">*</span>
					金额：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div name="money" class="jrad-input-container">
					</div> 
				</div>
			</div>
			<!-- <div class="row default1"> 
				<label class="span3 grid-layout-label"> 
					是否指定服务：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div name="assignService" class="jrad-select-container">
					</div> 
				</div>
			</div>  --> 
			<div class="row default1"> 
				<label class="span3 grid-layout-label"> 
					服务：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div name="zeroService" class="jrad-select-container service">
					</div> 
				</div>
			</div>
			<!--defaultShow  defaultHide-->
			<div class="row default2"> 
				<label class="span3 grid-layout-label"> 
					满多少元可用：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div name="spendingBottomLimit" class="jrad-input-container">
					</div> 
				</div>
			</div> 
			<div class="row-fluid marginleft">
				 <label class="span3 grid-layout-label"></label>
				 <div class="span18 grid-layout-content">
					   <div name="validType" class="jrad-radio-container"></div>
				 </div>
			</div>
			<div class="row date">
				<label class="span3 grid-layout-label"> 
					<span class="ui-form-required">*</span>有效期开始时间：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div class="jrad-dateinput-container" name="startDate">
					</div>
				</div>
				<label class="span3 grid-layout-label"> 
					<span class="ui-form-required">*</span>有效期结束时间：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div class="jrad-dateinput-container" name="endDate">
					</div>
				</div>
			</div>
			<div class="row expiration" style="display:none;"> 
				<label class="span3 grid-layout-label"> 
					有效期(天)：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div name="validDays" class="jrad-input-container">
					</div> 
				</div>
			</div>
			<div class="row">
				 <label class="span3 grid-layout-label"><span class="ui-form-required">*</span>代金劵详情：</label>
				 <div class="span5 grid-layout-content fluid-wrap">
					   <div name="illustrate" class="jrad-textarea-container"></div>
									</div>
			</div>  
			<div class="row">
				<label class="span3 grid-layout-label">备注：</label>
				<div class="span5 grid-layout-content fluid-wrap">
					   <div name="remarks" class="jrad-textarea-container"></div>
				</div>
			</div> 
			<div class="row">
				<label class="span3 grid-layout-label">跳转：</label>
				<div class="span5 grid-layout-content fluid-wrap">
					   <div name="turnType" class="jrad-select-container"></div>
				</div>
				<div class="span10 grid-layout-content fluid-wrap">
				 	   <div name="turnParam" class="jrad-input-container"></div>
				</div>
			</div>  
			<div class="row"> 
				<label class="span3 grid-layout-label fluid-wrap"> 
					<span class="ui-form-required">*</span>状态：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div name="status" class="jrad-select-container">
					</div>
				</div>
				<div class="span8 grid-layout-content fluid-wrap" style="color:#777;">
					<p>跳转格式说明：</p>
					<p>1、商家详情：id=xxx</p>
					<p>2、商家列表：service=xx&specialServiceId=xx</p>
					<p>3、服务详情：id=xxx&busiServiceRelId=xx</p>
					<p>4、其他链接：url=http://xxxx</p>
				</div>
			</div> 
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span>
			<span class="jrad-btn-normal">取消</span>
        </div>
    </div>
    <div id="Form_voucher_shop" style="display:none;">
        <div class="grid-layout-main jrad-form">  
		    <input name="dinnerId" type="hidden"/>   
			<div class="row"> 
				<label class="span3 grid-layout-label"> 
					<span class="ui-form-required">*</span>商家ID：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div name="businessInfoIds" class="jrad-input-container">
					</div> 
					<p class="tip">多个商家id用英文逗号隔开</p>
				</div>
			</div> 
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span>
			<span class="jrad-btn-normal">取消</span>
        </div>
    </div> 

	<div id="Form_voucher_msg" style="display:none;">
        <div class="grid-layout-main jrad-form">  
			<input type="hidden" name='voucherTopicId'/>
			<div class="row">
                 <label class="span3 grid-layout-label">用户Id：</label>
                 <div class="span5 grid-layout-content">
                       <div name="userInfoId" class="jrad-input-container"></div>
					    <p class="ui-note">多个用户Id请用英文;隔开</p>
                                    </div>
                 <label class="span3 grid-layout-label">用户手机号：</label>
                 <div class="span5 grid-layout-content">
                       <div name="userPoneNo" class="jrad-input-container"></div>
					    <p class="ui-note">多个手机号请用英文;隔开</p>
                                    </div>
            </div> 
			<div class="row">
                 <label class="span3 grid-layout-label">发送给：</label>
                 <div class="span8 grid-layout-content">
                       <div name="userInfoIdFile" class="jrad-upload-container"></div> <!--a href="#" class="download" id="download">下载模板</a-->
                                    </div>
            </div> 
        </div>
        <div class="jrad-buttons-container ui-buttons-container">
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>

    <div id="Form_voucher_add" style="display:none;">
        <div class="grid-layout-main jrad-form">  
			<input type="hidden" name='voucherTopicId'/>
			<div class="row">
                 <label class="span3 grid-layout-label">追加代金券数量：</label>
                 <div class="span5 grid-layout-content">
                       <div name="addCnt" class="jrad-input-container"></div>
                                    </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container">
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
    <div id="Form_explain_eg99" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                <label class="span3 grid-layout-label">业务说明：</label>
                <div class="span12 grid-layout-content">
                    <div><strong>功能简介：</strong>咱们APP、微信、各种活动发放的代金券，都是在这里创建的。</div>
                    <div><strong>重要功能说明：</strong>①创建：代金券类型：通用代金券为每个商家都可以使用，店铺代金券只能在指定的商家使用；
                     最大领取数量：同一个用户最多领取的数量，一般设置为1；
                     代金券主题：即为展示给用户的代金券的名称；
                     发布方：就是谁发放的代金券，一般填写”养车宝“；
                     数量：发放代金券的数量；
                     金额：代金券的金额；
                     服务：可以不选择，若选择的话，此代金券只能在此服务使用；
                     满多少元可用：只有超过此金额的服务可以使用，不填的话则没限制；
                     有效期开始时间/结束时间：即代金券的有效期；
                     代金券详情：代金券的介绍文字；
                     备注：一些备注的信息，像和谁合作的代金券啊，可不填；
                     跳转：点击代金券详情跳转到哪个页面在这里设置；
                     状态：只有有效的代金券才能发放。
            ②代金券发放：勾选代金券后，点击此按钮，输入用户手机号，即可给此用户发放此代金券；
            ③代金券追加：若设置的代金券数量不够发放时，可再此给已经创建好的代金券追加数量（每次追加不要超过5000个，否则会卡）。</div>
                    <div><strong>注意事项：</strong>1、创建专属代金券时，是先创建一个代金券，让后勾选此代金券，给此代金券绑定商家；
          2、创建的代金券，设置的“满多少元可用”一般要大于“代金券金额”，否则商家刷代金券比较方便。</div>
                </div> 
            </div> 
            <div class="row">
                <label class="span3 grid-layout-label">备注：</label>
                <div class="span12 grid-layout-content">
                    <div class="jrad-textarea-container" name="remark">
                    </div>
                </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
</div>
<script type="text/javascript">
$(document).ready(function(){ 
    var wraper = $('#Wraper_voucher');
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array(); 
	
	var page_column_model_c = new Array(); 
	var page_list_buttons_c = new Array();

	var page_column_model_v = new Array(); 
	var page_search_items_v = new Array(); 
	var page_list_buttons_v = new Array();
	
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel});  
	jRad.validators['businessInfoId'] = [{"msg":"商家id不能为空","type":"min","value":"1"},{msg:"商家id只能是数字",type:'regex',value:/^\d+$/}]; 
	jRad.validators['name'] = [{"msg":"请填写","type":"min","value":"1"}]; 
	jRad.validators['shopPrice'] = [{"msg":"请填写","type":"min","value":"1"},{msg:"价格只能是正整数",type:'regex',value:/^\d+$/}]; 
	jRad.validators['reservePrice'] = [{"msg":"请填写","type":"min","value":"1"},{msg:"价格只能是正整数",type:'regex',value:/^\d+$/}]; 
	jRad.validators['clearingPrice'] = [{"msg":"请填写","type":"min","value":"1"},{msg:"价格只能是正整数",type:'regex',value:/^\d+$/}]; 
	jRad.validators['offerServiceId'] = [{"msg":"请选择","type":"min","value":"1"}]; 
    jRad.validators['startTime'] = [{"msg":"请选择","type":"min","value":"1"}]; 
    jRad.validators['endTime'] = [{"msg":"请选择","type":"min","value":"1"}]; 
    jRad.validators['namreserveInfoe'] = [{"msg":"请填写","type":"min","value":"1"}]; 
    jRad.validators['useRole'] = [{"msg":"请填写","type":"min","value":"1"}]; 
    jRad.validators['illustrate'] = [{"msg":"请填写","type":"min","value":"1"}]; 
	jRad.validators['status'] = [{"msg":"请选择","type":"min","value":"1"}]; 
	jRad.validators['addCnt'] = [{"msg":"请填写","type":"min","value":"1"}]; 
	jRad.validators['validType'] = [{"msg":"有效时间不能为空","type":"min","value":"1"}];

	//省市区select值
	jRad.params['provinceCodeSearch'] = {
			urlData:{
				url:'/shopmanage-ws/ws/0.1/userInfoCms/provinceAll'
			},
			unshiftData: {id:'',name:'请选择'},
			onchange: function(){
				var provinceCode = $('.searchContent div[name=provinceId]').select('val');
				if(provinceCode==''){
					$('.searchContent div[name=areaCodeId]').select({
																urlData:{url:''},
																data:[{id:'',name:'请选择'}],
																val: ''});
				}else{
				$('.searchContent div[name=areaCodeId]').select({
					urlData:{
						url: '/shopmanage-ws/ws/0.1/userInfoCms/municipalities?provinceId=' + provinceCode 
					},
					unshiftData: {id:'',name:'请选择'},
					val:''
				});
				} 
				$('.searchContent div[name=countyId]').select({
																urlData:{url:''},
																data:[{id:'',name:'请选择'}],
																val: ''});
			}
		};
	jRad.params['cityIdSearch'] = {
		data: [{id:'',name:'请选择'}],
		onchange: function(){
			var cityId = $('.searchContent div[name=areaCodeId]').select('val');
			if(cityId==''){
				$('.searchContent div[name=countyId]').select({
																urlData:{url:''},
																data:[{id:'',name:'请选择'}],val: ''});
			}else{
				$('.searchContent div[name=countyId]').select({
					urlData:{
						url: '/shopmanage-ws/ws/0.1/userInfoCms/countries?areaCodeId=' + cityId
					},
					unshiftData: {id:'',name:'请选择'},
					val:''
				});
			}
		}
	};
	
	jRad.params['countyIdSearch'] = {
			data: [{id:'',name:'请选择'}]
		};

	var fields_params = {}; 

	
	fields_params['validType']={
        data:[{id:'1',name:'起始时间有效期'},{id:'2',name:'固定时间有效期'}],
        onclick:function(){  
            if($("div[data-name='validType']",wraper).radio('val')=='1'){ 
               $(".expiration",wraper).hide();
               $(".date",wraper).show();
            }
            else{
                $(".expiration",wraper).show();
                $(".date",wraper).hide();
            }
        }
    };

	fields_params['turnType'] = {
		data:[{id:"4",name:"其他链接"},{id:"1",name:"商家详情"},{id:"2",name:"商家列表"},{id:"3",name:"服务详情"}]
	};
	fields_params['status'] = {
		data:[{id:"0",name:"无效"},{id:"1",name:"有效"},{id:"2",name:"删除"}] 
	}; 
	fields_params['voucherType'] = {
		data:[{id:"1",name:"通用代金券"},{id:"2",name:"店铺代金券"}],
		onchange:function(val){
			var $select = $("div[name='assignService']",wraper);
			if(val=="1"){ 
				// $("#Form_voucher .default1").hide();
				// $("#Form_voucher .default2").show();
				// $("#Form_voucher .default3").show();
				$("#Form_voucher div[name='zeroService']").select('val','');
			}else{
				// $("#Form_voucher .default1").show();
				// $("#Form_voucher .default2").show();
				// $("#Form_voucher .default3").hide();
				$("#Form_voucher div[name='zeroService']").select('val','');
			}

		} 
	};
	// fields_params['assignService'] = {
	// 	data:[{id:"1",name:"是"},{id:"0",name:"否"}] ,
	// 	onchange: function(val){ 
	// 		if(val=='1'){
	// 			$("#Form_voucher .service").parents('.row').show(); 
	// 			$("#Form_voucher .default2").show();
	// 			//$("#Form_voucher .default3").hide();
	// 		}else{
	// 			$("#Form_voucher div[name='zeroService']").select('val','');
	// 			$("#Form_voucher .service").parents('.row').hide();
	// 			$("#Form_voucher .default2").hide();
	// 			$("#Form_voucher .default3").show();
	// 		}
	// 	}
	// }; 
	fields_params['zeroService'] = {
	 	data:[{id:'',name:'请选择'},{id:'1',name:'洗车'},{id:'2',name:'美容'},{id:'3',name:'保养'},{id:'4',name:'维修'}] ,
	 	onchange:function(val){ 
			getServiceSonNode(1,val,wraper); 
		}
	}; 
	fields_params['startDate'] = { 
	    	dateFmt:'yyyy-MM-dd' 
	};
	fields_params['endDate'] = { 
	    	dateFmt:'yyyy-MM-dd'
	};  
	$('#Form_voucher').form({ 
        grid: 20, 
        fluid: true,
        validators: jRad.validators,
        fields_params: fields_params, 
		type:'post'
    });   
	//var fields_params = {};    
	fields_params['userInfoIdFile'] = {
		url:'/shopmanage-ws/ws/0.1/voucherCms/batch/binding',
        autocomplete:false,
		success: function(data) {   
			if (data != undefined&&data[0]!=undefined&&data[0].message!="") {
				$.jRadAlert(data[0].message,"error");  
			}else{
				$('#Form_voucher_msg',wraper).form('close');
				$('#Table_voucher').flexReloadCurrentPage();				
				if(data.status=="400"){
					$.jRadAlert(data.msg, 'warning',"",-1); 
				}else{
					$('#Table_voucher',wraper).flexMessage(data.msg, 'success'); 
				}
			} 
		},
		error:function(xhr){
			var errormsg = eval("(" + xhr.responseText + ")");
			$.jRadMessage({level:'error',message:errormsg[0].message,selector:$('#Form_voucher_msg .pop-up-middle',wraper)})
		}
	};	
	$('#Form_voucher_msg',wraper).form({
                title: '代金券发放',
                validators: jRad.validators,
                fields_params: fields_params,  
                submit: addShortMessage 
            });
	$('#Form_voucher_add',wraper).form({
                title: '代金券追加',
                validators: jRad.validators,
                fields_params: fields_params
            });
	function addShortMessage(){
		    var _form = $("#Form_voucher_msg");
		    var json = _form.form('getValue'); 
		    var flag = _form.form('validateAll');
		    if(!flag) {
			    return;
		    }  
		    delete json.userInfoIdFile;
		    $('div[name=userInfoIdFile]',wraper).upload({
				params: json,
		    }).upload('upload'); 
		    $('.bDiv .searchButtons .search').click();
	} 

	page_column_model.push({display: 'ID', name : 'voucherTopicId'}); 
	page_column_model.push({display: '代金券主题', name : 'voucherTopic',width:130,diy:function(item,$div){
		var a_topic=$('<a>').addClass('a_topic').attr('href','javascript:').html(item.voucherTopic);
		$div.append(a_topic);
		$('.a_topic',$div).unbind('click').bind('click',function(){
			var _items=$.jRadGet({url:'/shopmanage-ws/ws/0.1/voucherCms/getVoucherTopic?voucherTopicId='+item.voucherTopicId});
			$('#Form_voucher').form({
                title: '代金券详情',
                item:_items,  
                style:{height:'300px'}  
            }).form('open');  
            $("#Form_voucher .defaultHide").hide();
            $("#Form_voucher .jrad-buttons-container").hide();
            $("#Form_voucher .voucherType").show();
            $("#Form_voucher .issuanceNum").show();
            $("#Form_voucher .money").show();
            $("#Form_voucher .defaultShow").show();
            $("#Form_voucher .date").show();
            $("#Form_voucher div[name='turnParam']").input('val',_items.turnParam);
            $("#Form_voucher .jrad-input-container").input("readonly",true);
            $("#Form_voucher .jrad-select-container").select("readonly",true);
            $("#Form_voucher .jrad-textarea-container").textarea("readonly",true);
            $("#Form_voucher .jrad-dateinput-container").dateinput("readonly",true);
		})
	}}); 
    page_column_model.push({display: '发布方', name : 'publisher',width:100}); 
    page_column_model.push({display: '使用数/领取数/总量',width:140,name : 'shopPrice',diy:function(item,$div){
	   var str = item.usedNum + " / " + item.claimedNum + " / " + item.issuanceNum; 
	   $div.html(str); 
	}});
	page_column_model.push({display: '最大领取数量', name : 'numLimit',width:100});
    page_column_model.push({display: '金额', name : 'money'}); 
    page_column_model.push({display: '满多少消费可用', name : 'spendingBottomLimit',width:130}); 
    page_column_model.push({display: '绑定服务', name : 'serviceName',width:150});  
    page_column_model.push({display: '有效期(天)', name : 'validDays',width:80});  
    page_column_model.push({display: '有效期开始', name : 'startDate',width:100}); 
    page_column_model.push({display: '有效期结束', name : 'endDate',width:100}); 
    page_column_model.push({display: '创建时间', name : 'createTime',width:140}); 
    page_column_model.push({display: '来源', name : 'scourceName'});  
    page_column_model.push({display: '状态', name : 'statusName'});  
    page_column_model.push({display: '最后操作人', name : 'modifyPerson',width:80}); 
    page_column_model.push({display: '备注', name : 'remarks'});  
   
	page_search_items.push({row:'1',type:'jrad-select',display:'代金劵类型',name:'voucherType',params:{
		data:[
			{"id":"",name:"请选择"},{id:'1',name:'通用代金券'},{id:'2',name:'店铺代金券'}
		]}
	});  
	page_search_items.push({row:'1',type:'jrad-input',display:'主题',name:'voucherTopic'}); 
	page_search_items.push({row:'1',type:'jrad-input',display:'发布方',name:'publisher'}); 
	page_search_items.push({row:'2',type:'jrad-input',display:'用户ID',name:'userId'}); 
	page_search_items.push({row:'2',type:'jrad-input',display:'用户手机号',name:'userMobile'});  
	
	page_search_items.push({row:'3',type:'jrad-input',display:'金额起',name:'moneyBottom'}); 
	page_search_items.push({row:'3',type:'jrad-input',display:'金额终',name:'moneyTop'}); 
	page_search_items.push({row:'4',type:'jrad-input',display:'消费下限起',name:'spendingBottomLimitBot'}); 
	page_search_items.push({row:'4',type:'jrad-input',display:'消费下限终',name:'spendingBottomLimitTop'});  
	page_search_items.push({row:'5',type:'jrad-dateinput',display:'有效期开始时间',name:'startDate',params:{'dateFmt':'yyyy-MM-dd'}});
	page_search_items.push({row:'5',type:'jrad-dateinput',display:'有效期结束时间',name:'endDate',params:{'dateFmt':'yyyy-MM-dd'}});
	page_search_items.push({row:'6',type:'jrad-dateinput',display:'创建开始时间',name:'createDateBottom',params:{'dateFmt':'yyyy-MM-dd HH:mm:ss'}});
    page_search_items.push({row:'6',type:'jrad-dateinput',display:'创建结束时间',name:'createDateTop',params:{'dateFmt':'yyyy-MM-dd HH:mm:ss'}});
	
    page_search_items.push({row:'7',type:'jrad-input',display:'绑定商家',name:'businessRegName'});
    page_search_items.push({row:'7',type:'jrad-input',display:'绑定服务',name:'serviceName'}); 
   
    page_search_items.push({row:'2',type:'jrad-select',display:'状态',name:'status',params:{
		data:[
			{id:'',name:'未删除'},{"id":"-1",name:"全部"},{id:'0',name:'无效'},{id:'1',name:'有效'},{id:'2',name:'删除'}
		]}
	});  
	page_search_items.push({row:'3',type:'jrad-select',display:'来源',name:'scource',params:{
		data:[
			{"id":"",name:"全部"},{id:'1',name:'CMS发放'},{id:'2',name:'VIP发放'}
		]}
	});  
    page_search_items.push({row:'4',type:'jrad-input',display:'最后操作人',name:'modifyPerson'}); 
    page_search_items.push({row:'8',type:'jrad-select',display:'省',name:'provinceId',params:jRad.params['provinceCodeSearch']});
	page_search_items.push({row:'8',type:'jrad-select',display:'市',name:'areaCodeId',params:jRad.params['cityIdSearch']});
	page_search_items.push({row:'8',type:'jrad-select',display:'县',name:'countyId',params:jRad.params['countyIdSearch']}); 
     
    page_list_buttons.push({title: '创建',name:'Add', bclass: 'add',onpress : function(){  
			$('#Form_voucher').form({
                title: '创建代金券',
                validators: jRad.validators,
                item:{'validType':'1'},
                style:{height:'300px'}, 
               	url:'/shopmanage-ws/ws/0.1/voucherCms/addVoucherTopic',
				before_submit:function(json){ 
					json.modifyPerson = carsmart_config.operatorName; 
					// if(json.fourService==""){
					// 	delete json.fourService;
					// }
					// if(json.thirdService==""){
					// 	delete json.thirdService;
					// }
					// if(json.secondService==""){
					// 	delete json.secondService;
					// }
					// if(json.firstService==""){
					// 	delete json.firstService;
					// } //
					// json.serviceId =json.fourService||json.thirdService||json.secondService||json.firstService||json.zeroService;
					var length = $("#Form_voucher .service").length;
					var $select = $("#Form_voucher .service:last"); 
					var serviceId = $select.select('val');
					if(serviceId==""){
						serviceId = $($("#Form_voucher .service")[length-2]).select('val');
					} 
					json.serviceId = serviceId;
					return json;
				},				
				success_callback:function(){ 
                            $('#Table_voucher').flexMessage('添加成功', 'success');
                            $('#Table_voucher').flexReload();
                        }
            }).form('open');  
            //$("#Form_voucher .default3").show();
            // $("#Form_voucher .defaultHide").eq(0).hide();
            // $("#Form_voucher .defaultHide").eq(1).show();
            // $("#Form_voucher .defaultShow").show();
            // $("#Form_voucher .defaultHide").hide();
            $("#Form_voucher .jrad-buttons-container").show();
            $("#Form_voucher .voucherType").show();
            $("#Form_voucher .issuanceNum").show();
            $("#Form_voucher .money").show();
            $("#Form_voucher .date").show();
            $("#Form_voucher .jrad-input-container").input("readonly",false);
            $("#Form_voucher .jrad-select-container").select("readonly",false);
            $("#Form_voucher .jrad-textarea-container").textarea("readonly",false);
            $("#Form_voucher .jrad-dateinput-container").dateinput("readonly",false);
            $("#Form_voucher div[name='turnParam']").input('val','url=http://app.yangchebao.com.cn/group1/M00/09/A0/ChUBl1UvZe-AAKVAAAAHm22-0I082.html');
            $("#Form_voucher div[name='turnType']").select({
            	onchange:function(val){
            		if(val==4){
            			$("#Form_voucher div[name='turnParam']").input('val','url=http://app.yangchebao.com.cn/group1/M00/09/A0/ChUBl1UvZe-AAKVAAAAHm22-0I082.html')
            		}else{
            			$("#Form_voucher div[name='turnParam']").input('val','')
            		}
            	}
            });
        }
    });
    page_list_buttons.push({title: '编辑',name:'Edit', bclass: 'edit',prefunc:function(){
            var checked = $('#Table_voucher').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){  
        	var checked=$('#Table_voucher').getCheckedTrs();
        	var _items=$.jRadGet({url:'/shopmanage-ws/ws/0.1/voucherCms/getVoucherTopic?voucherTopicId='+checked[0].voucherTopicId});
			$('#Form_voucher').form({
                title: '编辑代金券',
                validators: jRad.validators,
                item:_items,  
                style:{height:'300px'}, 
               	url:'/shopmanage-ws/ws/0.1/voucherCms/modifyVoucherTopic',
				before_submit:function(json){ 
					json.voucherTopicId=checked[0].voucherTopicId;
					json.modifyPerson = carsmart_config.operatorName; 
				},				
				success_callback:function(){ 
                            $('#Table_voucher').flexMessage('编辑成功', 'success');
                            $('#Table_voucher').flexReloadCurrentPage()
                        } 
            }).form('open');  
            //$("#Form_voucher .defaultHide").hide();
            $("#Form_voucher .jrad-buttons-container").show();
            $("#Form_voucher .voucherType").hide();
            $("#Form_voucher .issuanceNum").hide();
            $("#Form_voucher .money").hide();
            //$("#Form_voucher .defaultShow").hide();
            //$("#Form_voucher .date").hide();
            $("#Form_voucher .jrad-input-container").input("readonly",false);
            $("#Form_voucher .jrad-select-container").select("readonly",false);
            $("#Form_voucher .jrad-textarea-container").textarea("readonly",false);
            $("#Form_voucher .jrad-dateinput-container").dateinput("readonly",false);
            $("#Form_voucher div[name='turnParam']").input('val',_items.turnParam);
            $("#Form_voucher div[name='zeroService']").select('readonly',true);

            if($("div[data-name='validType']",wraper).radio('val')!=='1'){ 
               $(".expiration",wraper).show();
               $(".date",wraper).hide();
            }
            else{
                $(".expiration",wraper).hide();
                $(".date",wraper).show();
            }
        }
    });  
 	page_list_buttons.push({name:'delete',bclass: 'delete',prefunc:function(){ 
            var checked = $('#Table_voucher').getCheckedTrs();
            if (checked.length != 1) {return false;} 
        },onpress : function(){
	    	var checked = $('#Table_voucher').getCheckedTrs();   
			$ .jRadConfirm('确认删除吗？',1,function(){ 
				var postData = {};
				postData.status = '2';  // 0. 无效；1. 有效；2.删除 
				postData.voucherTopicId = checked[0]. voucherTopicId; 
				$.jRadPost({
					url:'/shopmanage-ws/ws/0.1/voucherCms/setVoucherTopicStatus',
					data:postData,
					success:function(){ 
						$('#Table_voucher').flexMessage('已删除', 'success');
	                    $('#Table_voucher').flexReload();
					} 
				});   
			});  
		}
	}); 
	page_list_buttons.push({displayname: '设为无效',name:'status',bclass: 'status',prefunc:function(){ 
            var checked = $('#Table_voucher').getCheckedTrs();
            if (checked.length != 1) {return false;} 
        },onpress : function(){
	    	var checked = $('#Table_voucher').getCheckedTrs();   
			$ .jRadConfirm('确认设为无效吗？',1,function(){ 
				var postData = {};
				postData.status = '0';  // 0. 无效；1. 有效；2.删除 
				postData.voucherTopicId = checked[0]. voucherTopicId; 
				$.jRadPost({
					url:'/shopmanage-ws/ws/0.1/voucherCms/setVoucherTopicStatus',
					data:postData,
					success:function(){ 
						$('#Table_voucher').flexMessage('状态修改成功', 'success');
	                    $('#Table_voucher').flexReload();
					} 
				});   
			});  
		}
	}); 	
	page_list_buttons.push({displayname: '代金券发放',name:'send',bclass: 'send',prefunc:function(){ 
            var checked = $('#Table_voucher').getCheckedTrs();
            if (checked.length != 1) {return false;} 
        },onpress : function(){
	    	var checked = $('#Table_voucher').getCheckedTrs();   
			$('#Form_voucher_msg',wraper).form({
				item:{'voucherTopicId':checked[0].voucherTopicId},
				success_callback:function(){ 
					$('.reload').eq(2).click();
					$('.bDiv .searchButtons .search').click();
                    $('#Table_voucher_vlist').flexMessage('发放成功', 'success');
                    $('#Table_voucher_vlist').flexReloadCurrentPage()
                    $('#Table_voucher_vlist').flexReload()
                } 
			}).form('open'); 

			$('#Form_voucher_msg div[name="userInfoId"]').input('readonly',false);
			$('#Form_voucher_msg div[name="userPoneNo"]').input('readonly',false);
			$('#Form_voucher_msg div[name="userInfoId"]').input({
					listeners: 
					[{type:'focus',hander:function(){
						if($('#Form_voucher_msg div[name="userPoneNo"]').input('val') == ''){

							$('#Form_voucher_msg div[name="userPoneNo"]').input('readonly',true);
							$('#Form_voucher_msg div[name="userInfoId"]').input('readonly',false);
						}
						else{
							$('#Form_voucher_msg div[name="userInfoId"]').input('readonly',true);
							$('#Form_voucher_msg div[name="userPoneNo"]').input('readonly',false);
						}
					}
					}]
			});
			$('#Form_voucher_msg div[name="userPoneNo"]').input({
					listeners: 
					[{type:'focus',hander:function(){
						if($('#Form_voucher_msg div[name="userInfoId"]').input('val') == ''){

							$('#Form_voucher_msg div[name="userInfoId"]').input('readonly',true);
							$('#Form_voucher_msg div[name="userPoneNo"]').input('readonly',false);
						}
						else{
							$('#Form_voucher_msg div[name="userPoneNo"]').input('readonly',true);
							$('#Form_voucher_msg div[name="userInfoId"]').input('readonly',false);
						}
					}
					}]
			})
		}
	});
	page_list_buttons.push({displayname: '代金券追加',name:'send',bclass: 'send',prefunc:function(){ 
            var checked = $('#Table_voucher').getCheckedTrs();
            if (checked.length != 1) {return false;} 
        },onpress : function(){
	    	var checked = $('#Table_voucher').getCheckedTrs();   
			$('#Form_voucher_add',wraper).form({
				url:'/shopmanage-ws/ws/0.1/voucherCms/addVoucherCnt',
				before_submit:function(json){ 
					json.voucherTopicId=checked[0].voucherTopicId;
					json.modifyPerson = carsmart_config.operatorName; 
				},				
				success_callback:function(){ 
                            $('#Table_voucher').flexMessage('追加成功', 'success');
                            $('#Table_voucher').flexReloadCurrentPage()
                        } 
			}).form('open'); 
		}
	});
    page_list_buttons.push({separator: true});
    
    $('#Table_voucher').flexigrid({
            reload:true,
			method:'get',
            colModel : page_column_model,
            buttons : page_list_buttons,
            searchitems :page_search_items,
			pagination: {
				diaplay_pages: 5,
				align: 'bottom' 
			},
			showSearch:true, 
			overflow:true,
            url:'/shopmanage-ws/ws/0.1/voucherCms/queryVoucherTopics', 
			onError:showError,
			checkBoxType:'single',
			trEvent:function(){		//监听行事件 
				var checked = $('#Table_voucher').getCheckedTrs();  
				$('#Table_voucher_shoplist').flexOptions({ 
					extParam:{
						voucherTopicId: checked[0].voucherTopicId
					}
				}).flexReload();
				$('#Table_voucher_vlist').flexOptions({ 
					extParam:{
						voucherTopicId: checked[0].voucherTopicId
					}
				}).flexReload();
			}
    });   
	page_column_model_c.push({display: '商家ID', name : 'businessInfoId'});	
	page_column_model_c.push({display: '商家简称', name : 'businessRegName'});
	page_column_model_c.push({display: '城市', name : 'proviceAreadCodeName'});
	page_column_model_c.push({display: '商家地址', name : 'address'});
	page_column_model_c.push({display: '合作等级', name : 'isCooperationName'});    
	 
	page_list_buttons_c.push({name:'Add',bclass: 'add',onpress : function(){
 			$('#Form_voucher_shop').form({
                title: '创建',
                // validators: jRad.validators,
                item:{},  
                style:{height:'100px'}, 
               	url:'/shopmanage-ws/ws/0.1/voucherCms/addBusiVoucherRels',
				before_submit:function(json){ 
					var checked = $('#Table_voucher').getCheckedTrs();
					json.voucherTopicId = checked[0]. voucherTopicId;
					return json;
				},				
				success_callback:function(){ 
                            $('#Table_voucher_shoplist').flexMessage('添加成功', 'success');
                            $('#Table_voucher_shoplist').flexReload();
                        } 
            }).form('open');  
		}
	});   
	 
	page_list_buttons_c.push({name:'delete',bclass: 'delete',prefunc:function(){ 
            var checked = $('#Table_voucher_shoplist').getCheckedTrs();
            if (checked.length < 1) {return false;} 
        },onpress : function(){
	    	var checked = $('#Table_voucher_shoplist').getCheckedTrs();   
			$ .jRadConfirm('确认删除吗？',1,function(){
				var ids = [];
				$.each(checked,function(i){
					ids.push(checked[i].businessInfoId);
				});
				var postData = {};
				postData.businessInfoIds = ids.join(","); 
				var vchecked = $('#Table_voucher').getCheckedTrs();
				postData.voucherTopicId = vchecked[0]. voucherTopicId; 
				$.jRadPost({
					url:'/shopmanage-ws/ws/0.1/voucherCms/deleteBusiVoucherRels',
					data:postData,
					success:function(){ 
						$('#Table_voucher_shoplist').flexMessage('已删除', 'success');
	                    $('#Table_voucher_shoplist').flexReload();
					} 
				});   
			});  
		}
	}); 
	$('#Table_voucher_shoplist').flexigrid({
			reload: true,
			autoload: false,
			method:'get',
			dataType: 'json',
			url: '/shopmanage-ws/ws/0.1/voucherCms/queryBusiVoucherRels',
			searchitems: [], 
			colModel : page_column_model_c,
			buttons : page_list_buttons_c, 
			pagedStyle: 'oc'
	});
	page_search_items_v.push({row:'1',type:'jrad-dateinput',display:'领取时间始',name:'claimStartTime',params:{'dateFmt':'yyyy-MM-dd'}});
	page_search_items_v.push({row:'1',type:'jrad-dateinput',display:'领取时间终',name:'claimEndTime',params:{'dateFmt':'yyyy-MM-dd'}});
	page_search_items_v.push({row:'1',type:'jrad-dateinput',display:'使用时间始',name:'useStartTime',params:{'dateFmt':'yyyy-MM-dd'}});
	page_search_items_v.push({row:'2',type:'jrad-dateinput',display:'使用时间终',name:'useEndTime',params:{'dateFmt':'yyyy-MM-dd'}});
	page_column_model_v.push({display: 'ID', name : 'voucherId'});	
	page_column_model_v.push({display: '是否领用', name : 'isClaimedName'});
	page_column_model_v.push({display: '是否使用', name : 'isUsedName'});
	page_column_model_v.push({display: '绑定用户手机', name : 'mobile'});    
	page_column_model_v.push({display: '领取时间', name : 'claimTime'});    
	page_column_model_v.push({display: '使用时间', name : 'usedTime'});    
	page_column_model_v.push({display: '使用商家', name : 'businessRegName'});    
	page_column_model_v.push({display: '使用服务', name : 'serviceName'});    
	page_list_buttons_v.push({displayname: '导出',name:'excel', bclass: 'excel',onpress : function(){ 
		 var checked = $('#Table_voucher').getCheckedTrs();
		 $ .jRadConfirm('确认导出吗？',1,function(){  
				window.open('/shopmanage-ws/ws/0.1/voucherCms/exportVouchersByTopic?voucherTopicId='+checked[0].voucherTopicId); 
			});  
		}
	});   
 
	$('#Table_voucher_vlist').flexigrid({
			reload: true,
			autoload: false,
			method:'get',
			dataType: 'json',
			url: '/shopmanage-ws/ws/0.1/voucherCms/queryVouchersByTopic',
			searchitems: [], 
			colModel : page_column_model_v,
			buttons : page_list_buttons_v,
            searchitems :page_search_items_v,
            onError:showError2,
			checkBoxType: 'single',
			showSearch:true,
			pagedStyle: 'oc'
	});
 	function getServiceSonNode(n,val,wraper){   
		// if(val==""){
		// 	$("#Form_voucher .first").parents(".row").remove();
		// 	$("#Form_voucher .second").parents(".row").remove();
		// 	$("#Form_voucher .third").parents(".row").remove();
		// 	$("#Form_voucher .four").parents(".row").remove();
		// 	return false;
		// }
		var label = "",serviceClass = "",num = "";
		var node = n;
		if(node==1){
			label = "一级服务";
			serviceClass = "firstService"; 
			num = "first"; 
			$("#Form_voucher .first").parents(".row").remove();
			$("#Form_voucher .second").parents(".row").remove();
			$("#Form_voucher .third").parents(".row").remove();
			$("#Form_voucher .four").parents(".row").remove();
		}else if(node==2){
			label = "二级服务";
			serviceClass = "secondService"; 
			num = "second"; 
			$("#Form_voucher .second").parents(".row").remove();
			$("#Form_voucher .third").parents(".row").remove();
			$("#Form_voucher .four").parents(".row").remove();
		} else if(node==3){
			label = "三级服务";
			serviceClass = "thirdService"; 
			num = "third"; 
			$("#Form_voucher .third").parents(".row").remove();
			$("#Form_voucher .four").parents(".row").remove();
		} else if(node==4){
			label = "四级服务";
			serviceClass = "fourService"; 
			num = "four"; 
			$("#Form_voucher .four").parents(".row").remove();
		}
		if(val!=""){
			var item = $.jRadGetDataSources("/shopmanage-ws/ws/0.1/service/getSonServices?parentId="+val,"id","serviceName");
			if(item.length>0){
				item.unshift({id:'',name:'请选择'}); 
				var row = '<div class="row defaultHide">'
							+'<label class="span3 grid-layout-label">'+label+'：</label>'
							+'<div class="span5 grid-layout-content fluid-wrap">'
							+'<div name="'+serviceClass+'" class="jrad-select-container service '+ num +'"></div>'
							+'</div>'
							+'</div>'  
				$("#Form_voucher .service:last",wraper).parents(".row").after(row); 
				node++;
				$('#Form_voucher div[name='+serviceClass+']').select({
					data:item,
					unshiftData: {id:'',name:'请选择'},
					grid:'5',
					onchange:function(val){
						getServiceSonNode(node,val,wraper)
					} 
				});
			} 
		}
	}  
	
    $(".numb99").click(function(){
        $('.overcurtainDiv').hide();
        var menuId = $(".tabs-selected").attr("menuId")
        var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        $("#Form_explain_eg99").form({}).form('close');
        $("#Form_explain_eg99").form({
            title:'页面说明',
            item:data,
            autobinding: true, 
            submit:function(){
                var postData = {};
                postData.operator = carsmart_config.operatorName;
                postData.menuName = $(".tabs-selected").attr("menuName");
                postData.menuId = $(".tabs-selected").attr("menuId");
                postData.remark = $("#Form_explain_eg99 div[name='remark']").textarea("val")
                $.jRadPost({
                    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
                    data:postData,
                    success:function(){
                        $("#Form_explain_eg99").form('close')
                        $('.overcurtainDiv').hide();
                    }
                });
            }, 
            cancel:function(){
                $("#Form_explain_eg99").form('close')
                $('.overcurtainDiv').hide();
            }
        }).form('open')
        $("#Form_explain_eg99 .textarea-content").removeClass("span4").addClass("span12")
        $('.overcurtainDiv').hide();
        $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
    })
	
});
function showError(xhr){
		 var errormsg = eval("(" + xhr.responseText + ")"); 
		  $.jRadMessage({level:'error',message:errormsg[0].message});
		} 
function showError2(xhr){
	var errormsg = eval("(" + xhr.responseText + ")");
	var bDiv = $("#Wraper_voucher .bDiv").eq(1);
	$.jRadMessage({level:'error',message:errormsg[0].message,selector:bDiv});
}
</script>

