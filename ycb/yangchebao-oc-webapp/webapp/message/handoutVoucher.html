<div class="urlContentWraper" id="Wraper_handout_voucher">
    <div class="ui-info-layout">
        <h2 class="ui-tit"><strong>外发代金券管理</strong><bottom class="all-work-info numb912">页面说明</bottom></h2>
        <!-- 列表显示 -->
        <table id="Table_handout_voucher"></table>
    </div>
    <div id="Form_handout_voucher" style="display:none;">
        <div class="grid-layout-main jrad-form">   
			<div class="row"> 
				<label class="span4 grid-layout-label">
				   <span class="ui-form-required">*</span>
					公司名称：
				</label>
				<div class="span5 grid-layout-content">
					<div name="companyName" class="jrad-input-container"></div>
				</div>
			</div>
			<div class="row">
				<label class="span4 grid-layout-label">
					IP：
				</label>
				<div class="span5 grid-layout-content">
					<div name="companyIps" class="jrad-textarea-container"></div>
					<p class="ui-note">多个IP、用英文逗号隔开</p>
				</div>
			</div>
			<div class="row">
				<label class="span4 grid-layout-label">
					<span class="ui-form-required">*</span>
					KEY：
				</label>
				<div class="span5 grid-layout-content">
					<div name="secretKey" class="jrad-input-container"></div>
				</div>
			</div>
			<div class="row"> 
				 <label class="span4 grid-layout-label">
					<span class="ui-form-required">*</span>
					代金券ID：
				</label>
				<div class="span6 grid-layout-content bank">
					<div name="voucherTopicIdsRate" class="jrad-textarea-container"></div>
					<p class="ui-note">示例：46:90%,67:10%<br>代金劵ID+英文冒号+概率+英文逗号隔开<br>概率总和为100%</p>
				</div>
			</div>
			<div class="row"> 
				<label class="span4 grid-layout-label">
				   <span class="ui-form-required">*</span>
					最大限额：
				</label>
				<div class="span5 grid-layout-content">
					<div name="maxTakeAmount" class="jrad-input-container"></div>
				</div>
			</div>
			<div class="row"> 
				<label class="span4 grid-layout-label">
				   <span class="ui-form-required">*</span>
					领取开始时间：
				</label>
				<div class="span5 grid-layout-content">
					<div name="takeStartTime" class="jrad-dateinput-container"></div>
				</div>
			</div>
			<div class="row"> 
				<label class="span4 grid-layout-label">
				   <span class="ui-form-required">*</span>
					领取结束时间：
				</label>
				<div class="span5 grid-layout-content">
					<div name="takeEndTime" class="jrad-dateinput-container"></div>
				</div>
			</div> 
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span>
			<span class="jrad-btn-normal">取消</span>
        </div>
    </div>
    <div id="Form_explain_eg912" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                <label class="span3 grid-layout-label">业务说明：</label>
                <div class="span12 grid-layout-content">
                    <div><strong>功能简介：</strong>和第三方合作时，如果第三方需要外发代金券，可以在这里设置好，第三方直接调用接口即可领取咱们的代金券。</div>
                    <div><strong>重要功能说明：</strong>①创建：公司名称：合作方的名称；
                      IP：IP校验，非必填，一般不用校验IP；
                      KEY：校验字符；
                      代金券ID：按示例输入正确格式的代金券ID，注意符号一定要用英文，概率之和不能大于100，否则概率100后的，无法领取到；
                      最大限额：第三方领取的代金券不能超过此限额，否则会有错误提示；
                      领取开始时间/结束时间：只能在此时间段内领取这些代金券。</div>
                    <div><strong>注意事项：</strong>无。</div>
                </div> 
            </div> 
            <div class="row">
                <label class="span3 grid-layout-label">备注：</label>
                <div class="span12 grid-layout-content">
                    <div class="jrad-textarea-container" name="remark">
                    </div>
                </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
</div>
<script type="text/javascript">
$(document).ready(function(){
    var wraper = $('#Wraper_handout_voucher');
    var page_column_model = new Array();
    var page_list_buttons = new Array();
    var page_search_items = new Array(); 
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel}); 
    
	jRad.validators['companyName'] = [{"msg":"公司名称不能为空","type":"min","value":"1"}];
	jRad.validators['secretKey'] = [{"msg":"公司秘钥不能为空","type":"min","value":"1"},{"msg":"公司秘钥长度不能超过16字符","type":"max","value":"16"},{msg:"只能输入数字和字母",type:'regex',value:/^[A-Za-z0-9]+$/}];
	jRad.validators['voucherTopicIdsRate'] = [{"msg":"代金券ID不能为空","type":"min","value":"1"},{msg:"请输入正确格式的代金券ID",type:'regex',value:/^([0-9]+:[0-9]+%{1},{1})*([0-9]+:[0-9]+%{1})+$/}];
	jRad.validators['maxTakeAmount'] = [{"msg":"最大限额不能为空","type":"min","value":"1"},{msg:"请输入正整数",type:'regex',value:/^[0-9]*[1-9][0-9]*$/}];

	
	$('.jrad-textarea-container',wraper).textarea({
		rows:5,
		grid:10
	});
	 $('#Form_handout_voucher').form({
        grid: 20
    });
	page_column_model.push({display: '公司ID', name : 'companyId'}); 
	page_column_model.push({display: '公司代号', name : 'companyNo'});
    page_column_model.push({display: '公司名称', name : 'companyName'}); 
    page_column_model.push({display: 'KEY', name : 'secretKey'}); 
    page_column_model.push({display: '已领取代金券金额', name : 'hasTakeAmount'}); 
    page_column_model.push({display: '最大限额', name : 'maxTakeAmount'}); 
    page_column_model.push({display: 'IP', name:'companyIps'});
    page_column_model.push({display: '领取开始时间', name : 'takeStartTime'}); 
    page_column_model.push({display: '领取结束时间', name : 'takeEndTime'}); 
    page_column_model.push({display: '创建时间',name:'createTime'});
    page_column_model.push({display: '最后操作时间',name:'updateTime'}); 
    page_column_model.push({display: '最后操作人',name:'lastOperator'});
  

   page_list_buttons.push({title: '创建',name:'Add', bclass: 'add',onpress : function(){ 
			$('#Form_handout_voucher').form({
                title: '创建',
                validators: jRad.validators, 
                item:{},
                style:{height:'300px'}, 
                url:'/shopmanage-ws/ws/0.1/thirdPartCompanyVoucherTopic/add', 
				before_submit:function(json){
					json.lastOperator=carsmart_config.operatorName
				},
				success_callback:function(){ 
                            $('#Table_handout_voucher').flexMessage('创建成功', 'success');
                            $('#Table_handout_voucher').flexReload();
                        } 
            }).form('open');

        }
    }); 
	
	page_list_buttons.push({name:'edit',bclass: 'edit',prefunc:function(){
            var checked = $('#Table_handout_voucher').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
        	var checked=$("#Table_handout_voucher",wraper).getCheckedTrs();
				$('#Form_handout_voucher').form({
                title: '编辑',
                validators: jRad.validators, 
                url:'/shopmanage-ws/ws/0.1/thirdPartCompanyVoucherTopic/modify', 
                before_submit:function(json){
                	json.companyId=checked[0].companyId;
                	json.lastOperator=carsmart_config.operatorName
                },
				success_callback:function(){ 
                            $('#Table_handout_voucher').flexMessage('编辑成功', 'success');
                            $('#Table_handout_voucher').flexReload();
                        } 
            }).form('open'); 
			var _takeStartTime=checked[0].takeStartTime.substr(0,10);
			var _takeEndTime=checked[0].takeEndTime.substr(0,10);
			var _maxTakeAmount=parseInt(checked[0].maxTakeAmount);
			$("#Form_handout_voucher div[name='companyName']",wraper).input('val',checked[0].companyName);
			$("#Form_handout_voucher div[name='companyIps']",wraper).textarea('val',checked[0].companyIps);
			$("#Form_handout_voucher div[name='secretKey']",wraper).input('val',checked[0].secretKey);
			$("#Form_handout_voucher div[name='voucherTopicIdsRate']",wraper).textarea('val',checked[0].voucherTopicIdsRate);
			$("#Form_handout_voucher div[name='maxTakeAmount']",wraper).input('val',_maxTakeAmount);
			$("#Form_handout_voucher div[name='takeStartTime']",wraper).dateinput('val',_takeStartTime);
			$("#Form_handout_voucher div[name='takeEndTime']",wraper).dateinput('val',_takeEndTime);
		}
	});
	page_list_buttons.push({name:'delete',bclass: 'delete',prefunc:function(){
            var checked = $('#Table_handout_voucher').getCheckedTrs();
            if (checked.length == 0) {return false;}else{return true;}
        },onpress : function(){
	    	var checked = $('#Table_handout_voucher').getCheckedTrs();
	    	var ids=[];
	    	$.each(checked,function(i){
	    		var id=checked[i].companyId;
	    		ids.push(id);
	    	});
	    	var _ids=ids.join(','); 
			$.jRadConfirm('确认删除吗？',1,function(){
				var postData={};
				postData.companyIds=_ids;
				postData.lastOperator=carsmart_config.operatorName
				$.jRadPost({
					url:'/shopmanage-ws/ws/0.1/thirdPartCompanyVoucherTopic/del',
					data:postData,
					success:function(){
						$('#Table_handout_voucher').flexMessage('已删除', 'success');
                        $('#Table_handout_voucher').flexReload();
					}
				})
			}) 
		}
	});   
    page_list_buttons.push({separator: true});
    
    $('#Table_handout_voucher').flexigrid({
            reload:true,
			method:'get',
            colModel : page_column_model,
            buttons : page_list_buttons,
            searchitems :page_search_items,
            pagination: {
				diaplay_pages: 5,
				align: 'bottom' 
			}, 
			showSearch:true,
            url:'/shopmanage-ws/ws/0.1/thirdPartCompanyVoucherTopic/list', 
            overflow:true,
			onError:showError
    });
    
    $(".numb912").click(function(){
        $('.overcurtainDiv').hide();
        var menuId = $(".tabs-selected").attr("menuId")
        var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        $("#Form_explain_eg912").form({}).form('close');
        $("#Form_explain_eg912").form({
            title:'页面说明',
            item:data,
            autobinding: true, 
            submit:function(){
                var postData = {};
                postData.operator = carsmart_config.operatorName;
                postData.menuName = $(".tabs-selected").attr("menuName");
                postData.menuId = $(".tabs-selected").attr("menuId");
                postData.remark = $("#Form_explain_eg912 div[name='remark']").textarea("val")
                $.jRadPost({
                    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
                    data:postData,
                    success:function(){
                        $("#Form_explain_eg912").form('close')
                        $('.overcurtainDiv').hide();
                    }
                });
            }, 
            cancel:function(){
                $("#Form_explain_eg912").form('close')
                $('.overcurtainDiv').hide();
            }
        }).form('open')
        $("#Form_explain_eg912 .textarea-content").removeClass("span4").addClass("span12")
        $('.overcurtainDiv').hide();
        $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
    })
    
});
function showError(xhr){
		 var errormsg = eval("(" + xhr.responseText + ")"); 
		  $.jRadMessage({level:'error',message:errormsg[0].message});
		} 
</script>

