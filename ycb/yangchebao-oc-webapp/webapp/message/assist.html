<div class="urlContentWraper" id="Wraper_assist">
    <div class="ui-info-layout">
        <div class="bDiv">
            <h2 class="ui-tit"><strong>抢购活动管理</strong></h2>
            <table id="Table_assist"></table>
        </div>
        <div class="hDiv" style="margin-top:15px;">
            <h2 class="ui-tit"><strong>参加活动用户列表</strong></h2>
            <table id="Table_users_list"></table>
        </div>
    </div>
    <div id="Form_assist" style="display: none;">
        <div class="grid-layout-main jrad-form">
            <input name="buyingActivityId" type="hidden">
            <input name="modifyPeople" type="hidden">
            <input name="tradePicUrl" type="hidden">
            <div class="row">
                <label class="span3 grid-layout-label">活动名称：</label>

                <div class="span5 grid-layout-content">
                    <div name="buyingActivityName" class="jrad-input-container"></div>
                </div>
            </div>
            <div class="row">
                <label class="span3 grid-layout-label">商品名称：</label>

                <div class="span5 grid-layout-content">
                    <div name="tradeName" class="jrad-input-container"></div>
                </div>
            </div>
            <div class="row">
                <label class="span3 grid-layout-label">商品类型：</label>

                <div class="span5 grid-layout-content">
                    <div name="tradeType" class="jrad-select-container"></div>
                </div>
            </div>
            <div class="row">
                <label class="span3 grid-layout-label">商品ID：</label>

                <div class="span5 grid-layout-content">
                    <div name="tradeId" class="jrad-input-container"></div>
                </div>
            </div>
            <div class="row">
                <label class="span3 grid-layout-label">商品图片：</label>

                <div class="span10 grid-layout-content fluid-wrap">
                    <div name="tradePicFile" class="jrad-uploadimg-container">
                    </div>
                </div>
            </div>
            <div class="row">
                <label class="span3 grid-layout-label">商品原价：</label>

                <div class="span5 grid-layout-content">
                    <div name="reservePrice" class="jrad-input-container"></div>
                </div>
            </div>
            <div class="row">
                <label class="span3 grid-layout-label">最少砍到价格：</label>

                <div class="span5 grid-layout-content">
                    <div name="minThreshold" class="jrad-input-container"></div>
                </div>
            </div>
            <div class="row">
                <label class="span3 grid-layout-label">砍价规则：</label>

                <div class="span4 grid-layout-content">
                    <div name="bargainRuleFirstValue" class="jrad-input-container"></div>
                </div>
                <label class="span grid-layout-label">%士</label>
                <div class="span4 grid-layout-content">
                    <div name="bargainRuleSecondValue" class="jrad-input-container"></div>
                </div> %

            </div>
            <p class="ui-note"><label class="span3 grid-layout-label"></label>说明：每次砍掉价格=（最新砍后价格-最少砍到价格）*砍价规则，砍价规则前面为固定百分比，后面为浮动百分比，最少砍掉1元，到达最少砍到价格，无法砍价。</p>
            <div class="row">
                <label class="span3 grid-layout-label">活动开始时间：</label>

                <div class="span5 grid-layout-content">
                    <div name="startTime" class="jrad-dateinput-container"></div>
                </div>
            </div>
            <div class="row">
                <label class="span3 grid-layout-label">活动结束时间：</label>

                <div class="span5 grid-layout-content">
                    <div name="endTime" class="jrad-dateinput-container"></div>
                </div>
            </div>
            <div class="row">
                <label class="span3 grid-layout-label">活动说明：</label>

                <div class="span5 grid-layout-content">
                    <div name="activityDesc" class="jrad-mediaarea-container" style="margin-left:0"></div>
                </div>
            </div>
            <div class="row">
                <label class="span3 grid-layout-label">标题说明：</label>

                <div class="span5 grid-layout-content">
                    <div name="titleDesc" class="jrad-mediaarea-container" style="margin-left:0"></div>
                </div>
            </div>
            <div class="row">
                <label class="span3 grid-layout-label">url链接：</label>

                <div class="span5 grid-layout-content">
                    <div name="activityUrl" class="jrad-input-container" style="margin-left:0"></div>
                </div>
            </div>
            <div class="row">
                <label class="span3 grid-layout-label">状态：</label>

                <div class="span5 grid-layout-content">
                    <div name="status" class="jrad-select-container"></div>
                </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container">
            <span class="jrad-btn-primary">确定</span>
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function(){
        var wraper = $('#Wraper_assist');
        var page_column_model = new Array();
        var page_search_items = new Array();
        var page_list_buttons = new Array();

        var page_column_model_b = new Array();
        var page_search_items_b = new Array();
        var entityModel = {};
        var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel});

        page_column_model.push({display: 'ID', name : 'buyingActivityId'});
        page_column_model.push({display: '活动名称', name : 'buyingActivityName'});
        page_column_model.push({display: '商品名称', name : 'tradeName'});
        page_column_model.push({display: '商品类型', name : 'tradeType'});
        page_column_model.push({display: '车主卡主题ID', name : 'cardTopicId'});
        page_column_model.push({display: '服务绑定ID', name : 'serviceId'});
        page_column_model.push({display: '商品原价', name : 'reservePrice'});
        page_column_model.push({display: '最少砍到价格', name : 'minThreshold'});
        page_column_model.push({display: '活动开始时间', name : 'startTime'});
        page_column_model.push({display: '活动结束时间', name : 'endTime'});
        page_column_model.push({display: 'url链接', name : 'activityUrl'});
        page_column_model.push({display: '状态', name : 'status'});
        page_column_model.push({display: '最后操作时间', name : 'updateDate'});
        page_column_model.push({display: '最后操作人', name : 'modifyPeople'});


        page_column_model_b.push({display: 'ID', name : 'buyingFriendAssistInId'});
        page_column_model_b.push({display: '微信昵称', name : 'sponsorNickname'});
        page_column_model_b.push({display: '领取手机号', name : 'mobile'});
        page_column_model_b.push({display: '好友砍价数', name : 'friendAssistInNumber'});
        page_column_model_b.push({display: '砍价金额', name : 'assistInCash'});
        page_column_model_b.push({display: '购买价格', name : 'purchasePrice'});
        page_column_model_b.push({display: '是否已购买商品', name : 'isOrdered'});
        page_column_model_b.push({display: '是否达到阈值', name : 'isAchieveThreshold'});
        page_column_model_b.push({display: '数据生成时间', name : 'createDate'});
        page_column_model_b.push({display: '购买时间', name : 'purchaseDate'});

        page_search_items.push({row:'1',type:'jrad-input',display:'活动名称',name:'buyingActivityName'});
        page_search_items.push({row:'1',type:'jrad-input',display:'商品名称',name:'tradeName'});
        page_search_items.push({row:'1',type:'jrad-select',display:'商品类型',name:'tradeType',params:{
            data:[
                {"id":"",name:"全部"},
                {"id":"1",name:"服务"},
                {"id":"2",name:"车主卡"}
            ]
        }});
        page_search_items.push({row:'2',type:'jrad-input',display:'车主卡主题ID',name:'cardTopicId'});
        page_search_items.push({row:'2',type:'jrad-input',display:'服务ID',name:'serviceId'});
        page_search_items.push({row:'2',type:'jrad-select',display:'状态',name:'status',params:{
            data:[
                {"id":"",name:"全部"},
                {"id":"0",name:"未删除"},
                {"id":"1",name:"有效"},
                {"id":"2",name:"无效"}
            ]
        }});

        page_search_items_b.push({row:'1',type:'jrad-input',display:'微信昵称',name:'sponsorNickname'});
        page_search_items_b.push({row:'1',type:'jrad-input',display:'领取手机号',name:'mobile'});
        page_search_items_b.push({row:'1',type:'jrad-select',display:'是否已购买商品',name:'isOrdered',params:{
            data:[
                {"id":"",name:"全部"},
                {"id":"1",name:"是"},
                {"id":"0",name:"否"}
            ]
        }});

        var fields_params = {};
        fields_params['startTime'] = {
            dateFmt:'yyyy-MM-dd HH:mm:ss'
        };
        fields_params['endTime'] = {
            dateFmt:'yyyy-MM-dd HH:mm:ss'
        };
        fields_params['tradeType'] = { data:[{"id":"2",name:"车主卡"},{"id":"1",name:"服务"}]};
        fields_params['status'] = { data:[{"id":"1",name:"有效"},{"id":"0",name:"未删除"},{"id":"2",name:"无效"}]};

        var _form = $("#Form_assist",wraper);
        fields_params['tradePicFile'] = {
            url:'/shopmanage-ws/ws/0.1/file/uploadThree',
            delFunc: function(item){
                item.list.remove();
                $("input[name='tradePicUrl']",_form).val("");
            },
            fileName:"file",
            note: '仅支持 JPG图片文件。',
            show: false,
            params: {type:""},
            success: function(data){
                if(data[0]&&data[0].code=="400"){
                    $.jRadMessage({level:'error',message:data[0].message});
                }else{
                    $("input[name='tradePicUrl']",_form).val(data.fileUrl)
                }
            },
            beforeSubmit: function(obj){
                var re = /^.*\.(jpg|JPG|png|PNG)$/;
                if(re.test(obj.val())){
                    return true;
                }else{
                    $.jRadAlert("只能上传jpg文件", "error");
                    $("div[name='tradePicFile']",_form).find("input[type='file']").val('');
                    return false;
                }
            },
            single: true,
            showInfo:false,
            prev:'smallUrl'
        };

        page_list_buttons.push({title: '创建', name: 'Add', bclass: 'add', onpress: function () {
                $('#Form_assist').form({
                    title: '创建',
                    validators: jRad.validators,
                    fields_params: fields_params,
                    url:"/shopmanage-ws/ws/0.1/buyingCms/editBuyingActivity",
                    item:[],
                    //submit: addMessage
                    before_submit:function(json){
                        delete json.tradePicFile;
                        json.modifyPeople = carsmart_config.operatorName;
                        return json;
                    },
                    success_callback:function(){
                        $('#Table_assist').flexMessage('添加成功', 'success');
                        $('#Table_assist').flexReload();
                    }
                }).form('open');
            }
        });

        page_list_buttons.push({title: '编辑', name: 'Edit', bclass: 'edit',prefunc:function(){
            var checked = $('#Table_assist').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress: function () {
                var checked = $('#Table_assist').getCheckedTrs();
                var buyingActivityId=checked[0].buyingActivityId;
                var items=$.jRadGet({url:'/shopmanage-ws/ws/0.1/buyingCms/getBuyingActivity?buyingActivityId='+buyingActivityId});
                $('#Form_assist').form({
                    title: '编辑',
                    validators: jRad.validators,
                    fields_params: fields_params,
                    item: items,
                    url:"/shopmanage-ws/ws/0.1/buyingCms/editBuyingActivity",
                    //submit: addMessage
                    before_submit:function(json){
                        delete json.tradePicFile;
                        json.modifyPeople = carsmart_config.operatorName;
                        return json;
                    },
                    success_callback:function(){
                        $('#Table_assist').flexMessage('编辑成功', 'success');
                        $('#Table_assist').flexReload();
                    }
                }).form('open');
                var _ul = $("div[name='tradePicFile']",_form).children(".pic-show"); 
                var src = items.tradePicUrl;  
                if(src!=undefined&&src!=""){ 
                    var _li = '<li><div class="smallUrl-pic"><div class="pic-box"><div class="pic-content"><div class="pic-vc">'
                            +'<img src="'+src+'">'
                            +'</div></div><span name="smallUrl" class="del-btn"></span></div></div></li>'
                    _ul.html(_li); 
                    $(".del-btn",_ul).click(function(){ 
                        _ul.html(""); 
                        $("input[name='tradePicUrl']",_form).val(""); 
                    });
                }
            }
        });

        page_list_buttons.push({separator: true});

        $('#Table_assist').flexigrid({
            reload:true,
            method:'get',
            colModel : page_column_model,
            searchitems :page_search_items,
            buttons: page_list_buttons,
            showSearch:true,
            pagination: {
                diaplay_pages: 5,
                align: 'bottom'
            },
            url:'/shopmanage-ws/ws/0.1/buyingCms/pageBuyingActivity',
            onError:showInfoError,
            checkBoxType:'single',
            overflow:true,
            trEvent:function(){     //监听行事件 
                var checked = $('#Table_assist').getCheckedTrs();  
                $('#Table_users_list').flexOptions({ 
                    extParam:{
                        buyingActivityId: checked[0].buyingActivityId
                    }
                }).flexReload();
            }
        });

        $('#Table_users_list').flexigrid({
            reload:true,
            autoload: false,
            method:'get',
            colModel : page_column_model_b,
            searchitems :page_search_items_b,
            showSearch:true,
            pagination: {
                diaplay_pages: 5,
                align: 'bottom'
            },
            overflow:true,
            preQuery: function(param){// 查询前对查询参数的操作
               var checked = $('#Table_assist').getCheckedTrs();  
               if(checked.length!=1){
                    delete param.buyingActivityId
               }
            }, 
            url:'/shopmanage-ws/ws/0.1/buyingCms/pageBuyingFriendAssistIn',
            onError:showInfoError2,
            checkBoxType:'single',
            overflow:true
        });

        $('div.searchContent:eq(1) label.grid-layout-label:eq(2)').removeClass('span3').addClass('span4');
        $('div.searchContent:eq(1) div.grid-layout-content:eq(2)').removeClass('span4').addClass('span3');


    });

    function showInfoError(xhr){
        var errormsg = eval("(" + xhr.responseText + ")");
        var cDiv = $("#Wraper_assist .bDiv .cDiv");
        $.jRadMessage({level:'error',message:errormsg[0].message,selector:cDiv});
    }
    function showInfoError2(xhr){
        var errormsg = eval("(" + xhr.responseText + ")");
        var cDiv = $("#Wraper_assist .hDiv .cDiv");
        $.jRadMessage({level:'error',message:errormsg[0].message,selector:cDiv});
    }
</script>