<div class="urlContentWraper" id="Wraper_businesystem_message">
    <div class="ui-info-layout">
        <h2 class="ui-tit"><strong>商家系统消息列表</strong><bottom class="all-work-info numb92">页面说明</bottom></h2>
        <!-- 列表显示 -->
        <table id="Table_businesystem_message"></table>
    </div>
    <div id="Form_businesystem_message" style="display:none;"> 
		<div class="grid-layout-main jrad-form">
            <input name="messageId" type="hidden"> 
			 <div class="row">
                 <label class="span3 grid-layout-label">IOS系统PUSH：</label>
                 <div class="span5 grid-layout-content">
                       <div name="iosPushStatus" class="jrad-select-container"></div>
                                    </div>
            </div>
			 <div class="row">
                 <label class="span3 grid-layout-label">安卓系统PUSH：</label>
                 <div class="span5 grid-layout-content">
                       <div name="androidPushStatus" class="jrad-select-container"></div>
                                    </div>
            </div>
			 <div class="row">
                 <label class="span3 grid-layout-label">系统消息：</label>
                 <div class="span5 grid-layout-content">
                       <div name="isSystemMsg" class="jrad-select-container"></div>
                                    </div>
            </div>
            <div class="row">
                 <label class="span3 grid-layout-label">平台：</label>
                 <div class="span5 grid-layout-content">
                       <div name="platform" class="jrad-select-container"></div>
                                    </div>
            </div>
            <div class="row">
                 <label class="span3 grid-layout-label">消息类型：</label>
                 <div class="span5 grid-layout-content">
                       <div name="infoType" class="jrad-select-container"></div>
                                    </div>
            </div>			
            <div class="row" >
                 <label class="span3 grid-layout-label">系统消息标题：</label>
                 <div class="span5 grid-layout-content">
                       <div name="title" class="jrad-input-container"></div>
                                    </div>
            </div>
            
            <div class="row">
                 <label class="span3 grid-layout-label">系统消息内容：</label>
                 <div class="span5 grid-layout-content">
                       <div name="remarks" class="jrad-textarea-container"></div>
                                    </div>
            </div>
			<div class="row">
                 <label class="span3 grid-layout-label">push内容：</label>
                 <div class="span5 grid-layout-content">
                       <div name="pushContent" class="jrad-textarea-container"></div>
                       <p>您已经输入了 <span name="pushLen">0</span> 个字节</p>
					   <p class="ui-note">push内容不得超出105字节</p>
                                    </div>
            </div>
			<div class="row">
                 <label class="span3 grid-layout-label">push打开界面：</label>
                 <div class="span5 grid-layout-content">
                       <div name="pushPage" class="jrad-input-container"></div>
                                    </div>
            </div>
			<div class="row">
                 <label class="span3 grid-layout-label">发送给：</label>
                 <div class="span8 grid-layout-content">
                       <div name="busiIds" class="jrad-upload-container"></div>
                                    </div>
            </div>
			<div class="row">
                 <label class="span3 grid-layout-label">状态：</label>
                 <div class="span5 grid-layout-content">
                       <div name="status" class="jrad-select-container"></div>
                                    </div>
            </div>
			<div class="row">
                 <label class="span3 grid-layout-label">发送时间：</label>
                 <div class="span5 grid-layout-content">
                       <div name="sendDate" class="jrad-dateinput-container"></div>
                                    </div>
            </div> 
        </div> 
        <div class="jrad-buttons-container ui-buttons-container">
            <span class="jrad-btn-primary">确定</span>
			<span class="jrad-btn-normal">取消</span> 
        </div>
    </div>
    <div id="Form_explain_eg92" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                <label class="span3 grid-layout-label">业务说明：</label>
                <div class="span12 grid-layout-content">
                    <div><strong>功能简介：</strong>给商家发送系统消息，是通过此功能发送的。</div>
                    <div><strong>重要功能说明：</strong>①平台：商家VIP是给商家后台发送系统消息，商家客户端是给商家APP发送消息。②消息类型：区分消息的分类，系统逻辑上没有用到；③系统消息标题：发送的系统消息的标题；④系统消息内容：系统消息的内容，字数可多发点；⑥push内容：发送的push的内容，只能支持35个左右的汉字；⑦Push打开页面：点击push，打开的页面；⑧发送给：可直接输入用户ID，也可上传txt的文件，每个用户ID一行；⑨状态：发送状态的消息才会发送；⑩发送时间：会在设置时间的下个整点发送消息或push。</div>
                    <div><strong>注意事项：</strong>1、一次发送不要超过1000条，否则系统可能挂掉，数量较多最好分多次发送；2、系统消息、PUSH都是发送时间的下个整点发送，不是实时的。</div>
                </div> 
            </div> 
            <div class="row">
                <label class="span3 grid-layout-label">备注：</label>
                <div class="span12 grid-layout-content">
                    <div class="jrad-textarea-container" name="remark">
                    </div>
                </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
</div>
<script type="text/javascript">
$(document).ready(function(){
	var pathJson = $.jRadGet({url:'/shopmanage-ws/ws/0.1/file/downFileDemo?type=2'});  
    var wraper = $('#Wraper_businesystem_message');
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array();
	 	
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel}); 
    jRad.validators['title'] = [{"msg":"标题不能为空","type":"min","value":"1"},{"msg":"标题超长","type":"max","value":"128"}];
	jRad.validators['remarks'] = [{"msg":"内容不能为空","type":"min","value":"1"},{"msg":"内容超长","type":"max","value":"2000"}];
	jRad.validators['sendDate'] = [{"msg":"发送时间不能为空","type":"min","value":"1"}];
	jRad.validators['busiIds'] = [{msg:"只能上传txt文件",type:'regex',value:/^.*\.txt$/}];
	// jRad.validators['pushContent'] = [{msg:"push内容不得超过35字",type:'max',value:'35'}];
	
	var fields_params = {};  
	fields_params['platform'] ={data:[{"id":"1",name:"商家VIP"},{"id":"2",name:"商家客户端"}]}; 
	fields_params['infoType'] ={data:[{"id":"1",name:"运营消息"},{"id":"2",name:"通知消息"}]};   
	fields_params['status'] = {data:[{"id":"0",name:"发送"},{"id":"1",name:"保存"},{"id":"2",name:"删除"}]};   
	fields_params['iosPushStatus'] = { data:[{"id":"0",name:"否"},{"id":"1",name:"是"}]};   
	fields_params['androidPushStatus'] = { data:[{"id":"0",name:"否"},{"id":"1",name:"是"}]};   
	fields_params['isSystemMsg'] = { data:[{"id":"0",name:"否"},{"id":"1",name:"是"}]};   
	fields_params['busiIds'] = {
		url:'/shopmanage-ws/ws/0.1/busiMsg/add',
        autocomplete:false,
		success: function(data) {   
			if (data != undefined&&data[0]!=undefined&&data[0].message!="") {
				$.jRadAlert(data[0].message,"error");  
			}else{
				$('#Form_businesystem_message').form('close');
				$('#Table_businesystem_message').flexMessage('创建成功', 'success');
				$('#Table_businesystem_message').flexReload();
			} 
		}
	};
	fields_params['sendDate'] = {
	    	dateFmt:'yyyy-MM-dd HH:mm:ss',
	};
	
    page_column_model.push({display: '消息标题', name : 'title'});
    page_column_model.push({display: '类型', name : 'InfoTypeDesc'});
	page_column_model.push({display: '平台', name : 'platformDesc'});
	page_column_model.push({display: '发送时间', name : 'sendDate',  sortable : true});
    page_column_model.push({display: 'IOS_PUSH', name : 'iosPushStatusDesc'});
    page_column_model.push({display: '安卓PUSH', name : 'androidPushStatusDesc'});
    page_column_model.push({display: '系统消息', name : 'isSystemMsgDesc'}); 
	page_column_model.push({display: '创建时间', name : 'createdDate',  sortable : true});
	page_column_model.push({display: '状态', name : 'statusDesc'});
    
    page_search_items.push({row:'1',type:'jrad-select',display:'类型',name:'infoType',params:{
	  data:[
	    {"id":"",name:"全部"},
		{"id":"1",name:"运营消息"},
		{"id":"2",name:"通知消息"}
	  ]
	}}); 
	page_search_items.push({row:'1',type:'jrad-select',display:'平台',name:'platform',params:{
		data:[
		   {"id":"",name:"全部"},
		   {"id":"1",name:"商家VIP"},
		   {"id":"2",name:"商家客户端"}
		]
	}}); 
	page_search_items.push({row:'1',type:'jrad-input',display:'消息标题',name:'title'}); 
	
	page_search_items.push({row:'2',type:'jrad-select',display:'IOS系统PUSH',name:'iosPushStatus',params:{
	  data:[
	    {"id":"",name:"全部"},
	    {"id":"0",name:"否"},
		{"id":"1",name:"是"}
	  ]
	}}); 
	page_search_items.push({row:'2',type:'jrad-select',display:'安卓系统PUSH',name:'androidPushStatus',params:{
	  data:[
	    {"id":"",name:"全部"},
	    {"id":"0",name:"否"},
		{"id":"1",name:"是"}
	  ]
	}}); 
	page_search_items.push({row:'3',type:'jrad-select',display:'系统消息',name:'isSystemMsg',params:{
	  data:[
	    {"id":"",name:"全部"},
	    {"id":"0",name:"否"},
		{"id":"1",name:"是"}
	  ]
	}}); 
	page_search_items.push({row:'3',type:'jrad-select',display:'状态',name:'status',params:{
	  data:[
	    {"id":"",name:"全部"},
	    {"id":"0",name:"发送"},
		{"id":"1",name:"保存"},
		{"id":"2",name:"删除"}
	  ]
	}});  
	
	page_search_items.push({row:'4',type:'jrad-dateinput',display:'发送开始时间',name:'sendStartDate',params:{
			grid:4,
	    	dateFmt:'yyyy-MM-dd HH:mm:ss',
	}});
	page_search_items.push({row:'4',type:'jrad-dateinput',display:'发送结束时间',name:'sendEndDate',params:{
			grid:4,
	    	dateFmt:'yyyy-MM-dd HH:mm:ss',
	}});
    
	
	
    page_search_items.push({row:'5',type:'jrad-dateinput',display:'创建开始时间',name:'createStartDate',params:{
			grid:4,
	    	dateFmt:'yyyy-MM-dd HH:mm:ss',
	}});
	page_search_items.push({row:'5',type:'jrad-dateinput',display:'创建结束时间',name:'createEndDate',params:{
			grid:4,
	    	dateFmt:'yyyy-MM-dd HH:mm:ss',
	}});


	$('div[name="remarks"]',wraper).textarea({
        			grid:9
              });


	$('#Form_businesystem_message').form({
		fluid: true,
		autobinding:true
	});
	var readonlyFields2 = {};
	readonlyFields2['busiIds'] = false; 
	page_list_buttons.push({title: '创建',name:'Add', bclass: 'add',onpress : function(){
            $('#Form_businesystem_message').form({
                title: '创建',
                validators: jRad.validators,
                fields_params: fields_params,
                item:{"iosPushStatus":"0","androidPushStatus":"0","isSystemMsg":"0","infoType":"0","status":"0",'infoType':'1'}, 
				readonlyFields: readonlyFields2,
                submit: addMessage,
                success_callback:function(){ 
                            $('#Table_businesystem_message').flexMessage('创建成功', 'success');
                            $('#Table_businesystem_message').flexReload();
                        } 
            }).form('open');
            $("#Form_businesystem_message span[name='pushLen']").html('0');
			$('#Form_businesystem_message').find("div.ui-select-content").addClass("span4");
			$('#Form_businesystem_message').find("div.ui-input-content").addClass("span9");
			 msgEvent()
			
        }
    });
	var readonlyFields = {};
	readonlyFields['busiIds'] = true; 
	page_list_buttons.push({title: '修改',name:'Edit', bclass: 'edit',prefunc:function(){
            var checked = $('#Table_businesystem_message').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
            var checked = $('#Table_businesystem_message').getCheckedTrs(); 
            if(checked[0]) {
			     var item = checked[0]; 
                 updateMessageView(item,wraper,fields_params); 
            }
        }
    }); 
  
	page_list_buttons.push({name:'delete',bclass: 'delete',prefunc:function(){
            var checked = $('#Table_businesystem_message').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
	    	var checked = $('#Table_businesystem_message').getCheckedTrs();
			$.jRadConfirm('确认删除吗？',1,function(){
				var id =  checked[0].vipMsgId;
				var postData={};
				postData.vipMessageId=id; 
				$.jRadPost({
				    data:postData,
					url:'/shopmanage-ws/ws/0.1/busiMsg/del', 
					success: function(){
						$('#Table_businesystem_message').flexMessage('删除成功!', 'success');
           	    		$('#Table_businesystem_message').flexReload();
					},
					error:function(xhr){
					    var errormsg = eval("(" + xhr.responseText + ")"); 
						if (errormsg != undefined) {
							$('#Table_businesystem_message').flexMessage(errormsg[0].message, 'error');
						}
					}
				});
			});
		}
	});
 	
    page_list_buttons.push({separator: true});
    
    $('#Table_businesystem_message').flexigrid({
            reload:true,
			method:'get',
            colModel : page_column_model,
            buttons : page_list_buttons,
            searchitems :page_search_items,
            pagination: {
				diaplay_pages: 5,
				align: 'bottom' 
			},
			showSearch:true,
            url:'/shopmanage-ws/ws/0.1/busiMsg/list',
			onError:showMessageError,
			overflow:true
    }); 
	if($(document).data('messageShopId')!=undefined&$(document).data('messageShopId')!=''){
		 var id =  $(document).data('messageShopId');
		 $('#Form_businesystem_message').form({
                title: '创建',
                validators: jRad.validators,
                fields_params: fields_params,
				readonlyFields: readonlyFields2,
                submit: addMessage 
                
            }).form('open');		 
		 $(document).removeData('messageShopId');
		 
	} 
	function updateMessageView(item,wraper,fields_params){
	   $('#Form_businesystem_message',wraper).form({grid:'16',
                        title: '修改', 
						submit: false,
						fields_params: fields_params,
                        validators: jRad.validators, 
                        item:item,
						readonlyFields: readonlyFields,
                        url:'/shopmanage-ws/ws/0.1/busiMsg/modify',
                        before_submit: function(json){
                        	json.vipMessageId=item.vipMsgId;
                            return json;
                        },
                        success_callback:function(){ 
                            $('#Table_businesystem_message').flexMessage('修改成功', 'success');
                            $('#Table_businesystem_message').flexReload();
                        },error_callback:function(xhr){
							var errormsg = eval("(" + xhr.responseText + ")"); 
							if (errormsg != undefined) { 
								 $.jRadAlert(errormsg[0].message,"error"); 
							} 
						} 
                    }).form('open');
				    var _str = $("#Form_businesystem_message div[name='pushContent']").textarea('val');
	   				$("#Form_businesystem_message span[name='pushLen']").html(lenFor(_str));
					$('#Form_businesystem_message').find("div.ui-select-content").addClass("span4");
					$('#Form_businesystem_message').find("div.ui-input-content").addClass("span9");
					 msgEvent()

	};
    
    $(".numb92").click(function(){
        $('.overcurtainDiv').hide();
        var menuId = $(".tabs-selected").attr("menuId")
        var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        $("#Form_explain_eg92").form({}).form('close');
        $("#Form_explain_eg92").form({
            title:'页面说明',
            item:data,
            autobinding: true, 
            submit:function(){
                var postData = {};
                postData.operator = carsmart_config.operatorName;
                postData.menuName = $(".tabs-selected").attr("menuName");
                postData.menuId = $(".tabs-selected").attr("menuId");
                postData.remark = $("#Form_explain_eg92 div[name='remark']").textarea("val")
                $.jRadPost({
                    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
                    data:postData,
                    success:function(){
                        $("#Form_explain_eg92").form('close')
                        $('.overcurtainDiv').hide();
                    }
                });
            }, 
            cancel:function(){
                $("#Form_explain_eg92").form('close')
                $('.overcurtainDiv').hide();
            }
        }).form('open')
        $("#Form_explain_eg92 .textarea-content").removeClass("span4").addClass("span12")
        $('.overcurtainDiv').hide();
        $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
    })
	
}); 
function msgEvent(){
		var _area = $("#Form_businesystem_message div[name='pushContent']");
		_area.keyup(function(){
			var str = _area.textarea('val');
			$("#Form_businesystem_message span[name='pushLen']").html(lenFor(str));
			var curStr = '';
			for(var i=0;i<str.length;i++){
				curStr += str.charAt(i);
				if(lenFor(curStr)>105){
					_area.textarea('val',str.substring(0,i));
					var change = lenFor(str) - 105;
					$("#Form_businesystem_message span[name='pushLen']").html(lenFor(str)-change);
					return false
				}
			}
		});
	} 
	var lenFor = function(str){
		var byteLen=0,len=str.length;
		if(str){
			for(var i=0; i<len; i++){
				if(str.charCodeAt(i)>255){
				byteLen += 3;
				}else{
				byteLen++;
				}
			}
			return byteLen;
		}else{
			return 0;
		}
	} 

function showMessageError(xhr){
			 var errormsg = eval("(" + xhr.responseText + ")");
			  var cDiv = $("#Wraper_businesystem_message .cDiv");
			  $.jRadMessage({level:'error',message:errormsg[0].message,selector:cDiv});
			}


function addMessage(){
	   var _form = $("#Form_businesystem_message");
	   var json = _form.form('getValue');
	   var flag = _form.form('validateAll');
	   if(!flag) {
		   return;
	   }
		delete json.busiIds;
	   $('div[name=busiIds]').upload({
			params: json,
	   }).upload('upload'); 
} 

</script>

