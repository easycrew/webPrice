<div class="urlContentWraper" id="Wraper_integralPay_manage">
<div class="ui-info-layout">
<div class="ui-info-layout-subbox "> 
	<div class="jrad-table">
        <h2 class="ui-tit"><strong>积分换购活动列表</strong><bottom class="all-work-info numb97">页面说明</bottom></h2>
        <!-- 列表显示 -->
        <table id="Table_integralPay_manage"></table>
    </div>
	<div class="details-box" style="display:none;">
			<ul class="details-tab">
				<li class="tab-cur tab-cur-first f-left"><span name="title">积分换购活动信息</span></li>
				<li><span class="return"></span></li>
			</ul>
			<div class="details-content">
				<div class="details-scroll">
					<div class="details-content-inner">
						<div class="grid-layout ui-form" id="Form_integralPay_manage">
							<div class="jrad-form">  
								<div class="grid-layout-main">
								<input name="integralRedemptionId" type="hidden"> 
								<input name="serviceId" type="hidden"> 
								<input name="statusOld" type="hidden"> 
								<div class="row-fluid">
									<label class="span3 grid-layout-label">
									<span class="ui-form-required">*</span>
									活动名称：</label>
									<div class="span5 grid-layout-content">
										   <div name="name" class="jrad-input-container"></div>
														</div>
									</div>
									<div class="row-fluid">
										 <label class="span3 grid-layout-label">服务：</label>
										 <div class="span5 grid-layout-content">
											   <div name="zeroService" class="jrad-select-container service"></div>
															</div>
									</div> 
									<div class="row-fluid">
										 <label class="span3 grid-layout-label">积分价：</label>
										 <div class="span5 grid-layout-content">
											   <div name="integral" class="jrad-input-container"></div>
															</div>
									</div>  
									<div class="row-fluid">
										 <label class="span3 grid-layout-label">状态：</label>
										 <div class="span5 grid-layout-content">
											   <div name="status" class="jrad-select-container"></div>
															</div>
									</div> 
								</div> 
							</div>
							<div class="jrad-buttons-container ui-buttons-container">
								<span class="jrad-btn-primary">确定</span> 
								<span class="jrad-btn-normal">取消</span>
							</div>
						</div> 
						<div class="form_table" style="margin-top:20px;" class="span15">
							<h2 class="ui-tit"><strong>商家列表</strong></h2>
							<table id="Table_integral_shop"></table>
						</div>
					</div>
					
				</div>
			</div>
     </div>
</div>
</div> 

<div id="Form_active_shop" style="display:none;">
	<div class="grid-layout-main jrad-form">   
		<div class="row">  
			<div class="span13 grid-layout-content fluid-wrap">
				<div name="businessIds" class="jrad-textarea-container">
				</div>
				<p class="ui-note">输入多个商家ID时，请以英文状态下逗号分隔</p>
			</div>
		</div> 
	</div>
	<div class="jrad-buttons-container ui-buttons-container"> 
		<span class="jrad-btn-primary">确定</span>
		<span class="jrad-btn-normal">取消</span>
	</div>
</div>
 	
    <div id="Form_explain_eg97" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                <label class="span3 grid-layout-label">业务说明：</label>
                <div class="span12 grid-layout-content">
                    <div><strong>功能简介：</strong>此功能已暂停服务，以积分商城代替。</div>
                    <div><strong>重要功能说明：</strong>无。</div>
                    <div><strong>注意事项：</strong>无。</div>
                </div> 
            </div> 
            <div class="row">
                <label class="span3 grid-layout-label">备注：</label>
                <div class="span12 grid-layout-content">
                    <div class="jrad-textarea-container" name="remark">
                    </div>
                </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
</div>
<script type="text/javascript">
$(document).ready(function(){ 
    var wraper = $('#Wraper_integralPay_manage');
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array();
	 	
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel});    
	jRad.validators['name'] = [{"msg":"请填写活动名称","type":"min","value":"1"}];
	var fields_params = {}; 
	fields_params['title'] = {grid: 9}; 
	fields_params['zeroService'] ={ 
		data:[
			{"id":"",name:"请选择"},{id:'1',name:'洗车'},{id:'2',name:'美容'},{id:'3',name:'保养'},{id:'4',name:'维修'}
		],
		onchange: function(val){  
			getIPServiceNode("1",val,wraper);  
		}
	 };  
	fields_params['status'] ={ 
		data:[
			 {"id":"1",name:"有效"},
			 {"id":"0",name:"无效"} 
		] 
	 }; 
	 fields_params['remarks'] ={ 
		 grid:18
	 };   
	fields_params['startTime'] = {
			grid:4,
	    	dateFmt:'yyyy-MM-dd HH:mm:ss'
	};
	fields_params['endTime'] = {
			grid:4,
	    	dateFmt:'yyyy-MM-dd HH:mm:ss'
	};
	fields_params['illustrate'] = {
 			theme:"Full",
 			resizing: false, 
 			grid: 18, 
 			height: 200,
			uploadImg: { //上传图片参数
				url: '/shopmanage-ws/ws/0.1/file/uploadThree',
				fileName: 'file', 
				delFunc: function(item) { 
					item.list.remove(); 
				}, 
				validator : [{
					msg : "只能上传jpg文件",
					type : "regex",
					value : /^.*\.(jpg|JPG)$/
				}], 
				success: function(data){  
					   if(data[0]&&data[0].code=="400"){
						 $.jRadMessage({level:'error',message:data[0].message});
					   }
					},
				note: '仅支持 JPG图片文件。',
				show:true,
				showLarge:true,  
				prev:'fileUrl', 
				params: {type:"",cutPicType:""}, 
				single: true 
			} 
 	}; 
	page_column_model.push({display: '活动名称', name : 'name'});
    page_column_model.push({display: '参与商家数', name : 'shopNum'});
    page_column_model.push({display: '服务', name : 'serviceName',width:280,diy:function(item,$div){
    	var _item = $.jRadGet({url : '/shopmanage-ws/ws/0.1/redemption/integral/detail?integralRedemptionId='+item.integralRedemptionId});
    	$div.html(_item.serviceNames)
    }}); 
	page_column_model.push({display: '创建人', name : 'createPerson'});
    page_column_model.push({display: '创建时间', name : 'createTime'}); 
	page_column_model.push({display: '状态', name : 'status',datasource:[{"id":"1",name:"有效"},{"id":"0",name:"无效"}]});   
	
	page_search_items.push({row:'1',type:'jrad-input',display:'活动名称',name:'name'}); 
	page_search_items.push({row:'1',type:'jrad-select',display:'状态',name:'status',params:{ 
	  data:[
	    {"id":"",name:"全部"},
	    {"id":"1",name:"有效"},
		{"id":"0",name:"无效"} 
	  ]
	}}); 
	 
    $('#Form_integralPay_manage .jrad-btn-normal',wraper).button({
		click: function(){
			$('.details-box',wraper).slideUp();
			$('.jrad-table',wraper).slideDown(); 
			$(".scroll-up-btn").click();
		}
	});  
	$('#Form_integralPay_manage .jrad-btn-primary',wraper).button({
		click: function(){
			var flag = $('#Form_integralPay_manage',wraper).form('validateAll');
			if(flag){
			var json = $('#Form_integralPay_manage',wraper).form('getValue');  
			var serviceId2 = $("#Form_integralPay_manage .service:last").select('val'); 
			if(json.serviceId&&json.serviceId!=""){ 
				if(serviceId2!=""){
				  json.serviceId = serviceId2;
				} 
			}else{
				 if(serviceId2==""){
					$.jRadMessage({ level:'error', 
									message:"请选择服务并且确认到最后一级" 
								  });
					return false;
				 }else{
					json.serviceId = serviceId2;
				 }
			}
			var status  = json.status;
			var statusOld = $("#Form_integralPay_manage input[name='statusOld']").val();
			json.createPerson = carsmart_config.operatorName;
			if(json.status==0&&json.integralRedemptionId!=""&&json.status!=statusOld){
				$.jRadConfirm('活动状态为无效，将会解除列表中的商家与服务的绑定关系。',1,function(){ 
				},function(){
					return false;
				});
			}
			var addFlag = true;
			if(json.integralRedemptionId!=undefined&&json.integralRedemptionId!=""){
				addFlag = false;
			}
			$.jRadPost({
				    	url:'/shopmanage-ws/ws/0.1/redemption/integral/addOrUpdate',
				    	data:json,
				    	success:function(data){ 
						    $.jRadMessage({ level:'success', 
											message:"编辑成功！" 
										});
							$("#Form_integralPay_manage input[name='integralRedemptionId']").val(data.integralRedemptionId);
							$("#Form_integralPay_manage input[name='statusOld']").val(status);
							$('#Table_integralPay_manage').flexReload(); 
							if(addFlag){
								$(".form_table",wraper).show();
							}else{
								$('#Table_integral_shop').flexOptions({ 
									url: '/shopmanage-ws/ws/0.1/redemption/integral/business/page?integralRedemptionId='+data.integralRedemptionId 
								}).flexReload();
							}
				    	},error:function(data){
				    		var mes = eval('('+data.responseText+')');
				    		 $.jRadMessage({
				    			 level:'error', 
			    				 message:mes[0].message 
				    		 });
				    	}
				    });
		 
			}	 
		}
	}); 
	$('#Form_integralPay_manage',wraper).form({
		validators: jRad.validators,
		fields_params:fields_params, 
		layout: 'grid', 
		autobinding: false
	 });  
	 
	page_list_buttons.push({title: '创建',name:'Add', bclass: 'add',onpress : function(){
			 initActiveInfo(wraper); 
			 $("#Form_integralPay_manage .addService").parents(".row-fluid").remove();
			 $("#Form_integralPay_manage .row-fluid:eq(1) .grid-layout-content #serviceNames").remove(); 
			 $('#Form_integralPay_manage',wraper).form({item:{}}); 
			 $(".details-box .details-tab",wraper).find("span[name='title']").html("积分换购活动添加");
			 $('.form_table',wraper).hide()
			 $('.jrad-table',wraper).slideUp();
			 $('.details-box',wraper).slideDown();
			 $(".scroll-up-btn").click();  
        }
    });
	var readonlyFields = {};
	readonlyFields['users'] = true; 
	page_list_buttons.push({title: '修改',name:'Edit', bclass: 'edit',prefunc:function(){
            var checked = $('#Table_integralPay_manage').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
            var checked = $('#Table_integralPay_manage').getCheckedTrs(); 
            if(checked[0]) {
				var id = checked[0].integralRedemptionId;
				$("#Form_integralPay_manage .addService").parents(".row-fluid").remove();
				$("#Form_integralPay_manage .row-fluid:eq(1) .grid-layout-content #serviceNames").remove(); 
				var item = $.jRadGet({url : '/shopmanage-ws/ws/0.1/redemption/integral/detail?integralRedemptionId='+id}); 	  
				$("#Form_integralPay_manage .row-fluid:eq(1) .grid-layout-content").append('<p id="serviceNames">已选择：'+item.serviceNames+'</p>');
				$(".details-box .details-tab",wraper).find("span[name='title']").html("积分换购活动编辑"); 
				initActiveInfo(wraper);  
				$('.form_table',wraper).show(); 
				$('.jrad-table',wraper).slideUp();
				$('.details-box',wraper).slideDown(); 
				$(".scroll-up-btn").click();  
				$('#Form_integralPay_manage',wraper).form({item: item});    
				$('#Table_integral_shop').flexOptions({ 
					url: '/shopmanage-ws/ws/0.1/redemption/integral/business/page?integralRedemptionId='+id 
				}).flexReload();
            }
        }
    });  
 
    page_list_buttons.push({separator: true}); 
	$('#Table_integralPay_manage').flexigrid({
			reload:true,
			method:'get',
			colModel : page_column_model,
			buttons : page_list_buttons,
			searchitems :page_search_items,
			pagination: {
				diaplay_pages: 5,
				align: 'bottom' 
			},
			showSearch:true, 
			url:'/shopmanage-ws/ws/0.1/redemption/integral/page',
			onError:showAdsError,
			overflow:true
	});   
	 
	
	$(".details-tab .return",wraper).click(function(){
		$('.details-box',wraper).slideUp();
		$('.jrad-table',wraper).slideDown(); 
		$(".scroll-up-btn").click();
	});
	
	$('#Form_active_shop',wraper).form({ 
		title: '积分换购活动绑定商家',
		validators: {'businessIds':[{msg:"请填写要绑定的商家ID",type:'min',value:'1'}]},  
		fields_params:{'businessIds':{grid:'13'}},
		url:'/shopmanage-ws/ws/0.1/redemption/integral/binding/business',
		before_submit:function(json){
					json.integralRedemptionId = $("#Form_integralPay_manage input[name='integralRedemptionId']").val();  
				},				
		success_callback:function(){ 
					$('#Table_integral_shop').flexMessage('新增成功', 'success');
					//var id =  $("#Form_integralPay_manage input[name='integralRedemptionId']").val();  
					$('#Table_integral_shop').flexReload();
				}, 
		autobinding: true
	 });  
	var page_column_model_s = new Array(); 
    var page_list_buttons_s = new Array(); 
    var page_search_items_s = new Array();   
	var submit = function(event,_data,item,$element){
		var $that = $(this);
		var newValue = event.data; 
		_data.businessIds = item.businessId;
		_data.integralRedemptionId = item.integralRedemptionId; 
		$.jRadPost({"url":'/shopmanage-ws/ws/0.1/redemption/integral/binding/business',
			data: _data,
			success: function(data){
				$that.data('value',newValue);
			}
		});
	};
	page_column_model_s.push({display: '商家ID', name : 'businessId'});
    page_column_model_s.push({display: '商家简称', name : 'businessRegName'});
    page_column_model_s.push({display: '所属城市', name : 'cityName'}); 
	page_column_model_s.push({display: '门市价', name : 'shopPrice',type:'input',submit: submit});
    page_column_model_s.push({display: '预订价', name : 'reservePrice',type:'input',submit: submit});
	page_column_model_s.push({display: '结算价', name : 'clearingPrice',type:'input',submit: submit});    
	page_column_model_s.push({display: '积分价', name : 'integral',type:'input',submit: submit});    
	page_list_buttons_s.push({title: '新增',name:'Add', bclass: 'add',onpress : function(){ 
		$('#Form_active_shop',wraper).form('open');  
        }
    }); 
	page_list_buttons_s.push({title: '删除',name:'delete',bclass: 'delete',prefunc:function(){
            var checked = $('#Table_integral_shop').getCheckedTrs();
            if (checked.length == 0 ) {return false;}else{return true;}
        },onpress : function(){
	    	var checked =$('#Table_integral_shop').getCheckedTrs();
			var ids = [];
			$.each(checked,function(i){
			  ids.push(checked[i].businessId);
			});
			var idString = ids.join(",");
			$.jRadConfirm('确认删除吗？',1,function(){
				var id =  checked[0].id; 
				var integralRedemptionId =  $("#Form_integralPay_manage input[name='integralRedemptionId']").val(); 
				var postData = {};
				postData.businessIds = idString;
				postData.integralRedemptionId = integralRedemptionId;
				$.jRadAjax({
				    type:'post',
					url:'/shopmanage-ws/ws/0.1/redemption/integral/delete/business',
					data:postData,
					success: function(){
						$('#Table_integral_shop').flexMessage('删除成功!', 'success');
           	    		$('#Table_integral_shop').flexReload();
					},
					error:function(xhr){
					    var errormsg = eval("(" + xhr.responseText + ")"); 
						if (errormsg != undefined) {
							$('#Table_integral_shop').flexMessage(errormsg[0].message, 'error');
						}
					}
				});
			});
		}
	}); 
    page_list_buttons_s.push({separator: true}); 
	$('#Table_integral_shop').flexigrid({
			reload:true,
			method:'get',
			colModel : page_column_model_s,
			buttons : page_list_buttons_s,
			searchitems :page_search_items_s, 
			pagination: {
				diaplay_pages: 5,
				align: 'bottom' 
			},
			showSearch:true,  
			onError:showAdsError,
			overflow:true 
	});    
    $(".numb97").click(function(){
        $('.overcurtainDiv').hide();
        var menuId = $(".tabs-selected").attr("menuId")
        var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        $("#Form_explain_eg97").form({}).form('close');
        $("#Form_explain_eg97").form({
            title:'页面说明',
            item:data,
            autobinding: true, 
            submit:function(){
                var postData = {};
                postData.operator = carsmart_config.operatorName;
                postData.menuName = $(".tabs-selected").attr("menuName");
                postData.menuId = $(".tabs-selected").attr("menuId");
                postData.remark = $("#Form_explain_eg97 div[name='remark']").textarea("val")
                $.jRadPost({
                    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
                    data:postData,
                    success:function(){
                        $("#Form_explain_eg97").form('close')
                        $('.overcurtainDiv').hide();
                    }
                });
            }, 
            cancel:function(){
                $("#Form_explain_eg97").form('close')
                $('.overcurtainDiv').hide();
            }
        }).form('open')
        $("#Form_explain_eg97 .textarea-content").removeClass("span4").addClass("span12")
        $('.overcurtainDiv').hide();
        $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
    })   
	
}); 

function showMessageError(xhr){
			 var errormsg = eval("(" + xhr.responseText + ")");
			  var cDiv = $("#Wraper_integralPay_manage .cDiv");
			  $.jRadMessage({level:'error',message:errormsg[0].message,selector:cDiv});
			}


function initActiveInfo(wraper){
 
}
  
function showAdsError(xhr){
	 var errormsg = eval("(" + xhr.responseText + ")");
	  var cDiv = $("#Wraper_integralPay_manage .cDiv");
	  $.jRadMessage({level:'error',message:errormsg[0].message,selector:cDiv});
	} 
function getIPServiceNode(node,val,wraper){   
	var label = "";
	var serviceClass = "";
	if(node==1){
		label = "一级";
		serviceClass = "firstService"; 
		$("#Form_integralPay_manage .addService").parents(".row-fluid").remove();
	}
	if(node==2){
		label = "二级";
		serviceClass = "secondService"; 
		$("#Form_integralPay_manage .secondService").parents(".row-fluid").remove();
		$("#Form_integralPay_manage .thirdService").parents(".row-fluid").remove();
		$('#Form_integralPay_manage .fourService').parents(".row-fluid").remove(); 
	}else if(node==3){
		label = "三级";
		serviceClass = "thirdService";
		$('#Form_integralPay_manage .thirdService').parents(".row-fluid").remove();
		$('#Form_integralPay_manage .fourService').parents(".row-fluid").remove();
	}else if(node==4){
		label = "四级";
		serviceClass = "fourService";
		$('#Form_integralPay_manage .fourService').parents(".row-fluid").remove();
	}
	if(val!=""){
		var item = $.jRadGetDataSources("/shopmanage-ws/ws/0.1/service/getSonServices?parentId="+val,"id","serviceName");
		if(item.length>0){
		item.unshift({id:'',name:'请选择'}); 
		var row = '<div class="row-fluid">'
					+'<label class="span3 grid-layout-label">'+label+'：</label>'
					+'<div class="span5 grid-layout-content">'
					+'<div name="'+serviceClass+'" class="jrad-select-container service addService '+serviceClass+'"></div>'
					+'</div>'
					+'</div>' 
		if(node==1){
		$("#Form_integralPay_manage .row-fluid:eq(1)",wraper).after(row);
		}else if(node==2){
		$("#Form_integralPay_manage .row-fluid:eq(2)",wraper).after(row);
		}else if(node==3){
		$("#Form_integralPay_manage .row-fluid:eq(3)",wraper).after(row);
		}else if(node==4){
		$("#Form_integralPay_manage .row-fluid:eq(4)",wraper).after(row);
		}
		node++; 
		$('#Form_integralPay_manage div[name='+serviceClass+']').select({
			data:item,
			unshiftData: {id:'',name:'请选择'}, 
			onchange: function(val){
				getIPServiceNode(node,val,wraper); 
			}
		});
		}else{
			var des = $.jRadGet({"url":'/shopmanage-ws/ws/0.1/service/detailService?id='+val});
			$('#Form_integralPay_manage div[name="illustrate"]').mediaarea('val',des.description?des.description:'');
		}
	}
}
</script>

