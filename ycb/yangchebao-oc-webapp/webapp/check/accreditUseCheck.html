<style>
.height28{
  height:28px;
  line-height:28px;
}
/*#cboxOverlay{
	opacity:none;
	display:none;
}
input{
	z-index:3000000;
}*/
</style>
<div class="urlContentWraper" id="Wraper_useCheck">
    <div class="ui-info-layout">
        <h2 class="ui-tit"><strong>认证用户审核</strong><bottom class="all-work-info numb85">页面说明</bottom></h2>
        <!-- 列表显示 -->
		<div class="pic-grid">
			<table id="Table_useCheck"></table>
		</div>
    </div> 
	<div id="Form_useCheck" style="display:none;">
		<div class="grid-layout-main jrad-form"> 
			<input type="hidden" name="carInfoId"/>
			<div class="row">
				<label class="span2 grid-layout-label"><span class="ui-form-required">*</span>
				 驳回原因：</label>
				 <div class="span5 grid-layout-content">
					   <div name="reasonOfReject" class="jrad-textarea-container"></div>
									</div>
			</div>
		</div>
		<div class="jrad-buttons-container ui-buttons-container">
			<span class="jrad-btn-primary">确定</span> 
			<span class="jrad-btn-normal">取消</span>
		</div>
	</div>
<div id="Form_explain_eg85" style="display:none;">
    <div class="grid-layout-main jrad-form"> 
        <div class="row">
            <label class="span3 grid-layout-label">业务说明：</label>
            <div class="span12 grid-layout-content">
                <div><strong>功能简介：</strong>用户领取代金券时，需要申请成为认证用户，否则无法领取，这里就是对认证用户审核的功能。</div>
                <div><strong>重要功能说明：</strong>加入黑名单：加入黑名单后，此用户不能领取代金券。</div>
                <div><strong>注意事项：</strong>无。</div>
            </div> 
        </div> 
        <div class="row">
            <label class="span3 grid-layout-label">备注：</label>
            <div class="span12 grid-layout-content">
                <div class="jrad-textarea-container" name="remark">
                </div>
            </div>
        </div>
    </div>
    <div class="jrad-buttons-container ui-buttons-container"> 
        <span class="jrad-btn-primary">确定</span> 
        <span class="jrad-btn-normal">取消</span>
    </div>
</div>
</div>
<script type="text/javascript">
$(document).ready(function(){
    var wraper = $('#Wraper_useCheck');
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array(); 
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel});  
	jRad.validators['reasonOfReject'] = [{"msg":"请填写原因","type":"min","value":"1"}];
	var checkParam = {};
	checkParam['reasonOfReject'] = {grid:14};
	var fields_params = {}; 
	fields_params["auditStatus"]={data:[{id:'3',name:'全部'},{id:'2',name:'驳回'},{id:'1',name:'通过'},{id:'0',name:'审核中'}]};

	jRad.params['auditStatus'] = {
		data: [{id:'3',name:'全部'},{id:'2',name:'驳回'},{id:'1',name:'通过'},{id:'0',name:'审核中'}]
	};
    var colorbox_params = {
        reposition:true,
        scalePhotos:true,
        scrolling:false,
        previous:'<i class="icon-arrow-left"></i>',
        next:'<i class="icon-arrow-right"></i>',
        close:'&times;',
        current:'{current} of {total}',
        maxWidth:'100%',
        maxHeight:'100%',
        //opacity:0,
        //overlayClose:false,
        //iframe:false,
        onOpen:function(){
            document.body.style.overflow = 'hidden';
            // //$('#cboxOverlay').attr('style','display:none');
            // $('#cboxOverlay').hide();
        },
        onClosed:function(){
            document.body.style.overflow = 'auto';
            $('#cboxOverlay').attr('style','display:none');
            //$('#cboxOverlay').hide();
        },
        onComplete:function(){
            $.colorbox.resize();
            // $('#cboxOverlay').attr('style','display:none');
            //$('#cboxOverlay').hide();
        }
    };
    page_column_model.push({display: '用户ID', name : 'userInfoId'}); 
    page_column_model.push({display: '用户手机号', name : 'userMobile'});
	page_column_model.push({display: '行驶证照片', name : 'drivingUrl', width:80,diy:function(item,$div){
        var pic=$('<a>').attr('href',item.drivingUrl).addClass('pic').html('查看');
        $div.append(pic);
        if(item.drivingUrl == ""){
            //$div.find('a').attr('href','javascript:').css({'color':'#888','cursor':'default','text-decoration':'none'})
            $div.html('');
        }else{
        	//$('#cboxOverlay').hide();
            $('a.pic',$div).colorbox(colorbox_params);
        	//$('#cboxOverlay').attr('style','display:none');
        }
        
    }}); 
	page_column_model.push({display: '号牌号码', name : 'plateNumber',width:180,diy:function(item,$div){
		var $afterhtml = $div.html(item.plateNumber+"&nbsp;&nbsp;");
		$div.html($('<span>').append(item.plateNumber+"&nbsp;&nbsp;"));
		//console.log($afterhtml)
		if(item.plateNumber == ''){
			$div.html();
		}
		else{
			var $a = $("<a>").html("编辑");
			$div.append($a);
			$a.click(function(){
				
				$(this).prev().html(function(){
					return '<input type="text" style="width:100px;" onfocus="" value='+item.plateNumber+' />';
				})
				$(this).prev().children("input").focus();
				// var target = document.activeElement;
				// console.log(target.tagName);

				$(this).prev().children().blur(function(){
					var str = $a.prev().children().val();
					//console.log(str)
					$a.prev().children().hide();
					$a.prev().html(function(){return '<span>'+str+'</span>'+"&nbsp;&nbsp;"});
						var postData= {};
					 	var checked = $('#Table_useCheck').getCheckedTrs(); 
					 	postData.carInfoId = checked[0].carInfoId
					 	postData.numberType = 1;
					 	postData.newNumber = str;
						$.jRadPost({
							url:'/shopmanage-ws/ws/0.1/userAudit/editUserInfo',
							type:'post',
							data:postData,
							success:function(){
								$('#Table_useCheck').flexMessage('编辑成功!', 'success');
		           	    		$('#Table_useCheck').flexReloadSearch();
							},
							error:function(xhr){
							    var errormsg = eval("(" + xhr.responseText + ")"); 
								if (errormsg != undefined) {
									$('#Table_useCheck').flexMessage(errormsg[0].message, 'error');
								}
							}
						});	

				})

			})
		}
	}});
	page_column_model.push({display: '车架号', name : 'vinNumber',width:270,diy:function(item,$div){
		var $afterhtml = $div.html(item.vinNumber+"&nbsp;&nbsp;");
		$div.html($('<span>').append(item.vinNumber+"&nbsp;&nbsp;"));
		//console.log($afterhtml)
		if(item.vinNumber == ''){
			$div.html();
		}
		else{
			var $a = $("<a>").html("编辑");
			$div.append($a);
			$a.click(function(){
				$(this).prev().html(function(){
					return '<input type="text" style="width:200px;" value='+item.vinNumber+' />';
				})
				$(this).prev().children().focus();
				$(this).prev().children().blur(function(){
					var str = $a.prev().children().val();
					$a.prev().children().hide();
					$a.prev().html(function(){return '<span>'+str+'</span>'+"&nbsp;&nbsp;"});
						var postData= {};
					 	var checked = $('#Table_useCheck').getCheckedTrs(); 
					 	postData.carInfoId = checked[0].carInfoId
					 	postData.numberType = 2;
					 	postData.newNumber = str;
						$.jRadPost({
							url:'/shopmanage-ws/ws/0.1/userAudit/editUserInfo',
							type:'post',
							data:postData,
							success:function(){
								$('#Table_useCheck').flexMessage('编辑成功!', 'success');
		           	    		$('#Table_useCheck').flexReloadSearch();
							},
							error:function(xhr){
							    var errormsg = eval("(" + xhr.responseText + ")"); 
								if (errormsg != undefined) {
									$('#Table_useCheck').flexMessage(errormsg[0].message, 'error');
								}
							}
						});	
				})
			})
		}
	}});
	page_column_model.push({display: '发动机号', name : 'machineNumber',width:200,diy:function(item,$div){
		var $afterhtml = $div.html(item.machineNumber+"&nbsp;&nbsp;");
		$div.html($('<span>').append(item.machineNumber+"&nbsp;&nbsp;"));
		//console.log($afterhtml)
		if(item.machineNumber == ''){
			$div.html();
		}
		else{
			var $a = $("<a>").html("编辑");
			$div.append($a);
			$a.click(function(){
				$(this).prev().html(function(){
					return '<input type="text" style="width:120px;" value='+item.machineNumber+' />';
				})
				$(this).prev().children().focus();
				$(this).prev().children().blur(function(){
					var str = $a.prev().children().val();
					$a.prev().children().hide();
					$a.prev().html(function(){return '<span>'+str+'</span>'+"&nbsp;&nbsp;"});
						var postData= {};
					 	var checked = $('#Table_useCheck').getCheckedTrs(); 
					 	postData.carInfoId = checked[0].carInfoId
					 	postData.numberType = 3;
					 	postData.newNumber = str;
						$.jRadPost({
							url:'/shopmanage-ws/ws/0.1/userAudit/editUserInfo',
							type:'post',
							data:postData,
							success:function(){
								$('#Table_useCheck').flexMessage('编辑成功!', 'success');
		           	    		$('#Table_useCheck').flexReloadSearch();
							},
							error:function(xhr){
							    var errormsg = eval("(" + xhr.responseText + ")"); 
								if (errormsg != undefined) {
									$('#Table_useCheck').flexMessage(errormsg[0].message, 'error');
								}
							}
						});	

				})

			})
		}
	}});  
	page_column_model.push({display: '审核状态', name : 'auditStatus',width:120,diy:function(item,$div){
	    $div.html(item.auditStatus+"&nbsp;&nbsp;&nbsp;&nbsp;");
	    if(item.auditStatus=='2'){
	    	$div.html('审核驳回')
		 var $a = $("<a>").html("查看原因");
		 $div.append($a);
		 $a.click(function(){
			$.jRadAlert(item.reasonOfReject,"info");
		 });
		 var checkDiv = $("<div>").addClass("checkInfo");
	    }
	    else if(item.auditStatus=='1'){$div.html('审核通过')}
	    else if(item.auditStatus=='0'){$div.html('审核中')}

	}}); 
	page_column_model.push({display: '提交审核次数', name : 'auditCount'});
	page_column_model.push({display: '审核时间', name : 'auditDate'});
	//page_column_model.push({display: '提交审核时间', name : 'createDate'}); 
	page_column_model.push({display: '审核人', name : 'auditOperator'});
 

	page_search_items.push({row:'1',type:'jrad-input',display:'用户ID',name:'userId'});
	page_search_items.push({row:'1',type:'jrad-input',display:'用户手机',name:'userMobile'});
	page_search_items.push({row:'1',type:'jrad-input',display:'号牌号码',name:'plateNumber'});
	page_search_items.push({row:'2',type:'jrad-input',display:'车架号',name:'vinNumber'});
	page_search_items.push({row:'2',type:'jrad-input',display:'发动机号',name:'machineNumber'});
	page_search_items.push({row:'2',type:'jrad-select',display:'状态',name:'auditStatus',params:jRad.params['auditStatus']});
	page_search_items.push({row:'3',type:'jrad-input',display:'审核人',name:'auditOperator'});
	page_search_items.push({row:'3',type:'jrad-dateinput',display:'审核时间始',name:'auditStartDate'});
	page_search_items.push({row:'3',type:'jrad-dateinput',display:'审核时间终',name:'auditEndDate'});
	page_search_items.push({row:'4',type:'jrad-dateinput',display:'提交审核时间始',name:'applyAuditStartDate'});
	page_search_items.push({row:'4',type:'jrad-dateinput',display:'提交审核时间终',name:'applyAuditEndDate'});


	page_list_buttons.push({displayname: '通过',name:'pass',bclass: 'pass',prefunc:function(){
            var checked = $('#Table_useCheck').getCheckedTrs();
            if (checked.length == 0) {return false;}else{return true;}
        },onpress : function(){
	    	var checked = $('#Table_useCheck').getCheckedTrs();
			var ids = [];
			$.each(checked,function(){
				ids.push(this.carInfoId);
			});
			//console.log(ids)
			$.jRadConfirm('确认审核通过吗？',1,function(){
				 var postData = []; 
				 $.each(checked,function(i){
				 	var postJson={};
				 	postJson.carInfoId=this.carInfoId;
				 	postJson.auditOperator=carsmart_config.operatorName;
				 	postJson.reasonOfReject=this.reasonOfReject;
				 	postJson.userInfoId=this.userInfoId;
				 	postJson.auditCount=this.auditCount;
				 	postJson.auditReasult=1;
				 	postData.push(postJson)
				 });
				 
				$.jRadAjax({
				    type:'post',
					data:postData,
					url:'/shopmanage-ws/ws/0.1/userAudit/auditUserInfo', 
					success: function(){
						$('#Table_useCheck').flexMessage('审核通过成功!', 'success');
           	    		$('#Table_useCheck').flexReloadSearch();
					},
					error:function(xhr){
					    var errormsg = eval("(" + xhr.responseText + ")"); 
						if (errormsg != undefined) {
							$('#Table_useCheck').flexMessage(errormsg[0].message, 'error');
						}
					}
				});
			});
		}
	});
	page_list_buttons.push({displayname: '驳回',name:'reject',bclass: 'reject',prefunc:function(){
            var checked = $('#Table_useCheck').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
			$('#Form_useCheck').form({
				title: '驳回原因',
				validators: jRad.validators,
				fields_params:checkParam,
				item:{} ,
				type:'post',
				url:'/shopmanage-ws/ws/0.1/userAudit/auditUserInfo', 
				before_submit:function(json){
					var checked = $('#Table_useCheck').getCheckedTrs(); 
			    	var postData = []; 
					$.each(checked,function(i){
					 	var postJson={};
					 	postJson.carInfoId=checked[i].carInfoId;
					 	postJson.userInfoId=checked[i].userInfoId;
					 	postJson.auditCount=checked[i].auditCount;
					 	postJson.auditOperator=carsmart_config.operatorName;
					 	postJson.reasonOfReject=json.reasonOfReject;
					 	postJson.auditReasult=2;
					 	postData.push(postJson)
					 });
					return postData
				},
				success_callback: function(){
					$("#Form_useCheck").form('close');
					$('#Table_useCheck').flexMessage('已驳回!', 'success');
					$('#Table_useCheck').flexReloadSearch();
				},
				error:function(xhr){
					var errormsg = eval("(" + xhr.responseText + ")"); 
					if (errormsg != undefined) {
						$('#Table_useCheck').flexMessage(errormsg[0].message, 'error');
					}
				},
				autobinding:true
			}).form('open'); 
		}
	}); 
	page_list_buttons.push({displayname: '加入黑名单',name:'pass',bclass: 'pass',prefunc:function(){
            var checked = $('#Table_useCheck').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
	    	var checked = $('#Table_useCheck').getCheckedTrs();
            var postData={};
            postData.userId = checked[0].userInfoId;
            postData.auditFlag =1;
			$.jRadConfirm('确认加入黑名单吗？',1,function(){
				$.jRadAjax({
				    type:'post',
					data:postData,
					url:'/shopmanage-ws/ws/0.1/user/addBlack', 
					success: function(){
						$('#Table_useCheck').flexMessage('加入黑名单成功!', 'success');
           	    		$('#Table_useCheck').flexReloadSearch();
					},
					error:function(xhr){
					    var errormsg = eval("(" + xhr.responseText + ")"); 
						if (errormsg != undefined) {
							$('#Table_useCheck').flexMessage(errormsg[0].message, 'error');
						}
					}
				});
			});
		}
	});
    page_list_buttons.push({separator: true});
    $('#Table_useCheck').flexigrid({
            reload:true,
			method:'get',
            colModel : page_column_model,
            buttons : page_list_buttons,
            searchitems :page_search_items,
            queryParam: {'auditStatus':3},
			showSearch:true,
            pagination: {
				diaplay_pages: 5,
				align: 'bottom' 
			},
            url:'/shopmanage-ws/ws/0.1/userAudit/queryAccountList', 
			onError:showError,
			overflow:true 
    });  
    $(".numb85").click(function(){
        $('.overcurtainDiv').hide();
        var menuId = $(".tabs-selected").attr("menuId")
        var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        $("#Form_explain_eg85").form({}).form('close');
        $("#Form_explain_eg85").form({
            title:'页面说明',
            item:data,
            autobinding: true, 
            submit:function(){
                var postData = {};
                postData.operator = carsmart_config.operatorName;
                postData.menuName = $(".tabs-selected").attr("menuName");
                postData.menuId = $(".tabs-selected").attr("menuId");
                postData.remark = $("#Form_explain_eg85 div[name='remark']").textarea("val")
                $.jRadPost({
                    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
                    data:postData,
                    success:function(){
                        $("#Form_explain_eg85").form('close')
                        $('.overcurtainDiv').hide();
                    }
                });
            }, 
            cancel:function(){
                $("#Form_explain_eg85").form('close')
                $('.overcurtainDiv').hide();
            }
        }).form('open')
        $("#Form_explain_eg85 .textarea-content").removeClass("span4").addClass("span12")
        $('.overcurtainDiv').hide();
        $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
    })
    function showError(xhr){
	  var errormsg = eval("(" + xhr.responseText + ")");
	  var cDiv = $("#Wraper_useCheck .cDiv");
	  $.jRadMessage({level:'error',message:errormsg[0].message,selector:cDiv});
	}
 
}); 
</script>
