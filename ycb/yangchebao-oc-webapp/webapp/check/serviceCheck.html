<style>
.height28{
  height:28px;
  line-height:28px;
}
</style>
<div class="urlContentWraper" id="Wraper_serviceCheck">
    <div class="ui-info-layout">
        <h2 class="ui-tit"><strong>服务信息审核</strong><bottom class="all-work-info numb82">页面说明</bottom></h2>
        <!-- 列表显示 -->
		<div class="pic-grid">
			<table id="Table_serviceCheck"></table>
		</div>
    </div> 
	<div id="Form_serviceCheck" style="display:none;">
		<div class="grid-layout-main jrad-form"> 
			<input type="hidden" name="id"/>
			<div class="row"> 
				 <div class="span5 grid-layout-content">
					   <div name="auditDesc" class="jrad-textarea-container"></div>
									</div>
			</div>
		</div>
		<div class="jrad-buttons-container ui-buttons-container">
			<span class="jrad-btn-primary">确定</span> 
			<span class="jrad-btn-normal">取消</span>
		</div>
	</div>
	<div id="Form_servicePrice" style="display:none;">
		<div class="grid-layout-main jrad-form"> 
			<input type="hidden" name="id"/>
			<div class="row"> 
				 <label class="span3 grid-layout-label">结算价：</label>
				 <div class="span8 grid-layout-content">
					   <div name="clearingPriceModify" class="jrad-input-container"></div>
									</div>
			</div>
		</div>
		<div class="jrad-buttons-container ui-buttons-container">
			<span class="jrad-btn-primary">确定</span> 
			<span class="jrad-btn-normal">取消</span>
		</div>
	</div>
	<div id="Form_explain_eg82" style="display:none;">
	    <div class="grid-layout-main jrad-form"> 
	        <div class="row">
	            <label class="span3 grid-layout-label">业务说明：</label>
	            <div class="span12 grid-layout-content">
	                <div><strong>功能简介：</strong>商家在商家后台创建、修改服务信息后，需要在此审核后，才能生效。</div>
	                <div><strong>重要功能说明：</strong>无。</div>
	                <div><strong>注意事项：</strong>无。</div>
	            </div> 
	        </div> 
	        <div class="row">
	            <label class="span3 grid-layout-label">备注：</label>
	            <div class="span12 grid-layout-content">
	                <div class="jrad-textarea-container" name="remark">
	                </div>
	            </div>
	        </div>
	    </div>
	    <div class="jrad-buttons-container ui-buttons-container"> 
	        <span class="jrad-btn-primary">确定</span> 
	        <span class="jrad-btn-normal">取消</span>
	    </div>
	</div>
</div>
<script type="text/javascript">
$(document).ready(function(){
    var wraper = $('#Wraper_serviceCheck');
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array(); 
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel});  
	jRad.validators['auditDesc'] = [{"msg":"请填写原因","type":"min","value":"1"}];
	jRad.validators['clearingPriceModify'] = [{"msg":"请填写结算价","type":"min","value":"1"}];
	var checkParam = {};
	checkParam['auditDesc'] = {grid:14};
	$('#Form_serviceCheck').form({
		title: '驳回原因',
		validators: jRad.validators,
		fields_params:checkParam,
		item:{} ,
		type:'post', 
		url:'/shopmanage-ws/ws/0.1/businessServiceModifyCms/auditReject', 
		before_submit:function(json){
			json.auditPerson = carsmart_config.operatorName;
			return json;
		},
		success_callback: function(){
			$("#Form_serviceCheck").form('close');
			$('#Table_serviceCheck').flexMessage('已驳回!', 'success');
			$('#Table_serviceCheck').flexReloadSearch();
		},
		error:function(xhr){
			var errormsg = eval("(" + xhr.responseText + ")"); 
			if (errormsg != undefined) {
				$('#Table_serviceCheck').flexMessage(errormsg[0].message, 'error');
			}
		},
		autobinding:true
	});  
	var checkParam2 = {};
	checkParam2['clearingPriceModify'] = {grid:8};
	$('#Form_servicePrice').form({
		title: '修改结算价',
		validators: jRad.validators,
		fields_params:checkParam2,
		item:{} ,
		url:'/shopmanage-ws/ws/0.1/businessServiceModifyCms/editClearingPrice', 
		type: 'post',
		before_submit:function(json){
			json.auditPerson = carsmart_config.operatorName;
			return json;
		},
		success_callback: function(){
			$("#Form_servicePrice").form('close');
			$('#Table_serviceCheck').flexMessage('修改成功!', 'success');
			$('#Table_serviceCheck').flexReloadSearch();
		},
		error:function(xhr){
			var errormsg = eval("(" + xhr.responseText + ")"); 
			if (errormsg != undefined) {
				$('#Table_serviceCheck').flexMessage(errormsg[0].message, 'error');
			}
		},
		autobinding:true
	});  
    page_column_model.push({display: '商家简称', name : 'businessRegName',diy:function(item,$div){
	   	var $a = $("<a>").html(item.businessRegName); 
	   	$div.html($a);
	   	$a.click(function(){
			$(document).data("checkShopId",item.businessInfoId)
			$.jRadOpenTab({'id':'3010','name':'商家信息管理','url':'shopManage/list2.html'},true);
	   	});
	}});
    page_column_model.push({display: '服务名称', name : 'serviceName'});
    page_column_model.push({display: '门市价', name : 'shopPriceModify'});
	page_column_model.push({display: '预定价', name : 'reservePriceModify'}); 
	page_column_model.push({display: '结算价', name : 'clearingPriceModify'});
	page_column_model.push({display: '工时费', name : 'workPriceModify'}); 
	page_column_model.push({display: '所需工时', name : 'workHourModify'});
	// page_column_model.push({display: '使用开始时间', name : 'useStartTimeModify'});
	// page_column_model.push({display: '使用结束时间', name : 'useEndTimeModify'}); 
	page_column_model.push({display: '预约信息', name : 'reserveInfoModify',diy:function(item,$div){
		if(item.reserveInfoModify=="0"){
			$div.html('无');
		}else if(item.reserveInfoModify=="1"){
			$div.html('1天');
		}else if(item.reserveInfoModify=="2"){
			$div.html('2天');
		}else if(item.reserveInfoModify=="3"){
			$div.html('3天');
		}else if(item.reserveInfoModify=="4"){
			$div.html('4天');
		}else if(item.reserveInfoModify=="5"){
			$div.html('5天');
		}else if(item.reserveInfoModify=="6"){
			$div.html('2小时');
		}
	}});
	page_column_model.push({display: '使用规则', name : 'useRuleModify'});
	page_column_model.push({display: '审核人', name : 'auditPerson'}); 
	page_column_model.push({display: '审核时间', name : 'auditTime'});
	page_column_model.push({display: '提交审核时间', name : 'commitAuditTime'}); 
	page_column_model.push({display: '审核状态', name : 'auditStatusDesc',width:120,diy:function(item,$div){
	    $div.html(item.auditStatusDesc+"&nbsp;&nbsp;&nbsp;&nbsp;");
	    if(item.auditStatus=='3'){
		 	var $a = $("<a>").html("查看原因");
		 	$div.append($a);
		 	$a.click(function(){
				$.jRadAlert(item.auditDesc,"info");
		 	});
		 	var checkDiv = $("<div>").addClass("checkInfo");
	    } 
	}}); 

	page_search_items.push({row:'1',type:'jrad-input',display:'商家简称',name:'businessName'});
	page_search_items.push({row:'1',type:'jrad-select',display:'状态',name:'auditStatus',params:{
		data:[
				{id:'',name:'全部'},
				{id:'1',name:'审核中'},
				{id:'2',name:'通过'},
				{id:'3',name:'未通过'}
		]}});
	page_search_items.push({row:'1',type:'jrad-input',display:'审核人',name:'auditPerson'});


	page_list_buttons.push({displayname: '通过',name:'pass',bclass: 'pass',
		prefunc:function(){
            var checked = $('#Table_serviceCheck').getCheckedTrs();
            if (checked.length == 0) {return false;}else{return true;}
        },
        onpress : function(){
	    	var checked = $('#Table_serviceCheck').getCheckedTrs();

	    	var ids2 = [];
			$.each(checked,function(){
				ids2.push(this.id);
			});

	    	var ids = [];
	    	$.each(checked,function(i){
	    		var jsonarry = {}
	    		var item = checked[i]
	    		jsonarry.businessInfoId = item.businessInfoId;
	    		jsonarry.serviceIdModify = item.serviceIdModify;
	    		jsonarry.serviceName = item.serviceName;
	    		ids.push(jsonarry)
	    	})

	    	$.jRadAjax({
			    type:'post',
				data:ids,
				url:'/shopmanage-ws/ws/0.1/businessServiceModifyCms/checkServiceHas', 
				success: function(data){
					if(data.flag == 1){
						$.jRadConfirm(data.serviceList+'&nbsp;&nbsp;商家此服务已存在，审核通过后，商家将有两个相同的服务，是否继续？',1,function(){
							var postData = {}; 
							postData.idString = ids2.join(',');
							postData.auditPerson = carsmart_config.operatorName; 
							$.jRadAjax({
							    type:'post',
								data:postData,
								url:'/shopmanage-ws/ws/0.1/businessServiceModifyCms/auditPass', 
								success: function(){
									$('#Table_serviceCheck').flexMessage('审核通过成功!', 'success');
			           	    		$('#Table_serviceCheck').flexReloadSearch();
								},
								error:function(xhr){
								    var errormsg = eval("(" + xhr.responseText + ")"); 
									if (errormsg != undefined) {
										$('#Table_serviceCheck').flexMessage(errormsg[0].message, 'error');
									}
								}
							});
						});
					}else{						
						$.jRadConfirm('确认审核通过吗？',1,function(){
							var postData = {}; 
							postData.idString = ids2.join(',');
							postData.auditPerson = carsmart_config.operatorName; 
							$.jRadAjax({
							    type:'post',
								data:postData,
								url:'/shopmanage-ws/ws/0.1/businessServiceModifyCms/auditPass', 
								success: function(){
									$('#Table_serviceCheck').flexMessage('审核通过成功!', 'success');
			           	    		$('#Table_serviceCheck').flexReloadSearch();
								},
								error:function(xhr){
								    var errormsg = eval("(" + xhr.responseText + ")"); 
									if (errormsg != undefined) {
										$('#Table_serviceCheck').flexMessage(errormsg[0].message, 'error');
									}
								}
							});
						});
					}
				}
			});
		}
	});
	page_list_buttons.push({displayname: '驳回',name:'reject',bclass: 'reject',
		prefunc:function(){
            var checked = $('#Table_serviceCheck').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
	    	var checked = $('#Table_serviceCheck').getCheckedTrs(); 
			$('#Form_serviceCheck').form({  
				item:{'id':checked[0].id}
			}).form('open');  
		}
	}); 
	page_list_buttons.push({displayname: '修改结算价',name:'upprice',bclass: 'upprice',
		prefunc:function(){
            var checked = $('#Table_serviceCheck').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
	    	var checked = $('#Table_serviceCheck').getCheckedTrs(); 
			$('#Form_servicePrice').form({  
				item:{'id':checked[0].id,'clearingPriceModify':checked[0].clearingPriceModify}
			}).form('open');  
		}
	}); 

    page_list_buttons.push({separator: true});
    
    $('#Table_serviceCheck').flexigrid({
        reload:true,
		method:'get',
        colModel : page_column_model,
        buttons : page_list_buttons,
        searchitems :page_search_items,
		showSearch:true,
        pagination: {
			diaplay_pages: 5,
			align: 'bottom' 
		},
		overflow:true,
        url:'/shopmanage-ws/ws/0.1/businessServiceModifyCms/queryBusiServiceMdys', 
		onError:showServiceCheckError
    });  

    $(".numb82").click(function(){
        $('.overcurtainDiv').hide();
        var menuId = $(".tabs-selected").attr("menuId")
        var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        $("#Form_explain_eg82").form({}).form('close');
        $("#Form_explain_eg82").form({
            title:'页面说明',
            item:data,
            autobinding: true, 
            submit:function(){
                var postData = {};
                postData.operator = carsmart_config.operatorName;
                postData.menuName = $(".tabs-selected").attr("menuName");
                postData.menuId = $(".tabs-selected").attr("menuId");
                postData.remark = $("#Form_explain_eg82 div[name='remark']").textarea("val")
                $.jRadPost({
                    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
                    data:postData,
                    success:function(){
                        $("#Form_explain_eg82").form('close')
                        $('.overcurtainDiv').hide();
                    }
                });
            }, 
            cancel:function(){
                $("#Form_explain_eg82").form('close')
                $('.overcurtainDiv').hide();
            }
        }).form('open')
        $("#Form_explain_eg82 .textarea-content").removeClass("span4").addClass("span12")
        $('.overcurtainDiv').hide();
        $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
    })
});
function showServiceCheckError(xhr){
 	var errormsg = eval("(" + xhr.responseText + ")");
  	var cDiv = $("#Wraper_serviceCheck .cDiv");
  	$.jRadMessage({level:'error',message:errormsg[0].message,selector:cDiv});
}
 
</script>
