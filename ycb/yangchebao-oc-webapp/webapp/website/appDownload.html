<div class="urlContentWraper" id="cms-app-wrapper">
	<div class="ui-info-layout">
		<div class="ui-info-layout-subbox ">
			<div class="jrad-table">
				<h2 class="ui-tit"><strong></strong><bottom class="all-work-info numb192">页面说明</bottom></h2>
				<table class="cms-table"></table>
			</div>
			<div class="details-box" style="display: none;">
				<ul class="details-tab">
					<li class="tab-cur tab-cur-first f-left"><span class="cms-title"></span></li>
					<li><span class="return"></span></li>
				</ul>
				<div class="details-content">
					<div class="details-scroll">
						<div class="details-content-inner">
							<div class="grid-layout ui-form cms-form">
								<div class="jrad-form">
									<div class="grid-layout-main">
										<input name="id" type="hidden"> 
										<input name="apkFileDataId" type="hidden">
										<div class="row-fluid">
											 <label class="span3 grid-layout-label"><span class="ui-form-required">*</span>版本详情：</label>
											 <div class="span5 grid-layout-content">
												   <div name="version" class="jrad-mediaarea-container" style="margin-left:0"></div>
											 </div>
										</div>
										<div class="row-fluid">
											 <label class="span3 grid-layout-label"><span class="ui-form-required">*</span>功能简介：</label>
											 <div class="span5 grid-layout-content">
												   <div name="functions" class="jrad-mediaarea-container" style="margin-left:0"></div>
											 </div>
										</div>
										<div class="row-fluid">
											 <label class="span3 grid-layout-label"><span class="ui-form-required">*</span>新版详情：</label>
											 <div class="span5 grid-layout-content">
												   <div name="feature" class="jrad-mediaarea-container" style="margin-left:0"></div>
											 </div>
										</div>
										<div class="row-fluid">
											<label class="span3 grid-layout-label"><span class="ui-form-required">*</span>状态：</label>
											<div class="span5 grid-layout-content">
												<div name="state" class="jrad-select-container"></div>
											</div>
										</div>
										<div class="row-fluid">
											<label class="span3 grid-layout-label">上次上传时间：</label>
											<div class="span5 grid-layout-content">
												<div name="lastUploadTime" class="jrad-input-container"></div>
											</div>
										</div>
										<div class="row-fluid">
											<label class="span3 grid-layout-label"><span class="ui-form-required">*</span>apk下载链接：</label>
											<div class="span5 grid-layout-content">
												<div name="apkDownloadUrl" class="jrad-input-container"></div>
											</div>
										</div>
										<div class="row-fluid">
											<label class="span3 grid-layout-label"><span class="ui-form-required">*</span>上传文件: </label>
											<div class="span5 grid-layout-content">
												<div name="apk" class="jrad-upload-container"></div>
											</div>
											<div class="span4 ui-info-layout-subbox ui-form"> 
													<span class="ui-btn-primary jrad-upload">上传</span>
											</div>
										</div>
									</div>
								</div>
								<div class="jrad-buttons-container ui-buttons-container">
									<span class="jrad-btn-primary">确定</span> 
									<span class="jrad-btn-normal">取消</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
    <div id="Form_explain_eg192" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                <label class="span3 grid-layout-label">业务说明：</label>
                <div class="span12 grid-layout-content">
                    <div><strong>功能简介：</strong>官网安卓包的上传功能。</div>
                    <div><strong>重要功能说明：</strong>创建： 版本详情：当前安卓包的版本；
                     功能简介：最新包的功能简介，需要分条描述；
                     新版详情：这版本增加的哪些功能的简介，需要分条描述；
                     状态：只有有效的包才能在官网下载；
                     上次上传时间：最新更新包的时间；
                     Apk下载链接：上传包的链接地址；
                     上传文件：点击后，把准备好的最新版本的包上传到服务器，注意命名一定要正确，注意包用QQ传送后，上传的包再下载，包名会出错。</div>
                    <div><strong>注意事项：</strong>无。</div>
                </div> 
            </div> 
            <div class="row">
                <label class="span3 grid-layout-label">备注：</label>
                <div class="span12 grid-layout-content">
                    <div class="jrad-textarea-container" name="remark">
                    </div>
                </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
</div>
<script type="text/javascript">
	
	$(document).ready(function() {
		
		var config = {
			url: {
				base: "/websitemanager-ws/ws/0.1",
				cms: "/appCms"
			},
			model: {
				displayName: "App"
			}
		};
		
		var URL = {
				"page": getUrl("/page"),
				"add": getUrl("/add"),
				"edit": getUrl("/edit"),
				"detail": getUrl("/detail"),
				"remove": getUrl("/remove"),
				"changeState": getUrl("/change/state"),
				"upload": {
					"pic1": config.url.base + "/fileCms/upload/pic1",
					"pic2": config.url.base + "/fileCms/upload/pic2",
					"apk": config.url.base + "/fileCms/upload/apk"
				}
		};
		
		var wrapper = $("#cms-app-wrapper");
		var table = $(".cms-table", wrapper);
		var submitForm = $(".cms-form", wrapper);
		var title = $(".cms-title", wrapper);
		
		$(".jrad-table strong").html(config.model.displayName + "列表");
		
		var submitValidators = {
			version: 		[{msg : "版本详情不能为空", type : "min", value : "1"},{msg:"版本详情不能为空",type:"func",value:function(value){
				if ($.trim(value.replace(/<p>/g, "").replace(/<\/p>/g, "").replace(/&nbsp;/g, "")) == "") {
					return false;
				}
				return true;
			}}],
			functions: 		[{msg : "功能简介不能为空", type : "min", value : "1"},{msg:"功能简介不能为空",type:"func",value:function(value){
				if ($.trim(value.replace(/<p>/g, "").replace(/<\/p>/g, "").replace(/&nbsp;/g, "")) == "") {
					return false;
				}
				return true;
			}}],
			feature: 		[{msg : "新版详情不能为空", type : "min", value : "1"},{msg:"新版详情不能为空",type:"func",value:function(value){
				if ($.trim(value.replace(/<p>/g, "").replace(/<\/p>/g, "").replace(/&nbsp;/g, "")) == "") {
					return false;
				}
				return true;
			}}],
			apkDownloadUrl: [{msg : "请先上传apk文件", type : "min", value : "1"}],
			state: 			[{msg : "有效状态不能为空", type : "min", value : "1"}],
			apk: 			[{msg : "请选择要上传的文件",type : "min", value : "1"},{msg:"只能上传apk文件",type:"regex",value:/^.+\.apk$/}]
		};
		
		var submitParams = {
			version: getEditorField(),
			functions: getEditorField(),
			feature: getEditorField(),
			state: {
				data : [
					{id : "1", name : "有效"},
					{id : "0", name : "无效"}
				]
			},
			lastUploadTime: {
				readonly: true
			},
			apkDownloadUrl: {
				grid: 18,
				readonly: true
			},
			apk: {
				url : URL.upload.apk,
				autocomplete : false,
				success : function(data) {
					if (!!data && !!data.apkDownloadUrl) {
						$("input[name='apkFileDataId']", wrapper).val(data.apkFileDataId);
						$("input[name='apkDownloadUrl']", wrapper).val(data.apkDownloadUrl);
						$.jRadMessage('上传成功');
					}
				}
			}
		};
		
		var pageSearchItems = [
       	];
		
		var pageColumnModel = [
			{name : 'id', display : 'ID', width : 50}, 
			{name : 'createTime', display : '创建时间'}, 
			{name : 'updateTime', display : '更新时间'}, 
			{name : 'stateName', display : '状态'},
			{name : 'apkDownloadUrl', display : 'apk下载链接'},
			{name : 'lastUploadTime', display : '上次上传时间'}
		];
		
		submitForm.form({
			validators : submitValidators,
			fields_params : submitParams,
			layout : 'grid',
			autobinding : false
		});
		
		$('.jrad-upload', wrapper).button({
			click : function() {
				$("div[name='apk']", wrapper).upload('upload');
			}
		});
		
		$(".ui-buttons-container .jrad-btn-normal", wrapper).button({
			click : function() {
				boxUp();
			}
		});

		$(".ui-buttons-container .jrad-btn-primary", wrapper).button({
			click : function() {
				if (!submitForm.form('validateAll')) {
					return;
				}
				var json = submitForm.form('getValue');
				if(!json.apkDownloadUrl){
					$.jRadMessage({level:'error',message:"请先上传apk文件"});
					return;
				}
				json.createOperator = getOperator();

				console.log(json);

				$.jRadPost({
					
					url : title.html() == config.model.displayName + "添加" ? URL.add : URL.edit,
					data : json,
					success : function() {
						boxUp();
						table.flexMessage('创建成功','success');
						table.flexReload();
					},
					error : onSubmitError
				});
			}
		});

		var pageListButtons = [];

		pageListButtons.push({
			title : '创建',
			name : 'Add',
			bclass : 'add',
			onpress : function() {
				
				submitForm.form({
					item : {}
				});
				boxDown();
				title.html(config.model.displayName + "添加");
			}
		});
	
		pageListButtons.push({
			title : '修改',
			name : 'Edit',
			bclass : 'edit',
			prefunc : function() {
				return table.getCheckedTrs().length == 1;
			},
			onpress : function() {
				var checked = table.getCheckedTrs();
				if (checked[0]) {
					var id = checked[0].id;
					fillEditForm(id);
				}
			}
		});

		pageListButtons.push({
			
			name : 'delete',
			bclass : 'delete',
			prefunc : function() {
				return table.getCheckedTrs().length != 0;
			},
			onpress : function() {
				var checked = table.getCheckedTrs();
				$.jRadConfirm('确认删除吗？', 1, function() {
					var idArr = [];
					$.each(checked, function() {
						idArr.push(this.id);
					});
					idArr.join(",");
					$.jRadAjax({
						type : 'post',
						url : URL.remove + "?idString="+ idArr,
						success : function() {
							table.flexMessage('删除成功!', 'success');
							table.flexReload();
						},
						error : onTableError
					});
				});
			}
		});

		pageListButtons.push({
			displayname : "设为有效",
			name : "unUse",
			bclass : "unUse",
			prefunc : function() {
				return table.getCheckedTrs().length != 0;
			},
			onpress : function() {
				var checked = table.getCheckedTrs();
				$.jRadConfirm("确认设置为有效吗？", 1, function() {
					var idArr = [];
					$.each(checked, function() {
						idArr.push(this.id);
					});
					idArr.join(",");
					$.jRadAjax({
						type : "post",
						url : URL.changeState + "?idString=" + idArr + "&state=1",
						success : function() {
							table.flexMessage("操作成功!", "success");
							table.flexReload();
						},
						error : onTableError
					});
				});
			}
		});

		pageListButtons.push({
			separator : true
		});
		
		table.flexigrid({
			reload : true,
			method : "get",
			colModel : pageColumnModel,
			buttons : pageListButtons,
			searchitems : pageSearchItems,
			pagination : {
				diaplay_pages : 5,
				align : "bottom"
			},
			showSearch : true,
			url : URL.page,
			onError : showError,
			overflow : true
		});

		$(".searchButtons .ui-btn-icon:first", wrapper).unbind("click");
		$(".searchButtons .ui-btn-icon:first", wrapper).click(function() {
			table.flexOptions({
				url : URL.page
			});
			table.flexReloadSearch();
		});
		$(".searchButtons .ui-btn-icon:nth-child(2)", wrapper).unbind("click");
		$(".searchButtons .ui-btn-icon:nth-child(2)", wrapper).click(function() {
			
			var sDiv = $(".searchContent", wrapper);
			$(".jrad-select", sDiv).select("val", "");
			$(".jrad-autocomplete", sDiv).autocomplete("val", "");
			$(".jrad-input", sDiv).input("val","");
			$(".jrad-dateinput", sDiv).dateinput("val", "");
			$(".jrad-autocombo", sDiv).autocombo("val", "");
			$(".jrad-checkbox", sDiv).checkbox("val", "");
			table.flexOptions({
				url : URL.page,
				queryParam : {},
				page : 0
			});
			table.flexReloadSearch();
		});

		$(".details-tab .return", wrapper).click(function() {
			boxUp();
		});
		
		function getUrl(method) {
			return config.url.base + config.url.cms + method;
		}
		
		function getEditorField() {
			return {
	 			theme:"Full",
	 			resizing: false, 
	 			grid: 18, 
	 			height: 200,
	 			uploadImg: { //上传图片参数
	 				url: URL.upload.pic2,
	 				filename: 'file', 
	 				delFunc: function(item) { 
	 					item.list.remove(); 
	 				}, 
	 				validator : [{
	 					msg : "只能上传jpg文件",
	 					type : "regex",
	 					value : /^.*\.(jpg|JPG)$/
	 				}], 
	 				success: function(data){ 
	 					   if(data[0]&&data[0].code=="400"){
	 						 $.jRadMessage({level:'error',message:data[0].message});
	 					   } 
	 					},
	 				note: '仅支持 JPG图片文件。',
	 				show:true,
	 				showLarge:true, 
	 				prev:'thumbnailPicUrl', 
	 				params: {type:""}, 
	 				single: true 
	 			}
			};
		}
	
		function fillEditForm(id) {
			
			var item = $.jRadGet({
				url : URL.detail + "?id=" + id
			});
			title.html(config.model.displayName + "修改");
			
			boxDown();
			
			submitForm.form({
				item : item
			});
		}
		
		function showError(xhr) {
			var msg = getErrorMessage(xhr);
			var cDiv = $(".cDiv", wrapper);
			$.jRadMessage({
				level : "error",
				message : msg,
				selector : cDiv
			});
		}
		
		function onSubmitError(xhr) {
			var msg = getErrorMessage(xhr);
			if (!!msg) {
				$.jRadMessage({
					level : "error",
					message : msg
				});
			}
		}
		
		function onTableError(xhr) {
			var msg = getErrorMessage(xhr);
			if (!!msg) {
				table.flexMessage(msg, "error");
			}
		}
		
		function getErrorMessage(xhr) {
			var msg = eval("(" + xhr.responseText + ")");
			return !!msg ? msg[0].message : null;
		}
		
		function getOperator() {
			var operator = carsmart_config.operatorName;
			return operator;
		}
		
		function boxUp() {
			$(".details-box", wrapper).slideUp();
			$(".jrad-table", wrapper).slideDown();
			$(".scroll-up-btn").click();
		}
		
		function boxDown() {
			$(".jrad-table", wrapper).slideUp();
			$(".details-box", wrapper).slideDown();
			$(".scroll-up-btn").click();
		}

        // $(".all-work-info").click(function(){
        //     var menuId = $(".tabs-selected").attr("menuId")
        //     var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        //     $("#Form_explain_eg192").form({
        //         title:'页面说明',
        //         item:data,
        //         url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
        //         before_submit:function(json){ 
        //             json.operator = carsmart_config.operatorName;
        //             json.menuName = $(".tabs-selected").attr("menuName");
        //             json.menuId = $(".tabs-selected").attr("menuId");
        //             return json;
        //         }
        //     }).form('open')
        //     $("#Form_explain_eg192 .textarea-content").removeClass("span4").addClass("span12")
        // })
        
        //$(".numb192").unbind("click").bind("click",function(){
        $(".numb192").click(function(){
            $('.overcurtainDiv').hide();
            var menuId = $(".tabs-selected").attr("menuId")
            var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
            $("#Form_explain_eg192").form({}).form('close');
            $("#Form_explain_eg192").form({
                title:'页面说明',
                item:data,
                autobinding: true, //是否自动绑定 确定/取消 按钮
				submit:function(){
                	var postData = {};
                    postData.operator = carsmart_config.operatorName;
                    postData.menuName = $(".tabs-selected").attr("menuName");
                    postData.menuId = $(".tabs-selected").attr("menuId");
                    postData.remark = $("#Form_explain_eg192 div[name='remark']").textarea("val")
					$.jRadPost({
					    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
					    data:postData,
					    success:function(){
							$("#Form_explain_eg192").form('close')
          					$('.overcurtainDiv').hide();
					   	}
					});
				}, 
				cancel:function(){
					$("#Form_explain_eg192").form('close')
          			$('.overcurtainDiv').hide();
				}
            }).form('open')
            $("#Form_explain_eg192 .textarea-content").removeClass("span4").addClass("span12")
            $('.overcurtainDiv').hide();
            $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
        })
	});

</script>
