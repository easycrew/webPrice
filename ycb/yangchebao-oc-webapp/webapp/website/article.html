<div class="urlContentWraper" id="cms-article-wrapper">
	<div class="ui-info-layout">
		<div class="ui-info-layout-subbox ">
			<div class="jrad-table">
				<h2 class="ui-tit"><strong></strong><bottom class="all-work-info numb193">页面说明</bottom></h2>
				<table class="cms-table"></table>
			</div>
			<div class="details-box" style="display: none;">
				<ul class="details-tab">
					<li class="tab-cur tab-cur-first f-left"><span class="cms-title"></span></li>
					<li><span class="return"></span></li>
				</ul>
				<div class="details-content">
					<div class="details-scroll">
						<div class="details-content-inner">
							<div class="grid-layout ui-form cms-form">
								<div class="jrad-form">
									<div class="grid-layout-main">
										<input name="id" type="hidden"> 
										<input name="picFileDataId" type="hidden"> 
										<input name="picUrl" type="hidden">
										<input name="realPicUrl" type="hidden">  
										<div class="row-fluid">
											<label class="span3 grid-layout-label"><span class="ui-form-required">*</span>标题：</label>
											<div class="span5 grid-layout-content">
												<div name="title" class="jrad-input-container"></div>
											</div>
										</div>
										<div class="row-fluid">
											<label class="span3 grid-layout-label"><span class="ui-form-required">*</span>短标题：</label>
											<div class="span5 grid-layout-content">
												<div name="shortTitle" class="jrad-input-container"></div>
											</div>
										</div>
										<div class="row-fluid">
											<label class="span3 grid-layout-label">发布时间：</label>
											<div class="span3 grid-layout-content">
												<div name="createTime" class="jrad-dateinput-container"></div>
											</div>
										</div>
										<div class="row-fluid">
											<label class="span3 grid-layout-label"><span class="ui-form-required">*</span>文章类型：</label>
											<div class="span5 grid-layout-content">
												<div name="type" class="jrad-select-container"></div>
											</div>
											<div class="type-mediaSource-link">
												<label class="span3 grid-layout-label"><span class="ui-form-required">*</span>媒体来源：</label>
												<div class="span5 grid-layout-content">
													<div name="mediaSource" class="jrad-input-container"></div>
												</div>
											</div>
										</div>
										<div class="row-fluid">
											<label class="span3 grid-layout-label"><span class="ui-form-required">*</span>文章图片： </label>
											<div class="span15 grid-layout-content fluid-wrap">
												<div name="picFile" class="jrad-uploadimg-container">
												</div>
											</div>
										</div>
										<div class="row-fluid">
											<label class="span3 grid-layout-label"><span class="ui-form-required">*</span>摘要：</label>
											<div class="span5 grid-layout-content">
												<div name="digest" class="jrad-textarea-container"></div>
											</div>
										</div>
										<div class="row-fluid">
											 <label class="span3 grid-layout-label"><span class="ui-form-required">*</span>详情：</label>
											 <div class="span5 grid-layout-content">
												   <div name="detail" class="jrad-mediaarea-container" style="margin-left:0"></div>
											 </div>
										</div>
										<div class="row-fluid">
											<label class="span3 grid-layout-label"><span class="ui-form-required">*</span>显示开始时间：</label>
											<div class="span3 grid-layout-content">
												<div name="displayTime" class="jrad-dateinput-container"></div>
											</div>
										</div>
										<div class="row-fluid">
											<label class="span3 grid-layout-label"><span class="ui-form-required">*</span>状态：</label>
											<div class="span5 grid-layout-content">
												<div name="state" class="jrad-select-container"></div>
											</div>
										</div>
									</div>
								</div>
								<div class="jrad-buttons-container ui-buttons-container">
									<span class="jrad-btn-primary">确定</span> 
									<span class="jrad-btn-normal">取消</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
    <div id="Form_explain_eg193" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                <label class="span3 grid-layout-label">业务说明：</label>
                <div class="span12 grid-layout-content">
                    <div><strong>功能简介：</strong>官网上传文章的功能。</div>
                    <div><strong>重要功能说明：</strong>上传的文章包含媒体报道、成功故事。</div>
                    <div><strong>注意事项：</strong>1、列表“文章链接”字段，点击弹出的链接不为真实链接，“媒体报道”真实链接为http://yangchebao.com.cn/mtbd.html?articleId=53，后面的53为弹出链接最后面的参数；“成功故事”真实链接为http://yangchebao.com.cn/cggs.html?articleId=50 ，后面的50为弹出链接最后面的参数；
           2、在官网是按“显示开始时间”倒序排列的。</div>
                </div> 
            </div> 
            <div class="row">
                <label class="span3 grid-layout-label">备注：</label>
                <div class="span12 grid-layout-content">
                    <div class="jrad-textarea-container" name="remark">
                    </div>
                </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
</div>
<script type="text/javascript">
	
	$(document).ready(function() {
		
		var config = {
			url: {
				base: "/websitemanager-ws/ws/0.1",
				cms: "/articleCms"
			},
			model: {
				displayName: "文章"
			}
		};
		
		var URL = {
				"page": getUrl("/page"),
				"add": getUrl("/add"),
				"edit": getUrl("/edit"),
				"detail": getUrl("/detail"),
				"remove": getUrl("/remove"),
				"changeState": getUrl("/change/state"),
				"upload": {
					"pic1": config.url.base + "/fileCms/upload/pic1",
					"pic2": config.url.base + "/fileCms/upload/pic2"
				}
		};
		
		var wrapper = $("#cms-article-wrapper");
		var table = $(".cms-table", wrapper);
		var submitForm = $(".cms-form", wrapper);
		var title = $(".cms-title", wrapper);
		
		$(".jrad-table strong").html(config.model.displayName + "列表");
		
		var submitValidators = {
			title: 			[{msg : "标题不能为空", type : "min", value : "1"},{"msg":"标题最大长度为17","type":"max","value":"17"}],
			shortTitle: 	[{msg : "短标题不能为空", type : "min", value : "1"},{"msg":"短标题最大长度为10","type":"max","value":"10"}],
			type: 			[{msg : "文章类型不能为空", type : "min", value : "1"}],
			picFileDataId: 	[{msg : "文章图片不能为空", type : "min", value : "1"}],
			mediaSource: 	[{"msg":"媒体来源最大长度为10","type":"max","value":"10"},{msg : "媒体来源不能为空", type : "func", value : function(value){
				if ($(".type-mediaSource-link", wrapper).is(":visible") && $.trim(value) == "") {
					return false;
				}
				return true;
			}}],
			digest: 		[{msg : "摘要不能为空", type : "min", value : "1"},{msg : "媒体报道最大长度为50，成功故事最大长度为200", type : "func", value : function(value){
				if ($('[name=type]',submitForm).select('val') == 2) {
					if (!value || value.length > 200) return false;
				} else {
					if (!value || value.length > 50) return false;
				}
				return true;
			}}],
			detail: 		[{msg : "详情不能为空", type : "min", value : "1"},{msg:"详情不能为空",type:"func",value:function(value){
				if ($.trim(value.replace(/<p>/g, "").replace(/<\/p>/g, "").replace(/&nbsp;/g, "")) == "") {
					return false;
				}
				return true;
			}}],
			displayTime:	[{msg : "显示时间不能为空", type : "min", value : "1"}],
			state: 			[{msg : "有效状态不能为空", type : "min", value : "1"}]
		};
		
		var submitParams = {
			title: 	{
				grid : 4
			},
			shortTitle: 	{
				grid : 4
			},
			createTime: {
				grid : 4,
				dateFmt : 'yyyy-MM-dd HH:mm:ss'
			},
			type: {
				data : [
					{id : "1", name : "媒体报道"}, 
					{id : "2", name : "成功故事"}, 
					{id : "3", name : "活动"}, 
					{id : "4", name : "其他"}
				],
				onchange: function(id) {
					
					var typeMediaSourceLink = $(".type-mediaSource-link", wrapper);
					if (id == "1") {
						typeMediaSourceLink.show();
					}
					else {
						typeMediaSourceLink.hide();
					}
				}
			},
			mediaSource: 	{
				grid : 4
			},
			picFile: {
				url : URL.upload.pic1,
				delFunc : function(item) {
					item.list.remove();
					$("input[name='picFileDataId']", submitForm).val("");
					$("input[name='picUrl']", submitForm).val("");
					$("input[name='realPicUrl']", submitForm).val("");
				},
				fileName : "file",
				note : '仅支持JPG或PNG图片文件。',
				show : false,
				params : {
					type : ""
				},
				success : function(data) {

					if (data[0] && data[0].code == "400") {

						$.jRadMessage({
							level : 'error',
							message : data[0].message
						});
					} else {
						$("input[name='picFileDataId']", submitForm).val(data.realPicFileDataId);
						$("input[name='picUrl']", submitForm).val(data.realPicUrl);
						$("input[name='realPicUrl']", submitForm).val(data.realPicUrl);
					}
				},
				beforeSubmit : function(obj) {
					var re = /^.*\.(jpg|JPG|png|PNG)$/;
					if (re.test(obj.val())) {
						return true;
					} else {
						$.jRadAlert("只能上传jpg或png文件", "error");
						$("div[name='picFile']", submitForm).find("input[type='file']").val('');
						return false;
					}
				},
				single : true,
				showInfo : false,
				prev : 'realPicUrl'
			},
			digest: {
				grid: 9
			},
			detail: {
	 			theme:"Full",
	 			resizing: false, 
	 			grid: 18, 
	 			height: 200,
	 			uploadImg: { //上传图片参数
	 				url: URL.upload.pic2,
	 				filename: 'file', 
	 				delFunc: function(item) { 
	 					item.list.remove(); 
	 				}, 
	 				validator : [{
	 					msg : "只能上传jpg或png文件",
	 					type : "regex",
	 					value : /^.*\.(jpg|JPG|png|PNG)$/
	 				}], 
	 				success: function(data){ 
	 					   if(data[0]&&data[0].code=="400"){
	 						 $.jRadMessage({level:'error',message:data[0].message});
	 					   }else{
	 						   $(".realPicUrl-pic img").css({width: "140px", height: "140px"});
	 					   }
	 					},
	 				note: '仅支持JPG或PNG图片文件。',
	 				show:true,
	 				showLarge:true, 
	 				prev:'realPicUrl', 
	 				params: {type:""}, 
	 				single: true 
	 			}
			},
			displayTime: {
				grid : 4,
				dateFmt : 'yyyy-MM-dd HH:mm:ss'
			},
			state: {
				data : [
					{id : "1", name : "有效"}, 
					{id : "0", name : "无效"}
				]
			}
		};
		
		var pageSearchItems = [
   			{name : 'id', display : '文章ID', type : 'jrad-input', row : '1'}, 
   			{name : 'title', display : '标题', type : 'jrad-input', row : '1'},
   			{name : 'shortTitle', display : '短标题', type : 'jrad-input', row : '1'},
   			{name : 'type', display : "文章类型", type : 'jrad-select', row : '2', params : {data : [
																				   						{id : "", name : "全部"}, 
																				   						{id : "1", name : "媒体报道"}, 
																				   						{id : "2", name : "成功故事"}, 
																				   						{id : "3", name : "活动"}, 
																				   						{id : "4", name : "其他"}
																			   						]}}, 
			{name : 'createTimeStart', display : '创建开始时间', type : 'jrad-dateinput', row : '2', params : {grid : 4, dateFmt : 'yyyy-MM-dd HH:mm:ss'}}, 
			{name : 'createTimeStop', display : '创建结束时间', type : 'jrad-dateinput', row : '2', params : {grid : 4, dateFmt : 'yyyy-MM-dd HH:mm:ss'}}, 
			{name : 'state', display : '状态', type : 'jrad-select', row : '3', params : {data : [
																			   						{id : "", name : "全部"}, 
																			   						{id : "1",name : "有效"},
																			   						{id : "0",name : "无效"}
																			   					]}}, 
			{name : 'displayTimeStart', display : '显示开始时间', type : 'jrad-dateinput', row : '3', params : {grid : 4, dateFmt : 'yyyy-MM-dd HH:mm:ss'}}, 
			{name : 'displayTimeStop', display : '显示结束时间', type : 'jrad-dateinput', row : '3', params : {grid : 4, dateFmt : 'yyyy-MM-dd HH:mm:ss'}}, 
			{name : 'createOperator', display : '创建人', type : 'jrad-input', row : '4'}
       	];
		
		var pageColumnModel = [
			{name : 'id', display : 'ID', width : 50}, 
			{name : 'title', display : '标题'},
			{name : 'shortTitle', display : '短标题'},
			{name : 'typeName', display : '文章类型'}, 
			{name : 'createTime', display : '发布时间'}, 
			{name : 'displayTime', display : '显示开始时间'}, 
			{name : 'stateName', display : '状态'},
			{name : 'createOperator', display : '创建人'},
			{name : 'pageLinkUrl', display : '文章链接', diy: function(item, $div) {
				var pageLinkUrl = item.pageLinkUrl;
				$div.append("<a class='messageLink clipboard' title='" + pageLinkUrl + "'>点击复制链接</a>");
				$div.mouseover(function(){
					if(!this.zclip) {
						this.zclip = true;
						$('a', this).zclip({
							path: "./js/zclip/ZeroClipboard.swf",
							copy: pageLinkUrl
						});
					}
				});
			}}
		];
		
		submitForm.form({
			validators : submitValidators,
			fields_params : submitParams,
			layout : 'grid',
			autobinding : false
		});
		
		$(".ui-buttons-container .jrad-btn-normal", wrapper).button({
			click : function() {
				boxUp();
			}
		});

		$(".ui-buttons-container .jrad-btn-primary", wrapper).button({
			click : function() {
				
				if (!submitForm.form('validateAll')) {
					return;
				}

				var json = submitForm.form('getValue');
				if(!json.picFileDataId){
					$.jRadMessage({level:'error',message:"文章图片不能为空"});
					return;
				}
				json.createOperator = getOperator();

				console.log(json);

				delete json.picFile;
				
				$.jRadPost({
					
					url : title.html() == config.model.displayName + "添加" ? URL.add : URL.edit,
					data : json,
					success : function() {
						boxUp();
						table.flexMessage('创建成功','success');
						table.flexReload();
					},
					error : onSubmitError
				});
			}
		});

		var pageListButtons = [];

		pageListButtons.push({
			title : '创建',
			name : 'Add',
			bclass : 'add',
			onpress : function() {
				
				submitForm.form({
					item : {}
				});
				clearPic();
				boxDown();
				title.html(config.model.displayName + "添加");
			}
		});
	
		pageListButtons.push({
			title : '修改',
			name : 'Edit',
			bclass : 'edit',
			prefunc : function() {
				return table.getCheckedTrs().length == 1;
			},
			onpress : function() {
				var checked = table.getCheckedTrs();
				if (checked[0]) {
					var id = checked[0].id;
					fillEditForm(id);
				}
			}
		});

		pageListButtons.push({
			
			name : 'delete',
			bclass : 'delete',
			prefunc : function() {
				return table.getCheckedTrs().length != 0;
			},
			onpress : function() {
				var checked = table.getCheckedTrs();
				$.jRadConfirm('确认删除吗？', 1, function() {
					var idArr = [];
					$.each(checked, function() {
						idArr.push(this.id);
					});
					idArr.join(",");
					$.jRadAjax({
						type : 'post',
						url : URL.remove + "?idString="+ idArr,
						success : function() {
							table.flexMessage('删除成功!', 'success');
							table.flexReload();
						},
						error : onTableError
					});
				});
			}
		});

		pageListButtons.push({
			displayname : "设为无效",
			name : "unUse",
			bclass : "unUse",
			prefunc : function() {
				return table.getCheckedTrs().length != 0;
			},
			onpress : function() {
				var checked = table.getCheckedTrs();
				$.jRadConfirm("确认设置为无效吗？", 1, function() {
					var idArr = [];
					$.each(checked, function() {
						idArr.push(this.id);
					});
					idArr.join(",");
					$.jRadAjax({
						type : "post",
						url : URL.changeState + "?idString=" + idArr + "&state=0",
						success : function() {
							table.flexMessage("操作成功!", "success");
							table.flexReload();
						},
						error : onTableError
					});
				});
			}
		});

		pageListButtons.push({
			separator : true
		});
		
		table.flexigrid({
			reload : true,
			method : "get",
			colModel : pageColumnModel,
			buttons : pageListButtons,
			searchitems : pageSearchItems,
			pagination : {
				diaplay_pages : 5,
				align : "bottom"
			},
			showSearch : true,
			url : URL.page,
			onError : showError,
			overflow : true
		});

		$(".searchButtons .ui-btn-icon:first", wrapper).unbind("click");
		$(".searchButtons .ui-btn-icon:first", wrapper).click(function() {
			table.flexOptions({
				url : URL.page
			});
			table.flexReloadSearch();
		});
		$(".searchButtons .ui-btn-icon:nth-child(2)", wrapper).unbind("click");
		$(".searchButtons .ui-btn-icon:nth-child(2)", wrapper).click(function() {
			
			var sDiv = $(".searchContent", wrapper);
			$(".jrad-select", sDiv).select("val", "");
			$(".jrad-autocomplete", sDiv).autocomplete("val", "");
			$(".jrad-input", sDiv).input("val","");
			$(".jrad-dateinput", sDiv).dateinput("val", "");
			$(".jrad-autocombo", sDiv).autocombo("val", "");
			$(".jrad-checkbox", sDiv).checkbox("val", "");
			table.flexOptions({
				url : URL.page,
				queryParam : {},
				page : 0
			});
			table.flexReloadSearch();
		});

		$(".details-tab .return", wrapper).click(function() {
			boxUp();
		});
		
		function getUrl(method) {
			return config.url.base + config.url.cms + method;
		}
	
		function clearPic() {
			$("div[name='picFile']", wrapper).children(".pic-show").html("");
			
		}
		
		function fillEditForm(id) {
			
			var item = $.jRadGet({
				url : URL.detail + "?id=" + id
			});
			title.html(config.model.displayName + "修改");
			
			clearPic();
			boxDown();
			
			item.realPicUrl = item.picUrl;
			
			submitForm.form({
				item : item
			});
			createThumbnailPreview(wrapper, item);
			
		}
		
		function createThumbnailPreview(wrapper, item) {
			
			var picShow = $("div[name='picFile']", wrapper).children(".pic-show");
			var src = item.picUrl;
			if (src != undefined && src != "") {
				var view = '<li name="" class="adPicBoxli"><div class="large-pic"><div class="pic-box"><div class="pic-content"><div class="pic-vc">'
						+ '<img src="'+src+'">'
						+ '</div></div><span name="small" class="del-btn"></span></div></div></li>'
				picShow.html(view);
						
				$(".adPicBoxli .del-btn", wrapper).click(function() {
					
					$(this).parents(".adPicBoxli").remove();
					
					$("input[name='picFileDataId']", submitForm).val("");
					$("input[name='picUrl']", submitForm).val("");
				});
			}
		}

		function showError(xhr) {
			var msg = getErrorMessage(xhr);
			var cDiv = $(".cDiv", wrapper);
			$.jRadMessage({
				level : "error",
				message : msg,
				selector : cDiv
			});
		}
		
		function onSubmitError(xhr) {
			var msg = getErrorMessage(xhr);
			if (!!msg) {
				$.jRadMessage({
					level : "error",
					message : msg
				});
			}
		}
		
		function onTableError(xhr) {
			var msg = getErrorMessage(xhr);
			if (!!msg) {
				table.flexMessage(msg, "error");
			}
		}
		
		function getErrorMessage(xhr) {
			var msg = eval("(" + xhr.responseText + ")");
			return !!msg ? msg[0].message : null;
		}
		
		function getOperator() {
			var operator = carsmart_config.operatorName;
			return operator;
		}
		
		function boxUp() {
			$(".details-box", wrapper).slideUp();
			$(".jrad-table", wrapper).slideDown();
			$(".scroll-up-btn").click();
		}
		
		function boxDown() {
			$(".jrad-table", wrapper).slideUp();
			$(".details-box", wrapper).slideDown();
			$(".scroll-up-btn").click();
		}
        // $(".all-work-info").click(function(){
        //     var menuId = $("#tabs").attr("menuId")
        //     var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        //     $("#Form_explain_eg193").form({
        //         title:'页面说明',
        //         item:data,
        //         url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
        //         before_submit:function(json){ 
        //             json.operator = carsmart_config.operatorName;
        //             json.menuName = $("#tabs").attr("menuName");
        //             json.menuId = $("#tabs").attr("menuId");
        //             return json;
        //         }
        //     }).form('open')
        //     $("#Form_explain_eg193 .textarea-content").removeClass("span4").addClass("span12")
        //     $('.overcurtainDiv').hide();
        //     $('.overcurtainDiv').eq(0).show();
        // })
        $(".numb193").click(function(){
            $('.overcurtainDiv').hide();
            var menuId = $(".tabs-selected").attr("menuId")
            var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
            $("#Form_explain_eg193").form({}).form('close');
            $("#Form_explain_eg193").form({
                title:'页面说明',
                item:data,
                autobinding: true, 
				submit:function(){
                	var postData = {};
                    postData.operator = carsmart_config.operatorName;
                    postData.menuName = $(".tabs-selected").attr("menuName");
                    postData.menuId = $(".tabs-selected").attr("menuId");
                    postData.remark = $("#Form_explain_eg193 div[name='remark']").textarea("val")
					$.jRadPost({
					    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
					    data:postData,
					    success:function(){
							$("#Form_explain_eg193").form('close')
          					$('.overcurtainDiv').hide();
					   	}
					});
				}, 
				cancel:function(){
					$("#Form_explain_eg193").form('close')
          			$('.overcurtainDiv').hide();
				}
            }).form('open')
            $("#Form_explain_eg193 .textarea-content").removeClass("span4").addClass("span12")
            $('.overcurtainDiv').hide();
            $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
        })
		
	});

</script>
