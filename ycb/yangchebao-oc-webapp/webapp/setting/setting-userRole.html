<div class="urlContentWraper" id="Wraper_setting_UserRole">
    <div class="ui-info-layout">
        <h2 class="ui-tit"><strong>账号权限列表</strong><bottom class="all-work-info numb13">页面说明</bottom></h2>
        <!-- 列表显示 -->
        <table id="Table_setting_UserRole"></table>
    </div>
    <div id="Form_setting_UserRole" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                 <label class="span3 grid-layout-label">账号：</label>
                 <div class="span5 grid-layout-content">
                       <div name="userId" class="jrad-select-container"></div>
                                    </div>
            </div> 
			 <div class="row">
                <label class="span3 grid-layout-label">权限组：</label>
                <div class="span5 grid-layout-content">
                    <div name="roleId" class="jrad-select-container"></div>
                </div>
            </div> 
             <input type="hidden" name="id"/> 
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span>
			<span class="jrad-btn-normal">取消</span>
        </div>
    </div>
    
    <div id="Form_explain_eg13" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                <label class="span3 grid-layout-label">业务说明：</label>
                <div class="span12 grid-layout-content">
                    <div><strong>功能简介：</strong>给已经创建好的CMS账号分配权限。</div>
                    <div><strong>重要功能说明：</strong>无。</div>
                    <div><strong>注意事项：</strong>可给同一账号分配多个权限，最终权限为多个权限的并集。</div>
                </div> 
            </div> 
            <div class="row">
                <label class="span3 grid-layout-label">备注：</label>
                <div class="span12 grid-layout-content">
                    <div class="jrad-textarea-container" name="remark">
                    </div>
                </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
</div>
<script type="text/javascript">
$(document).ready(function(){
    var wraper = $('#Wraper_setting_UserRole');
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array();
	//var jRad = $.jRad('/radsample-ws','ent','Menu');	 
	var userId=$.jRadGet({'url':'/euc/ws/0.1/user/all?pagable=false'});
	var userData=[];
	$.each(userId,function(i){
		var userItem={};
		userItem.id=userId[i].id;
		userItem.name=userId[i].name;
		userData.push(userItem)
	});
	var roleId = $.jRadGet({'url':'/euc/ws/0.1/role/all?pagable=false'});
	var roleData=[];
	$.each(roleId,function(i){
		var roleItem={};
		roleItem.id=roleId[i].id;
		roleItem.name=roleId[i].name;
		roleData.push(roleItem)
	});
	var fields_params = {};
	fields_params['userId'] ={data:userData}; 
	fields_params['roleId'] ={data:roleData}; 
	 
	
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel}); 
    
	jRad.validators['userId'] = [{"msg":"请选择账号","type":"min","value":"1"}];
    jRad.validators['roleId'] = [{"msg":"请选择权限组","type":"min","value":"1"}];
	
	//{"userName":"admin","roleName":"系统管理员","userId":10000,"roleId":100,"id":123,"created":null,"deleted":null,"updated":null}
    page_column_model.push({display: '账号', name : 'userName',  sortable:true}); 
    page_column_model.push({display: '权限组名称', name : 'roleName',  sortable: true}); 
    
   page_search_items.push({row:'1',type:'jrad-input',display:'账号',name:'name'}); 
   
   page_list_buttons.push({title: '创建',name:'Add', bclass: 'add',onpress : function(){
            $('#Form_setting_UserRole').form({
                title: '创建',
                validators: jRad.validators,
				fields_params: fields_params,
                item:{},
                style:{height:'300px'}, 
				before_submit:function(data){ 
				  return data;
				},
                url:'/euc/ws/0.1/user/role/add', 
				success_callback:function(){ 
                            $('#Table_setting_UserRole').flexMessage('添加成功', 'success');
                            $('#Table_setting_UserRole').flexReload();
                        } 
            }).form('open');
        }
    }); 
	 page_list_buttons.push({title: '修改',name:'Edit', bclass: 'edit',prefunc:function(){
            var checked = $('#Table_setting_UserRole').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
            var checked = $('#Table_setting_UserRole').getCheckedTrs(); 
            if(checked[0]) {
                $('#Form_setting_UserRole').form({
					title: '修改',
					validators: jRad.validators,
					fields_params: fields_params,
					item:checked[0],
					style:{height:'300px'},
					before_submit:function(data){
					  delete data.userId;
					  return data;
					},
					url:'/euc/ws/0.1/user/role/update', 
					success_callback:function(){ 
								$('#Table_setting_UserRole').flexMessage('添加成功', 'success');
								$('#Table_setting_UserRole').flexReload();
							} 
				}).form('open');  
            }
        }
    }); 
	
	page_list_buttons.push({name:'Delete',bclass: 'delete',prefunc:function(){
            var checked = $('#Table_setting_UserRole').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
	    	var checked = $('#Table_setting_UserRole').getCheckedTrs();
			  if(checked[0]) { 
				$ .jRadConfirm('确认删除吗？',1,function(){
					var id =  checked[0].id; 
					$.jRadPost({
						url:'/euc/ws/0.1/user/role/delete?id='+id, 
						success: function(){
							$('#Table_setting_UserRole').flexMessage('删除成功。', 'success');
							$('#Table_setting_UserRole').flexReload();
						}
					});
				});
			}
		}
	}); 
    page_list_buttons.push({separator: true});
    
    $('#Table_setting_UserRole').flexigrid({
            reload:true,
			method:'get',
            colModel : page_column_model,
            buttons : page_list_buttons,
            searchitems :page_search_items,
            pagination: {
				diaplay_pages: 5,
				align: 'bottom' 
			},		
			showSearch:true, 
            url:'/euc/ws/0.1/user/role/all',
		    queryUrl:'/euc/ws/0.1/user/role/query',
			onError:showUserRoleError,
			checkBoxType:'single'
    });
	$(".userLink",wraper).live('click',function(){
		var item = $(this).data("item");
		updateUserView(item);
	}); 
    
    $(".numb13").click(function(){
        $('.overcurtainDiv').hide();
        var menuId = $(".tabs-selected").attr("menuId")
        var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        $("#Form_explain_eg13").form({}).form('close');
        $("#Form_explain_eg13").form({
            title:'页面说明',
            item:data,
            autobinding: true, 
            submit:function(){
                var postData = {};
                postData.operator = carsmart_config.operatorName;
                postData.menuName = $(".tabs-selected").attr("menuName");
                postData.menuId = $(".tabs-selected").attr("menuId");
                postData.remark = $("#Form_explain_eg13 div[name='remark']").textarea("val")
                $.jRadPost({
                    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
                    data:postData,
                    success:function(){
                        $("#Form_explain_eg13").form('close')
                        $('.overcurtainDiv').hide();
                    }
                });
            }, 
            cancel:function(){
                $("#Form_explain_eg13").form('close')
                $('.overcurtainDiv').hide();
            }
        }).form('open')
        $("#Form_explain_eg13 .textarea-content").removeClass("span4").addClass("span12")
        $('.overcurtainDiv').hide();
        $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
    })
});
function showUserRoleError(xhr){
		 var errormsg = eval("(" + xhr.responseText + ")");
		  var cDiv = $("#Wraper_setting_UserRole .cDiv");
		  $.jRadMessage({level:'error',message:errormsg[0].message,selector:cDiv});
		} 
</script>
