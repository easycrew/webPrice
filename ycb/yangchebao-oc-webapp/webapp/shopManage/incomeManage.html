 <style>
    #Form_contract_info div{
        line-height: 24px;
    }
 </style>
 <div class="urlContentWraper" id="Wraper_income_manage">
    <div class="ui-info-layout">
        <h2 class="ui-tit"><strong>商家收益管理</strong><bottom class="all-work-info numb36">页面说明</bottom></h2>
        <!-- 列表显示 -->
        <div class="pic-grid">
			<table id="Table_income_manage"></table>
		</div>
    </div>
    <div id="Form_income_manage" style="display:none;">
        <div class="grid-layout-main jrad-form">
	        <input type="hidden" name="businessContractId" />
            <div class="row">
                 <label class="span3 grid-layout-label"><span class="ui-form-required">*</span>每万份收益：</label>
                 <div class="span6 grid-layout-content">
                       <div name="profit" class="jrad-input-container"></div>
						</div> 
            </div> 
        </div>
        <div class="jrad-buttons-container ui-buttons-container">
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
    <div id="Form_income_manage_Batch" style="display:none;">
        <div class="grid-layout-main jrad-form">
            <input type="hidden" name="operator">
            <div class="row">
                 <label class="span1 grid-layout-label"></label>
                 <div class="span6 grid-layout-content">
                       <div name="setType" class="jrad-radio-container"></div>
                 </div> 
            </div> 
            <div class="row uploadtxt" style="display:none">
                 <label class="span3 grid-layout-label">上传TXT：</label>
                 <div class="span6 grid-layout-content">
                       <div name="profitFile" class="jrad-upload-container"></div>
                        </div> 
            </div> 
            <div class="row">
                 <label class="span3 grid-layout-label">每万份收益：</label>
                 <div class="span6 grid-layout-content">
                       <div name="profit" class="jrad-input-container"></div>
                        </div> 
            </div> 
        </div>
        <div class="jrad-buttons-container ui-buttons-container">
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
    <div id="Form_contract_info" style="display:none;">
      <div class="grid-layout-main jrad-form">
        <table id="Table_accountdetail">
            <tr>
                <th style="width:100px;">每万份收益变动</th>
                <th>时间</th>
                <th>操作人</th>
            </tr>
        </table>
      </div>
    </div>
    <div id="Form_explain_eg36" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                <label class="span3 grid-layout-label">业务说明：</label>
                <div class="span12 grid-layout-content">
                    <div><strong>功能简介：</strong>商家理财账户里面的余额，会每天按照设置的“年化收益率”生成利息。</div>
                    <div><strong>重要功能说明：</strong>1、收益设置/收益批量设置：可以在这里单个设置商家的年化收益率，也可以批量上传，批量修改商家的年化收益率。</div>
                    <div><strong>注意事项：</strong>新添加的商家，默认收益率与“养车宝北京用户服务示范店”相同。</div>
                </div> 
            </div> 
            <div class="row">
                <label class="span3 grid-layout-label">备注：</label>
                <div class="span12 grid-layout-content">
                    <div class="jrad-textarea-container" name="remark">
                    </div>
                </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
</div>
<script type="text/javascript">
$(document).ready(function(){
    var wraper = $('#Wraper_income_manage');
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array();
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel}); 

    var fields_params = {}; 
    fields_params['setType'] ={
        data:[{"id":"1",name:"全部"},{"id":"2",name:"上传TXT"}],
        onclick:function(){
            var all = $('#Form_income_manage_Batch div[name="setType"]').radio('val')
            if(all == 2){
                $('.uploadtxt').show();
            }else if(all == 1){
                $('.uploadtxt').hide();
            }
        }
    };

    fields_params['profitFile'] = {
        url:'/shopmanage-ws/ws/0.1/busiProfitRate/batchSetProfit',
        autocomplete:false,
        success: function(data) {   
            if (data != undefined&&data[0]!=undefined&&data[0].message!="") {
                $.jRadAlert(data[0].message,"error");  
            }else{
                $('#Form_income_manage_Batch',wraper).form('close');
                $('#Table_income_manage').flexReloadCurrentPage();        
                if(data.status=="400"){
                    $.jRadAlert(data.msg, 'warning',"",-1); 
                }else{
                    $('#Table_income_manage',wraper).flexMessage(data.msg, 'success'); 
                }
            } 
        },
        error:function(xhr){
            var errormsg = eval("(" + xhr.responseText + ")");
            $.jRadMessage({level:'error',message:errormsg[0].message,selector:$('#Form_income_manage_Batch .pop-up-middle',wraper)})
        }
    };  

    $('#Form_income_manage_Batch',wraper).form({
        title: '收益批量设置',
        validators: jRad.validators,
        fields_params: fields_params,  
        submit: addShortMessage 
    });
    function addShortMessage(){
           var _form = $("#Form_income_manage_Batch");
           var json = _form.form('getValue'); 
           var flag = _form.form('validateAll');
           if(!flag) {
             return;
           }  
           delete json.profitFile;
           $('div[name=profitFile]',wraper).upload({
            params: json,
           }).upload('upload'); 
    } 

    page_column_model.push({display: '商家ID', name : 'businessId'});
    page_column_model.push({display: '商家简称', name : 'businessRegName'});
    page_column_model.push({display: '每万份收益(元)', name : 'perMillionProfit'}); 
    page_column_model.push({display: '年化收益率', name : 'profitRate'});
    page_column_model.push({display: '昨日收益(元)', name : 'yesterdayProfit'});
	page_column_model.push({display: '累计收益(元)', name : 'totalProfit'});
	page_column_model.push({display: '操作日志', diy:function(item,$div){
		var a=$('<a>').attr('href','javascript:').html('详情');
		$div.append(a);
        $div.find('a').unbind('click').bind('click',function(){
            $.jRadGet({
                url:'/shopmanage-ws/ws/0.1/busiProfitRate/changeTrailList?businessId='+item.businessId,
                success:function(data){
                    $("#Form_contract_info").form({
                        title:"操作日志",
                        success_callback:function(){
                            $('#Table_account_manage').flexReload();
                        }
                    }).form('open');
                    
                    var tr_len=$("#Table_accountdetail",wraper).find("tr").length;
                    for(cur=0;cur<tr_len;cur++){
                      if(cur!==0){
                        $("#Table_accountdetail",wraper).find("tr").eq(cur).hide();
                      }
                    };
                    var str="";
                    $.each(data,function(i){
                        var _item=data[i];
                        str+="<tr>"
                            +"<td>"+_item.profitChange+"</td>"
                            +"<td>"+_item.changeDate+"</td>"
                            +"<td>"+_item.operator+"</td>"
                            +"</tr>";
                    });
                    $("#Table_accountdetail",wraper).append(str);
                },
                error:function(xhr){
                    var errormsg = eval("(" + xhr.responseText + ")"); 
                    if (errormsg != undefined) {
                        $('#Table_account_manage').flexMessage(errormsg[0].message, 'error');
                    } 
                }
            })
        });
	}});
    page_search_items.push({row:'1',type:'jrad-input',display:'商家ID',name:'businessId'});
    page_search_items.push({row:'1',type:'jrad-input',display:'商家简称',name:'businessRegName'}); 

    page_list_buttons.push({displayname: '收益设置',name:'contractInstall', bclass: 'contractInstall',prefunc:function(){
            var checked = $('#Table_income_manage',wraper).getCheckedTrs();
            if (checked.length == 0) {return false;}else{return true;}
        },onpress : function(){ 
		    $('#Form_income_manage').form({
                title: '收益设置',
                grid:10,
                url:'/shopmanage-ws/ws/0.1/busiProfitRate/updateProfit',
                before_submit:function(json){
                    var checked=$('#Table_income_manage',wraper).getCheckedTrs();
                    var postData = []; 
                    $.each(checked,function(i){
                        var postJson={};
                        postJson.businessId=this.businessId;
                        postJson.operator=carsmart_config.operatorName;
                        postJson.oldProfitRate=checked[0].profitRate; //年化收益率 旧
                        postJson.oldProfit=checked[0].perMillionProfit;  // 每万份收益 旧
                        postJson.profit=$('#Form_income_manage div[name="profit"]').input('val'); // 每万份收益 新
                        //postJson.profit=this.profit; // 每万份收益 新
                        postData.push(postJson)
                    });
                    return postData
                },
                success_callback:function(){ 
                    $('#Table_income_manage').flexMessage('设置成功', 'success');
                    $('#Table_income_manage').flexReload();
                }
		    }).form('open');
        }
    }); 

    page_list_buttons.push({displayname: '收益批量设置',name:'contractInstall', bclass: 'contractInstall',
        onpress : function(){ 
            var checked=$('#Table_income_manage',wraper).getCheckedTrs();
            $('#Form_income_manage_Batch').form({
                title: '收益批量设置',
                fields_params:fields_params,
                item:{'setType':1,'operator':carsmart_config.operatorName}
            }).form('open');
            var all = $('#Form_income_manage_Batch div[name="setType"]').radio('val')
            if(all == 2){
                $('.uploadtxt').show();
            }else if(all == 1){
                $('.uploadtxt').hide();
            }
        }
    });

    page_list_buttons.push({separator: true});

	$('#Table_income_manage').flexigrid({
			reload:true,
			method:'get', 
			colModel : page_column_model,
			buttons : page_list_buttons,
			searchitems :page_search_items,
			showSearch:true,
			pagination: {
				diaplay_pages: 5,
				align: 'bottom' 
			},
			url:'/shopmanage-ws/ws/0.1/busiProfitRate/list',
			onError:showError
			//checkBoxType:'single'
	});  
    $(".numb36").click(function(){
        $('.overcurtainDiv').hide();
        var menuId = $(".tabs-selected").attr("menuId")
        var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        $("#Form_explain_eg36").form({}).form('close');
        $("#Form_explain_eg36").form({
            title:'页面说明',
            item:data,
            autobinding: true, 
            submit:function(){
                var postData = {};
                postData.operator = carsmart_config.operatorName;
                postData.menuName = $(".tabs-selected").attr("menuName");
                postData.menuId = $(".tabs-selected").attr("menuId");
                postData.remark = $("#Form_explain_eg36 div[name='remark']").textarea("val")
                $.jRadPost({
                    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
                    data:postData,
                    success:function(){
                        $("#Form_explain_eg36").form('close')
                        $('.overcurtainDiv').hide();
                    }
                });
            }, 
            cancel:function(){
                $("#Form_explain_eg36").form('close')
                $('.overcurtainDiv').hide();
            }
        }).form('open')
        $("#Form_explain_eg36 .textarea-content").removeClass("span4").addClass("span12")
        $('.overcurtainDiv').hide();
        $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
    })
});
function showError(xhr){
    var errormsg = eval("(" + xhr.responseText + ")");
    var cDiv = $("#Wraper_income_manage .cDiv");
    $.jRadMessage({level:'error',message:errormsg[0].message,selector:cDiv});
}
</script>
