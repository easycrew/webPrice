<div class="urlContentWraper" id="Wraper_cash_review"> 
	<div class="row-fluid ui-data-show"> 
			<div class="hDiv">
				 <h2 class="ui-tit"><strong>商家提现审核</strong><bottom class="all-work-info numb35">页面说明</bottom></h2> 
				 <table id="Table_cash_review"></table>
			</div> 
			<div class="bDiv">
				<br/>
				 <h2 class="ui-tit"><strong>订单详情</strong></h2> 
				<table id="Table_order_info"></table>
			</div> 
    </div> 
    <div id="Form_back" style="display:none;">
		<div class="grid-layout-main jrad-form"> 
			<input type="hidden" name="carInfoId"/>
			<div class="row">
				<label class="span2 grid-layout-label"><span class="ui-form-required">*</span>
				 驳回原因：</label>
				 <div class="span5 grid-layout-content">
					   <div name="reasonOfReject" class="jrad-textarea-container"></div>
				 </div>
			</div>
		</div>
		<div class="jrad-buttons-container ui-buttons-container">
			<span class="jrad-btn-primary">确定</span> 
			<span class="jrad-btn-normal">取消</span>
		</div>
	</div>
	<div id="Form_set_cash" style="display:none;">
        <div class="grid-layout-main jrad-form">  
			<div class="row"> 
				<label class="span4 grid-layout-label"><span class="ui-form-required">*</span> 
					最小提现金额：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div name="minTackCash" class="jrad-input-container">
					</div> 
				</div>元
			</div>
			<div class="row"> 
				<label class="span4 grid-layout-label"><span class="ui-form-required">*</span> 
					最大提现金额：
				</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div name="maxTackCash" class="jrad-input-container">
					</div> 
				</div>元
			</div>
			<div class="row">
				<label class="span4 grid-layout-label"><span class="ui-form-required">*</span>提现次数：</label>
				<div class="span10 grid-layout-content" id="maxFrequency">
                  <input type="text" name="taskTimesDay" class="days">天<input type="text" name="taskTimesNum" class="times">次
                </div>
			</div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span>
			<span class="jrad-btn-normal">取消</span>
        </div>
    </div>

	<div id="Form_is_carry" style="display:none;">
        <div class="grid-layout-main jrad-form">  
			<div class="row"> 
				<label class="span4 grid-layout-label"> 
					修改转账状态：
				</label>
				<div class="span4 grid-layout-content fluid-wrap">
					<div name="isTransfered" class="jrad-select-container">
					</div> 
				</div>
			</div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span>
			<span class="jrad-btn-normal">取消</span>
        </div>
    </div>    
    <div id="Form_explain_eg35" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                <label class="span3 grid-layout-label">业务说明：</label>
                <div class="span12 grid-layout-content">
                    <div><strong>功能简介：</strong>商家申请提现后，需要在这里审核一下，审核成功后，才会给商家账户添加对应余额。</div>
                    <div><strong>重要功能说明：</strong>1、提现设置：可再此设置商家提现的频率，以及提现金额的上下限；2、修改转账状态：线下转账后，需要在这里给对应的申请设置为已转账的状态。</div>
                    <div><strong>注意事项：</strong>无。</div>
                </div> 
            </div> 
            <div class="row">
                <label class="span3 grid-layout-label">备注：</label>
                <div class="span12 grid-layout-content">
                    <div class="jrad-textarea-container" name="remark">
                    </div>
                </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
</div>
<script type="text/javascript">
$(document).ready(function(){
	var ExchangeCodeId = "";
    var wraper = $('#Wraper_cash_review');
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array(); 
	
	var page_column_model_c = new Array(); 
	var page_list_buttons_c = new Array();
	
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel}); 
    jRad.validators['zeroService'] = [{"msg":"绑定服务不能为空","type":"min","value":"1"}]; 

	jRad.validators['remarks'] = [{"msg":"内容超长","type":"max","value":"2000"}];  
	jRad.params['auditStatus'] = {data:[{id:'',name:'全部'},{id:'0',name:'审核中'},{id:'1',name:'审核通过'},{id:'2',name:'审核驳回'}]}
	var checkParam = {};

	jRad.params['isTransfered'] = {data:[{id:'',name:'全部'},{id:'1',name:'是'},{id:'0',name:'否'},{id:'2',name:'退回'}]}
	checkParam['reasonOfReject'] = {grid:14};

	var fields_params = {}; 
	fields_params['isTransfered'] = {data:[{id:'1',name:'是'},{id:'0',name:'否'},{id:'2',name:'退回'}]}

	page_column_model.push({display: '申请提现时间', name : 'applyData'}); 
    page_column_model.push({display: '商家ID', name : 'businessId'}); 
    page_column_model.push({display: '商家简称', name : 'businessRegName'}); 
    page_column_model.push({display: '用户支付金额', name : 'userPayment'}); 
    page_column_model.push({display: '车主卡支付金额', name : 'cardPayment'}); 
    page_column_model.push({display: '补贴金额', name : 'subsidy'}); 
    page_column_model.push({display: '提现金额(元)', name : 'cashWithdrawal'}); 
    page_column_model.push({display: '扣2%后金额(元)', name : 'cashWithdrawalReal'}); 
    page_column_model.push({display: '审核状态', name : 'auditStatus',width:150,diy:function(item,$div){
	    $div.html(item.auditStatus);
	    if(item.auditStatus=='审核驳回'){
	    	$div.html('审核驳回&nbsp;&nbsp;&nbsp;&nbsp;')
		 var $a = $("<a>").html("驳回原因");
		 $div.append($a);
		 $a.click(function(){
			$.jRadAlert(item.remark,"info");
		 });
		 var checkDiv = $("<div>").addClass("checkInfo");
	    }
	    else if(item.auditStatus=='1'){$div.html('审核通过')}
	    else if(item.auditStatus=='0'){$div.html('审核中')}
	}});
    page_column_model.push({display: '审核时间', name : 'auditDate'}); 
    page_column_model.push({display: '转账状态', name : 'isTransfered'}); 
    page_column_model.push({display: '转账时间', name : 'transferDate'}); 
    page_column_model.push({display: '审核人', name : 'auditOperator'});
   
   page_search_items.push({row:'1',type:'jrad-input',display:'商家ID',name:'businessId'});
   page_search_items.push({row:'1',type:'jrad-input',display:'商家简称',name:'businessRegName'});
   page_search_items.push({row:'1',type:'jrad-select',display:'审核状态',name:'auditStatus',params:jRad.params['auditStatus']});
   page_search_items.push({row:'2',type:'jrad-dateinput',display:'申请提现时间始',name:'applyStartDate'}); 
   page_search_items.push({row:'2',type:'jrad-dateinput',display:'申请提现时间终',name:'applyEndDate'}); 
   page_search_items.push({row:'2',type:'jrad-select',display:'转账状态',name:'isTransfered',params:jRad.params['isTransfered']});  
   page_search_items.push({row:'3',type:'jrad-dateinput',display:'最后审核时间始',name:'auditStartDate'}); 
   page_search_items.push({row:'3',type:'jrad-dateinput',display:'最后审核时间终',name:'auditEndDate'}); 
 	
 	page_list_buttons.push({displayname: '提现审核通过',name:'pass',bclass: 'pass',
 		prefunc:function(){
            var checked = $('#Table_cash_review').getCheckedTrs();
            if (checked.length == 0 || checked[0].auditStatus !== '审核中') {return false;}else{return true;}
        },
        onpress : function(){
	    	var checked = $('#Table_cash_review').getCheckedTrs();
			var ids = [];
			$.each(checked,function(){
				ids.push(this.carInfoId);
			});
			//console.log(ids)
			$.jRadConfirm('确认审核通过吗？',1,function(){
				 var postData = []; 
				 $.each(checked,function(i){
				 	var postJson={};
				 	postJson.busiTackCashAuditId=this.busiTackCashAuditId;
				 	postJson.auditOperator=carsmart_config.operatorName;
				 	postJson.businessId=this.businessId;
				 	postJson.auditReasult=1;
				 	postData.push(postJson)
				 });
				 
				$.jRadAjax({
				    type:'post',
					data:postData,
					url:'/shopmanage-ws/ws/0.1/businessTackCash/auditTackCash', 
					success: function(){
						$('#Table_cash_review').flexMessage('审核通过成功!', 'success');
           	    		$('#Table_cash_review').flexReloadSearch();
					},
					error:function(xhr){
					    var errormsg = eval("(" + xhr.responseText + ")"); 
						if (errormsg != undefined) {
							$('#Table_cash_review').flexMessage(errormsg[0].message, 'error');
						}
					}
				});
			});
		}
	});

	page_list_buttons.push({displayname: '提现审核驳回',name:'reject',bclass: 'reject',
		prefunc:function(){
            var checked = $('#Table_cash_review').getCheckedTrs();
            if (checked.length == 0 || checked[0].auditStatus !== '审核中') {return false;}else{return true;}
        },
        onpress : function(){
			$('#Form_back').form({
				title: '驳回原因',
				validators: jRad.validators,
				fields_params:checkParam,
				item:{},
				type:'post',
				url:'/shopmanage-ws/ws/0.1/businessTackCash/auditTackCash', 
				before_submit:function(json){
					var checked = $('#Table_cash_review').getCheckedTrs(); 
			    	var postData = []; 
					$.each(checked,function(i){
					 	var postJson={};
						 	postJson.busiTackCashAuditId=this.busiTackCashAuditId;
						 	postJson.auditOperator=carsmart_config.operatorName;
				 			postJson.businessId=this.businessId;
						 	postJson.reasonOfReject=json.reasonOfReject;
						 	postJson.auditReasult=2;
					 	postData.push(postJson)
					 });
					return postData
				},
				success_callback: function(){
					$("#Form_back").form('close');
					$('#Table_cash_review').flexMessage('已驳回!', 'success');
					$('#Table_cash_review').flexReloadSearch();
				},
				error:function(xhr){
					var errormsg = eval("(" + xhr.responseText + ")"); 
					if (errormsg != undefined) {
						$('#Table_cash_review').flexMessage(errormsg[0].message, 'error');
					}
				},
				autobinding:true
			}).form('open'); 
		}
	});  
	page_list_buttons.push({displayname: '提现设置',name:'cashInstall', bclass: 'cashInstall',onpress : function(){
			var _item=$.jRadGet({url:'/shopmanage-ws/ws/0.1/businessTackCash/getRule'});
			$('#Form_set_cash',wraper).form({
				title:'主动提现设置',
				url:'/shopmanage-ws/ws/0.1/businessTackCash/setRule',
				//item:_item,
				item:{'minTackCash':_item.minTackCash,'maxTackCash':_item.maxTackCash,'taskTimesDay':_item.taskTimesDay,'taskTimesNum':_item.taskTimesNum},
				type:'post',
				before_submit:function(json){
					var day = $('#Form_set_cash input[name="taskTimesDay"]').val();
					var num = $('#Form_set_cash input[name="taskTimesNum"]').val();
					json.taskTimesDay = day
					json.taskTimesNum = num
					return json
				},
				success_callback:function(){
					$('#Table_cash_review').flexMessage('设置成功', 'success')
					$('#Table_cash_review').flexReloadSearch();
				}
			}).form('open');
			$('.days').val(_item.taskTimesDay)
			$('.times').val(_item.taskTimesNum)
	}}); 
	page_list_buttons.push({displayname: '修改转账状态',name:'cashInstall', bclass: 'cashInstall',prefunc:function(){
            var checked = $('#Table_cash_review').getCheckedTrs();
            if (checked.length == 0 || checked[0].isTransfered == "退回"){return false;}else{return true;}
        },onpress:function(){
		    	$('#Form_is_carry').form({
		    		title:'修改转账状态',
		    		item:{},
		    		fields_params:fields_params,
	               	url:'/shopmanage-ws/ws/0.1/businessTackCash/setIsTransfer',
					before_submit:function(json){ 
						var checked = $('#Table_cash_review').getCheckedTrs(); 
				    	var postData = []; 
						$.each(checked,function(i){
						 	var postJson={};
							 	postJson.busiTackCashAuditId=this.busiTackCashAuditId;
							 	postJson.isTransfered=json.isTransfered;
						 	postData.push(postJson)
						 });
						return postData
					},				
					success_callback:function(){ 
                        $('#Table_cash_review').flexMessage('修改成功', 'success');
                        $('#Table_cash_review').flexReloadCurrentPage()
	                } 
	            }).form('open'); 
	        }
	}); 
	function excelplus(){
		var param = {};
			 var businessId = $.trim($(".searchContent div[name='businessId']",wraper).input('val'));
			 if(businessId!=""){
				param['businessId'] = businessId;
			 };
			 var businessRegName = $.trim($(".searchContent div[name='businessRegName']",wraper).input('val'));
			 if(businessRegName!=""){
				param['businessRegName'] = businessRegName;
			 };
			 var auditStatus = $.trim($(".searchContent div[name='auditStatus']",wraper).select('val'));
			 if(auditStatus!=""){
				param['auditStatus'] = auditStatus;
			 };
			 var applyStartDate = $.trim($(".searchContent div[name='applyStartDate']",wraper).dateinput('val'));
			 if(applyStartDate!=""){
				param['applyStartDate'] = applyStartDate;
			 };
			 var applyEndDate = $.trim($(".searchContent div[name='applyEndDate']",wraper).dateinput('val'));
			 if(applyEndDate!=""){
				param['applyEndDate'] = applyEndDate;
			 };
			 var isTransfered = $.trim($(".searchContent div[name='isTransfered']",wraper).select('val'));
			 if(isTransfered!=""){
				param['isTransfered'] = isTransfered;
			 };
			 var auditStartDate = $.trim($(".searchContent div[name='auditStartDate']",wraper).dateinput('val'));
			 if(auditStartDate!=""){
				param['auditStartDate'] = auditStartDate;
			 };
			 var auditEndDate = $.trim($(".searchContent div[name='auditEndDate']",wraper).dateinput('val'));
			 if(auditEndDate!=""){
				param['auditEndDate'] = auditEndDate;
			 };
			 var paramUrl = "";
			 if(param!={}){
				 paramUrl+="?"
				 $.each(param,function(k,v){paramUrl+="&"+k+"="+v;});
			 }
			 param['paramUrl'] = paramUrl;
			 return param;
	}
	page_list_buttons.push({displayname: '导出Excel',name:'excel', bclass: 'excel',onpress : function(){
			$.jRadConfirm('确认导出吗？',1,function(){
			 var paramUrl = excelplus().paramUrl;
			 window.open('/shopmanage-ws/ws/0.1/businessTackCash/exportTakeAuditList'+paramUrl);
			})
		}
	});
    page_list_buttons.push({separator: true});
    
    $('#Table_cash_review').flexigrid({
            reload:true,
			method:'get',
            colModel : page_column_model,
            buttons : page_list_buttons,
            searchitems :page_search_items,
            pagination: {
				diaplay_pages: 5,
				align: 'bottom' 
			},
			showSearch:true, 
			checkBoxType:'single',
			overflow:true,
            url:'/shopmanage-ws/ws/0.1/businessTackCash/getTackCashList', 
			onError:showError,
			trEvent:function(){		
				var checked = $('#Table_cash_review').getCheckedTrs();
				if (checked.length >2 ){
					return false;
				}else{
					$('#Table_order_info').flexOptions({ 
						url: '/shopmanage-ws/ws/0.1/businessTackCash/getTaskCashOrderList',
						extParam:{
							businessId : checked[0].businessId,
							applyDate : checked[0].applyData
						}
					}).flexReload();
				}
			}
    }); 
    var total=$.jRadGet({url:'/shopmanage-ws/ws/0.1/businessTackCash/getTackCashList'});
	$.each(total,function(i,val){
		var obj = total.items;
		if(obj !=''&&obj !='undefined'){
			$.each(obj,function(i,k){
				// $('.hDivBox:eq(0) th:eq(4)',wraper).html('&nbsp;&nbsp;用户支付金额(元)<br>（合计'+k.userPayment+'元）');
				// $('.hDivBox:eq(0) th:eq(5)',wraper).html('&nbsp;&nbsp;车主卡支付金额(元)<br>（合计'+k.cardPayment+'元）');
				// $('.hDivBox:eq(0) th:eq(6)',wraper).html('&nbsp;&nbsp;补贴金额(元)<br>（合计'+k.subsidy+'元）');
				$('.hDivBox:eq(0) th:eq(7)',wraper).html('&nbsp;&nbsp;提现金额(元)<br>（合计'+k.totalCash+'元）');
				$('.hDivBox:eq(0) th:eq(8)',wraper).html('&nbsp;&nbsp;扣2%后金额(元)<br>（合计'+k.totalCashReal+'元）');
			})
		}else{
			// $('.hDivBox:eq(0) th:eq(4)',wraper).html('提现金额(元)');
			// $('.hDivBox:eq(0) th:eq(5)',wraper).html('提现金额(元)');
			// $('.hDivBox:eq(0) th:eq(6)',wraper).html('提现金额(元)');
			$('.hDivBox:eq(0) th:eq(7)',wraper).html('提现金额(元)');
			$('.hDivBox:eq(0) th:eq(8)',wraper).html('扣2%后金额(元)');
		}
	})
	$('.ui-btn-icon:first',wraper).click(function(){
			var param = excelplus();
		    var total2=$.jRadGet({url:'/shopmanage-ws/ws/0.1/businessTackCash/getTackCashList'+param.paramUrl});
			$.each(total2,function(i,val){
				var obj2 = total2.items;
				if(obj2 !=''&&obj2 !='undefined'){
					$.each(obj2,function(i,H){
						// $('.hDivBox:eq(0) th:eq(4)',wraper).html('&nbsp;&nbsp;用户支付金额(元)<br>（合计'+H.userPayment+'元）');
						// $('.hDivBox:eq(0) th:eq(5)',wraper).html('&nbsp;&nbsp;车主卡支付金额(元)<br>（合计'+H.cardPayment+'元）');
						// $('.hDivBox:eq(0) th:eq(6)',wraper).html('&nbsp;&nbsp;补贴金额(元)<br>（合计'+H.subsidy+'元）');
						$('.hDivBox:eq(0) th:eq(7)',wraper).html('&nbsp;&nbsp;提现金额(元)<br>（合计'+H.totalCash+'元）');
						$('.hDivBox:eq(0) th:eq(8)',wraper).html('&nbsp;&nbsp;扣2%后金额(元)<br>（合计'+H.totalCashReal+'元）');
					})
				}else{
						// $('.hDivBox:eq(0) th:eq(4)',wraper).html('用户支付金额');
						// $('.hDivBox:eq(0) th:eq(5)',wraper).html('车主卡支付金额');
						// $('.hDivBox:eq(0) th:eq(6)',wraper).html('补贴金额');
						$('.hDivBox:eq(0) th:eq(7)',wraper).html('提现金额');
						$('.hDivBox:eq(0) th:eq(8)',wraper).html('扣2%后金额(元)');
				}
			}) 
	}); 
	page_column_model_c.push({display: '订单编号', name : 'orderNumber'});	
	page_column_model_c.push({display: '订单生成时间', name : 'orderDate'});	
	page_column_model_c.push({display: '交易完成日期', name : 'serviceDate'});
	page_column_model_c.push({display: '订单金额', name : 'orderTotalAmount'});
	page_column_model_c.push({display: '通用代金券金额', name : 'generalAmount'});
	page_column_model_c.push({display: '补贴金额', name : 'subsidyMoney'});
	page_column_model_c.push({display: '余额支付金额', name : 'balancePayAmount'});
	page_column_model_c.push({display: '用户支付金额', name : 'userPayAmount'});  

 	page_list_buttons_c.push({displayname: '导出EXCEL',name:'excel', bclass: 'excel',onpress : function(){ 
		 $ .jRadConfirm('确认导出吗？',1,function(){
			 	var checked = $('#Table_cash_review').getCheckedTrs();
			 	if(checked[0]){
				 	var businessId = checked[0].businessId;
				 	var applyDate = checked[0].applyData;
					window.open('/shopmanage-ws/ws/0.1/businessTackCash/exportOrderList?businessId='+businessId+'&applyDate='+applyDate);
				}else{
					alert('请勾选一家商家提现')
				}
			}); 
        }
    });
	$('#Table_order_info').flexigrid({  
			colModel : page_column_model_c,
			buttons : page_list_buttons_c, 
			pagination: {
				diaplay_pages: 5,
				align: 'bottom'
			},
			checkBoxType:'single',
			method:'get',
			overflow:true,
			pagedStyle: 'oc'	
	});  
	$(".numb35").click(function(){
        $('.overcurtainDiv').hide();
        var menuId = $(".tabs-selected").attr("menuId")
        var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        $("#Form_explain_eg35").form({}).form('close');
        $("#Form_explain_eg35").form({
            title:'页面说明',
            item:data,
            autobinding: true, 
			submit:function(){
            	var postData = {};
                postData.operator = carsmart_config.operatorName;
                postData.menuName = $(".tabs-selected").attr("menuName");
                postData.menuId = $(".tabs-selected").attr("menuId");
                postData.remark = $("#Form_explain_eg35 div[name='remark']").textarea("val")
				$.jRadPost({
				    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
				    data:postData,
				    success:function(){
						$("#Form_explain_eg35").form('close')
      					$('.overcurtainDiv').hide();
				   	}
				});
			}, 
			cancel:function(){
				$("#Form_explain_eg35").form('close')
      			$('.overcurtainDiv').hide();
			}
        }).form('open')
        $("#Form_explain_eg35 .textarea-content").removeClass("span4").addClass("span12")
        $('.overcurtainDiv').hide();
        $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
    })    
	
});
function showError(xhr){
		 var errormsg = eval("(" + xhr.responseText + ")"); 
		  $.jRadMessage({level:'error',message:errormsg[0].message});
		} 
</script>
