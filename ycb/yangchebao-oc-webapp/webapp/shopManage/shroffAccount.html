<style type="text/css">
.bank .ui-autocomplete-btn{
	display:none;
}
div.urlContentWraper {
    min-width: 1600px;
    padding: 10px;
}
</style>
<div class="urlContentWraper" id="Wraper_shroff_account">
    <div class="ui-info-layout">
        <h2 class="ui-tit"><strong>收款账号管理列表</strong><bottom class="all-work-info numb37">页面说明</bottom></h2>
        <!-- 列表显示 -->
        <table id="Table_shroff_account"></table>
    </div>
    <div id="Form_shroff_account" style="display:none;">
        <div class="grid-layout-main jrad-form">  
		    <input name="shroffAccountId" type="hidden">  
			<div class="row"> 
				<label class="span4 grid-layout-label">
				   <span class="ui-form-required">*</span>
					商家ID：
				</label>
				<div class="span5 grid-layout-content">
					<div name="businessInfoId" class="jrad-input-container">
					</div>
				   <p class="ui-note"></p>
				   <p class="nameTips"></p>
				</div>
				<label class="span3 grid-layout-label">
				   <span class="ui-form-required">*</span>
					账号类型：
				</label>
				<div class="span5 grid-layout-content">
					<div name="type" class="jrad-select-container">
					</div>
				</div>
			</div>
			<div class="row">
				<label class="span4 grid-layout-label">
					<span class="ui-form-required">*</span>
					省：
				</label>
				<div class="span5 grid-layout-content">
					<div name="provinceId" class="jrad-select-container">
					</div>
				</div>
				<label class="span3 grid-layout-label">
					<span class="ui-form-required">*</span>
					市：
				</label>
				<div class="span5 grid-layout-content">
					<div name="areaCodeId" class="jrad-select-container">
					</div>
				</div> 
			</div>
			<div class="row"> 
				 <label class="span4 grid-layout-label">
					<span class="ui-form-required">*</span>
					银行：
				</label>
				<div class="span5 grid-layout-content bank">
					<div name="bankId" class="jrad-autocomplete-container">
					</div>
				</div> 
				<label class="span3 grid-layout-label">
					<span class="ui-form-required">*</span>
					开户分行：
				</label>
				<div class="span5 grid-layout-content">
					<div name="bankBranch" class="jrad-input-container">
					</div>
				</div>
			</div>
			<div class="row"> 
				<label class="span4 grid-layout-label">
				   <span class="ui-form-required">*</span>
					账号：
				</label>
				<div class="span5 grid-layout-content">
					<div name="bankAccount" class="jrad-input-container">
					</div>
				</div>
				<label class="span3 grid-layout-label period">
				   <span class="ui-form-required">*</span>
					结算周期：
				</label>
				<div class="span5 grid-layout-content">
					<div name="billingPeriod" class="jrad-select-container">
					</div>
				</div>
			</div>
			<div class="row"> 
				<label class="span4 grid-layout-label">
				   <span class="ui-form-required">*</span>
					重复账号：
				</label>
				<div class="span8 grid-layout-content">
					<div name="bankAccountAgain" class="jrad-input-container">
					</div>
				</div>
			</div>
			<div class="row"> 
				<label class="span4 grid-layout-label">
				   <span class="ui-form-required">*</span>
					户主姓名：
				</label>
				<div class="span8 grid-layout-content">
					<div name="accountHolder" class="jrad-input-container">
					</div>
				</div>
			</div> 
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span>
			<span class="jrad-btn-normal">取消</span>
        </div>
    </div>
    <div id="Form_account_detail" style="display:none;">
      <div class="grid-layout-main jrad-form">
        <table id="Table_accountdetail">
        	<tr>
        		<th style="width:100px;">ID</th>
        		<th>详细操作</th>
        		<th>操作时间</th>
        		<th>操作人</th>
        	</tr>
        </table>
      </div>
    </div>
    <div id="Form_explain_eg37" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                <label class="span3 grid-layout-label">业务说明：</label>
                <div class="span12 grid-layout-content">
                    <div><strong>功能简介：</strong>商家收款账号的管理的功能。</div>
                    <div><strong>重要功能说明：</strong>无。</div>
                    <div><strong>注意事项：</strong>1、商家收款账号的来源是，创建商家登陆账号时，自动生成；2、若需要增加银行没有，直接找后端开发添加即可（QQ群喊下就ok，2分钟的事）。</div>
                </div> 
            </div> 
            <div class="row">
                <label class="span3 grid-layout-label">备注：</label>
                <div class="span12 grid-layout-content">
                    <div class="jrad-textarea-container" name="remark">
                    </div>
                </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
</div>
<script type="text/javascript">
$(document).ready(function(){
    var wraper = $('#Wraper_shroff_account');
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array(); 
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel}); 
    
	jRad.validators['businessInfoId'] = [{"msg":"商家id不能为空","type":"min","value":"1"},{msg:"商家id只能是数字",type:'regex',value:/^\d+$/}];
	jRad.validators['billingPeriod'] = [{"msg":"结算周期不能为空","type":"min","value":"1"}];

	jRad.params['type']={
		data: [{id:'',name:'请选择'},{id:'1',name:'商家账号'},{id:'2',name:'业务员账号'}] 
	};
	jRad.params['billingPeriod']={
		data: [{"id":"",name:"请选择"},{"id":"1",name:"T+1"},{"id":"2",name:"T+1(≥1000元)"},{"id":"3",name:"T+3(无金额限制)"},{"id":"4",name:"半月结"},{"id":"5",name:"月结"}] 
	};
	//省市区select值
	jRad.params['provinceCodeSearch'] = {
			urlData:{
				url:'/euc/ws/0.1/user/provinces?userId='+carsmart_config.userId
			},
			unshiftData: {id:'',name:'请选择'},
			onchange: function(){
				var provinceCode = $('.searchContent div[name=provinceId]').select('val');
				if(provinceCode==''){
					$('.searchContent div[name=areaCodeId]').select({
																urlData:{url:''},
																data:[{id:'',name:'请选择'}],
																val: ''});
				}else{
				$('.searchContent div[name=areaCodeId]').select({
					urlData:{
						url: '/euc/ws/0.1/user/cities?provinceId='+provinceCode+'&userId='+carsmart_config.userId
					},
					unshiftData: {id:'',name:'请选择'},
					val:''
				});
				} 
				$('.searchContent div[name=countyId]').select({
																urlData:{url:''},
																data:[{id:'',name:'请选择'}],
																val: ''});
			}
		};
	jRad.params['cityIdSearch'] = {
		data: [{id:'',name:'请选择'}],
		onchange: function(){
			var cityId = $('.searchContent div[name=areaCodeId]').select('val');
			if(cityId==''){
				$('.searchContent div[name=countyId]').select({
																urlData:{url:''},
																data:[{id:'',name:'请选择'}],val: ''});
			}else{
				$('.searchContent div[name=countyId]').select({
					urlData:{
						url: '/shopmanage-ws/ws/0.1/userInfoCms/countries?areaCodeId=' + cityId
					},
					unshiftData: {id:'',name:'请选择'},
					val:''
				});
			}
		}
	};
	
	jRad.params['countyIdSearch'] = {
			data: [{id:'',name:'请选择'}]
		};
    var fields_params = {}; 
    fields_params['type'] ={data:[{"id":"",name:"请选择"},{"id":"1",name:"商家账号"},{"id":"2",name:"业务员账号"}]};
    fields_params['billingPeriod'] ={data:[{"id":"",name:"请选择"},{"id":"1",name:"T+1"},{"id":"2",name:"T+1(≥1000元)"},{"id":"3",name:"T+3(无金额限制)"},{"id":"4",name:"半月结"},{"id":"5",name:"月结"}]}; 
	fields_params['provinceId'] = {
		urlData:{
			url:'/shopmanage-ws/ws/0.1/userInfoCms/provinceAll' 
		},
		unshiftData: {id:'',name:'请选择'},
		onchange: function(){
			var provinceCode = $('#Form_shroff_account div[name=provinceId]').select('val');
			if(provinceCode==''){
				$('#Form_shroff_account div[name=areaCodeId]').select({
															urlData:{url:''},
															data:[{id:'',name:'请选择'}]});
			}else{
				$('#Form_shroff_account div[name=areaCodeId]').select({
				urlData:{
					url: '/shopmanage-ws/ws/0.1/userInfoCms/municipalities?provinceId=' + provinceCode 
				},
				unshiftData: {id:'',name:'请选择'}
				});
			}
			$('#Form_shroff_account div[name=areaCodeId]').select('val','');
		}
	};
	fields_params['areaCodeId'] = {
		data: [{id:'',name:'请选择'}]
	}; 
	fields_params['bankId'] = { 
		//url:'/shopmanage-ws/ws/0.1/bank/getBankList', 
		url:'/vip-ws/ws/0.1/bank/getBankList',
		queryParam:'name',
		fl: 'name',
        displayField:'name',
        valueField:'id',
        defaultValue: '',
		response: function(data){
			return data;
		}		
	};  

	 $('#Form_shroff_account').form({
        title: '账户管理',
        grid: 20,
      //  validators: jRad.validators,
        fields_params: fields_params 
    });
	page_column_model.push({display: '商家ID', name : 'businessInfoId'}); 
	page_column_model.push({display: '商家工商注册名称', name : 'businessName'});
    page_column_model.push({display: '商家简称', name : 'businessRegName'}); 
    page_column_model.push({display: '城市', name : 'cityName'}); 
    page_column_model.push({display: '账号类型', name : 'typeDesc'}); 
    page_column_model.push({display: '户主姓名', name : 'accountHolder'}); 
    page_column_model.push({display: '银行账号', name : 'bankAccount'}); 
    page_column_model.push({display: '开户行', name:'bankBranch',width:200,diy:function(item,$div){
    	$div.html(item.bankName+item.bankBranch);
    }});
    page_column_model.push({display: '结算周期', name : 'billingPeriodDesc'}); 
    page_column_model.push({display: '创建时间', name : 'createTime'}); 
    page_column_model.push({display: '操作日志', diy:function(item,$div){
    	var account_detail=$('<a>').css('href','javascript:').addClass('account_detail').html('详情');
    	$div.html(account_detail);
    	$div.find('a').unbind('click').bind('click',function(){
    		$.jRadGet({
    			url:'/shopmanage-ws/ws/0.1/shroffAccountCms/getOperateHistorylist?shroffAccountId='+item.shroffAccountId,
    			success:function(data){
    				$("#Form_account_detail").form({
    					title:"操作日志",
    					success_callback:function(){
    						$('#Table_account_manage').flexReload();
    					}
    				}).form('open');
    				var tr_len=$("#Table_accountdetail",wraper).find("tr").length;
    				for(cur=0;cur<tr_len;cur++){
    				  if(cur!==0){
    				    $("#Table_accountdetail",wraper).find("tr").eq(cur).hide();
    				  }
    				};
    				var str="";
    				$.each(data,function(i){
    					var _item=data[i];
    					str+="<tr>"
    					    +"<td>"+_item.shroffAccountOperHistoryId+"</td>"
    					    +"<td>"+_item.beforeOperCardUserName+'<br>'
    					           +_item.beforeOperCardProvice+_item.beforeOperCardAread+_item.beforeOperBankName+_item.beforeOperBankBranchName+'<br>'
    					           +_item.beforeOperCardNo+'<br>'
    					           +'<p style="position:relative;top:0;left:-14px;">-> '+_item.afterOperCardUserName+'</p>'
    					           +_item.afterOperCardProvice+_item.afterOperCardAread+_item.afterOperBankName+_item.afterOperBankBranchName+'<br>'
    					           +_item.afterOperCardNo
				            +"</td>"
    					    +"<td>"+_item.createTime+"</td>"
    					    +"<td>"+_item.operater+"</td>"
    					    +"</tr>";
    				});
    				$("#Table_accountdetail",wraper).append(str);
    			},
					  error:function(xhr){
					  		var errormsg = eval("(" + xhr.responseText + ")"); 
							if (errormsg != undefined) {
								$('#Table_shroff_account').flexMessage(errormsg[0].message, 'error');
							} 
					  }
    		})
    	});
    }}); 
    
   page_search_items.push({row:'1',type:'jrad-input',display:'商家工商注册名称',name:'businessName'});
   page_search_items.push({row:'1',type:'jrad-input',display:'商家简称',name:'businessRegName'}); 
   page_search_items.push({row:'1',type:'jrad-select',display:'账号类型',name:'type',params:jRad.params['type']}); 
   page_search_items.push({row:'2',type:'jrad-input',display:'户主姓名',name:'accountHolder'}); 
   page_search_items.push({row:'2',type:'jrad-input',display:'银行账号',name:'bankAccount'}); 
   page_search_items.push({row:'2',type:'jrad-select',display:'结算周期',name:'billingPeriod',params:jRad.params['billingPeriod']});
   page_search_items.push({row:'3',type:'jrad-select',display:'省',name:'provinceId',params:jRad.params['provinceCodeSearch']}); 
   page_search_items.push({row:'3',type:'jrad-select',display:'市',name:'areaCodeId',params:jRad.params['cityIdSearch']}); 
   page_search_items.push({row:'3',type:'jrad-select',display:'县',name:'countyId',params:jRad.params['countyIdSearch']});

   page_list_buttons.push({title: '创建',name:'Add', bclass: 'add',onpress : function(){ 
   	$("#Form_shroff_account div[name='businessInfoId']").input("readonly",'');
			$('#Form_shroff_account').form({
                title: '创建',
                validators: jRad.validators, 
                fields_params: fields_params,
                item:{},
                style:{height:'300px'}, 
                url:'/shopmanage-ws/ws/0.1/shroffAccountCms/addShroffAccount', 
				/**before_submit:function(json){
					json.way = 2;
					json.status = 1;
				},**/
				before_submit:function(json){
					json.operator=carsmart_config.operatorName
				},
				success_callback:function(){ 
                            $('#Table_shroff_account').flexMessage('添加成功', 'success');
                            $('#Table_shroff_account').flexReload();
                        } 
            }).form('open');

			getNameTips();
			$('div[name="type"]').select({
				onchange:function(val){
					if(val==2){
						$('.period').hide();
	            		$('div[name="billingPeriod"]').hide();
            		}else{
            			$('.period').show();
	            		$('div[name="billingPeriod"]').show();
            		}
				}
            })
        }
    }); 
	
	page_list_buttons.push({name:'edit',bclass: 'edit',prefunc:function(){
            var checked = $('#Table_shroff_account').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
	    	var checked = $('#Table_shroff_account').getCheckedTrs();  
			var json = $.jRadGet({url:'/shopmanage-ws/ws/0.1/shroffAccountCms/detailShroffAccount?shroffAccountId='+checked[0].shroffAccountId}); 
			json.bankAccountAgain = json.bankAccount;
			var bankId = {'id':json.bankId,"name":json.bankName};
			json.bankId = bankId;
				$('#Form_shroff_account').form({
                title: '编辑',
                validators: jRad.validators, 
                item:json,
                style:{height:'300px'}, 
                url:'/shopmanage-ws/ws/0.1/shroffAccountCms/editShroffAccount', 
                before_submit:function(json){
                	json.operater=carsmart_config.operatorName
                },
				success_callback:function(){ 
                            $('#Table_shroff_account').flexMessage('编辑成功', 'success');
                            $('#Table_shroff_account').flexReload();
                        } 
            }).form('open');  
			$("#Form_shroff_account div[name='businessInfoId']").input("readonly","true");
			getNameTips();
			$("#Form_shroff_account .nameTips").html(json.businessName.businessName);
			$('div[name="type"]').select({
				onchange:function(val){
					if(val==2){
						$('.period').hide();
	            		$('div[name="billingPeriod"]').hide();
            		}else{
            			$('.period').show();
	            		$('div[name="billingPeriod"]').show();
            		}
				}
            })
		}
	}); 
	page_list_buttons.push({name:'delete',bclass: 'delete',prefunc:function(){
            var checked = $('#Table_shroff_account').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
	    	var checked = $('#Table_shroff_account').getCheckedTrs();  
	    	var postData={};
	    	postData.shroffAccountId=checked[0].shroffAccountId;
	    	postData.operator=carsmart_config.operatorName;
			$.jRadConfirm('确认删除？',1,function(){
				$.jRadAjax({
					type:'post',
					url:'/shopmanage-ws/ws/0.1/shroffAccountCms/delShroffAccount',
					data:postData,
					success:function(){
						$('#Table_shroff_account').flexMessage('删除成功!', 'success');
           	    		$('#Table_shroff_account').flexReload();
					},error:function(xhr){
						var errormsg = eval("(" + xhr.responseText + ")"); 
						if (errormsg != undefined) {
							$('#Table_shroff_account').flexMessage(errormsg[0].message, 'error');
						}
					}
				})
			})
		}
	});  
    page_list_buttons.push({separator: true});
    
    $('#Table_shroff_account').flexigrid({
            reload:true,
			method:'get',
            colModel : page_column_model,
            buttons : page_list_buttons,
            searchitems :page_search_items,
            pagination: {
				diaplay_pages: 5,
				align: 'bottom' 
			},
			showSearch:true, 
			//overflow:true,
            url:'/shopmanage-ws/ws/0.1/shroffAccountCms/queryShroffAccounts', 
			onError:showError,
			checkBoxType:'single'
    });
    $(".numb37").click(function(){
        $('.overcurtainDiv').hide();
        var menuId = $(".tabs-selected").attr("menuId")
        var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        $("#Form_explain_eg37").form({}).form('close');
        $("#Form_explain_eg37").form({
            title:'页面说明',
            item:data,
            autobinding: true, 
            submit:function(){
                var postData = {};
                postData.operator = carsmart_config.operatorName;
                postData.menuName = $(".tabs-selected").attr("menuName");
                postData.menuId = $(".tabs-selected").attr("menuId");
                postData.remark = $("#Form_explain_eg37 div[name='remark']").textarea("val")
                $.jRadPost({
                    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
                    data:postData,
                    success:function(){
                        $("#Form_explain_eg37").form('close')
                        $('.overcurtainDiv').hide();
                    }
                });
            }, 
            cancel:function(){
                $("#Form_explain_eg37").form('close')
                $('.overcurtainDiv').hide();
            }
        }).form('open')
        $("#Form_explain_eg37 .textarea-content").removeClass("span4").addClass("span12")
        $('.overcurtainDiv').hide();
        $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
    })
	function getNameTips(){
		$("#Form_shroff_account .nameTips").html("");
		$("#Form_shroff_account div[name='businessInfoId']").focusout(function(){ 
			 var flag = $("#Form_shroff_account div[name='businessInfoId']").input('validate',jRad.validators["businessInfoId"]);
			 if(flag){
			   var id = $(this).input("val");
			   var _tip = $(this).parent().children(".nameTips");
			   var json = $.jRadGet({
						url:'/shopmanage-ws/ws/0.1/shopmanage/shop/name?id='+id, 
						success: function(data){ 
							_tip.html(data.businessName).css("color","#1F2228"); 
						},
						error:function(){ 
							_tip.html("查询商家不存在！").css("color","#BB4B47"); 
						}
					});
			   
			 }else{
			   $(this).parent().children(".nameTips").html("");
			 }
		});  
	}

	function showError(xhr){
	 	var errormsg = eval("(" + xhr.responseText + ")"); 
	  	$.jRadMessage({level:'error',message:errormsg[0].message});
	} 
});
</script>
