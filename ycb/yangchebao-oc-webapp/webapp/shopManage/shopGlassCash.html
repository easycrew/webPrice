<div class="urlContentWraper" id="Wraper_glass_cash"> 
	<div class="row-fluid ui-data-show"> 
			<div class="hDiv">
				 <h2 class="ui-tit"><strong>玻璃水返现列表</strong><bottom class="all-work-info numb310">页面说明</bottom></h2> 
				 <table id="Table_glass_list"></table>
			</div> 
    </div> 
	<div id="Form_glass_set" style="display:none;">
        <div class="grid-layout-main jrad-form">  
			<div class="row"> 
				<label class="span4 grid-layout-label"><span class="ui-form-required">*</span>城市：</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div name="areaCodeId" class="jrad-autocomplete-container">
					</div> 
				</div>
			</div>
			<div class="row"> 
				<label class="span4 grid-layout-label"><span class="ui-form-required">*</span> 玻璃水单价：</label>
				<div class="span5 grid-layout-content fluid-wrap">
					<div name="price" class="jrad-input-container">
					</div> 
				</div>
			</div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span>
			<span class="jrad-btn-normal">取消</span>
        </div>
    </div>
    <div id="Form_glass_info" style="display:none;">
        <div class="grid-layout-main jrad-form">
	        <table id="Table_accountdetail">
	            <tr>
	                <th style="width:100px;">变动说明</th>
	                <th style="width:100px;">变动时间</th>
	                <th style="width:100px;">操作人</th>
	            </tr>
	        </table>
        </div>
    </div>
    <div id="Form_explain_eg310" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                <label class="span3 grid-layout-label">业务说明：</label>
                <div class="span12 grid-layout-content">
                    <div><strong>功能简介：</strong>商家购买玻璃水，以及赠送玻璃水的统计情况。</div>
                    <div><strong>重要功能说明：</strong>无。</div>
                    <div><strong>注意事项：</strong>无。</div>
                </div> 
            </div> 
            <div class="row">
                <label class="span3 grid-layout-label">备注：</label>
                <div class="span12 grid-layout-content">
                    <div class="jrad-textarea-container" name="remark">
                    </div>
                </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
</div>
<script type="text/javascript">
$(document).ready(function(){
    var wraper = $('#Wraper_glass_cash');
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array(); 
	
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel});

	var fields_params = {}; 
	fields_params['areaCodeId'] = {
		grid:5,
		url: '/shopmanage-ws/ws/0.1/busiSubsidyForGlass/cityList', 
        queryParam:'name',
        fl: 'name',
        displayField:'name',
        valueField:'id',
        defaultValue: '',
        response: function(data){
          return data;
        },
        query: function(value){
            if(value == '*'){
                return value = '';
            }else{
                return value;
            }
        },
        onchange:function(){
            var fristId = $("div[name='areaCodeId']",wraper).autocomplete('val');
 			var Data = $.jRadGet({url : '/shopmanage-ws/ws/0.1/busiSubsidyForGlass/getPriceByAreaCodeId?areaCodeId='+fristId});
			$('input[name="price"]').val(Data.price);
        }
    };

	page_column_model.push({display: '商户ID', name : 'businessInfoId'}); 
    page_column_model.push({display: '城市id', name : 'areaCodeId',hidden:true}); 
    page_column_model.push({display: '城市', name : 'cityName'}); 
    page_column_model.push({display: '商家简称', name : 'businessRegName'}); 
    page_column_model.push({display: '玻璃水单价(元/瓶)', name : 'price'}); 
    page_column_model.push({display: '购买玻璃水数量', name : 'buyCnt'}); 
    page_column_model.push({display: '当前玻璃水数量', name : 'surplusCnt'});
    page_column_model.push({display: '订单数量', name : 'orderSaleCnt'}); 
    page_column_model.push({display: '车主卡销量', name : 'cardSaleCnt'}); 
    page_column_model.push({display: '返现金额', name : 'subsidyAmount'});
    page_column_model.push({display: '更新时间', name : 'updateDate'});
	page_column_model.push({display: '操作日志', diy:function(item,$div){
		var a=$('<a>').attr('href','javascript:').html('详情');
		$div.append(a);
        $div.find('a').unbind('click').bind('click',function(){
            $.jRadGet({
                url:'/shopmanage-ws/ws/0.1/busiSubsidyForGlass/changeTrail?areaCodeId='+item.areaCodeId,
                success:function(data){
                    $("#Form_glass_info").form({
                        title:"操作日志",
                        success_callback:function(){
                            $('#Table_glass_list').flexReload();
                        }
                    }).form('open');
                    
                    var tr_len=$("#Table_accountdetail",wraper).find("tr").length;
                    for(cur=0;cur<tr_len;cur++){
                      if(cur!==0){
                        $("#Table_accountdetail",wraper).find("tr").eq(cur).hide();
                      }
                    };
                    var str="";
                    $.each(data,function(i){
                        var _item=data[i];
                        str+="<tr>"
                            +"<td>"+_item.changeDiscription+"</td>"
                            +"<td>"+_item.changeDate+"</td>"
                            +"<td>"+_item.operator+"</td>"
                            +"</tr>";
                    });
                    $("#Table_accountdetail",wraper).append(str);
                },
                error:function(xhr){
                    var errormsg = eval("(" + xhr.responseText + ")"); 
                    if (errormsg != undefined) {
                        $('#Table_glass_list').flexMessage(errormsg[0].message, 'error');
                    } 
                }
            })
        });
	}});
   
    page_search_items.push({row:'1',type:'jrad-input',display:'商家ID',name:'businessInfoId'});
    page_search_items.push({row:'1',type:'jrad-input',display:'商家简称',name:'businessRegName'});
    page_search_items.push({row:'2',type:'jrad-dateinput',display:'更新时间始',name:'updateStartDate'}); 
    page_search_items.push({row:'2',type:'jrad-dateinput',display:'更新时间终',name:'updateEndDate'}); 
 	
	page_list_buttons.push({displayname: '设置玻璃水单价',name:'cashInstall', bclass: 'cashInstall',
		onpress : function(){
			$('#Form_glass_set',wraper).form({
				title:'设置玻璃水单价',
				fields_params:fields_params,
				url:'/shopmanage-ws/ws/0.1/busiSubsidyForGlass/setGlassPrice',
				type:'post',
				before_submit:function(json){

					json.operator = carsmart_config.operatorName;
					return json
				},
				success_callback:function(){
					$('#Table_glass_list').flexMessage('设置成功', 'success')
					$('#Table_glass_list').flexReload();
				}
			}).form('open');
	}}); 
    page_list_buttons.push({separator: true});
    
    $('#Table_glass_list').flexigrid({
            reload:true,
			method:'get',
            colModel : page_column_model,
            buttons : page_list_buttons,
            searchitems :page_search_items,
            pagination: {
				diaplay_pages: 5,
				align: 'bottom' 
			},
			showSearch:true, 
			overflow:true,
            url:'/shopmanage-ws/ws/0.1/busiSubsidyForGlass/getBusiSubsidyForGlass', 
			onError:showError
    }); 


    $(".numb310").click(function(){
        $('.overcurtainDiv').hide();
        var menuId = $(".tabs-selected").attr("menuId")
        var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        $("#Form_explain_eg310").form({}).form('close');
        $("#Form_explain_eg310").form({
            title:'页面说明',
            item:data,
            autobinding: true, 
            submit:function(){
                var postData = {};
                postData.operator = carsmart_config.operatorName;
                postData.menuName = $(".tabs-selected").attr("menuName");
                postData.menuId = $(".tabs-selected").attr("menuId");
                postData.remark = $("#Form_explain_eg310 div[name='remark']").textarea("val")
                $.jRadPost({
                    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
                    data:postData,
                    success:function(){
                        $("#Form_explain_eg310").form('close')
                        $('.overcurtainDiv').hide();
                    }
                });
            }, 
            cancel:function(){
                $("#Form_explain_eg310").form('close')
                $('.overcurtainDiv').hide();
            }
        }).form('open')
        $("#Form_explain_eg310 .textarea-content").removeClass("span4").addClass("span12")
        $('.overcurtainDiv').hide();
        $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
    })
	function showError(xhr){
		var errormsg = eval("(" + xhr.responseText + ")"); 
		$.jRadMessage({level:'error',message:errormsg[0].message});
	} 
})
</script>
