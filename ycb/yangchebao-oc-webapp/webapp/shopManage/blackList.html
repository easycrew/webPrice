<div class="urlContentWraper" id="Wraper_shop_black">
    <div class="ui-info-layout">
        <h2 class="ui-tit"><strong>黑名单商家管理列表</strong><bottom class="all-work-info numb32">页面说明</bottom></h2>
        <!-- 列表显示 -->
        <table id="Table_shop_black"></table>
    </div>
    <div id="Form_shop_black" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
             <div class="row">
                 <label class="span3 grid-layout-label">商家ID：</label>
                 <div class="span6 grid-layout-content">
                       <div name="businessInfoId" class="jrad-input-container"></div>
					   <p class="ui-note">如不知道商家ID，请在商家管理界面选择商家并通过“加入黑名单”功能将此商家加入黑名单</p>
                       <p class="nameTips"></p>
					   </div>
					 
            </div>
			 <div class="row">
                 <label class="span3 grid-layout-label">备注：</label>
                 <div class="span5 grid-layout-content">
                       <div name="remarks" class="jrad-textarea-container"></div>
                                    </div>
            </div> 
             <input type="hidden" name="blackListId"/>  
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span>
			<span class="jrad-btn-normal">取消</span>
        </div>
    </div>
    <div id="Form_explain_eg32" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                <label class="span3 grid-layout-label">业务说明：</label>
                <div class="span12 grid-layout-content">
                    <div><strong>功能简介：</strong>违章商家，将被拉到此黑名单，现在已停用，若有违规商家，直接改成无效即可。</div>
                    <div><strong>重要功能说明：</strong>无。</div>
                    <div><strong>注意事项：</strong>无。</div>
                </div> 
            </div> 
            <div class="row">
                <label class="span3 grid-layout-label">备注：</label>
                <div class="span12 grid-layout-content">
                    <div class="jrad-textarea-container" name="remark">
                    </div>
                </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
</div>
<script type="text/javascript">
$(document).ready(function(){
    var wraper = $('#Wraper_shop_black');
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array();
	//var jRad = $.jRad('/radsample-ws','ent','Menu');	 
	
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel}); 
    
	jRad.validators['businessInfoId'] = [{"msg":"商家id不能为空","type":"min","value":"1"},{msg:"商家id只能是数字",type:'regex',value:/^\d+$/}]; 
	jRad.validators['remarks'] = [{"msg":"内容超长","type":"max","value":"2000"}];
	 
    page_column_model.push({display: '商家ID', name : 'businessInfoId'}); 
    page_column_model.push({display: '商家简称', name : 'businessRegName'}); 
    page_column_model.push({display: '最近进入黑名单时间', name : 'blackDate'}); 
    page_column_model.push({display: '进入方式', name : 'wayName'}); 
    page_column_model.push({display: '历史举报次数', name : 'hisTimes',  sortable:true}); 
    page_column_model.push({display: '新增举报次数', name : 'newTimes',  sortable:true}); 
    page_column_model.push({display: '备注', name : 'remarks'}); 
    page_column_model.push({display: '黑名单中', name : 'statusName'}); 
    
   page_search_items.push({row:'1',type:'jrad-input',display:'商家简称',name:'businessRegName'}); 
   page_search_items.push({row:'1',type:'jrad-input',display:'商家ID',name:'businessInfoId'}); 
   page_search_items.push({row:'1',type:'jrad-select',display:'是否正在黑名单中',name:'status',params:{
	  data:[
	    {"id":"",name:"全部"},
	    {"id":"0",name:"否"},
	    {"id":"1",name:"是"},
		{"id":"2",name:"等待确认"}
	  ]
	}}); 
	page_list_buttons.push({displayname: '查看举报',name:'seeInform',bclass: 'seeInform',prefunc:function(){
            var checked = $('#Table_shop_black').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
	    	var checked = $('#Table_shop_black').getCheckedTrs();  
			var name = checked[0].businessRegName; 
			$(document).data("blackInformShopName",name);
			$.jRadOpenTab({'name':'举报管理','url':'userManage/inform.html'});
		}
	});
   
   page_list_buttons.push({displayname: '移入黑名单',name:'inBlack',bclass: 'inBlack',prefunc:function(){
            var checked = $('#Table_shop_black').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
	    	var checked = $('#Table_shop_black').getCheckedTrs(); 
			var postData = {};
			postData.blackListId = checked[0].id;
			postData.operateCode = 0; //0.移入 1.移出
			$.jRadPost({
				url:'/shopmanage-ws/ws/0.1/blacklist/shiftInOrOut',
				data:postData,
				success: function(){
					$('#Table_shop_black').flexMessage('操作成功!', 'success');
					$('#Table_shop_black').flexReload();
				},
				error:function(xhr){
				  var errormsg = eval("(" + xhr.responseText + ")"); 
				 $('#Table_shop_black').flexMessage(errormsg[0].message,'error');
				} 
			});
 
		}
	});
	
	 page_list_buttons.push({displayname: '移出黑名单',name:'outBlack',bclass: 'outBlack',prefunc:function(){
            var checked = $('#Table_shop_black').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
	    	var checked = $('#Table_shop_black').getCheckedTrs(); 
			var postData = {};
			postData.blackListId = checked[0].id;
			postData.operateCode = 1; //0.移入 1.移出
			$.jRadPost({
				url:'/shopmanage-ws/ws/0.1/blacklist/shiftInOrOut',
				data:postData,
				success: function(){
					$('#Table_shop_black').flexMessage('操作成功!', 'success');
					$('#Table_shop_black').flexReload();
				},
				error:function(xhr){
				  var errormsg = eval("(" + xhr.responseText + ")"); 
				 $('#Table_shop_black').flexMessage(errormsg[0].message,'error');
				} 
			});
 
		}
	}); 
	 
   page_list_buttons.push({displayname: '新增黑名单商家',name:'AddBlackShop', bclass: 'AddBlackShop',onpress : function(){ 
			$('#Form_shop_black').form({
                title: '创建',
                validators: jRad.validators, 
                item:{},
                style:{height:'300px'}, 
                url:'/shopmanage-ws/ws/0.1/blacklist/addBlackList', 
				before_submit:function(json){
					json.way = 2;
					json.status = 1;
				},
				success_callback:function(){ 
                            $('#Table_shop_black').flexMessage('添加成功', 'success');
                            $('#Table_shop_black').flexReload();
                        } 
            }).form('open');
			$('#Form_shop_black div[name="businessInfoId"]').input("readonly",false);
			getNameTips();
        }
    }); 
	
	 page_list_buttons.push({displayname: '编辑黑名单商家',name:'EditBlackShop', bclass: 'EditBlackShop',prefunc:function(){
            var checked = $('#Table_shop_black').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
			var checked = $('#Table_shop_black').getCheckedTrs(); 
            $('#Form_shop_black').form({
                title: '修改',
                validators: jRad.validators, 
                item:checked[0],
                style:{height:'300px'}, 
                url:'/shopmanage-ws/ws/0.1/blacklist/editBlacklist', 
				success_callback:function(){ 
                            $('#Table_shop_black').flexMessage('添加成功', 'success');
                            $('#Table_shop_black').flexReload();
                        } 
            }).form('open');
			 $('#Form_shop_black .nameTips').html(checked[0].businessRegName);
			 $('#Form_shop_black div[name="businessInfoId"]').input("readonly",true);
			 $('#Form_shop_black input[name="blackListId"]').val(checked[0].id);
        }
    }); 
	
	
	 
    page_list_buttons.push({separator: true});
    
    $('#Table_shop_black').flexigrid({
            reload:true,
			method:'post',
            colModel : page_column_model,
            buttons : page_list_buttons,
            searchitems :page_search_items,
            pagination: {
				diaplay_pages: 5,
				align: 'bottom' 
			},
			showSearch:true, 
            url:'/shopmanage-ws/ws/0.1/blacklist/queryBlackLists', 
			onError:showBlackListError,
			checkBoxType:'single'
    });
    $(".numb32").click(function(){
        $('.overcurtainDiv').hide();
        var menuId = $(".tabs-selected").attr("menuId")
        var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        $("#Form_explain_eg32").form({}).form('close');
        $("#Form_explain_eg32").form({
            title:'页面说明',
            item:data,
            autobinding: true, 
			submit:function(){
            	var postData = {};
                postData.operator = carsmart_config.operatorName;
                postData.menuName = $(".tabs-selected").attr("menuName");
                postData.menuId = $(".tabs-selected").attr("menuId");
                postData.remark = $("#Form_explain_eg32 div[name='remark']").textarea("val")
				$.jRadPost({
				    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
				    data:postData,
				    success:function(){
						$("#Form_explain_eg32").form('close')
      					$('.overcurtainDiv').hide();
				   	}
				});
			}, 
			cancel:function(){
				$("#Form_explain_eg32").form('close')
      			$('.overcurtainDiv').hide();
			}
        }).form('open')
        $("#Form_explain_eg32 .textarea-content").removeClass("span4").addClass("span12")
        $('.overcurtainDiv').hide();
        $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
    })
	if($(document).data('blackShopId')!=undefined & $(document).data('blackShopId')!=''){
		  var id = $(document).data('blackShopId');
		  $('#Form_shop_black').form({
										title:'创建黑名单',
										item:{'businessInfoId':id},
										validators: jRad.validators,  
										style:{height:'300px'}, 
										url:'/shopmanage-ws/ws/0.1/blacklist/addBlackList', 
										before_submit:function(json){
											json.way = 2;
											json.status = 1;
										},
										success_callback:function(){ 
													$('#Table_shop_black').flexMessage('添加成功', 'success');
													$('#Table_shop_black').flexReload();
										} 
									}).form('open');
		  $(document).removeData('blackShopId');
		   getNameTips();		 
		   var json = $.jRadGet({url:'/shopmanage-ws/ws/0.1/shopmanage/shop/name?id='+id});
		  $("#Form_shop_black div[name='businessInfoId']").parent().children(".nameTips").html(json.businessName);
	} 
	 
	function getNameTips(){
				$("#Form_shop_black .nameTips").html("");
				$("#Form_shop_black div[name='businessInfoId']").focusout(function(){ 
					 var flag = $("#Form_shop_black div[name='businessInfoId']").input('validate',jRad.validators["businessInfoId"]);
					 if(flag){
					   var id = $(this).input("val");
					   var _tip = $(this).parent().children(".nameTips");
					   var json = $.jRadGet({
								url:'/shopmanage-ws/ws/0.1/shopmanage/shop/name?id='+id, 
								success: function(data){ 
									_tip.html(data.businessName).css("color","#1F2228"); 
								},
								error:function(){ 
									_tip.html("查询商家不存在！").css("color","#BB4B47"); 
								}
							});
					   
					 }else{
					   $(this).parent().children(".nameTips").html("");
					 }
				});  
	}
});
function showBlackListError(xhr){
		 var errormsg = eval("(" + xhr.responseText + ")");
		  var cDiv = $("#Wraper_shop_black .cDiv");
		  $.jRadMessage({level:'error',message:errormsg[0].message,selector:cDiv});
		} 
</script>
