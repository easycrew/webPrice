<div class="urlContentWraper" id="Wraper_repairFactory_Manage"> 
	<div class="row-fluid ui-data-show"> 
		<div class="hDiv">
			 <h2 class="ui-tit"><strong>维修厂管理</strong><bottom class="all-work-info numb311">页面说明</bottom></h2>  
			 <table id="Table_repairFactory_manage"></table>
		</div> 
    </div> 
    <div id="Form_repairFactory_add" style="display:none;">
        <div class="grid-layout-main jrad-form">  
		    <input name="shroffAccountId" type="hidden">  
			<div class="row"> 
				<label class="span4 grid-layout-label"><span class="ui-form-required">*</span>商家ID：</label>
				<div class="span5 grid-layout-content">
					<div name="businessInfoId" class="jrad-input-container"></div> 
				</div>
			</div> 
			<div class="row"> 
				<label class="span4 grid-layout-label"><span class="ui-form-required">*</span>零件结算比例%：</label>
				<div class="span5 grid-layout-content">
					<div name="partsRatio" class="jrad-input-container"></div> 
				</div>
			</div> 
			<div class="row"> 
				<label class="span4 grid-layout-label"><span class="ui-form-required">*</span>工时费结算比例%：</label>
				<div class="span5 grid-layout-content">
					<div name="workRatio" class="jrad-input-container"></div> 
				</div>
			</div> 
			<div class="row"> 
				<label class="span4 grid-layout-label"><span class="ui-form-required">*</span>状态：</label>
				<div class="span5 grid-layout-content">
					<div name="status" class="jrad-select-container"></div> 
				</div>
			</div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span>
			<span class="jrad-btn-normal">取消</span>
        </div>
    </div>
    <div id="Form_explain_eg311" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                <label class="span3 grid-layout-label">业务说明：</label>
                <div class="span12 grid-layout-content">
                    <div><strong>功能简介：</strong>永安理赔功能，维修厂在此创建。</div>
                    <div><strong>重要功能说明：</strong>无。</div>
                    <div><strong>注意事项：</strong>1、创建维修厂后，会在对应商家创建一个马甲服务，此服务不要删除，否则APP找不到此商家。</div>
                </div> 
            </div> 
            <div class="row">
                <label class="span3 grid-layout-label">备注：</label>
                <div class="span12 grid-layout-content">
                    <div class="jrad-textarea-container" name="remark">
                    </div>
                </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
</div>

<script type="text/javascript">
$(document).ready(function(){
    var wraper = $('#Wraper_repairFactory_Manage');
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array(); 
	
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel}); 
	var fields_params = {};  
	fields_params['status'] = {data:[{id:"1",name:"有效"},{id:"0",name:"无效"},{id:"2",name:"删除"}]};

	page_column_model.push({display: '维修厂匹配ID', name : 'businessConfigId',hidden:true}); 
    page_column_model.push({display: '商家ID', name : 'businessInfoId'}); 
    page_column_model.push({display: '商家简称', name : 'businessRegName'}); 
    page_column_model.push({display: '城市', name : 'city'}); 
    page_column_model.push({display: '地址', name : 'address'}); 
    page_column_model.push({display: '售后电话', name : 'mobile'}); 
    page_column_model.push({display: '零件结算比例%', name : 'partsRate'}); 
    page_column_model.push({display: '工时费结算比例%', name : 'workRate'});
    page_column_model.push({display: '状态', name : 'status'});  
    page_column_model.push({display: '创建时间', name : 'createDate'}); 
    page_column_model.push({display: '最后操作时间', name : 'updateDate'});  
    page_column_model.push({display: '最后操作人', name : 'operator'});  
   
    page_search_items.push({row:'1',type:'jrad-input',display:'维修厂ID',name:'businessInfoId'});
    page_search_items.push({row:'1',type:'jrad-input',display:'维修厂简称',name:'businessRegName'});
    page_search_items.push({row:'1',type:'jrad-input',display:'城市',name:'city'});     
    page_search_items.push({row:'2',type:'jrad-input',display:'售后电话',name:'mobile'})
    page_search_items.push({row:'2',type:'jrad-select',display:'状态',name:'status',params:{
		data:[{"id":"2",name:"未删除"},{id:' ',name:'全部'},{id:'1',name:'有效'},{id:'0',name:'无效'}]}
	});   
     
    page_list_buttons.push({title: '创建',name:'Add', bclass: 'add',
    	onpress : function(){ 
			$('#Form_repairFactory_add').form({
                title: '创建',
                item:{},
				fields_params:fields_params,
               	url:'/shopmanage-ws/ws/0.1/repairFactory/addFactory',
				before_submit:function(json){
                    json.operator = carsmart_config.operatorName;
					return json
				},				
				success_callback:function(){ 
                    $('#Table_repairFactory_manage').flexMessage('添加成功', 'success');
                    $('#Table_repairFactory_manage').flexReload();
                } 
            }).form('open');  
            
            $('#Form_repairFactory_add div[name="businessInfoId"]').input('readonly',false);
        }
    }); 
	page_list_buttons.push({title: '修改',name:'edit', bclass: 'edit',
        prefunc:function(){
            var checked = $('#Table_repairFactory_manage').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },
    	onpress : function(){ 
            var checked = $('#Table_repairFactory_manage').getCheckedTrs();
            var sta ='';
            if(checked[0].status == '删除'){sta = 2}else if(checked[0].status == '有效'){sta = 1}else{sta = 0}
			$('#Form_repairFactory_add').form({
                title: '修改',
                fields_params:fields_params,
                item:{businessInfoId:checked[0].businessInfoId,partsRatio:checked[0].partsRate,workRatio:checked[0].workRate,status:sta},
               	url:'/shopmanage-ws/ws/0.1/repairFactory/updateFactory',
				before_submit:function(json){
                    json.businessConfigId = checked[0].businessConfigId;
                    json.operator = carsmart_config.operatorName;
					return json
				},				
				success_callback:function(){ 
                    $('#Table_repairFactory_manage').flexMessage('添加成功', 'success');
                    $('#Table_repairFactory_manage').flexReload();
                } 
            }).form('open'); 
            $('#Form_repairFactory_add div[name="businessInfoId"]').input('readonly',true);
        }
    });
	page_list_buttons.push({title: '删除',name:'delete', bclass: 'delete',
        prefunc:function(){
            var checked = $('#Table_repairFactory_manage').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },
    	onpress : function(){ 
            var checked = $('#Table_repairFactory_manage').getCheckedTrs();
            var postData={};
            postData.businessConfigId=checked[0].businessConfigId;
			$.jRadConfirm('确认删除吗？',1,function(){
                $.jRadPost({  
                    url:'/shopmanage-ws/ws/0.1/repairFactory/deleteFactory',
                    data:postData, 
                    success: function(data){ 
                        $('#Table_repairFactory_manage').flexMessage('删除成功!', 'success');
                        $('#Table_repairFactory_manage').flexReload();
                    },
                    error:function(xhr){ 
                        var errormsg = eval("(" + xhr.responseText + ")"); 
                        if (errormsg != undefined) {
                            $('#Table_repairFactory_manage').flexMessage(errormsg[0].message, 'error');
                        }
                    }
                });
            });   
        }
    }); 

    page_list_buttons.push({displayname: '导出EXCEL',name:'excel', bclass: 'excel',onpress : function(){ 
		$ .jRadConfirm('确认导出吗？',1,function(){
			var param = {};
			var businessInfoId = $.trim($(".searchContent div[name='businessInfoId']",wraper).input('val'));
			if(businessInfoId!=""){
				param['businessInfoId'] = businessInfoId;
			};
			var businessRegName = $.trim($(".searchContent div[name='businessRegName']",wraper).input('val'));
			if(businessRegName!=""){
				param['businessRegName'] = businessRegName;
			}; 
			var mobile = $.trim($(".searchContent div[name='mobile']",wraper).input('val'));
			if(mobile!=""){
				param['mobile'] = mobile;
			};
			var city = $.trim($(".searchContent div[name='city']",wraper).input('val'));
			if(city!=""){
				param['city'] = city;
			};
			var status = $.trim($(".searchContent div[name='status']",wraper).select('val'));
			if(status!=""){
				param['status'] = status;
			};
			var paramUrl = "";
			if(param!={}){   
				paramUrl+="?"
			 	$.each(param,function(k,v){ 
					paramUrl+="&"+k+"="+v; 
			 	});
			}
			window.open('/shopmanage-ws/ws/0.1/repairFactory/exportRepairFactoryList'+paramUrl);
			}); 
        }
    });
    page_list_buttons.push({separator: true});
    
    $('#Table_repairFactory_manage').flexigrid({
        reload:true,
		method:'get',
        colModel : page_column_model,
        buttons : page_list_buttons,
        searchitems :page_search_items,
        pagination: {
			diaplay_pages: 5,
			align: 'bottom' 
		},
		showSearch:true, 
        queryParam: {'status':2},
        url:'/shopmanage-ws/ws/0.1/repairFactory/getFactoryList', 
		onError:showError,
		checkBoxType:'single'
    }); 
    $(".numb311").click(function(){
        $('.overcurtainDiv').hide();
        var menuId = $(".tabs-selected").attr("menuId")
        var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        $("#Form_explain_eg311").form({}).form('close');
        $("#Form_explain_eg311").form({
            title:'页面说明',
            item:data,
            autobinding: true, 
            submit:function(){
                var postData = {};
                postData.operator = carsmart_config.operatorName;
                postData.menuName = $(".tabs-selected").attr("menuName");
                postData.menuId = $(".tabs-selected").attr("menuId");
                postData.remark = $("#Form_explain_eg311 div[name='remark']").textarea("val")
                $.jRadPost({
                    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
                    data:postData,
                    success:function(){
                        $("#Form_explain_eg311").form('close')
                        $('.overcurtainDiv').hide();
                    }
                });
            }, 
            cancel:function(){
                $("#Form_explain_eg311").form('close')
                $('.overcurtainDiv').hide();
            }
        }).form('open')
        $("#Form_explain_eg311 .textarea-content").removeClass("span4").addClass("span12")
        $('.overcurtainDiv').hide();
        $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
    })

});
function showError(xhr){
    var errormsg = eval("(" + xhr.responseText + ")"); 
    $.jRadMessage({level:'error',message:errormsg[0].message});
} 
</script>
