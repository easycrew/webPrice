<style type="text/css">
	#Form_remark_check .row{
		margin-left:0;
	}
</style>
 <div class="urlContentWraper" id="Wraper_service_remark">
    <div class="ui-info-layout">
        <h2 class="ui-tit"><strong>服务点评列表</strong><bottom class="all-work-info numb28">页面说明</bottom></h2>
        <!-- 列表显示 --> 
		<table id="Table_service_remark"></table> 
    </div> 
	<div id="Form_remark_check" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <input type="hidden" name="remarkServiceId"/>
			<div class="piclist">
			</div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container">
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
    <div id="Form_explain_eg28" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                <label class="span3 grid-layout-label">业务说明：</label>
                <div class="span12 grid-layout-content">
                    <div><strong>功能简介：</strong>用户购买服务后，对此服务的评价。</div>
                    <div><strong>重要功能说明：</strong>无。</div>
                    <div><strong>注意事项：</strong>无。</div>
                </div> 
            </div> 
            <div class="row">
                <label class="span3 grid-layout-label">备注：</label>
                <div class="span12 grid-layout-content">
                    <div class="jrad-textarea-container" name="remark">
                    </div>
                </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>

</div>
<script type="text/javascript">
$(document).ready(function(){
    var wraper = $('#Wraper_service_remark');
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array(); 
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel});
    jRad.params['level'] = {data:[{id:'10',name:'10'},
								 {id:'8',name:'8'},
								 {id:'6',name:'6'},
								 {id:'4',name:'4'},
								 {id:'2',name:'2'}
								 ]};   
	jRad.params['remarksFrom'] = {data:[  
							{"id":"0",name:"用户"},
							{"id":"1",name:"系统"},
							{"id":"2",name:"运营"}
						  ]};   
     
    jRad.validators['businessId'] = [{"msg":"商家id不能为空","type":"min","value":"1"},{msg:"商家id只能是数字",type:'regex',value:/^\d+$/}];
	jRad.validators['userInfoId'] = [{"msg":"用户id不能为空","type":"min","value":"1"},{msg:"用户id只能是数字",type:'regex',value:/^\d+$/}];
	jRad.validators['remarks'] = [{"msg":"内容超长","type":"max","value":"2000"}];
	
    $("#Form_remark_check").form({
	  title:'图片审核',
	  grid:18,
	  height:'400px',
	  url:'/shopmanage-ws/ws/0.1/remarkService/auditRemarkPics',
	  before_submit:function(json){
	    json.auditPerson = carsmart_config.operatorName;
		var pics = [];
		var picsDiv = $("#Form_remark_check .row");
		$.each(picsDiv,function(){
			var pic = {};
			pic.status = $(this).children(".jrad-radio").radio('val');
			pic.id = $(this).data("id"); 
			pics.push(pic);
		});
		json.pics = pics;
		return json;
	  },
	  success_callback:function(){
		$('#Table_service_remark').flexReloadCurrentPage();
	  }
	});
    page_column_model.push({display: '用户ID', name : 'userInfoId',width:80,diy:function(item,$div){
	   var $a = $("<a>").html(item.userInfoId); 
	   $div.html($a);
	   $a.click(function(){
		$(document).data("skipUserId",item.userInfoId)
		$.jRadOpenTab({"id":"2010","name":"用户管理","remark":"","url":"userManage/user.html"},true);
	   });
	}});
    page_column_model.push({display: '商家简称', name : 'businessRegName',width:200,diy:function(item,$div){
	   var $a = $("<a>").html(item.businessRegName); 
	   $div.html($a);
	   $a.click(function(){
		$(document).data("checkShopId",item.businessInfoId)
		$.jRadOpenTab({'id':'3010','name':'商家信息管理','url':'shopManage/list2.html'},true);
	   });
	}});
    page_column_model.push({display: '服务名称', name : 'serviceName',width:400});
    page_column_model.push({display: '来源', name : 'remarksFrom',width:50,datasource:jRad.params['remarksFrom'].data});
    page_column_model.push({display: '服务评分', name : 'serviceLevel',width:50});
    page_column_model.push({display: '质量评分', name : 'qualityLevel',width:50}); 
	page_column_model.push({display: '评论时间', name : 'createDate',width:150}); 
	page_column_model.push({display: '图片', name : 'imgCount',width:50,diy:function(item,$div){
	   var $a = $("<a>").html(item.imgCount==0?"":item.imgCount); 
	   $div.html($a);
	   var id = item.id; 
	   $a.click(function(){ 
	      var jsonArr = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remarkService/getRemarkPicList?id='+id});
		  $("#Form_remark_check .piclist").html("");
		  var $list = $("<div>");
		  $.each(jsonArr,function(i){
			var row = $("<div>").addClass("row").data("id",jsonArr[i].id);
			var img = $("<img>").attr("src",jsonArr[i].imgUrl);
			var radio = $("<div>").addClass("jrad-radio");
			$list.append(row.append(img).append(radio)); 
			radio.radio({
			data:[{"id":"0","name":"驳回"},{"id":"1","name":"通过"}]
			}).radio('val',jsonArr[i].status);
		  });
		  $("#Form_remark_check .piclist").append($list); 
		  $("#Form_remark_check").form({item:{'remarkServiceId':item.id}}).form('open');
	   });
	}});
	page_column_model.push({display: '状态', name : 'statusName',width:80}); 
	page_column_model.push({display: '审核时间', name : 'auditTime',width:150}); 
	page_column_model.push({display: '审核人', name : 'auditPerson',width:100});  
	page_column_model.push({display: '评价', name : 'remarks'});
    
    page_search_items.push({row:'1',type:'jrad-input',display:'用户ID',name:'userInfoId'});
	page_search_items.push({row:'1',type:'jrad-input',display:'商家简称',name:'businessRegName'});
	page_search_items.push({row:'1',type:'jrad-select',display:'点评来源',name:'remarksFrom',params:{
	  data:[
	     {"id":"",name:"全部"}, 
		{"id":"0",name:"用户"},
		{"id":"1",name:"系统"},
		{"id":"2",name:"运营"}
	  ]
	}});
	page_search_items.push({row:'2',type:'jrad-select',display:'状态',name:'status',params:{
	  data:[
	     {"id":"",name:"全部"}, 
		{"id":"0",name:"未审核"},
		{"id":"1",name:"已审核"}
	  ]
	}});
	page_search_items.push({row:'2',type:'jrad-dateinput',display:'评论时间开始',name:'startDate',params:{'dateFmt':'yyyy-MM-dd HH:mm:ss'}});
	page_search_items.push({row:'2',type:'jrad-dateinput',display:'评论时间结束',name:'endDate',params:{'dateFmt':'yyyy-MM-dd HH:mm:ss'}});
	 
   $('#Form_service_remark').form({
		title: '创建',
		validators: jRad.validators,
		fields_params:jRad.params,
		item:{}, 
		height:280,
		url:'/shopmanage-ws/ws/0.1/remark/cms/add',
		success_callback:function(){ 
			$('#Table_service_remark').flexMessage('创建成功', 'success');
			$('#Table_service_remark').flexReload();
		}
	});  
  
	page_list_buttons.push({name:'delete',bclass: 'delete',prefunc:function(){
            var checked = $('#Table_service_remark').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
	    	var checked = $('#Table_service_remark').getCheckedTrs();
			$ .jRadConfirm('确认删除吗？',1,function(){
				var id =  checked[0].id; 
				$.jRadPost({
					url:'/shopmanage-ws/ws/0.1/remarkService/deleteServiceRemark?id='+id, 
					success: function(){
						$('#Table_service_remark').flexMessage('删除成功!', 'success');
           	    		$('#Table_service_remark').flexReloadSearch();
					}
				});
			});
		}
	});
 	
    page_list_buttons.push({separator: true});
    
	$('#Table_service_remark').flexigrid({
			reload:true,
			method:'get',  
			colModel : page_column_model,
			buttons : page_list_buttons,
			searchitems :page_search_items,
			showSearch:true,
			pagination: {
				diaplay_pages: 5,
				align: 'bottom' 
			},
			url:'/shopmanage-ws/ws/0.1/remarkService/queryServiceRemarks',
			onError:showServiceRemarkError,
			checkBoxType:'single',
			overflow:true
	});  
	
    $(".numb28").click(function(){
        $('.overcurtainDiv').hide();
        var menuId = $(".tabs-selected").attr("menuId")
        var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        $("#Form_explain_eg28").form({}).form('close');
        $("#Form_explain_eg28").form({
            title:'页面说明',
            item:data,
            autobinding: true, 
            submit:function(){
                var postData = {};
                postData.operator = carsmart_config.operatorName;
                postData.menuName = $(".tabs-selected").attr("menuName");
                postData.menuId = $(".tabs-selected").attr("menuId");
                postData.remark = $("#Form_explain_eg28 div[name='remark']").textarea("val")
                $.jRadPost({
                    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
                    data:postData,
                    success:function(){
                        $("#Form_explain_eg28").form('close')
                        $('.overcurtainDiv').hide();
                    }
                });
            }, 
            cancel:function(){
                $("#Form_explain_eg28").form('close')
                $('.overcurtainDiv').hide();
            }
        }).form('open')
        $("#Form_explain_eg28 .textarea-content").removeClass("span4").addClass("span12")
        $('.overcurtainDiv').hide();
        $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
    })
});
function showServiceRemarkError(xhr){
			 var errormsg = eval("(" + xhr.responseText + ")");
			  var cDiv = $("#Wraper_service_remark .cDiv");
			  $.jRadMessage({level:'error',message:errormsg[0].message,selector:cDiv});
}
</script>
