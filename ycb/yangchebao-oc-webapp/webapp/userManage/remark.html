 <div class="urlContentWraper" id="Wraper_user_remark">
    <div class="ui-info-layout">
        <h2 class="ui-tit"><strong>用户点评列表</strong><bottom class="all-work-info numb27">页面说明</bottom></h2>
        <!-- 列表显示 -->
        <div class="pic-grid">
			<table id="Table_user_remark"></table>
		</div>
    </div>
    <div id="Form_user_remark" style="display:none;">
        <div class="grid-layout-main jrad-form">
            <input name="id" type="hidden">
            <div class="row">
                 <label class="span3 grid-layout-label">商家ID：</label>
                 <div class="span6 grid-layout-content">
                       <div name="businessId" class="jrad-input-container"></div>
					   <p class="ui-note">如不知道商家ID，请在商家管理界面选择商家并通过“点评-快捷”功能为商家添加点评</p>
                       <p class="nameTips"></p>
					   </div>
					 
            </div>
            <div class="row">
                 <label class="span3 grid-layout-label">用户ID：</label>
                 <div class="span6 grid-layout-content">
                       <div name="userInfoId" class="jrad-input-container"></div>
						<p class="nameTips"></p>
						</div> 
            </div>  
            <div class="row">
                 <label class="span3 grid-layout-label">评分：</label>
                 <div class="span5 grid-layout-content">
                       <div name="level" class="jrad-select-container"></div>
                 </div>
            </div>
            
            <div class="row">
                 <label class="span3 grid-layout-label">评价内容：</label>
                 <div class="span5 grid-layout-content">
                       <div name="remarks" class="jrad-textarea-container"></div>
                                    </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container">
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
    <div id="Form_explain_eg27" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                <label class="span3 grid-layout-label">业务说明：</label>
                <div class="span12 grid-layout-content">
                    <div><strong>功能简介：</strong>用户对商家评价的展示功能。</div>
                    <div><strong>重要功能说明：</strong>无。</div>
                    <div><strong>注意事项：</strong>无。</div>
                </div> 
            </div> 
            <div class="row">
                <label class="span3 grid-layout-label">备注：</label>
                <div class="span12 grid-layout-content">
                    <div class="jrad-textarea-container" name="remark">
                    </div>
                </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>
</div>
<script type="text/javascript">
$(document).ready(function(){
    var wraper = $('#Wraper_user_remark');
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array();
	//var jRad = $.jRad('/radsample-ws','ent','Menu');	
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel});
    jRad.params['level'] = {data:[{id:'10',name:'10'},
								 {id:'8',name:'8'},
								 {id:'6',name:'6'},
								 {id:'4',name:'4'},
								 {id:'2',name:'2'}
								 ]};   
	jRad.params['remarksFrom'] = {data:[ 
							{"id":"1",name:"用户"},
							{"id":"2",name:"运营"}
						  ]};   
     
    jRad.validators['businessId'] = [{"msg":"商家id不能为空","type":"min","value":"1"},{msg:"商家id只能是数字",type:'regex',value:/^\d+$/}];
	jRad.validators['userInfoId'] = [{"msg":"用户id不能为空","type":"min","value":"1"},{msg:"用户id只能是数字",type:'regex',value:/^\d+$/}];
	jRad.validators['remarks'] = [{"msg":"内容超长","type":"max","value":"2000"}];
	
    
    page_column_model.push({display: '用户ID', name : 'userInfoId',  sortable : true,width:80});
    page_column_model.push({display: '商家简称', name : 'businessRegName',  sortable : true,width:300});
    page_column_model.push({display: '来源', name : 'remarksFrom',  sortable : true,width:50,datasource:jRad.params['remarksFrom'].data});
    page_column_model.push({display: '评分', name : 'level',  sortable : true,width:50});
	page_column_model.push({display: '评价', name : 'remarks',  sortable : true});
	page_column_model.push({display: '评论时间', name : 'createDate',sortable : true,width:150});
    
    page_search_items.push({row:'1',type:'jrad-input',display:'用户ID',name:'userInfoId'});
	page_search_items.push({row:'1',type:'jrad-input',display:'商家简称',name:'businessRegName'});
	page_search_items.push({row:'1',type:'jrad-select',display:'点评来源',name:'remarksFrom',params:{
	  data:[
	     {"id":"",name:"全部"}, 
		{"id":"1",name:"用户"},
		{"id":"2",name:"运营"}
	  ]
	}});
	page_search_items.push({row:'2',type:'jrad-dateinput',display:'评论时间开始',name:'startDate'});
	page_search_items.push({row:'2',type:'jrad-dateinput',display:'评论时间结束',name:'endDate'});
	 
   $('#Form_user_remark').form({
		title: '创建',
		validators: jRad.validators,
		fields_params:jRad.params,
		item:{}, 
		height:280,
		url:'/shopmanage-ws/ws/0.1/remark/cms/add',
		success_callback:function(){ 
			$('#Table_user_remark').flexMessage('创建成功', 'success');
			$('#Table_user_remark').flexReload();
		}
	}); 
	 
    page_list_buttons.push({title: '创建',name:'Add', bclass: 'add',onpress : function(){ 
		   $('#Form_user_remark').form({item:{}}).form('open');
			getNameTips();
        }
    });
  
	page_list_buttons.push({name:'delete',bclass: 'delete',prefunc:function(){
            var checked = $('#Table_user_remark').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
	    	var checked = $('#Table_user_remark').getCheckedTrs();
			$ .jRadConfirm('确认删除吗？',1,function(){
				var id =  checked[0].id; 
				$.jRadPost({
					url:'/shopmanage-ws/ws/0.1/remark/delete?id='+id, 
					success: function(){
						$('#Table_user_remark').flexMessage('删除成功!', 'success');
           	    		$('#Table_user_remark').flexReload();
					}
				});
			});
		}
	});
 	
    page_list_buttons.push({separator: true});
     var reloadFlag = false;
   //用户管理-查看点评
	if($(document).data('userRemarkId')!=undefined & $(document).data('remarkShopId')!=''){
		var id = $(document).data('userRemarkId'); 
		$(document).removeData('userRemarkId');     
	    var queryParamJson = {"userInfoId":id};
		getRemarkList(queryParamJson);
		$('.sDiv div[name="userInfoId"]',wraper).input('val',id);
		reloadFlag = true;
	}
	//商家管理-查看点评
	if($(document).data('shopRemarkName')!=undefined & $(document).data('shopRemarkName')!=''){
		var name = $(document).data('shopRemarkName'); 
		$(document).removeData('shopRemarkName');     
	    var queryParamJson = {"businessRegName":name};
		getRemarkList(queryParamJson);
		$('.sDiv div[name="businessRegName"]',wraper).input('val',name);
		reloadFlag = true;
	}
	
	if(!reloadFlag){
		getRemarkList({});
	}
    function getRemarkList(json){
		$('#Table_user_remark').flexigrid({
				reload:true,
				method:'get', 
				queryParam:json,
				colModel : page_column_model,
				buttons : page_list_buttons,
				searchitems :page_search_items,
				showSearch:true,
				pagination: {
					diaplay_pages: 5,
					align: 'bottom' 
				},
				url:'/shopmanage-ws/ws/0.1/remark/cms/page',
				onError:showRemarkError,
				checkBoxType:'single'
		});  
	}
	if($(document).data('remarkShopId')!=undefined & $(document).data('remarkShopId')!=''){
		  var id = $(document).data('remarkShopId');
		  $('#Form_user_remark').form({item:{'businessId':id}}).form('open');
		  $(document).removeData('remarkShopId');
		   getNameTips();		 
		   var json = $.jRadGet({url:'/shopmanage-ws/ws/0.1/shopmanage/shop/name?id='+id});
		  $("#Form_user_remark div[name='businessId']").parent().children(".nameTips").html(json.businessName);
	} 
	function getNameTips(){
				$("#Form_user_remark .nameTips").html("");
				$("#Form_user_remark div[name='businessId']").focusout(function(){ 
					 var flag = $("#Form_user_remark div[name='businessId']").input('validate',jRad.validators["businessId"]);
					 if(flag){
					   var id = $(this).input("val");
					   var _tip = $(this).parent().children(".nameTips");
					   var json = $.jRadGet({
								url:'/shopmanage-ws/ws/0.1/shopmanage/shop/name?id='+id, 
								success: function(data){ 
									_tip.html(data.businessName).css("color","#1F2228"); 
								},
								error:function(){ 
									_tip.html("查询商家不存在！").css("color","#BB4B47"); 
								}
							});
					   
					 }else{
					   $(this).parent().children(".nameTips").html("");
					 }
				}); 
			$("#Form_user_remark div[name='userInfoId']").focusout(function(){ 
					 var flag = $("#Form_user_remark div[name='userInfoId']").input('validate',jRad.validators["userInfoId"]);
					 if(flag){
					   var id = $(this).input("val");
					   var _tip = $(this).parent().children(".nameTips");
					   $.jRadGet({
								url:'/shopmanage-ws/ws/0.1/user/getNameById?id='+id, 
								success: function(data){
									_tip.html(data.userName).css("color","#1F2228"); 
								},
								error:function(){ 
									_tip.html("查询用户不存在！").css("color","#BB4B47"); 
								}
							});
					   
					 }else{
					   $(this).parent().children(".nameTips").html("");
					 }
				});
	}
	
    $(".numb27").click(function(){
        $('.overcurtainDiv').hide();
        var menuId = $(".tabs-selected").attr("menuId")
        var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        $("#Form_explain_eg27").form({}).form('close');
        $("#Form_explain_eg27").form({
            title:'页面说明',
            item:data,
            autobinding: true, 
            submit:function(){
                var postData = {};
                postData.operator = carsmart_config.operatorName;
                postData.menuName = $(".tabs-selected").attr("menuName");
                postData.menuId = $(".tabs-selected").attr("menuId");
                postData.remark = $("#Form_explain_eg27 div[name='remark']").textarea("val")
                $.jRadPost({
                    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
                    data:postData,
                    success:function(){
                        $("#Form_explain_eg27").form('close')
                        $('.overcurtainDiv').hide();
                    }
                });
            }, 
            cancel:function(){
                $("#Form_explain_eg27").form('close')
                $('.overcurtainDiv').hide();
            }
        }).form('open')
        $("#Form_explain_eg27 .textarea-content").removeClass("span4").addClass("span12")
        $('.overcurtainDiv').hide();
        $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
    })
});
function showRemarkError(xhr){
			 var errormsg = eval("(" + xhr.responseText + ")");
			  var cDiv = $("#Wraper_user_remark .cDiv");
			  $.jRadMessage({level:'error',message:errormsg[0].message,selector:cDiv});
			}
</script>
