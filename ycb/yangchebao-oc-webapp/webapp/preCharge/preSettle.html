<div class="urlContentWraper" id="Wraper_preSettle">
    <div class="ui-info-layout">
      <div class="cdiv">
           <h2 class="ui-tit"><strong>代理商结算列表</strong></h2>
           <table id="Table_preSettle"></table>
      </div>
      <div class="sdiv" style="margin-top:10px;">
           <h2 class="ui-tit"><strong>结算详情</strong></h2>
           <table id="Table_preSettleDetail"></table>
      </div>
    </div>
    <!-- 备注 -->
    <div id="Form_preSettle_remark" style="display:none;">
        <div class="grid-layout-main jrad-form">  
          <div class="row-fluid">
             <label class="span4 grid-layout-label">备注详情：</label>
             <div class="span5 grid-layout-content">
                 <div name="remark" class="jrad-textarea-container"></div>
             </div>
          </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span>
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>   
</div>
<script type="text/javascript">
$(document).ready(function(){
    var wraper = $('#Wraper_preSettle');
    var page_column_model = new Array();
    var page_column_model_c = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array();
    var page_list_buttons_c = new Array();
  	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel}); 
    jRad.params['provinceCodeSearch'] = {
      urlData:{
        url:'/euc/ws/0.1/user/provinces?userId='+carsmart_config.userId
      },
      unshiftData: {id:'',name:'请选择'}
    };
    jRad.params['status'] = {data:[{id:'',name:'全部'},{id:'0',name:'未转账'},{id:'1',name:'已转账'}]};
    $('#Form_preSettle_remark div[name="remark"]',wraper).textarea({
    	 title: '添加备注',          fluid: true,         autobinding:true
    });

   $('#Form_preSettle_remark').form({
      fluid: true,
      grid:12,
      autobinding:true
    });

    page_column_model.push({display: 'ID', name : 'agentWithdrawId'}); 
    page_column_model.push({display: '代理商账号', name : 'userName'}); 
	page_column_model.push({display: '代理商省', name : 'agentCityName',diy:function(item,$div){
      var str='';
      var area=item.agentCityName;
      $.each(area,function(i){
        if(area[i].provinceName!=null && area[i].provinceName!=undefined){
          str += area[i].provinceName
        }
        if(area[i].areaList!=null && area[i].areaList!=undefined){
          $.each(area[i].areaList,function(j){
            str += area[i].areaList[j].areaCodeName
          })
        }
        
      })
      $div.html(str)
    }});

    page_column_model.push({display: '开户行', name : 'bankName'});
    page_column_model.push({display: '开户名', name : 'cardName'});
    page_column_model.push({display: '银行账户', name : 'cardNo'});
    page_column_model.push({display: '转账金额', name : 'realTransAmount'});
    page_column_model.push({display: '状态', name : 'transferStatusDesc'});
    
    page_column_model.push({display: '结算周期（月）', name : 'billingPeriod'});
    page_column_model.push({display: '转账时间', name  : 'transferDate'});
  	page_column_model.push({display: '数据生成时间', name  : 'createDate'});
  	
    page_column_model.push({display: '最后操作时间', name  : 'updateTime'});

    page_column_model.push({display: '最后操作人', name  : 'operator'});
	
    
   page_search_items.push({row:'1',type:'jrad-input',display:'代理商账号',name:'userName'}); 
   page_search_items.push({row:'1',type:'jrad-select',display:'代理省',name:'provinceId',params:jRad.params['provinceCodeSearch']}); 
   page_search_items.push({row:'1',type:'jrad-select',display:'状态',name:'transferStatus',params:jRad.params['status']}); 
   page_search_items.push({row:'2',type:'jrad-dateinput',display:'转账时间始',name:'transferStartDate'}); 
   page_search_items.push({row:'2',type:'jrad-dateinput',display:'转账时间终',name:'transferEndDate'}); 
   page_search_items.push({row:'2',type:'jrad-input',display:'最后操作人',name:'operator'}); 
   page_search_items.push({row:'3',type:'jrad-dateinput',display:'数据生成时间始',name:'createStartDate'}); 
   page_search_items.push({row:'3',type:'jrad-dateinput',display:'数据生成时间终',name:'createEndDate'}); 
   page_search_items.push({row:'4',type:'jrad-dateinput',display:'最后操作时间始',name:'operStartDate'}); 
   page_search_items.push({row:'4',type:'jrad-dateinput',display:'最后操作时间终',name:'operEndDate'}); 

	page_list_buttons.push({title: '导出Excel',displayname:'导出EXCEL',name:'excel', bclass: 'excel',onpress : function(){
        	var checked = $('#Table_preSettle').getCheckedTrs();
        	$.jRadConfirm('确认导出？',1,function(){
        		   var param = {};
                   var userName = $.trim($(".searchContent div[name='userName']",wraper).input('val'));
                   if(userName!=""){
                    param['userName'] = userName;
                   };
                   var provinceId = $.trim($(".searchContent div[name='provinceId']",wraper).select('val'));
                   if(provinceId!=""){
                    param['provinceId'] = provinceId;
                   };
                    var transferStatus = $.trim($(".searchContent div[name='transferStatus']",wraper).select('val'));
                   if(transferStatus!=""){
                    param['transferStatus'] = transferStatus;
                   };
                   var transferStartDate = $.trim($(".searchContent div[name='transferStartDate']",wraper).dateinput('val'));
                   if(transferStartDate!=""){
                    param['transferStartDate'] = transferStartDate;
                   };
                   var operator = $.trim($(".searchContent div[name='operator']",wraper).input('val'));
                   if(operator!=""){
                    param['operator'] = operator;
                   };
                   var createStartDate = $.trim($(".searchContent div[name='createStartDate']",wraper).dateinput('val'));
                   if(createStartDate!=""){
                    param['createStartDate'] = createStartDate;
                   };
                   var createEndDate = $.trim($(".searchContent div[name='createEndDate']",wraper).dateinput('val'));
                   if(createEndDate!=""){
                    param['createEndDate'] = createEndDate;
                   };
                   var operStartDate = $.trim($(".searchContent div[name='operStartDate']",wraper).dateinput('val'));
                   if(operStartDate!=""){
                    param['operStartDate'] = operStartDate;
                   };
                   var operEndDate = $.trim($(".searchContent div[name='operEndDate']",wraper).dateinput('val'));
                   if(operEndDate!=""){
                    param['operEndDate'] = operEndDate;
                   };
                    var paramUrl='';
                   if(param!={}){   
                	     paramUrl+="?"
                	     $.each(param,function(k,v){ 
                          paramUrl+="&"+k+"="+v; 
                        });
                   }
                 window.open('/shopmanage-ws/ws/0.1/agentManager/exportCoopBusiDetai'+paramUrl);    
        	})
		}
	});
  page_list_buttons.push({separator: true});
    
    $('#Table_preSettle').flexigrid({
            reload:true,
      			method:'get',
            colModel : page_column_model,
            buttons : page_list_buttons,
            searchitems :page_search_items,
            pagination: {
      				diaplay_pages: 5,
      				align: 'bottom' 
      			},
      			showSearch:true,  
            url:'/shopmanage-ws/ws/0.1/agentManager/coopBusiBillingStatic', //此时userId为当前登录用户的ID 
      			onError:showError, 
      			checkBoxType:'single',
      			overflow:true
,
				trEvent:function(){		//监听行事件 
			 	var checked = $('#Table_preSettle').getCheckedTrs();  
			 	$('#Table_preSettleDetail').flexOptions({ 
			 		extParam:{
			 			agentWithdrawId: checked[0].agentWithdrawId
			 		}
			 	}).flexReload()
			 }
    });

  	page_column_model_c.push({display: 'ID', name : 'id'});
	page_column_model.push({display: '代理市', name : 'agentCityName',diy:function(item,$div){
      var str='';
      var area=item.agentCityName;
      $.each(area,function(i){
        //if(area[i].provinceName!=null && area[i].provinceName!=undefined){
        //  str += area[i].provinceName
        //}
        if(area[i].areaList!=null && area[i].areaList!=undefined){
          $.each(area[i].areaList,function(j){
            str += area[i].areaList[j].areaCodeName
          })
        }
        
      })
      $div.html(str)
    }});

	page_column_model_c.push({display: '代理商市', name : 'agentCityName',diy:function(item,$div){
	      var str='';
	      var area=item.agentCityName;
	      $.each(area,function(i){
	        if(area[i].areaList!=null && area[i].areaList!=undefined){
	          $.each(area[i].areaList,function(j){
	            str += area[i].areaList[j].areaCodeName+"、";
	          })
	        }
	        
	      })
	      var length = str.length;
	      $div.html(str.substr(0,length-1))
	    }});
  	page_column_model_c.push({display: '商家ID', name : 'busiId'});
  	page_column_model_c.push({display: '商家简称', name : 'busiRegName'});
  	page_column_model_c.push({display: '预付款支付', name : 'agentPayAmount'});
    page_column_model_c.push({display: '养车宝收取', name : 'ycbRecAmount'});
  	page_column_model_c.push({display: '省代理收取', name : 'parentRecAmount'});
    page_column_model_c.push({display: '购买时间', name : 'createDate'});
    page_column_model_c.push({display: '到期时间', name : 'coopEndDate'});
    page_column_model_c.push({display: '状态', name : 'transferStatusDesc'});
    page_column_model_c.push({display: '最后操作时间', name : 'updateDate'});
    page_column_model_c.push({display: '最后操作人', name : 'operator'});
    page_column_model_c.push({display: '备注',  name : 'remark', width:130,diy:function(item,$div){
      var addRemark = $('<a>').addClass('addRemark').css('margin-left','1px').html('添加');
      var checkRmark = $('<a>').addClass('checkRmark').css('margin-left','10px').html('查看详情');
      $div.html(addRemark.after(checkRmark));      
      $('a.addRemark',$div).unbind('click').bind('click',function(){
        $('#Form_preSettle_remark',wraper).form({
          url:'/shopmanage-ws/ws/0.1/agentManager/saveCoopBusiBillingDetailRemark',
          item:{},
          before_submit:function(json){
            json.operator = carsmart_config.operatorName;
            json.id = item.id;
            return json;
          },
          success_callback:function(){
            $('#Table_preSettleDetail',wraper).flexMessage('添加成功', 'success');
            $('#Table_preSettleDetail',wraper).flexReload()
          }
        }).form('open');
        $('div[name="remark"]').textarea('val',item.remark);        $('div[name="remark"]').textarea('readonly',false);
        $('#Form_preSettle_remark div.ui-buttons-container',wraper).show()
      });
      $('a.checkRmark',$div).unbind('click').bind('click',function(){
    	  $("#Form_preSettle_remark").form('open');

          $('div[name="remark"]').textarea('val',item.remark);

          $('div[name="remark"]').textarea('readonly',true);
  	    
        $('#Form_preSettle_remark div.ui-buttons-container',wraper).hide()
     })
    }
    });

    page_list_buttons_c.push({title: '设为已转账',displayname:'设为已转账',name:'transAccount', bclass: 'transAccount',prefunc:function(){
            var checked = $('#Table_preSettleDetail',wraper).getCheckedTrs();
            if (checked.length == 0) {return false;}else{return true;}
        },onpress : function(){
          var checked = $('#Table_preSettleDetail').getCheckedTrs();
          var postData={};
          var arr=[];
          $.each(checked,function(i){
              var id=checked[i].id;
              arr.push(id);
          });
          var ids=arr.join(',');
          postData.ids=ids;
          postData.operator=carsmart_config.operatorName;
          $.jRadConfirm('确认设为已转账？',1,function(){
             $.jRadPost({
              url:'/shopmanage-ws/ws/0.1/agentManager/setCoopBusiTransStatic',
              data:postData,
              success:function(){
                $('#Table_preSettleDetail',wraper).flexMessage('成功设为已转账', 'success');
                $('#Table_preSettleDetail',wraper).flexReload()
              }
             })
          })
    }
  });
  page_list_buttons_c.push({separator: true});

    $('#Table_preSettleDetail').flexigrid({
            reload:true,
            autoload: false,
      			method:'get',
            colModel : page_column_model_c,
            buttons : page_list_buttons_c,
            searchitems: [],
            pagination: {
      				diaplay_pages: 5,
      				align: 'bottom' 
      			},
      			showSearch:true,  
      			overflow:true,
            url:'/shopmanage-ws/ws/0.1/agentManager/coopBusiBillingDetails', 
      			onError:showError_2, 
      			checkBoxType:'single'
    });
  	function showError(xhr){
  		 var errormsg = eval("(" + xhr.responseText + ")"); 
  		 $.jRadMessage({level:'error',message:errormsg[0].message})
  	}
  	function showError_2(xhr){
  		 var errormsg = eval("(" + xhr.responseText + ")"); 
  		 $.jRadMessage({level:'error',message:errormsg[0].message})
  	}
});
</script>
