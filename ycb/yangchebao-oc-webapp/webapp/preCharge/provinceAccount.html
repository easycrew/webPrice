<style type="text/css">
.bank .ui-autocomplete-btn{
  display:none;
}
#Form_opration_log table td,#Form_opration_log table th{
  padding: 5px 0;
  text-align: center;
}
</style>
<div class="urlContentWraper" id="Wraper_provinceAccount">
    <div class="ui-info-layout">
      <div class="cdiv">
           <h2 class="ui-tit"><strong>省代理商收款账号列表</strong></h2>
           <table id="Table_provinceAccount"></table>
      </div>
    </div>
    <!-- 创建&修改 -->
    <div id="Form_provinceAccount" style="display:none;">
        <div class="grid-layout-main jrad-form">    
    			<div class="row"> 
    				<label class="span3 grid-layout-label"><span class="ui-form-required">*</span>代理账号：</label>
    				<div class="span6 grid-layout-content fluid-wrap">
    					<div name="userName" class="jrad-input-container">
    					</div> 
    				</div>
            <label class="span3 grid-layout-label"><span class="ui-form-required">*</span>账号类型：</label>
            <div class="span6 grid-layout-content fluid-wrap">
              <div name="type" class="jrad-select-container">
              </div> 
            </div>
    			</div> 
          <div class="row"> 
            <label class="span3 grid-layout-label"><span class="ui-form-required">*</span>省：</label>
            <div class="span6 grid-layout-content fluid-wrap">
              <div name="provinceId" class="jrad-select-container">
              </div> 
            </div>
            <label class="span3 grid-layout-label"><span class="ui-form-required">*</span>市：</label>
            <div class="span6 grid-layout-content fluid-wrap">
              <div name="areaCodeId" class="jrad-select-container">
              </div> 
            </div>
          </div>
          <div class="row"> 
            <label class="span3 grid-layout-label"><span class="ui-form-required">*</span>银行：</label>
            <div class="span6 grid-layout-content fluid-wrap bank">
              <div name="bankId" class="jrad-autocomplete-container">
              </div> 
            </div>
            <label class="span3 grid-layout-label"><span class="ui-form-required">*</span>开户分行：</label>
            <div class="span6 grid-layout-content fluid-wrap">
              <div name="bankBranch" class="jrad-input-container">
              </div> 
            </div>
          </div>
          <div class="row"> 
            <label class="span3 grid-layout-label"><span class="ui-form-required">*</span>账号：</label>
            <div class="span6 grid-layout-content fluid-wrap">
              <div name="bankAccount" class="jrad-input-container">
              </div> 
            </div>
            <label class="span3 grid-layout-label"><span class="ui-form-required">*</span>结算周期：</label>
            <div class="span6 grid-layout-content fluid-wrap">
              <div name="billingPeriod" class="jrad-input-container" placeholder="请输入月数">
              </div> 
            </div>
          </div>
          <div class="row"> 
            <label class="span3 grid-layout-label"><span class="ui-form-required">*</span>重复账号：</label>
            <div class="span6 grid-layout-content fluid-wrap">
              <div name="repeatBankAccount" class="jrad-input-container">
              </div> 
            </div>
          </div>
          <div class="row"> 
            <label class="span3 grid-layout-label"><span class="ui-form-required">*</span>户主姓名：</label>
            <div class="span6 grid-layout-content fluid-wrap">
              <div name="accountHolder" class="jrad-input-container">
              </div> 
            </div>
          </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span>
      			<span class="jrad-btn-normal">取消</span>
        </div>
    </div>  
    <!-- 操作日志 -->
    <div id="Form_opration_log" style="display:none;">
        <div class="grid-layout-main jrad-form">  
  			<table id="Table_opration_log">
  	        	<tr>
  	        		<th>ID</th>
  	        		<th>详细操作</th>
  	        		<th>操作时间</th>
  	        		<th>操作人</th>
  	        	</tr>
        	</table>
        </div> 
    </div>  
</div>
<script type="text/javascript">
$(document).ready(function(){
    var wraper = $('#Wraper_provinceAccount');
    var page_column_model = new Array();
    var page_column_model_c = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array();
  	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel}); 

    jRad.params['provinceId'] = {
      urlData:{
        url:'/euc/ws/0.1/user/provinces?userId='+carsmart_config.userId
      },
      unshiftData: {id:'',name:'请选择'},
      onchange: function(){
        var provinceCode = $('#Form_provinceAccount div[name=provinceId]',wraper).select('val'); 
        if(provinceCode==''){ 
          $('#Form_provinceAccount div[name=areaCodeId]',wraper).select({
                                  urlData:{url:''},
                                  data:[{id:'',name:'请选择'}]});
        }else{  
        $('#Form_provinceAccount div[name=areaCodeId]',wraper).select({ 
          urlData:{
             url:'/euc/ws/0.1/user/cities?provinceId='+provinceCode+'&userId='+carsmart_config.userId
          },
          unshiftData: {id:'',name:'请选择'}
        }).select('val','');
        }
      }
    };
    jRad.params['areaCodeId'] = {
      data: [{id:'',name:'请选择'}] 
    };
    jRad.params['type'] = {
      data:[{id:'',name:'请选择'},{id:'1',name:'省代理'},{id:'2',name:'市代理'}]
    };
    jRad.params['bankId'] = { 
          //url:'/shopmanage-ws/ws/0.1/bank/getBankList', 
          url:'/vip-ws/ws/0.1/bank/getBankList',
          queryParam:'name',
          fl: 'name',
          displayField:'name',
          valueField:'id',
          defaultValue: '',
      response: function(data){
        return data;
      }   
    }; 


   $('#Form_provinceAccount',wraper).form({
  		fluid: true,
      grid:22,
  		autobinding:true
  	});
   $('#Form_opration_log',wraper).form({
      fluid: true,
      grid:14,
      autobinding:true
    });
    page_column_model.push({display: '代理商账号', name : 'userName'});  
    page_column_model.push({display: '代理商省市', name : 'agentCityName',diy:function(item,$div){

        var str='';

        var area=item.agentCityName;

        $.each(area,function(i){

          if(area[i].provinceName!=null && area[i].provinceName!=undefined){

            str += area[i].provinceName

          }

          if(area[i].areaList!=null && area[i].areaList!=undefined){

            $.each(area[i].areaList,function(j){

              str += area[i].areaList[j].areaCodeName

            })

          }

          

        })

        $div.html(str)

      }}); 
    page_column_model.push({display: '账号类型', name : 'typeDesc'});
    page_column_model.push({display: '开户省市', diy:function(item,$div){
      $div.html(item.proName+item.areaCodeName)
    }});
    page_column_model.push({display: '户主姓名', name : 'accountHolder'});
  	page_column_model.push({display: '银行账号', name : 'bankAccount'});
    page_column_model.push({display: '开户行', name : 'bankName'});
  	page_column_model.push({display: '开户行Id', name : 'bankId',hidden:true});
  	page_column_model.push({display: '结算周期', name : 'billingPeriod'});
    page_column_model.push({display: '创建时间', name : 'createDate'});
  	page_column_model.push({display: '操作日志', diy:function(item,$div){
      var a_detail = $('<a>').attr('href','javascript:').html('详情');
      $div.html(a_detail);
      $div.find('a').unbind('click').bind('click',function(){
          $.jRadGet({
              url:'/shopmanage-ws/ws/0.1/agentManager/bankOperRecords?agentId='+item.agentId,
              success:function(data){
                  $("#Form_opration_log").form({
                      title:"操作日志",
                      success_callback:function(){
                          $('#Form_opration_log').flexReload();
                      }
                  }).form('open');
                  $("#Form_opration_log table td",wraper).parent().remove();
                  var str="";
                  $.each(data,function(i){
                      var _item=data[i];
                      str+="<tr>"
                          +"<td>"+_item.id+"</td>"
                          +"<td style='text-align:left;padding-left:10px;'>&nbsp;&nbsp;&nbsp;&nbsp;"+_item.beforeOperCardUserName+'<br>&nbsp;&nbsp;&nbsp;&nbsp;'
                                 +_item.beforeOperCardProvice+_item.beforeOperCardAread+_item.beforeOperBankBranchName+'<br>&nbsp;&nbsp;&nbsp;&nbsp;'
                                 +_item.beforeOperCardNo+'<br>->'
                                 +_item.afterOperCardUserName+'<br>&nbsp;&nbsp;&nbsp;&nbsp;'
                                 +_item.afterOperCardProvice+_item.afterOperCardAread+_item.afterOperBankName+_item.afterOperBankBranchName+'<br>&nbsp;&nbsp;&nbsp;&nbsp;'
                                 +_item.afterOperCardNo
                          +"</td>"
                          +"<td>"+_item.createTime+"</td>"
                          +"<td>"+_item.operater+"</td>"
                          +"</tr>";
                  });
                  $("#Form_opration_log table",wraper).append(str);
              },
                    error:function(xhr){
                          var errormsg = eval("(" + xhr.responseText + ")"); 
                          if (errormsg != undefined) {
                              $('#Form_opration_log').flexMessage(errormsg[0].message, 'error');
                          } 
                    }
          })
      });
    }});
	
    
   page_search_items.push({row:'1',type:'jrad-input',display:'代理商账号',name:'userName'}); 
   page_search_items.push({row:'1',type:'jrad-select',display:'账号类型',name:'type',params:{data:[{id:'',name:'请选择'},{id:'1',name:'省代理'},{id:'2',name:'市代理'}]}}); 
   page_search_items.push({row:'1',type:'jrad-input',display:'结算周期',name:'billingPeriod'}); 
   page_search_items.push({row:'2',type:'jrad-input',display:'户主姓名',name:'accountHolder'}); 
   page_search_items.push({row:'2',type:'jrad-input',display:'银行账号',name:'bankAccount'}); 

   page_list_buttons.push({title: '创建',displayname:'创建',name:'add', bclass: 'add',onpress : function(){
	      $("#Form_provinceAccount div[name='userName']").input("readonly","");
          $("#Form_provinceAccount div[name='type']").select("readonly","");
    				var form = $('#Form_provinceAccount',wraper);
    			
    				form.form({
        					title:'创建',
        				 fields_params: jRad.params,
	                item:{},
	                url:'/shopmanage-ws/ws/0.1/agentManager/agentBankSave',
	                before_submit:function(json){
	                	json.operator = carsmart_config.operatorName;
	                	return json
	                },
	                success_callback:function(data){ 
          						$('#Table_provinceAccount',wraper).flexMessage('创建成功', 'success');
          						$('#Table_provinceAccount',wraper).flexReload()
        					}  
            	}).form('open')
            	
		}
	});
	 page_list_buttons.push({title: '修改',displayname:'修改',name:'edit', bclass: 'edit',prefunc:function(){
            var checked = $('#Table_provinceAccount').getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
				 var form = $('#Form_provinceAccount',wraper);
				 var checked = $('#Table_provinceAccount').getCheckedTrs();
         checked[0].bankId={id:checked[0].bankId,name:checked[0].bankName};
				 form.form({
        					title:'修改', 
                  fields_params: jRad.params,
	                item:checked[0],
	                url:'/shopmanage-ws/ws/0.1/agentManager/agentBankSave',
	                before_submit:function(json){
	                	json.operator = carsmart_config.operatorName;
	                	return json
	                },
	                success_callback:function(){
	                	$('#Table_provinceAccount',wraper).flexMessage('修改成功','success');
	                	$('#Table_provinceAccount',wraper).flexReload()
	                }
            	}).form('open')
                $("#Form_provinceAccount div[name='userName']").input("readonly","true");
				$("#Form_provinceAccount div[name='type']").select("readonly","true");

		}
	}); 
  page_list_buttons.push({separator: true});
    
    $('#Table_provinceAccount').flexigrid({
            reload:true,
      			method:'get',
            colModel : page_column_model,
            buttons : page_list_buttons,
            searchitems :page_search_items,
            pagination: {
      				diaplay_pages: 5,
      				align: 'bottom' 
      			},
      			showSearch:true,  
            url:'/shopmanage-ws/ws/0.1/agentManager/agentBankList', //此时userId为当前登录用户的ID 
      			onError:showError, 
      			checkBoxType:'single',
      			overflow:true
    });

  	function showError(xhr){
  		 var errormsg = eval("(" + xhr.responseText + ")"); 
  		 $.jRadMessage({level:'error',message:errormsg[0].message})
  	}
});
</script>
