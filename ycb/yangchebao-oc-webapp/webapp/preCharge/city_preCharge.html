<style>
  #Form_cityTransaction_flow td,#Form_cityTransaction_flow th{
    text-align: center;
  }
</style>
<div class="urlContentWraper" id="Wraper_cityCharge">
    <div class="ui-info-layout">
      <div class="cdiv">
           <h2 class="ui-tit"><strong>预付款管理列表</strong></h2>
           <table id="Table_cityCharge"></table>
      </div>
    </div>
    <!-- 充值 -->
    <div id="Form_cityCharge_recharge" style="display:none;">
    <form action="/shopmanage-ws/ws/0.1/agentManager/genPayAgentOrder" method="get" target="_blank" id="cityChargeForm" name="cityChargeForm">
        <div class="grid-layout-main jrad-form">  
          <div class="row"> 
            <label class="span3 grid-layout-label"> 充值金额：</label>
            <div class="span4 grid-layout-content fluid-wrap">
              <div name="money" class="jrad-input-container">
              </div> 
            </div><span style="position:relative;left:10px;top:3px;"> 元</span>
          </div> 
          <div class="row"> 
            <label class="span3 grid-layout-label"> 充值方式：</label>
            <div class="span14 grid-layout-content fluid-wrap">
              <div name="defaultbank" class="jrad-radio-container">
              </div> 
            </div>
          </div> 
        </div>
      </form>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary ui-btn-primary">确定</span>
            <span class="jrad-btn-normal ui-btn-normal">取消</span>
        </div>
    </div>  
    <!-- 交易流水 -->
    <div id="Form_cityTransaction_flow" style="display:none;">
        <div class="grid-layout-main jrad-form">  
  			<table id="Table_cityTransaction_flow">
  	        	<tr>
  	        		<th>变动金额</th>
  	        		<th>变动后金额</th>
  	        		<th>变动方式</th>
  	        		<th>变动时间</th>
  	        	</tr>
        	</table>
          <div class="pagation"></div>
        </div> 
    </div>  
</div>
<script type="text/javascript">
$(document).ready(function(){
    var wraper = $('#Wraper_cityCharge');
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array();
  	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel}); 
    var regions=eval('('+carsmart_config.regions+')');
    if(regions[0].areaCodeId=='0'){
      $('#Wraper_cityCharge').html('您不是市代理商，请到“预付款管理”查看相关信息！');
      return false
    }
    jRad.validators['money']=[
      {msg:'充值金额不能为空',type:'min',value:'1'},
      {msg:'请填写正数且最多精确到小数点后两位',type:'regex',value:/^(([0-9]+.(([0-9]{0,1}[1-9])|([1-9][0-9])))|([0-9]*[1-9][0-9]*.[0-9]{1,2})|([0-9]*[1-9][0-9]*))$/}
    ];
    jRad.params['defaultbank'] = {data:[
      {id:'',name:'支付宝'},
      {id:'ICBCB2C',name:'中国工商银行'},
      {id:'ABC',name:'中国农业银行'},
      {id:'BOCB2C',name:'中国银行'},
      {id:'CCB',name:'中国建设银行'},
      {id:'CMB',name:'招商银行'},
      {id:'PSBC',name:'中国邮政储蓄银行'},
      {id:'COMM',name:'交通银行'},
      {id:'SHBANK',name:'上海银行'},
      {id:'CEB',name:'中国光大银行'},
      {id:'CMBC',name:'中国民生银行'},
      {id:'SPABANK',name:'平安银行'},
      {id:'SPDB',name:'浦发银行'},
      {id:'GDB',name:'广发银行'},
      {id:'CIB',name:'兴业银行'},
      {id:'BJBANK',name:'北京银行'},
      {id:'BJRCB',name:'北京农商银行'},
      {id:'CITIC',name:'中信银行'}]};

   $('#Form_cityCharge_recharge').form({
      fluid: true,
      grid:18,
      fields_params:jRad.params,
      autobinding:false
    });
   $('#Form_cityTransaction_flow').form({
      title:'交易流水',
      fluid: true,
      grid:14,
      autobinding:true
    });
   
    page_column_model.push({display: '商家ID', name : 'busiId'});  
    page_column_model.push({display: '商家简称', name : 'busiRegName'}); 
    page_column_model.push({display: '预付款支付', name : 'agentPayAmount'});
    page_column_model.push({display: '购买时间', name : 'coopStartDate'});
    page_column_model.push({display: '到期时间', name : 'coopEndDate'});
	
    
   page_search_items.push({row:'1',type:'jrad-input',display:'商家ID',name:'busiId'}); 
   page_search_items.push({row:'1',type:'jrad-input',display:'商家简称',name:'busiRegName'}); 

	 page_list_buttons.push({title: '充值',displayname:'充值',name:'recharge', bclass: 'recharge',onpress : function(){
				 var form = $('#Form_cityCharge_recharge',wraper);
				 form.form({
        					title:'充值', 
	                item:{},
                  validators:jRad.validators
            	}).form('open');
              $('div[name="defaultbank"] div[data-id=""] label',form).html('<img src="preCharge/img/alipay.png">');
              $('div[name="defaultbank"] div[data-id="ICBCB2C"] label',form).html('<img src="preCharge/img/ICBC.png">');
              $('div[name="defaultbank"] div[data-id="ABC"] label',form).html('<img src="preCharge/img/ABC.png">');
              $('div[name="defaultbank"] div[data-id="BOCB2C"] label',form).html('<img src="preCharge/img/BOCB2C.png">');
              $('div[name="defaultbank"] div[data-id="CCB"] label',form).html('<img src="preCharge/img/CCB.png">');
              $('div[name="defaultbank"] div[data-id="CMB"] label',form).html('<img src="preCharge/img/CMB.png">');
              $('div[name="defaultbank"] div[data-id="PSBC"] label',form).html('<img src="preCharge/img/PSBC.png">');
              $('div[name="defaultbank"] div[data-id="COMM"] label',form).html('<img src="preCharge/img/COMM.png">');
              $('div[name="defaultbank"] div[data-id="SHBANK"] label',form).html('<img src="preCharge/img/SHBANK.png">');
              $('div[name="defaultbank"] div[data-id="CEB"] label',form).html('<img src="preCharge/img/CEB.png">');
              $('div[name="defaultbank"] div[data-id="CMBC"] label',form).html('<img src="preCharge/img/CMBC.png">');
              $('div[name="defaultbank"] div[data-id="SPABANK"] label',form).html('<img src="preCharge/img/SPABANK.png">');
              $('div[name="defaultbank"] div[data-id="SPDB"] label',form).html('<img src="preCharge/img/SPDB.png">');
              $('div[name="defaultbank"] div[data-id="GDB"] label',form).html('<img src="preCharge/img/GDB.png">');
              $('div[name="defaultbank"] div[data-id="CIB"] label',form).html('<img src="preCharge/img/CIB.png">');
              $('div[name="defaultbank"] div[data-id="BJBANK"] label',form).html('<img src="preCharge/img/BJBANK.png">');
              $('div[name="defaultbank"] div[data-id="BJRCB"] label',form).html('<img src="preCharge/img/BJRCB.png">');
              $('div[name="defaultbank"] div[data-id="CITIC"] label',form).html('<img src="preCharge/img/CITIC.png">');
              $('div[name="defaultbank"] div.ui-radio',form).css('margin-bottom','15px');
              $('div[name="defaultbank"]',form).find('input').attr('name','defaultbank');
              $('#Form_cityCharge_recharge div.ui-radio',wraper).addClass('span4');
              $('#Form_cityCharge_recharge span.jrad-btn-primary',wraper).unbind('click').bind('click',function(){
                var flag=form.form('validateAll');
                
                if(flag){
                  if($('div[name="money"]',wraper).input('val')>500000){
                    var _error=$('<div>').addClass('ui-field-error').css('display','inline-block').append('<div class="ui-field-msg">金额不能超出50万元</div>');
                    $('div[name="money"]',wraper).after(_error);
                    return false
                  }
                  // var money=$('#Form_cityCharge_recharge div[name="money"]',wraper).input('val');
                  // var defaultbank=$('#Form_cityCharge_recharge div[name="defaultbank"]',wraper).radio('val');
                  form.form('close');
                  // window.open('/shopmanage-ws/ws/0.1/agentManager/genPayAgentOrder?money='+money+'&defaultbank='+defaultbank);
                  document.cityChargeForm.submit()
                }else{
                  return false
                }
              });
              $('span.jrad-btn-normal',form).bind('click',function(){
                form.form('close')
              })
              
		}
	}); 
	page_list_buttons.push({title: '导出Excel',displayname:'导出EXCEL',name:'excel', bclass: 'excel',onpress : function(){
        	var checked = $('#Table_cityCharge').getCheckedTrs();
        	$.jRadConfirm('确认导出？',1,function(){
             var param = {};
             var userName = $.trim($(".searchContent div[name='userName']",wraper).input('val'));
             if(userName!=""){
              param['userName'] = userName;
             };
             var busiRegName = $.trim($(".searchContent div[name='busiRegName']",wraper).input('val'));
             if(busiRegName!=""){
              param['busiRegName'] = busiRegName;
             };
             var paramUrl = "";
             if(param!={}){   
             paramUrl+="?"
             $.each(param,function(k,v){ 
                paramUrl+="&"+k+"="+v; 
             });
             }
             window.open('/shopmanage-ws/ws/0.1/agentManager/exportCoopBusi'+paramUrl);
      })
		}
	});
  page_list_buttons.push({separator: true});
    
    $('#Table_cityCharge').flexigrid({
            reload:true,
      			method:'get',
            colModel : page_column_model,
            buttons : page_list_buttons,
            searchitems :page_search_items,
            pagination: {
      				diaplay_pages: 5,
      				align: 'bottom' 
      			},
      			showSearch:true,  
            url:'/shopmanage-ws/ws/0.1/agentManager/coopBusiList', //此时userId为当前登录用户的ID 
      			onError:showError, 
      			checkBoxType:'single',
      			overflow:true
    });
    var accountDetail=$.jRadGet({url:'/shopmanage-ws/ws/0.1/agentManager/cityAccountDetail?agentUserId='+carsmart_config.userId});
    $('div.mDiv',wraper).append('<span style="color:#000;margin-right:20px;margin-left:30px;" class="addSpan">预付款余额：'+accountDetail.usableSum+'</span><a href="javascript:" style="margin-right:20px;" class="transFlow">交易流水</a><span style="color:#000;" class="addSpan">已使用预付款：'+accountDetail.hasUsedAmount+'</span>');
    transFlow();
    $('div[title="刷新"]').parent().click(function(){
      $.jRadGet({
        url:'/shopmanage-ws/ws/0.1/agentManager/cityAccountDetail?agentUserId='+carsmart_config.userId,
        success:function(data){
          $('div.mDiv',wraper).find('span.addSpan').remove();
          $('div.mDiv',wraper).find('a.transFlow').remove();
          $('div.mDiv',wraper).append('<span style="color:#000;margin-right:20px;margin-left:30px;" class="addSpan">预付款余额：'+data.usableSum+'</span><a href="javascript:" style="margin-right:20px;" class="transFlow">交易流水</a><span style="color:#000;" class="addSpan">已使用预付款：'+data.hasUsedAmount+'</span>');
          transFlow()
        }
      })
    });
    function transFlow(){
        $('a.transFlow').unbind('click').bind('click',function(){
        $('#Form_cityTransaction_flow',wraper).form('open');
          fundRecords(0);
          function fundRecords(page){
            $.jRadGet({
              url:'/shopmanage-ws/ws/0.1/agentManager/fundRecords?agentUserId='+carsmart_config.userId+'&pageindex='+page+'&pagesize=6',
              success:function(data){
                var str='';
                if(data.items!=null && data.items!=undefined){
                  for(i=0;i<data.items.length;i++){
                    if(data.items[i].changeAmount>0){
                      data.items[i].changeAmount='+'+data.items[i].changeAmount
                    };
                    str+='<tr>'
                        +'<td>'+data.items[i].changeAmount+'</td>'
                        +'<td>'+data.items[i].accountAmount+'</td>'
                        +'<td>'+data.items[i].operateTypeDesc+'</td>'
                        +'<td>'+data.items[i].recordTime+'</td>'
                        +'<tr>'
                  };
                  $('#Form_cityTransaction_flow table').find('tr').remove();
                  var _th='<tr><th>变动金额</th><th>变动后金额</th><th>变动方式</th><th>变动时间</th></tr>';
                  $('#Form_cityTransaction_flow table').append(_th).append(str);
                  if(data.items!=''){
                    $('div.pagation').page({
                      diaplay_pages: 5, //展示几页页码
                      pageindex: data.page, //当前页index
                      pagesize: 6, //每页展示size
                      totalCount: data.totalCount, //总条数
                      totalPages: data.totalPages, //总页数
                      callback: function(pageIndex) { //换页回调函数
                        return fundRecords(pageIndex)
                      },
                      align:'right', //分页组件显示位置 left right center 默认center
                      showText:'从第_start_到_end_项 共_total_项' 
                    })
                  }else{
                    $('#Form_cityTransaction_flow div.pagation').html('');
                    $('#Form_cityTransaction_flow table').append('<tr><td colspan="4">暂无符合条件的记录</td></tr>');
                  }
                  
                }
              }
            })
          }
      });
    };
   
    $('span.offset0',wraper).removeClass('span3').addClass('span6');
  	function showError(xhr){
  		 var errormsg = eval("(" + xhr.responseText + ")"); 
  		 $.jRadMessage({level:'error',message:errormsg[0].message})
  	}
});
</script>
