<style>
  #Table_transaction_flow td,#Table_transaction_flow th{
    text-align: center;
  }
</style>
<div class="urlContentWraper" id="Wraper_preCharge">
    <div class="ui-info-layout">
      <div class="cdiv">
           <h2 class="ui-tit"><strong>预付款管理列表</strong><bottom class="all-work-info numb61">页面说明</bottom></h2>
           <table id="Table_preCharge"></table>
      </div>
      <div class="sdiv" style="margin-top:10px;">
           <h2 class="ui-tit"><strong>商家列表</strong></h2>
           <table id="Table_preCharge_busiList"></table>
      </div>
    </div>
    <!-- 预付款充值 -->
    <div id="Form_preCharge_recharge" style="display:none;">
        <div class="grid-layout-main jrad-form">    
			<div class="row"> 
				<label class="span3 grid-layout-label"> 充值金额：</label>
				<div class="span6 grid-layout-content fluid-wrap">
					<div name="money" class="jrad-input-container">
					</div> 
				</div>
			</div> 
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span>
      			<span class="jrad-btn-normal">取消</span>
        </div>
    </div>
    <!-- 预付款设置 -->
    <div id="Form_preCharge_install" style="display:none;">
        <div class="grid-layout-main jrad-form">  
          <div class="ycb">
            <p style="margin:15px 0;"><span class="ui-form-required">*</span>养车宝收取金额</p>
          </div>
          <div class="agent">
            <p style="margin:15px 0;"><span class="ui-form-required">*</span>代理商收取金额</p> 
          </div>
          <p class="ui-note">养车宝收取金额：养车宝售给省代理合作商家每年的价钱；<br>省代理收取金额：对应省代理售给市代理合作商家每年的价钱范围。</p>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span>
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div>  
    <!-- 交易流水 -->
    <div id="Form_transaction_flow" style="display:none;">
        <div class="grid-layout-main jrad-form">  
  			<table id="Table_transaction_flow">
  	        	<tr>
  	        		<th>变动金额</th>
  	        		<th>变动后金额</th>
  	        		<th>变动方式</th>
  	        		<th>变动时间</th>
  	        	</tr>
        	</table>
          <div class="pagation"></div>
        </div> 
    </div> 
    <div id="Form_explain_eg61" style="display:none;">
        <div class="grid-layout-main jrad-form"> 
            <div class="row">
                <label class="span3 grid-layout-label">业务说明：</label>
                <div class="span12 grid-layout-content">
                    <div><strong>功能简介：</strong>此菜单下的功能都没有使用。</div>
                    <div><strong>重要功能说明：</strong>无。</div>
                    <div><strong>注意事项：</strong>无。</div>
                </div> 
            </div> 
            <div class="row">
                <label class="span3 grid-layout-label">备注：</label>
                <div class="span12 grid-layout-content">
                    <div class="jrad-textarea-container" name="remark">
                    </div>
                </div>
            </div>
        </div>
        <div class="jrad-buttons-container ui-buttons-container"> 
            <span class="jrad-btn-primary">确定</span> 
            <span class="jrad-btn-normal">取消</span>
        </div>
    </div> 
</div>
<script type="text/javascript">
$(document).ready(function(){
    var wraper = $('#Wraper_preCharge');
    var page_column_model = new Array();
    var page_column_model_c = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array();
    
  	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel}); 
    jRad.validators['money']=[{msg:'充值金额不能为空',type:'min',value:'1'},{msg:'请填写正整数',type:'regex',value:/^[0-9]*[1-9][0-9]*$/}];
    jRad.params['provinceCodeSearch'] = {
    urlData:{
      url:'/euc/ws/0.1/user/provinces?userId='+carsmart_config.userId
    },
    unshiftData: {id:'',name:'请选择'},
    onchange: function(){
      var provinceCode = $('.searchContent div[name=provinceId]',wraper).select('val'); 
      if(provinceCode==''){ 
        $('.searchContent div[name=municipalityId]',wraper).select({
                                urlData:{url:''},
                                data:[{id:'',name:'请选择'}]});
      }else{  
      $('.searchContent div[name=municipalityId]',wraper).select({ 
        urlData:{
           url:'/euc/ws/0.1/user/cities?provinceId='+provinceCode+'&userId='+carsmart_config.userId
        },
        unshiftData: {id:'',name:'请选择'}
      }).select('val','');
      }
    }
  };
  jRad.params['cityIdSearch'] = {
    data: [{id:'',name:'请选择'}] 
  };
   var provinces=$.jRadGet({url:'/euc/ws/0.1/user/provinces'});
   var validators={};
   var str='';
   $.each(provinces,function(i){
    str+='<div class="row">'
       +'<label class="span4 grid-layout-label">'+provinces[i].name+'：</label>'
       +'<div class="span4 grid-layout-content fluid-wrap">'
       +'<div name="'+provinces[i].id+'" class="jrad-input-container">'
       +'</div></div></div>';
    validators[provinces[i].id]=[{msg:'请填写',type:'min',value:'1'},{msg:'请填写非负整数',type:'regex',value:/^\d+$/}];
   });
   $('#Form_preCharge_install div.ycb',wraper).append(str);

   var _str='';
   $.each(provinces,function(i){
    _str+='<div class="row">'
       +'<label class="span4 grid-layout-label">'+provinces[i].name+'：</label>'
       +'<div class="span9 grid-layout-content fluid-wrap">'
       +'<input type="text" class="minPreCharge_'+provinces[i].id+' min"> -- <input type="text" class="maxPreCharge_'+provinces[i].id+' max">'
       +'</div></div>';
   });
   $('#Form_preCharge_install div.agent',wraper).append(_str);



   $('#Form_preCharge_recharge',wraper).form({
  		fluid: true,
      validators: jRad.validators,
      grid:14,
  		autobinding:true
  	});
   $('#Form_preCharge_install',wraper).form({
      fluid: true,
      validators: validators,
      grid:14,
      autobinding:true
    });
   $('#Form_transaction_flow',wraper).form({
      title:'交易流水',
      fluid: true,
      grid:14,
      autobinding:true
    });
    page_column_model.push({display: 'ID', name : 'agentUserId'});
    page_column_model.push({display: '代理商账号', name : 'agentUserName'});  
    page_column_model.push({display: '代理商省市', name : 'agentCityName',diy:function(item,$div){
      var str='';
      var area=item.agentCityName;
      $.each(area,function(i){
        if(area[i].provinceName!=null && area[i].provinceName!=undefined){
          str += area[i].provinceName
        }
        if(area[i].areaList!=null && area[i].areaList!=undefined){
          $.each(area[i].areaList,function(j){
            str += area[i].areaList[j].areaCodeName
          })
        }
      })
      $div.html(str)
    }}); 
    page_column_model.push({display: '预付款余额（元）', name : 'useableSum',diy:function(item,$div){
      $div.html(item.useableSum);
      var flow=$('<a>').html('交易流水').addClass('flow').attr('href','javascript:').css('margin-left','10px');
      $div.append(flow);
      $('a.flow',$div).unbind('click').bind('click',function(){
        $('#Form_transaction_flow',wraper).form('open');
        fundRecords(0);
        function fundRecords(page){
          $.jRadGet({
            url:'/shopmanage-ws/ws/0.1/agentManager/fundRecords?agentUserId='+item.agentUserId+'&pageindex='+page+'&pagesize=6',
            success:function(data){
              var str='';
              if(data.items!=null && data.items!=undefined){
                for(i=0;i<data.items.length;i++){
                  if(data.items[i].changeAmount>0){
                    data.items[i].changeAmount='+'+data.items[i].changeAmount
                  };
                  str+='<tr>'
                      +'<td>'+data.items[i].changeAmount+'</td>'
                      +'<td>'+data.items[i].accountAmount+'</td>'
                      +'<td>'+data.items[i].operateTypeDesc+'</td>'
                      +'<td>'+data.items[i].recordTime+'</td>'
                      +'<tr>'
                };
                $('#Form_transaction_flow table').find('tr').remove();
                var _th='<tr><th>变动金额</th><th>变动后金额</th><th>变动方式</th><th>变动时间</th></tr>';
                $('#Form_transaction_flow table').append(_th).append(str);
                if(data.items!=''){
                  $('div.pagation').page({
                    diaplay_pages: 5, //展示几页页码
                    pageindex: data.page, //当前页index
                    pagesize: 6, //每页展示size
                    totalCount: data.totalCount, //总条数
                    totalPages: data.totalPages, //总页数
                    callback: function(pageIndex) { //换页回调函数
                      return fundRecords(pageIndex)
                    },
                    align:'right', //分页组件显示位置 left right center 默认center
                    showText:'从第_start_到_end_项 共_total_项' 
                  })
                }else{
                  $('#Form_transaction_flow div.pagation').html('');
                  $('#Form_transaction_flow table').append('<tr><td colspan="4">暂无符合条件的记录</td></tr>');
                }
                
              }
            }
          })
        }
      })
    }});
    page_column_model.push({display: '已使用预付款金额（元）', name : 'hasUsedAmount'});
    page_column_model.push({display: '养车宝收取金额', name : 'ycbRecAmount'});
  	page_column_model.push({display: '代理商收取金额', name : 'parentRecAmount'});
  	page_column_model.push({display: '账号生成时间', name : 'createDate'});
  	page_column_model.push({display: '最后操作时间', name : 'updateDate'});
  	page_column_model.push({display: '最后操作人', name : 'operator'});
	
    
   page_search_items.push({row:'1',type:'jrad-input',display:'代理商账号',name:'userName'}); 
   page_search_items.push({row:'1',type:'jrad-select',display:'省',name:'provinceId',params:jRad.params['provinceCodeSearch']}); 
   page_search_items.push({row:'1',type:'jrad-select',display:'市',name:'municipalityId',params:jRad.params['cityIdSearch']}); 
   page_search_items.push({row:'2',type:'jrad-dateinput',display:'最后操作时间始',name:'startDate'}); 
   page_search_items.push({row:'2',type:'jrad-dateinput',display:'最后操作时间终',name:'endDate'}); 
   page_search_items.push({row:'2',type:'jrad-input',display:'最后操作人',name:'operator'}); 

   page_list_buttons.push({title: '预付款充值',displayname:'预付款充值',name:'recharge', bclass: 'recharge',prefunc:function(){
            var checked = $('#Table_preCharge',wraper).getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
            var checked = $('#Table_preCharge',wraper).getCheckedTrs();
    				var form = $('#Form_preCharge_recharge',wraper);
    				form.form({
        					title:'预付款充值', 
	                item:{},
	                url:'/shopmanage-ws/ws/0.1/agentManager/cmsRecharge',
	                before_submit:function(json){
	                	json.agentUserId = checked[0].agentUserId;
	                	return json
	                },
	                success_callback:function(data){ 
          						$('#Table_preCharge',wraper).flexMessage('充值成功', 'success');
          						$('#Table_preCharge',wraper).flexReload()
        					}  
            	}).form('open')
		}
	});
	 page_list_buttons.push({title: '预付款设置',displayname:'预付款设置',name:'chargeInstall', bclass: 'chargeInstall',onpress : function(){
				 var form = $('#Form_preCharge_install',wraper);
         var proPepaidDetai=$.jRadGet({url:'/shopmanage-ws/ws/0.1/agentManager/proPepaidDetai'});
				 form.form({
        					title:'预付款设置', 
	                item:{},
	                url:'/shopmanage-ws/ws/0.1/agentManager/proPepaidSave',
	                before_submit:function(){
                    var proPepaidArr=[];
                    $('#Form_preCharge_install div.ycb input',wraper).each(function(i){
                      var proJson={};
                      proPepaidArr.push(proJson);
                      proPepaidArr[i].provinceId=$(this).attr('name');
                      proPepaidArr[i].ycbPaid=$(this).val()
                    });
                    $('#Form_preCharge_install div.agent input.min',wraper).each(function(i){
                      // var maxval=$(this).parent().find('input.max').val();
                      // if(!(/^[0-9]*[1-9][0-9]*$/.test($(this).val()))){
                      //   $.jRadMessage({level:'error',message:'请填写非负整数',selector:form});
                      //   return false
                      // }
                      // if($(this).val>maxval){
                      //   $.jRadMessage({level:'error',message:'代理商收取金额后面数必须大于前面数',selector:form});
                      //   return false
                      // }
                      proPepaidArr[i].proPaidMin=$(this).val()
                    });
                    $('#Form_preCharge_install div.agent input.max',wraper).each(function(i){
                      // if(!(/^[0-9]*[1-9][0-9]*$/.test($(this).val()))){
                      //   $.jRadMessage({level:'error',message:'请填写非负整数'});
                      //   return false
                      // }
                      proPepaidArr[i].proPaidMax=$(this).val()
                    });
	                	return proPepaidArr
	                },
	                success_callback:function(){
	                	$('#Table_preCharge',wraper).flexMessage('设置成功','success');
	                	$('#Table_preCharge',wraper).flexReload()
	                }
                    // $.jRadMessage({level:'error',message:'请填写非负整数',selector:form})
            	}).form('open');
              if(proPepaidDetai!=null&&proPepaidDetai!=undefined){
                $.each(proPepaidDetai,function(i){
                  var proName=proPepaidDetai[i].provinceId;
                  $('div[name="'+proName+'"]',wraper).input('val',proPepaidDetai[i].ycbPaid);
                  $('input.minPreCharge_'+proName,wraper).val(proPepaidDetai[i].proPaidMin);
                  $('input.maxPreCharge_'+proName,wraper).val(proPepaidDetai[i].proPaidMax)
                })
              }

		}
	}); 
	page_list_buttons.push({title: '导出Excel',displayname:'导出EXCEL',name:'excel', bclass: 'excel',onpress : function(){
        	var checked = $('#Table_preCharge').getCheckedTrs();
        	$.jRadConfirm('确认导出？',1,function(){
             var param = {};
             var userName = $.trim($(".searchContent div[name='userName']",wraper).input('val'));
             if(userName!=""){
              param['userName'] = userName;
             };
             var provinceId = $.trim($(".searchContent div[name='provinceId']",wraper).select('val'));
             if(provinceId!=""){
              param['provinceId'] = provinceId;
             };
             var municipalityId = $.trim($(".searchContent div[name='municipalityId']",wraper).select('val'));
             if(municipalityId!=""){
              param['municipalityId'] = municipalityId;
             };
             var operStartDate = $.trim($(".searchContent div[name='operStartDate']",wraper).dateinput('val'));
             if(operStartDate!=""){
              param['operStartDate'] = operStartDate;
             };
             var endDate = $.trim($(".searchContent div[name='endDate']",wraper).dateinput('val'));
             if(endDate!=""){
              param['endDate'] = endDate;
             };
             var operator = $.trim($(".searchContent div[name='operator']",wraper).input('val'));
             if(operator!=""){
              param['operator'] = operator;
             };
             var paramUrl='';
             if(param!={}){   
             paramUrl+="?"
             $.each(param,function(k,v){ 
                paramUrl+="&"+k+"="+v; 
             });
             }
             window.open('/shopmanage-ws/ws/0.1/agentManager/exportCoopBusi'+paramUrl);
        	})
		}
	});
  page_list_buttons.push({separator: true});
    
    $('#Table_preCharge').flexigrid({
            // reload:true,
      			method:'get',
            colModel : page_column_model,
            buttons : page_list_buttons,
            searchitems :page_search_items,
            pagination: {
      				diaplay_pages: 5,
      				align: 'bottom' 
      			},
      			showSearch:true,  
            url:'/shopmanage-ws/ws/0.1/agentManager/accountList', //此时userId为当前登录用户的ID 
      			onError:showError, 
      			// checkBoxType:'single',
      			overflow:true,
      			trEvent:function(){		//监听行事件 
      				var checked = $('#Table_preCharge').getCheckedTrs();  
      				$('#Table_preCharge_busiList').flexOptions({ 
      					extParam:{
      						agentUserId: checked[0].agentUserId
      					}
      				}).flexReload()
      			}
    });
    var _span3=$('div.searchButtons',wraper).parent().removeClass('span3').addClass('span20');
    var _div=$('<div>').addClass('row-fluid').append(_span3);
    $('div.searchContent',wraper).append(_div);
    sumMoney();
    function sumMoney(){
       $.jRadGet({
        url:'/shopmanage-ws/ws/0.1/agentManager/getYcbProRecAmount',
        success:function(data){
          $('div.hDivBox:eq(0) th:eq(6) div').html('养车宝收取金额<br>（合计：'+data.ycbRecAmount+'元）');
          $('div.hDivBox:eq(0) th:eq(7) div').html('省代理收取金额<br>（合计：'+data.proRecAmount+'元）');
        }
      })
    };
   $('div.searchButtons span[title="清空查询条件"]',wraper).click(function(){
      sumMoney()
   });
    $('div.searchButtons span[title="查询"]',wraper).click(function(){
         var param = {};
         var userName = $.trim($(".searchContent div[name='userName']",wraper).input('val'));
         if(userName!=""){
          param['userName'] = userName;
         };
         var provinceId = $.trim($(".searchContent div[name='provinceId']",wraper).select('val'));
         if(provinceId!=""){
          param['provinceId'] = provinceId;
         };
         var municipalityId = $.trim($(".searchContent div[name='municipalityId']",wraper).select('val'));
         if(municipalityId!=""){
          param['municipalityId'] = municipalityId;
         };
         var startDate = $.trim($(".searchContent div[name='startDate']",wraper).dateinput('val'));
         if(startDate!=""){
          param['startDate'] = startDate;
         };
         var endDate = $.trim($(".searchContent div[name='endDate']",wraper).dateinput('val'));
         if(endDate!=""){
          param['endDate'] = endDate;
         };
         var operator = $.trim($(".searchContent div[name='operator']",wraper).input('val'));
         if(operator!=""){
          param['operator'] = operator;
         };
         
         var paramUrl = "";
         if(param!={}){   
         paramUrl+="?"
         $.each(param,function(k,v){ 
            paramUrl+="&"+k+"="+v; 
         })
         };
       $.jRadGet({
          url:'/shopmanage-ws/ws/0.1/agentManager/getYcbProRecAmount'+paramUrl,
          success:function(data){
            $('div.hDivBox:eq(0) th:eq(6) div').html('养车宝收取金额<br>（合计：'+data.ycbRecAmount+'元）');
            $('div.hDivBox:eq(0) th:eq(7) div').html('省代理收取金额<br>（合计：'+data.proRecAmount+'元）');
          }
        });
     });

  	page_column_model_c.push({display: '商家ID', name : 'busiId'});	
  	page_column_model_c.push({display: '商家简称', name : 'busiRegName'});
  	page_column_model_c.push({display: '预付款支付', name : 'agentPayAmount'});
  	page_column_model_c.push({display: '养车宝收取', name : 'ycbRecAmount'});
  	page_column_model_c.push({display: '代理商收取', name : 'parentRecAmount'});
    page_column_model_c.push({display: '购买时间', name : 'coopStartDate'});
  	page_column_model_c.push({display: '到期时间', name : 'coopEndDate'});


    $('#Table_preCharge_busiList').flexigrid({
            reload:true,
            autoload: false,
      			method:'get',
            colModel : page_column_model_c,
            searchitems: [],
            pagination: {
      				diaplay_pages: 5,
      				align: 'bottom' 
      			},
      			showSearch:false,  
      			overflow:true,
            url:'/shopmanage-ws/ws/0.1/agentManager/coopBusiList', 
      			onError:showError_2, 
            showCheckbox: false
    });
    
    $(".numb61").click(function(){
        $('.overcurtainDiv').hide();
        var menuId = $(".tabs-selected").attr("menuId")
        var data = $.jRadGet({url:'/shopmanage-ws/ws/0.1/remark/getMenuRemark?menuId='+menuId})
        $("#Form_explain_eg61").form({}).form('close');
        $("#Form_explain_eg61").form({
            title:'页面说明',
            item:data,
            autobinding: true, 
            submit:function(){
                var postData = {};
                postData.operator = carsmart_config.operatorName;
                postData.menuName = $(".tabs-selected").attr("menuName");
                postData.menuId = $(".tabs-selected").attr("menuId");
                postData.remark = $("#Form_explain_eg61 div[name='remark']").textarea("val")
                $.jRadPost({
                    url:'/shopmanage-ws/ws/0.1/remark/updateMenuRemark',
                    data:postData,
                    success:function(){
                        $("#Form_explain_eg61").form('close')
                        $('.overcurtainDiv').hide();
                    }
                });
            }, 
            cancel:function(){
                $("#Form_explain_eg61").form('close')
                $('.overcurtainDiv').hide();
            }
        }).form('open')
        $("#Form_explain_eg61 .textarea-content").removeClass("span4").addClass("span12")
        $('.overcurtainDiv').hide();
        $('.overcurtainDiv').eq(0).show().attr("style","z-index:303;display:block");
    })
  	function showError(xhr){
  		 var errormsg = eval("(" + xhr.responseText + ")"); 
  		 $.jRadMessage({level:'error',message:errormsg[0].message})
  	}
  	function showError_2(xhr){
  		 var errormsg = eval("(" + xhr.responseText + ")"); 
  		 $.jRadMessage({level:'error',message:'请预付款账号'})
  	}
});
</script>
