<div class="urlContentWraper" id="ycb-channel"> 
	<div class="grid-row-fluid ui-form">
		<div class="grid-row">
			<label class="span3 grid-layout-label width-auto">选择渠道：</label>
			<div class="span5 grid-layout-content">
				<div class="channelType_select"></div>
			</div>
		</div>
		<div class="grid-row">
		    <label class="span3 grid-layout-label width-auto">选择时间：</label>
			<div class="span11 grid-layout-content fluid-wrap">
				<div class="ui-date input-daterange jrad-daterange-time">
					<div class="input-append date">
						<div class="input-wrap">
							<input type="text" class="input-start" name="start" />
						</div>
						<span class="add-on"><i class="icon-calendar"></i></span>
					</div>  
					<span class="date-to">至</span>
					<div class="input-append date">
						<div class="input-wrap">
							<input type="text" class="input-end" name="end" />
						</div>
						<span class="add-on"><i class="icon-calendar"></i></span>
					</div>  
				</div>
			</div>
			<div class="span6">
				<button class="jrad-btn-search btn btn-small btn-primary">查询</button>
				<button class="jrad-btn-clear btn btn-small btn-normal">清空</button>
			</div>
		</div>
		 
	</div>
    <div class="row-container"  id="channel_table">
        <div class="jrad-dimensiontable"></div>
    </div>
</div>
<script type="text/javascript">
$(document).ready(function(){
	var wraper = $('#ycb-channel'); 
	var $analytics = $("#channel_table").analytics({
		sType:['date'],
		tOptions:{"aaSorting": [[ 0, "desc" ]]}, // 默认排序
		config:{file:'/public/ebybi/channel_statistics.saiku',type:'QM'},page:true}); 
	var json = $.jRadGetDataSources('/sps-ws/ws/0.1/channel/getChannelByAccount?account='+carsmart_config.operatorName,'id','name'); 
	$(".channelType_select",wraper).select({
		data:json,
		onclick:function(item){ 
			var _delete = '{"hierarchy":"[channel_dim.channels]","uniquename":"[channel_dim.channels].[channel]","type":"level","action":"delete"}'; 
			var _add = '{"uniquename":"[channel_dim.channels].['+item.id+']","type":"member","action":"add"}'; 
			var formData = {'selections':'['+_delete+','+_add+']'};
			$analytics.analytics('changeFilter','channel_dim',formData);
			initsituation();
		}
	});
	var _delete = '{"hierarchy":"[channel_dim.channels]","uniquename":"[channel_dim.channels].[channel]","type":"level","action":"delete"}';
	var _add = []; 
	_add.push('{"uniquename":"[channel_dim.channels].['+$(".channelType_select",wraper).select('val')+']","type":"member","action":"add"}');
	 
	var formData = {'selections':'['+_delete+','+_add.join(',')+']'};
	if(json.length!=0){
		$analytics.analytics('addRowCondition','channel_dim',formData);
		var start = "2015-12-01" ;
		var end = moment().format('YYYY-MM-DD');
		var dateFormData = getDateFormData(start,end);
		if(dateFormData){
			$analytics.analytics('addRowCondition','Date_dim',dateFormData);
		}
	}
	var initsituation =  function(){ 
		$analytics.analytics('query',function(){
			$analytics.analytics('renderTable');
		});
	}
	if(json.length!=0){
		initsituation();
	}   
	$('.jrad-daterange-time',wraper).datepickerBS({
		format: 'yyyy-mm-dd', 
		startDate:'2015-12-01',
		endDate:  moment().format('YYYY-MM-DD'),  
		language: "zh-CN",
		todayHighlight: 1,
		minViewMode: 0,
		autoclose: 1,
		inputs: $('.jrad-daterange-time .input-append')
	}); 
	$('.jrad-btn-search',wraper).click(function(){
		var start = $('input[name="start"]',wraper).val();
		var end = $('input[name="end"]',wraper).val();
		if(start==""&&end==""){
			return false;
		}
		var formData = getDateFormData(start,end); 
		if(formData){
			$analytics.analytics('addRowCondition','Date_dim',formData); 
			initsituation();
		}else{
			$analytics.analytics('clearTable');
		}
	});
	$('.jrad-btn-clear',wraper).click(function(){
		$('input[name="start"]',wraper).val("");
		$('input[name="end"]',wraper).val("");
		var start = "2015-12-01" ;
		var end = moment().format('YYYY-MM-DD');
		var formData = getDateFormData(start,end);
		if(formData){
			$analytics.analytics('addRowCondition','Date_dim',formData);
			initsituation();
		}else{
			$analytics.analytics('clearTable');
		}
	});
});

function CompareDate(d1,d2)
{
  return moment(d1).diff(moment(d2)) > 0;
}
function getDateFormData(start,end){ 
	if(start==""||CompareDate(start, moment().format('YYYY-MM-DD'))==true){
		return false;
	}
	if(CompareDate("2015-12-01",start)==true){
		start = "2015-12-01";
	} 
	if(end==""){
		end = moment().format('YYYY-MM-DD');
	}
	if(CompareDate("2015-12-01",end)==true){
		return false;
	}
	if(CompareDate(start,end)==true){
		return false;
	}
	var _delete = '{"hierarchy":"[Date_dim.Year_Month_Day]","uniquename":"[Date_dim.Year_Month_Day].[day]","type":"level","action":"delete"}';
	var _add = [];
	var _date = moment(start).format('YYYY-MM-DD');
	var count = 0;
	do {
		if (_date === end) {
			count++;
		}
		var year = moment(_date).format('YYYY');
		var month = moment(_date).format('M');
		var _day = moment(_date).format('D');
		_add.push('{"uniquename":"[Date_dim.Year_Month_Day].[' + year + '-' + month + '-' + _day + ']","type":"member","action":"add"}');
		_date = moment(_date).add('days', 1).format('YYYY-MM-DD');
	} while (count < 1); 
	var formData = {
		'selections' : '[' + _delete + ',' + _add.join(',') + ']'
	};
	return formData; 
}
 
</script>
<div id="footer" style=""><div style="">©2016 北京车盈科技有限公司 京ICP备15056241号-1</div> </div>