<div class="urlContentWraper" id="Wraper_shop_service"> 
		<div id="serviceTabs"> 
			<div class="widget-toolbar no-border">
					<ul>
						<li>
							<a href="#carwash">洗车</a>
						</li>
						<li>
							<a href="#beautify">美容</a>
						</li>
						<li>
							<a href="#upkeep">保养</a>
						</li>
						<li>
							<a href="#repair">维修</a>
						</li>
					</ul>
			</div> 
			<div class="widget-body">
				<div class="widget-main padding-10">
					<div id="carwash" style="height:500px;">
						<table id="Table_carwash_list"></table> 
					</div>
					<div id="beautify" style="height:500px;">
						<table id="Table_beautify_list"></table> 
					</div>
					<div id="upkeep" style="height:500px;">
						<table id="Table_upkeep_list"></table> 
					</div>
					<div id="repair" style="height:500px;">
						<table id="Table_repair_list"></table> 
					</div>
				</div>
			</div>
		</div>  
<!--服务carwash form-->
<div id="Form_service_carwash" class="grid-layout ui-form">
	<div class="grid-layout-main jrad-form"> 
		 <input name="serviceId" type="hidden">  
		 <div class="grid-row-fluid">
			 <label class="span4 grid-layout-label">一级：</label>
			 <div class="span8 grid-layout-content">
				   <div name="firstService" class="jrad-select-container service"></div>
								</div>
		</div>
		<div class="grid-row-fluid">
			 <label class="span4 grid-layout-label">门市价：</label>
			 <div class="span8 grid-layout-content">
				   <div name="shopPrice" class="jrad-input-container"></div>
								</div>
		</div> 
		<div class="grid-row-fluid">
			 <label class="span4 grid-layout-label">预订价：</label>
			 <div class="span8 grid-layout-content">
				   <div name="reservePrice" class="jrad-input-container"></div>
								</div>
		</div> 
		<!--div class="grid-row-fluid">
			 <label class="span4 grid-layout-label">限时优惠价：</label>
			 <div class="span8 grid-layout-content">
				   <div name="privilegePrice" class="jrad-input-container"></div>
								</div>
		</div>  
		<div class="grid-row-fluid">
			<label class="span4 grid-layout-label">限时优惠时间：</label> 
			<div class="span18 grid-layout-content"> 
				<div id="privilege_date_range" data-name="datetimerange"></div>
			</div>
		</div> 
		<div class="grid-row-fluid">
			 <label class="span4 grid-layout-label">结算价：</label>
			 <div class="span8 grid-layout-content">
				   <div name="clearingPrice" class="jrad-input-container"></div>
								</div>
		</div-->
		<div class="grid-row-fluid">
			 <label class="span4 grid-layout-label">服务说明：</label>
			 <div class="span18 grid-layout-content">
				   <div name="illustrate" class="jrad-mediaarea-container"></div>
								</div>
		</div>  
	</div>
	<div class="jrad-buttons-container ui-buttons-container"> 
		 <button class="jrad-btn-primary btn btn-small btn-primary">
            确定
        </button>
        <button class="jrad-btn-normal btn btn-small btn-default">
            取消
        </button>
	</div>
</div> 
</div> 
<script type="text/javascript">
	$(document).ready(function(){ 
		var serviceJson = {};
		serviceJson.carwash = "1";
		serviceJson.beautify = "2";
		serviceJson.upkeep = "3";
		serviceJson.repair = "4";
		$('#serviceTabs').tabs({
			heightStyle: 'auto', 
			beforeLoad: function( event, ui ) {// 加载前操作
				  ui.jqXHR.error(function() {
				  ui.panel.html("无法加载页面" );
				});
			},
			select:function(event, ui){
				var panel = ui.panel; 
				var typeName = $(panel).attr('id'); 
				var type = serviceJson[typeName]; 
				window.setTimeout(function(){
					getServiceInfo(type,typeName,carsmart_config.shopId);//1.洗车 2.美容 3.保养 4.维修 
				},300);
			}
		});
		getServiceInfo("1","carwash",carsmart_config.shopId)
	});
	
function getServiceInfo(type,typeName,shopId){ 
	var wraper = $('#Wraper_shop_service'); 
	var _table = 'Table_'+typeName+'_list';
    var page_column_model = new Array();
    var page_search_items = new Array();
    var page_list_buttons = new Array();
	 //1.洗车  2.美容 3.保养 4.维修	
	var entityModel = {};
    var jRad = $.jRad({app:'radsample-ws',entityModel:entityModel});  
	jRad.validators['firstService'] = [{msg:"请选择一级服务",type:'min',value:'1'}];
	jRad.validators['secondService'] = [{msg:"请选择二级服务",type:'min',value:'1'}];
	jRad.validators['thirdService'] = [{msg:"请选择三级服务",type:'min',value:'1'}];
	jRad.validators['shopPrice'] = [{msg:"请填写门市价",type:'min',value:'1'}];
	jRad.validators['reservePrice'] = [{msg:"请填写预订价",type:'min',value:'1'}];
	jRad.validators['illustrate'] = [{msg:"请填写服务说明",type:'min',value:'1'}]; 
	var fields = {};  
	fields['firstService'] = {
		urlData: {
				url:'/vip-ws/ws/0.1/business/getSonServices?parentId='+type,
				id: 'id',
				name: 'serviceName',
				type: 'get',
				dataType: 'json'
			}, 
		unshiftData:{id:'',name:'请选择'}, 
		onchange: function(val){ 
				getServiceSonNode("2",val,wraper);  
		}
	};
	$('#privilege_date_range').datetimerange();
	$('#Form_service_carwash').form({ 
		fields: fields	
	});
	//page_column_model.push({display: '一级服务', name : 'firstName'});
	//page_column_model.push({display: '二级服务', name : 'secondName'});
	page_column_model.push({display: '服务', name : 'serviceNames'});
    page_column_model.push({display: '门市价', name : 'shopPrice'});
    page_column_model.push({display: '预订价', name : 'reservePrice'});    
    page_column_model.push({display: '审核状态', name : 'auditStatus '}); 
	page_column_model.push({display: '审核描述', name : 'auditDesc'});  
    page_column_model.push({display: '操作', name : 'id',width:100 ,diy:function(item,$div){
		var $a = $("<a>").html("删除");
		$div.append($a);
		$a.click(function(e){
			console.log("eee");
		});
	}});
     
	 
	page_list_buttons.push({title: '新增',bclass: 'icon-plus',onpress : function(){
            $("#Form_service_carwash .addService").parents(".row").remove();
			$("#Form_service_carwash .row:first .grid-layout-content #serviceNames").remove();
			$('#Form_service_carwash').form({
                title: '创建',   
                url: '/vip-ws/ws/0.1/business/addServiceInfo', 
				//validators: jRad.validators,
				item:{},
				preSubmit:function(json){
					json.shopAccountId = shopId; 
					json.serviceId = $("#Form_service_carwash .service:last").select('val'); 
					return json;
				},
				success:function(){ 
					$('#'+_table).flexMessage('创建成功', 'success');
					$('#'+_table).flexReload();
				}
            }).form('open'); 
        }
    });
	 
	page_list_buttons.push({title: '修改',bclass: 'icon-edit',prefunc:function(){
            var checked = $('#'+_table).getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
            var checked = $('#'+_table).getCheckedTrs(); 
            if(checked[0]){ 
				  $("#Form_service_carwash .addService").parents(".row").remove();
				  $("#Form_service_carwash .row:first .grid-layout-content #serviceNames").remove(); 
				  var businessServiceRelId = checked[0].businessServiceRelId?checked[0].businessServiceRelId:""; 
				  var modifyId = checked[0].modifyId?checked[0].modifyId:""; 
				  var param = "";
				  if(businessServiceRelId!=""){
					param+="?businessServiceRelId="+businessServiceRelId;
				  } 
				  if(modifyId!=""){
					if(param==""){
					param+="?modifyId="+modifyId;
					}else{
					param+="&modifyId="+modifyId;
					}
				  }
				  var item = $.jRadGet({url:'/vip-ws/ws/0.1/business/getServiceInfo'+param});  
				  $("#Form_service_carwash .row:first .grid-layout-content").append('<p id="serviceNames">已选择：'+item.serviceNames+'</p>');
				  $('#Form_service_carwash').form({
					title: '修改', 
					fields: fields,
					validators:[],
					item:item,  
					url: '/vip-ws/ws/0.1/business/editServiceInfo',
					preSubmit:function(json){
						json.shopAccountId = shopId; 
						var serviceId = $("#Form_service_carwash .service:last").select('val'); 
						if(serviceId!=""){
						  json.serviceId = serviceId;
						}
						json.businessServiceRelId = businessServiceRelId;
						json.modifyId = modifyId; 
						return json;
					},
					success:function(){ 
						$('#'+_table).flexMessage('修改成功', 'success');
						$('#'+_table).flexReload();
					}
				}).form('open');
            }
        }
    }); 
  
	page_list_buttons.push({title: '删除',bclass: 'icon-trash',prefunc:function(){
            var checked = $('#'+_table).getCheckedTrs();
            if (checked.length != 1) {return false;}else{return true;}
        },onpress : function(){
	    	var checked = $('#'+_table).getCheckedTrs(); 
			//$.jRadConfirm('确认删除吗？',1,function(){
				var businessServiceRelId = checked[0].businessServiceRelId?checked[0].businessServiceRelId:""; 
				var modifyId = checked[0].modifyId?checked[0].modifyId:"";   
				var param = "";
				if(businessServiceRelId!=""){
					param+="?businessServiceRelId="+businessServiceRelId;
				} 
				if(modifyId!=""){
					if(param==""){
						param+="?modifyId="+modifyId;
					}else{
						param+="&modifyId="+modifyId;
					}
				} 
				$.jRadPost({  
					url:'/vip-ws/ws/0.1/business/deleteServiceInfo'+param, 
					success: function(){
						console.log("success");
						//$('#'+_table).flexMessage('删除成功!', 'success');
           	    		//$('#'+_table).flexReload();
					},
					error:function(xhr){
					    var errormsg = eval("(" + xhr.responseText + ")"); 
						if (errormsg != undefined) {
							$('#'+_table).flexMessage(errormsg[0].message, 'error');
						}
					}
				});
			//});
		}
	});   
    $('#'+_table).flexigrid({
            reload:true,
			method:'get',
            colModel : page_column_model,
            buttons : page_list_buttons,
            searchitems :page_search_items,
            pagedStyle: 'oc',
			checkBoxType:'single',
			showSearch:true,
            url:'/vip-ws/ws/0.1/business/queryServiceInfo?offerServiceId='+type+"&shopAccountId="+shopId,
			//onError:showCategoryError,
			overflow:true 
    });  
}

function getServiceSonNode(node,val,wraper){   
	var label = "";
	var serviceClass = "";
	if(node==2){
		label = "二级";
		serviceClass = "secondService"; 
		$("#Form_service_carwash .addService").parents(".grid-row-fluid").remove();
	}else if(node==3){
		label = "三级";
		serviceClass = "thirdService";
		$('#Form_service_carwash div[name='+serviceClass+']').parents(".grid-row-fluid").remove();
	}
	if(val!=""){
		var item = $.jRadGetDataSources("/vip-ws/ws/0.1/business/getSonServices?parentId="+val,"id","serviceName");
		if(item.length>0){
		item.unshift({id:'',name:'请选择'}); 
		var row = '<div class="grid-row-fluid">'
					+'<label class="span4 grid-layout-label">'+label+'：</label>'
					+'<div class="span8 grid-layout-content">'
					+'<div name="'+serviceClass+'" class="jrad-select-container service addService"></div>'
					+'</div>'
					+'</div>' ; 
		if(node==2){
		$("#Form_service_carwash .grid-row-fluid:first",wraper).after(row);
		}else if(node==3){
		$("#Form_service_carwash .grid-row-fluid:eq(1)",wraper).after(row);
		}
		node++; 
		$('#Form_service_carwash div[name='+serviceClass+']').select({
			data:item,
			unshiftData: {id:'',name:'请选择'}, 
			onchange: function(val){
				getServiceSonNode(node,val,wraper); 
			}
		});
		}
	} 
}
</script>