<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black" name="apple-mobile-web-app-status-bar-style"/>
<link type="text/css" href="css/index.css" rel="stylesheet"/>
<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script> 
<script type="text/javascript" src="js/jquery.json-2.2.js"></script> 
<script type="text/javascript" src="js/index.js"></script> 
<script type="text/javascript" src="js/slides.js"></script><title>服务码验证</title>
<style>
	.right-share{float: right; color:#FB451F;background:url(css/images/share-bg.png) 0  0 no-repeat;background-size:0.9em auto; 
	background-position:left 0px;padding-left:1.2em;padding-top:0.1em;margin-right:1em;font-size:1.4em;font-family:"STHeitiSC-Light";}
</style>
</head>  
<body> 
	<section class="main-wrap">  
		<article> 
			<div class="header" id="ads">
			</div>			
			<div class="codes-wrap"> 
				<div class="input-wrap">
					<div class="area" style="margin-left: 1.2rem;padding-top: 1.6em;">
						<textarea id="serviceCode" placeholder="请输入短信验证码" rows="1"></textarea>
                        <a href="javascript:void(0);" class="help"></a>
					</div>
					<div class="codeBtn">
						<img src="css/images/codeBtn.png"/>
					</div>
				</div>
				<a href="javascript:void(0);" class="btnn ablebtn" id="submit">确定</a> 
			</div> 
			<div class="customer-service-wrap org">
			   <p>问题快速处理电话：01058377979</p>
			   <p>服务时间：工作日8:30-18:30</p>
			</div>
			<div class="overlay-containter">
				<ul class="order-wrap" id="orderList">
				</ul>  
				<div class="overlay-wrap"></div> 
			</div>
		</article> 
	</section>   
	<script type="text/javascript">
	$(document).ready(function(){
		var response = "1",page = 0,pagesize=10,shopId="-1",atomic="";   
        function voiceTip(bridge){  
			if(bIsAndroid()){  
				android.startVoiceTip();				
			}else{ 
				bridge.send("Audio", function(responseData) {
					log('Audio', responseData)
				});
			} 
		}
 		function getOrderList(shopId,owraper){    
			response = "1";
			$.ajax({
				url: '/vip-app-ws/ws/0.1/orders?withBranchs=1&shopId='+shopId+'&orderListType=1&pageindex='+page+'&pagesize='+pagesize+'&sortname=serviceDate&sortorder=desc&vs=1'+"&"+atomic,
				type: 'get',
				async: false,
				dataType: 'json',
				success: function(data) {   
					page++; 
					var str = "";
					var items = data.items; 
					$.each(items,function(i){
						var item = items[i];
						var _span = "";
						var _box = ""; 
						var _box = ""; 
						var resule = "";
						if(item.serviceNameForApp==undefined){
						    item.serviceNameForApp = item.serviceName;
						}
						if(item.moneyDesc==undefined){
						    var msg = "";
						    if(item.paid=="0"){  
								msg ='客户需当面支付现金'+item.reservePrice+'元';    
							}else{ 
								msg ='客户已网上支付现金'+item.reservePrice+'元';  
							}
						    item.moneyDesc = msg;
						}
						if(item.isShow == 1){
							resule +='<span class="right-share" serviceId="'+item.serviceId+'" reservePrice="'+item.reservePrice+'" serviceName="'+item.serviceName+'">分享服务</span>'
						}else{
							 resule += ''
						}
						str += '<li orderId="'+ item.orderId +'">' 
							+'<div>'
							+'<div class="user-info"> '
							+'<span class="time">验证时间：'+ item.serviceDate +'</span>' 
							//+resule
							+'</div>'
							+'<div class="order-info">'
							+'<p class="serviceName">'+ item.serviceNameForApp +'</p>'
							+'<div class="clearfix">'
							+'<span class="left-span">'+item.moneyDesc+'</span>'
							+'</div>'
							+'</div>'
							+'</div>' 
							+'</li>';
					});
					if(owraper!=undefined&&owraper!=""){ 
						$("#orderList").next('.null-tip').remove();
						$("#orderList").html(str); 
						$("#orderNum").html(data.totalCount);
						if(str==""){
							$("#orderList").after('<p class="null-tip">您还没有已完成订单</p>'); 
						}
					}else{
						$("#orderList").append(str);
					}
					if(data.page >= data.totalPages-1){
						response = "0";
					}
					if(bIsAndroid()){
						$(".overlay-containter").css("min-height",$(window).height()-178);  
					}else{
						$(".overlay-containter").css("min-height",$(window).height()-130);  
					}
				},
				error:function(xhr){

				}
			}); 
			return response;
	 	} 
	 	index.init = function(userInfo,bridge) {
	 		shopId = userInfo.shopAccountId;
	 		userInfo.userId = userInfo.userId||"";
	 		userInfo.osInfo = userInfo.osInfo||"";
	 		userInfo.version = userInfo.version||"";
	 		userInfo.imei = userInfo.imei||"";
	 		userInfo.deviceToken = userInfo.deviceToken||"";
			atomic ="userId="+userInfo.userId+"&osInfo="+userInfo.osInfo+"&version="+userInfo.version+"&imei="+userInfo.imei+"&deviceToken="+userInfo.deviceToken; 
		 	$(".ablebtn").on('click',function(){ 
		 		$(this).removeClass("ablebtn");
		 		checkCode(); 
		 	});  
		 	$('body').on('click',function(e){
		 		var target = e.srcElement|| e.target;
		 		if($(target).hasClass('overlay-wrap')||$(target).hasClass('codes-wrap')) {
		 			$('.shop-icon').removeClass("open");
			 		$(".shop-select").slideUp(400); 
			 		$('.overlay-wrap').slideUp(400);
		 		}  
		 	});
		 	$(".codeBtn").click(function(){
				var version=userInfo.version.replace(/\./g,'');
		 		if(version<130){
		 			alertRe("使用该功能需要更新升级至最新版本，重新打开客户端将提示您升级。",'');
		 			return false
		 		}else{
			 		window.location.href="http://w2l/?presentType=1&androidName=5&iosName=ScanBarCodeViewController";
		 		}
		 	})
		 	var path = getPath(); 
		 	$('#orderList').delegate('li','touchstart click touchend',function(e){ 
	 			var that = this;
	 			var home = path; 
	 			var target = e.srcElement || e.target;
	 			switch(e.type) {
	 				case 'touchstart':
	 					$("#orderList .selected").removeClass('selected');  
	 					$(that).addClass('selected');
	 					break;
	 				case 'click':  
				 		if(target.tagName.toLowerCase() == 'span' || $(target).hasClass('right-share')) {
					 		var serviceId = $(that).find(".right-share").attr("serviceId");
					 		var serviceName = $(that).find(".right-share").attr("serviceName");
					 		var reservePrice = $(that).find(".right-share").attr("reservePrice");
				 			window.location.href = "http://w2nw?"+path+"/creatVoucher.html?serviceId="+serviceId+'&serviceName='+serviceName+'&reservePrice='+reservePrice;
				 			return;
				 		}
				 		// else{ 
					 	// 	var orderId = $(that).attr("orderId");  
		 				// 	window.location.href = "http://w2nw?"+path+"/order-detail.html?orderId="+orderId; 
				 		// 	return;
				 		// }
				 		// break; 
				 		
					 	var orderId = $(that).attr("orderId");  
		 				window.location.href = "http://w2nw?"+path+"/order-detail.html?orderId="+orderId; 
				 		break; 
	 			}
 		    });
 		    $(".help").click(function(){
 		    	window.location.href = "http://w2nw?"+path+"/help.html"; 
 		    }); 
		 	function checkCode(){ 
		 		var serviceCode = $("#serviceCode").val();
		 		if(serviceCode==""){
		 			alertTasat("请输入短信验证码");
		 			return false;
		 		}
		 		var reg = /^\d{8}$/;
		 		if(!reg.test(serviceCode)){
		 			alertTasat("请输入正确的短信验证码");
		 			return false;
		 		} 
		 		var postData = {};
		 		postData.serviceCode = serviceCode;
		 		postData.shopAccountId = userInfo.shopAccountId; 
				$.ajax({
					url: '/vip-app-ws/ws/0.1/serviceCode/checkCode?serviceCode='+serviceCode+'&shopAccountId='+userInfo.shopAccountId+"&"+atomic,
					contentType : "application/json;charset=utf-8",
					dataType : "json",
					type : "POST",
					data : $.toJSON(postData),
					async : false,
					success: function(data) {   
						page = 0;
						getOrderList(userInfo.shopAccountId,"html"); 
						var msg = "";
						var _box = "";
						if(data.cardSendBoxFlag=="1"){
							_box = "购买车主卡赠送盒子，结算0元。";
							alertRe(_box,"验证成功");  
						}
						else{
							if(data.paid=="0"){ 
								voiceTip(bridge);
								if(data.isCounPay){ 
								msg+='<span class="org">客户需当面支付现金'+data.couponCashPrice+'元,已扣除抵用券'+data.couponPrice+'</span><br/>购买“'+data.serviceName+'”服务。'+_box;  
								}else{ 
								//msg+='<span class="org">客户需当面支付现金'+data.servicePrice+'元</span><br/>购买“'+data.serviceName+'”服务。'+_box;
								msg +='客户购买'+data.serviceName+'服务，结算'+data.clearingPrice+'元' 
								} 
							}else if(data.paid=="1"){
								if(data.isCounPay){ 
								msg+='<span>客户已网上支付现金'+data.couponCashPrice+'元,扣除抵用券'+data.couponPrice+'</span><br/>购买“'+data.serviceName+'”服务。'+_box; 
								}else{ 
								//msg+='<span>客户已网上支付现金'+data.servicePrice+'元</span><br/>购买“'+data.serviceName+'”服务。'+_box; 
								msg +='客户购买'+data.serviceName+'服务，结算'+data.clearingPrice+'元'
								} 
							}
							alertRe(msg,"验证成功"); 
						}  
						$("#submit").addClass("ablebtn");
					},
					error:function(xhr){ 
						var mes = eval('('+xhr.responseText+')');    
						alertTasat(mes[0].message);  
						$("#submit").addClass("ablebtn");
					}
				}); 
		 	} 
			getOrderList(userInfo.shopAccountId,"html");
			return response;
	 	};
	 	index.pullUpRefresh = function(bridge) {  
				getOrderList(shopId,""); 
				return response; 
		}

		});   
	</script>  
</body>

</html>

