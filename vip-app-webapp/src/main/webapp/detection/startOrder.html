<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"/>
		<meta content="yes" name="apple-mobile-web-app-capable"/>
		<meta content="black" name="apple-mobile-web-app-status-bar-style"/>
		<link type="text/css" href="../css/base.css" rel="stylesheet"/>
		<link rel="stylesheet" href="css/detection.css" />
		<script type="text/javascript" src="../js/jquery-1.9.1.min.js"></script> 
		<script type="text/javascript" src="../js/index.js"></script>
		<title></title>
		<style>
			body{
				font-size: 62.5%;
				width: 100%;
			}
		</style>
	</head>
	<body>
	<section class="order-wrap">
		<div class="order-list">
			
		</div>
	</section>
	<script type="text/javascript">
	$(function(){
		/*获得用户职员信息*/
		function getEmployeeInfo(userInfo){
			var shopName;
	 		$.ajax({
	 			type:"get",
	 			url:"/vip-app-ws/ws/0.1/common/getEmployeeInfo",
	 			async:false,
	 			data:{userId:userInfo.userId},
	 			dataType:'json',
	 			contentType:'application/json;charset=utf-8',
	 			success:function(data){
	 				shopName=data.shopName;
	 			},
	 			error:function(xhr){
	 				var error=eval('('+xhr.responseText+')');
					alertTasat(error[0].message);
					return
	 			}
	 		});
	 		return shopName
	 	}
		function getWorkOrderList(userInfo){
			$.ajax({
				type:"get",
				url:"/vip-app-ws/ws/0.1/workOrder/getWorkOrderList?businessInfoId="+userInfo.businessInfoId,
				async:false,
				dataType:'json',
				success:function(data){
					var str='';
					$.each(data, function(i) {
						str+='<div class="order-item">'+
								'<input type="hidden" name="busiWorkOrderId" value="'+this.busiWorkOrderId+'">'+
								'<div class="order-time">'+
									'<div>'+
										'<span class="orderTime">'+this.updateTime+'</span>'+
									'</div>'+
									'<span class="orderStateN">'+this.orderStatusName+'</span>'+
								'</div>'+
								'<div class="car-info">'+
									'<div class="plateNumber">'+this.plateNumber+'</div>'
								/*3:未出库   1:已出库*/
								if(this.orderStatus=='7'){
									str+='<div class="btn startBtn">开工</div>'
								}else if(this.orderStatus=='2'){
									str+='<div class="btn finishBtn">完工</div>'
								}
								str+='</div>'+
							'</div>'
					});
					if(str==""){
						showEmpty("暂无工单");
					}else{
						$(".order-list").html(str);
					}
				},
				error:function(xhr){
					var error=JSON.param(xhr.responseText);
					alertTasat('error[0].message');
				}
			});
		}
		function reflesh(){
			window.location=location;
		}
		index.init=function(userInfo,bridge){
			/*title 商家名称显示*/
			var shopName;
			shopName=getEmployeeInfo(userInfo);
			store.set('shopName',shopName);
			$("title").html(shopName);
			if(bIsAndroid()){
				window.mallTitle.getMallTitle('0',shopName);  
			}else{
				 bridge.callHandler('sendShopNameTitle',{'shopNameTitle':shopName});
			}
			var path=getPath();
			getWorkOrderList(userInfo);
			
			$(".order-list").on('click','.btn',function(){
				var busiWorkOrderId=$(this).parent().siblings('input[name="busiWorkOrderId"]').val();
				var plateNumber=$(this).siblings('.plateNumber').html();
				var operateType=0;
				if($(this).hasClass('startBtn')){
					operateType=1;
				}else if($(this).hasClass('finishBtn')){
					operateType=2;
				}
				$.ajax({
					type:"get",
					url:"/vip-app-ws/ws/0.1/workOrder/judgeStatus",/*状态校验接口*/
					async:false,
					data:{busiWorkOrderId:busiWorkOrderId,operateType:operateType},
					dataType:'json',
					contentType:'application/json; charset=utf-8',
					success:function(data){
						window.location.href="http://w2nw?"+path+"/workList.html?busiWorkOrderId="+busiWorkOrderId+"&operateType="+operateType+"&plateNumber="+plateNumber;
					},
					error:function(xhr){
						var error=eval('('+xhr.responseText+')');
						alertTasatF(error[0].message,reflesh);
					}
				});
			});
				
			return 0;
		}
	})
	</script>
	</body>
</html>
