<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black" name="apple-mobile-web-app-status-bar-style"/>
<link type="text/css" href="css/index.css" rel="stylesheet"/>
<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script> 
<script type="text/javascript" src="js/jquery.json-2.2.js"></script> 
<script type="text/javascript" src="js/index.js"></script> 
<title>服务码验证</title>
</head>
<body> 
	<section class="main-wrap">  
		<article>
			<div class="header" id="ads">
			<!-- 
				<img src="http://app.yangchebao.com.cn/group1/M00/02/58/ChoCK1ZYMm-AK3t3AAIFcQBmDPk183.png" url="http://w2nw?http://app.yangchebao.com.cn/yangchebao-app-ws/ws/0.1/urlMapper/rot/09502848?cardTopicNumber=13983033"/>
				<img src="http://app.yangchebao.com.cn/group1/M00/01/75/ChoCK1YXayaAc_yYAAHOTTWPnXo804.png" url="http://app.yangchebao.com.cn/yangchebao-app-ws/ws/0.1/urlMapper/rot/02036535"/> -->
				<img src="css/images/banner.jpg" url="http://w2nw?http://app.yangchebao.com.cn/yangchebao-app-ws/ws/0.1/urlMapper/rot/09502848?cardTopicNumber=13983033"/>
			</div>
			<div class="codes-wrap">
				<!-- <div class="input-wrap"><input type="text" id="serviceCode" placeholder="请输入短信验证码"/></div> -->
				<div class="input-wrap"><div><textarea id="serviceCode" placeholder="请输入短信验证码" rows="1"></textarea></div></div>
				<a href="javascript:void(0);" class="btnn ablebtn" id="submit">确定</a> 
			</div>
			<div class="order-label"> 
				<div>
					<span class="shop-info"><span id="shopName"></span>（已完成<span id="orderNum"></span>单）</span>
					<div  class="shop-icon"><span></span></div>
				</div>
				<ul class="shop-select" id="shopSelect">
					<!-- <li>北京海淀区xxxxx总店第二分店（小营）</li>
					<li class="selected">北京海淀区xxxxx总店第二分店（小营）</li> -->
				</ul>
			</div>
			<div class="overlay-containter">
				<ul class="order-wrap" id="orderList">
					<!-- <li class="selected">
						<div>
							<div class="user-info"> 
								<span class="time">2014.09.12 15:20</span>
								<span class="name">三少爷的剑的</span> 
							</div>
							<div class="order-info">
								<p class="serviceName">洗车－电脑-电脑精洗－电脑精洗－sss大车...</p>
								<div class="clearfix">
									<span class="left-span">车型:丰田86</span>
									<span class="right-span org">当面支付 ¥89</span>
								</div>
							</div>
						</div>
					</li>  -->
				</ul>  
				<div class="overlay-wrap"></div> 
			</div>
		</article> 
	</section>   
	<script type="text/javascript">
	$(document).ready(function(){
		var response = "1",page = 0,pagesize=10,shopId="-1";  
		function getBranchShopList(userInfo){  
			$.ajax({
				url: '/vip-app-ws/ws/0.1/shopAccount/getBranchShopList?shopAccountId='+userInfo.shopAccountId+'&hasmain=true',
				type: 'get',
				async: false,
				dataType: 'json',
				success: function(data) {   
					var str = "";
					$("#shopName").html(data[0].shopName);
					$.each(data,function(i){
						var item = data[i];
						str += '<li shopAccountId="'+item.shopAccountId+'">'+ item.shopName+'</li>';
					});
				 	$("#shopSelect").html(str);
				},
				error:function(xhr){
					alertRe("获取数据失败！");
				}
			}); 
	 	}  
 		function getOrderList(shopId,owraper){    
			response = "1";
			$.ajax({
				url: '/vip-app-ws/ws/0.1/orders?shopId='+shopId+'&orderListType='+1+'&pageindex='+page+'&pagesize='+pagesize+'&sortname=serviceDate&sortorder=desc',
				type: 'get',
				async: false,
				dataType: 'json',
				success: function(data) {   
					page++; 
					var str = "";
					var items = data.items; 
					$.each(items,function(i){
						var item = items[i];
						if(item.paid=="0"){ 
							item.paid="当面支付"; 
						}else if(item.paid=="1"){
							item.paid="网上支付";
						} 
						str += '<li orderId="'+ item.orderId +'">' 
							+'<div>'
							+'<div class="user-info"> '
							+'<span class="time">'+ item.serviceDate +'</span>'
							+'<span class="name">'+ item.nicName +'</span> '
							+'</div>'
							+'<div class="order-info">'
							+'<p class="serviceName">'+ item.serviceName +'</p>'
							+'<div class="clearfix">'
							+'<span class="left-span">车型:'+ item.model +'</span>'
							+'<span class="right-span">'+item.paid+' ¥'+ item.reservePrice +'</span>'
							+'</div>'
							+'</div>'
							+'</div>' 
							+'</li> ';
					});  
					if(owraper!=undefined&&owraper!=""){ 
						$("#orderList").next('.null-tip').remove();
						$("#orderList").html(str); 
						$("#orderNum").html(data.totalCount);
						if(str==""){
							$("#orderList").after('<p class="null-tip">您还没有已完成订单</p>'); 
						}
					}else{
						$("#orderList").append(str);
					}
					if(data.page >= data.totalPages-1){
						response = "0";
					}
					if(bIsAndroid()){
						$(".overlay-containter").css("min-height",$(window).height()-178);  
					}else{
						$(".overlay-containter").css("min-height",$(window).height()-130);  
					}
				},
				error:function(xhr){

				}
			}); 
			return response;
	 	} 
	 	index.init = function(userInfo,bridge) { 
	 		shopId = userInfo.shopAccountId;
		 	$(".ablebtn").on('click',function(){ 
		 		$(this).removeClass("ablebtn");
		 		checkCode(); 
		 	}); 
		 	$(".shop-icon").on('click',function(){
		 		if($(this).hasClass("open")){ 
			 		$(this).removeClass("open");
			 		$(".shop-select").slideUp(400); 
			 		$('.overlay-wrap').slideUp(400);
			 	}else{ 
			 		$(this).addClass("open");
			 		$('.shop-select').slideDown();
			 		$('.overlay-wrap').slideDown(); 
			 	}
		 	});
		 	$(".shop-select").on('click','li',function(){ 
		 		shopId = $(this).attr("shopAccountId"); 
		 		page = 0;
		 		$("#shopName").html($(this).html());
		 		getOrderList(shopId,"html"); 
		 		mobileCallBack(response,bridge);
		 		$(".shop-select .selected").removeClass('selected');
		 		$(this).addClass('selected'); 
		 		$('.shop-icon').removeClass("open");
			 	$(".shop-select").slideUp(400); 
			 	$('.overlay-wrap').slideUp(400);
		 	});  
		 	$('body').on('click',function(e){
		 		var target = e.srcElement|| e.target;
		 		if($(target).hasClass('overlay-wrap')||$(target).hasClass('codes-wrap')) {
		 			$('.shop-icon').removeClass("open");
			 		$(".shop-select").slideUp(400); 
			 		$('.overlay-wrap').slideUp(400);
		 		}  
		 	});  
		 	var path = getPath(); 
		 	$('#orderList').delegate('li','touchstart click touchend',function(e){ 
	 			var that = this;
	 			var home = path; 
	 			switch(e.type) {
	 				case 'touchstart':
	 					$("#orderList .selected").removeClass('selected');  
	 					$(that).addClass('selected');
	 					break;
	 				case 'click':   
				 		var orderId = $(that).attr("orderId");  
	 					window.location.href = "http://w2nw?"+path+"/order-detail.html?orderId="+orderId; 
	 					break; 
	 			}
 		}); 
		 	function checkCode(){ 
		 		var serviceCode = $("#serviceCode").val();
		 		if(serviceCode==""){
		 			return false;
		 		}
		 		var postData = {};
		 		postData.serviceCode = serviceCode;
		 		postData.shopAccountId = userInfo.shopAccountId; 
				$.ajax({
					url: '/vip-app-ws/ws/0.1/serviceCode/checkCode?serviceCode='+serviceCode+'&shopAccountId='+userInfo.shopAccountId,
					contentType : "application/json;charset=utf-8",
					dataType : "json",
					type : "POST",
					data : $.toJSON(postData),
					async : false,
					success: function(data) {  
						page = 0;
						getOrderList(userInfo.shopAccountId,"html"); 
						window.location.href = encodeURI("http://w2l?"+path+"/checkcode-success.html?serviceName="+data.serviceName+"&servicePrice="+data.servicePrice+"&paid="+data.paid+"&userInfoId="+data.userInfoId+"&shopId="+data.shopId);  
						$("#submit").addClass("ablebtn");
					},
					error:function(xhr){ 
						var mes = eval('('+xhr.responseText+')');    
						window.location.href = encodeURI("http://w2l?"+path+"/checkcode-error.html?message="+mes[0].message); 
						$("#submit").addClass("ablebtn");
					}
				}); 
		 	}
		 	getBranchShopList(userInfo);
			getOrderList(userInfo.shopAccountId,"html");
			return response;
	 	};
	 	index.pullUpRefresh = function(bridge) {  
				getOrderList(shopId,""); 
				return response;
		}

		});  
 
	</script>  
</body>

</html>

