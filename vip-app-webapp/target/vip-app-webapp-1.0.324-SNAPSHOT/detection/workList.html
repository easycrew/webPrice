<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"/>
		<meta content="yes" name="apple-mobile-web-app-capable"/>
		<meta content="black" name="apple-mobile-web-app-status-bar-style"/>
		<link type="text/css" href="../css/base.css" rel="stylesheet"/>
		<link rel="stylesheet" href="css/detection.css" />
		<script type="text/javascript" src="../js/jquery-1.9.1.min.js"></script> 
		<script type="text/javascript" src="../js/index.js"></script>
		<title>服务详情</title>
		<style>
			body{
				font-size: 62.5%;
			}
		</style>
	</head>
	<body>
		<div class="shopTitle"><span>京A23121</span>车辆信息</div>
		<section class="list-wrap">
			<!--<div class="order-item">
				<div class="service-title row">服务：<span class="title-name">玻璃贴膜</span></div>
				<div class="service-con row">
					<div class="parts">配件：<span class="parts-name">3M玻璃</span></div>
					<div class="amount">数量：<span class="amount-num">1</span></div>
				</div>
			</div>	
			<div class="order-item">
				<div class="service-title row">服务：<span class="title-name">玻璃贴膜</span></div>
				<div class="service-con row">
					<div class="parts">配件：<span class="parts-name empty">——</span></div>
					<div class="amount">数量：<span class="amount-num empty">--</span></div>
				</div>
			</div>			-->
		</section>
		<div class="button-wrap">
			<div id="begain" class="button">开工</div>
			<div id="finish" class="button" style="display: none;">完工</div>
		</div>
		<script type="text/javascript">
		$(function(){
			var userInfo;
			var bridge;
			var path=getPath();
			var response="0";
			var url = window.location.search;
			var paramJson = {};
			if (url != undefined && url != "") {
				var paramsArr = (url.split("?")[1]).split("&");
				$.each(paramsArr, function(i) {
					var item = paramsArr[i].split("=");
					paramJson[item[0]] = item[1];
				});
			}
			var busiWorkOrderId=paramJson.busiWorkOrderId;
			var operateType=paramJson.operateType;
			paramJson.plateNumber=decodeURI(paramJson.plateNumber);
			var plateNumber=paramJson.plateNumber;
			$(".shopTitle span").html(plateNumber);
			function turnPage(){
				if(bIsAndroid()){
					window.mallTitle.popToRootVC('1');  
				}else{
					bridge.callHandler('popToRootVC',{'isPopToRootVC':'1'});
				}
			}
			/*工单详情*/
			function detail(){
				$.ajax({
					type:"get",
					url:"/vip-app-ws/ws/0.1/workOrder/detail",
					async:false,
					data:{busiWorkOrderId:busiWorkOrderId,operateType:operateType},
					dataType:'json',
					contentType:'application/jso;charset=utf-8',
					success:function(data){
						if(operateType==1){
							$("#begain").show().html('开工');
							$("#finish").hide();
						}else if(operateType==2){
							$("#begain").hide();
							$("#finish").show().html('完工');
						}
						var str='';
						var listWrap=$(".list-wrap");
						$.each(data, function(i) {
							str+='<div class="order-item">'+
									'<div class="service-title row">服务：<span class="title-name">'+this.serviceName+'</span></div>'
									if(this.commodities!=''){
										$.each(this.commodities, function() {
											str+='<div class="service-con row">'+
												'<div class="parts">配件：<span class="parts-name">'+this.commodityName+'</span></div>'+
												'<div class="amount">数量：<span class="amount-num">'+this.amount+'</span></div>'+
												'</div>'
										});
									}else{
										str+='<div class="service-con row">'+
												'<div class="parts">配件：<span class="parts-name">——</span></div>'+
												'<div class="amount">数量：<span class="amount-num">--</span></div>'+
												'</div>'
									}
							str+='</div>'
							listWrap.append(str);
						});
					},
					error:function(xhr){
						var error=eval('('+xhr.responseText+')');
						alertTasatF(error[0].message,turnPage);
					}
				});	
			}
			/*检验单子状态*/
			function checkStatus(){
				$.ajax({
					type:"get",
					url:"/vip-app-ws/ws/0.1/workOrder/judgeStatus",/*状态校验接口*/
					async:false,
					data:{busiWorkOrderId:busiWorkOrderId,operateType:operateType},
					dataType:'json',
					contentType:'application/json; charset=utf-8',
					success:function(data){
						delivery();
					},
					error:function(xhr){
						var error=eval('('+xhr.responseText+')');
						alertTasatF(error[0].message,turnPage);
					}
				});
			}
			
			/*
			 * 开工/完工
			 * operateType  1：开工,  2：完工
			 */
			function delivery(){
				$.ajax({
					type:"post",
					url:"/vip-app-ws/ws/0.1/workOrder/operate",
					async:false,
					data:JSON.stringify({busiWorkOrderId:busiWorkOrderId,operator:userInfo.userId,operateType:operateType}),
					dataType:'json',
					contentType:"application/json; charset=utf-8",
					success:function(){
						if(operateType == 1){
							alertTasatF('动起来，修车啦',turnPage);
						}else{
							alertTasatF('这个车可以开走啦',turnPage);
						}
					},
					error:function(xhr){
						var error=eval('('+xhr.responseText+')');
						alertTasatF(error[0].message,turnPage);
					}
				});
			}
			index.init=function(userInfo_,bridge_){
				userInfo=userInfo_;
				bridge=bridge_;
				detail();
				$("body").on('click','#begain',function(){
					confirmRe('确定要开工吗？',checkStatus);
				});
				$("body").on('click','#finish',function(){
					confirmRe('确定要完工吗？',checkStatus);
				})
				return 0;
			}
			
		})
		</script>
	</body>
</html>

